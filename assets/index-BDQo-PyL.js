var J=Object.defineProperty;var q=(P,r,t)=>r in P?J(P,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):P[r]=t;var o=(P,r,t)=>q(P,typeof r!="symbol"?r+"":r,t);import{P as v}from"./phaser-0RJB29YE.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class j extends v.Scene{constructor(){super("BootScene")}preload(){}create(){const r=this.cameras.main.width,t=this.cameras.main.height;this.add.text(r/2,t/2,"Loading...",{font:"20px monospace",color:"#ffffff"}).setOrigin(.5,.5),this.scene.start("MainScene")}}const D=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"釋放靈魂能量波動，對周圍敵人造成傷害",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5},{id:"active_coder",name:"編碼者",subtitle:"遊戲先知",description:"釋放程式碼能量，對周圍 3 單位範圍敵人造成傷害",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5},{id:"active_vfx",name:"視效師",subtitle:"超級導演",description:"投射貫穿光束，對直線 10 單位範圍敵人造成傷害",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5},{id:"active_architect",name:"架構師",subtitle:"靈魂統領",description:"建構護盾抵擋傷害，並反傷攻擊者",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5},{id:"passive_titanium_liver",name:"鈦金肝",description:"每級提升 5% HP 總量",type:"passive",color:11189196,maxLevel:5},{id:"passive_sync_rate",name:"精神同步率強化",description:"每級提升 8% 移動速度、減少 5% 技能冷卻",type:"passive",color:14518340,maxLevel:5},{id:"passive_retina_module",name:"視網膜增強模組",description:"每級提升 10% 經驗取得量",type:"passive",color:10092390,maxLevel:5},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"每級提升 15% 攻擊、3% 防禦",type:"passive",color:16737945,maxLevel:5}],R=class R{constructor(){o(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return D.filter(r=>r.type==="active")}getPassiveSkillDefinitions(){return D.filter(r=>r.type==="passive")}getPlayerSkill(r){return this.playerSkills.get(r)}getPlayerActiveSkills(){const r=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&r.push(e)});const t=[];for(let e=0;e<4;e++)t.push(r[e]||null);return t}getPlayerPassiveSkills(){const r=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&r.push(e)});const t=[];for(let e=0;e<R.MAX_PASSIVE_SLOTS;e++)t.push(r[e]||null);return t}getOwnedPassiveCount(){let r=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&r++}),r}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=R.MAX_PASSIVE_SLOTS}getSkillLevel(r){const t=this.playerSkills.get(r);return t?t.level:-1}isSkillMaxLevel(r){const t=this.playerSkills.get(r);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(r){const t=D.find(s=>s.id===r);if(!t)return!1;const e=this.playerSkills.get(r);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(r,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(r=>{const t=this.playerSkills.get(r.id);return!t||t.level<r.maxLevel})}getUpgradeablePassiveSkills(){const r=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return r?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const r=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){const a=this.shuffleArray([...r]);for(let l=0;l<Math.min(3,a.length);l++)e.push(a[l]);return e}const s=this.shuffleArray([...r]);for(let a=0;a<Math.min(2,s.length);a++)e.push(s[a]);const i=this.shuffleArray([...t]);return i.length>0&&e.push(i[0]),e}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(r){for(let t=r.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[r[t],r[e]]=[r[e],r[t]]}return r}static formatLevel(r,t=5){return r<=0?"Lv.0":r>=t?"MAX":`Lv.${r}`}getTitaniumLiverHpBonus(){const r=this.playerSkills.get("passive_titanium_liver");return r?(r.level+1)*.05:0}getSyncRateSpeedBonus(){const r=this.playerSkills.get("passive_sync_rate");return r?(r.level+1)*.08:0}getSyncRateCooldownReduction(){const r=this.playerSkills.get("passive_sync_rate");return r?(r.level+1)*.05:0}getRetinaModuleExpBonus(){const r=this.playerSkills.get("passive_retina_module");return r?(r.level+1)*.1:0}getAiEnhancementDamageBonus(){const r=this.playerSkills.get("passive_ai_enhancement");return r?(r.level+1)*.15:0}getAiEnhancementDefenseBonus(){const r=this.playerSkills.get("passive_ai_enhancement");return r?(r.level+1)*.03:0}calculateFinalMaxHp(r){const t=this.getTitaniumLiverHpBonus();return Math.floor(r*(1+t))}calculateFinalMoveSpeed(r){const t=this.getSyncRateSpeedBonus();return r*(1+t)}calculateFinalCooldown(r){const t=this.getSyncRateCooldownReduction();return r*(1-t)}calculateFinalExp(r){const t=this.getRetinaModuleExpBonus();return Math.floor(r*(1+t))}calculateFinalDamage(r){const t=this.getAiEnhancementDamageBonus();return Math.floor(r*(1+t))}calculateFinalDamageTaken(r){const t=this.getAiEnhancementDefenseBonus();return Math.floor(r*(1-t))}};o(R,"MAX_PASSIVE_SLOTS",3);let G=R;const Q=[{id:"slime",name:"史萊姆",color:6750054,speed:80,damage:1,size:.08,hp:30,exp:20}],O=class O{constructor(r,t,e,s,i){o(this,"scene");o(this,"monsters",[]);o(this,"nextMonsterId",0);o(this,"container");o(this,"spawnInterval",2e3);o(this,"lastSpawnTime",0);o(this,"isSpawning",!1);o(this,"gameBounds");o(this,"mapWidth");o(this,"mapHeight");o(this,"playerLevel",0);this.scene=r,this.container=t,this.gameBounds=e,this.mapWidth=s,this.mapHeight=i}setPlayerLevel(r){this.playerLevel=r}calculateMonsterHp(r){return Math.floor(r*Math.pow(O.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(){const r=Math.max(1,this.playerLevel);return O.DAMAGE_UNIT*r}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(r,t,e,s,i){const a=this.scene.time.now;let l=0;const h=[];this.isSpawning&&a-this.lastSpawnTime>=this.spawnInterval&&(this.spawnMonster(t,e,s,i),this.lastSpawnTime=a);const n=this.gameBounds.height*.1,d=this.gameBounds.height*.1;return this.monsters.forEach(c=>{const g=t-c.x,p=e-c.y,m=Math.sqrt(g*g+p*p);if(m>d){const f=c.definition.speed*r/1e3/m;c.x+=g*f,c.y+=p*f}else a-c.lastDamageTime>=3e3&&(l+=this.calculateMonsterDamage(),c.lastDamageTime=a,h.push(c));this.drawMonster(c,n,s,i)}),{damage:l,hitMonsters:h}}spawnMonster(r,t,e,s){const i=["top","left","right"],a=i[Math.floor(Math.random()*i.length)];let l,h;const n=100,d=e,c=e+this.gameBounds.width,g=s;switch(a){case"top":l=d+Math.random()*this.gameBounds.width,h=g-n;break;case"left":l=d-n,h=g+Math.random()*this.gameBounds.height;break;case"right":l=c+n,h=g+Math.random()*this.gameBounds.height;break}l=Phaser.Math.Clamp(l,0,this.mapWidth),h=Phaser.Math.Clamp(h,0,this.mapHeight);const p=Q[0],m=this.scene.add.graphics(),S=this.calculateMonsterHp(p.hp),f={id:this.nextMonsterId++,definition:p,x:l,y:h,hp:S,graphics:m,lastDamageTime:0};this.monsters.push(f),this.container.add(m)}drawMonster(r,t,e,s){const i=r.graphics;i.clear();const a=r.x,l=r.y;i.fillStyle(r.definition.color,.8),i.fillCircle(a,l-t/2,t/2),i.fillStyle(0,1),i.fillCircle(a-t*.15,l-t*.6,t*.08),i.fillCircle(a+t*.15,l-t*.6,t*.08)}removeMonster(r){const t=this.monsters.findIndex(e=>e.id===r);t!==-1&&(this.monsters[t].graphics.destroy(),this.monsters.splice(t,1))}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters.forEach(r=>{r.graphics.destroy()}),this.monsters=[]}setSpawnInterval(r){this.spawnInterval=r}damageMonster(r,t){const e=this.monsters.find(s=>s.id===r);if(!e)return{killed:!1,exp:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const s=e.definition.exp;return this.removeMonster(r),{killed:!0,exp:s}}return{killed:!1,exp:0}}flashMonster(r){const t=r.definition.color,e=r.graphics,s=this.gameBounds.height*.1;e.clear(),e.fillStyle(16777215,1),e.fillCircle(r.x,r.y-s/2,s/2),this.scene.time.delayedCall(50,()=>{r.hp>0&&(e.clear(),e.fillStyle(t,.8),e.fillCircle(r.x,r.y-s/2,s/2),e.fillStyle(0,1),e.fillCircle(r.x-s*.15,r.y-s*.6,s*.08),e.fillCircle(r.x+s*.15,r.y-s*.6,s*.08))})}damageMonsters(r,t){let e=0,s=0;for(const i of r){const a=this.damageMonster(i,t);a.killed&&(e+=a.exp,s++)}return{totalExp:e,killCount:s}}};o(O,"HP_GROWTH_RATE",1.1),o(O,"DAMAGE_UNIT",10);let Y=O;const u=class u extends v.Scene{constructor(){super("MainScene");o(this,"character");o(this,"characterState","idle");o(this,"facingRight",!0);o(this,"skillIcons",[]);o(this,"gameBounds");o(this,"boundsBorder");o(this,"background");o(this,"gameAreaContainer");o(this,"revealMask");o(this,"mapWidth");o(this,"mapHeight");o(this,"characterX");o(this,"characterY");o(this,"characterSize");o(this,"isMoving",!1);o(this,"isPointerDown",!1);o(this,"targetX");o(this,"targetY");o(this,"baseMoveSpeed",200);o(this,"moveSpeed",200);o(this,"floorGrid");o(this,"worldContainer");o(this,"uiContainer");o(this,"cameraOffsetX",0);o(this,"cameraOffsetY",0);o(this,"cursors");o(this,"isKeyboardMoving",!1);o(this,"skillPanelContainer");o(this,"isPaused",!1);o(this,"skillOptions",[]);o(this,"skillCardBgs",[]);o(this,"selectedSkillIndex",0);o(this,"currentSkillChoices",[]);o(this,"skillManager",new G);o(this,"skillIconContainers",[]);o(this,"skillLevelTexts",[]);o(this,"currentExp",0);o(this,"maxExp",100);o(this,"currentLevel",0);o(this,"expBarContainer");o(this,"expBarFill");o(this,"expBarFlowOffset",0);o(this,"levelText");o(this,"currentHp",200);o(this,"maxHp",200);o(this,"hpBarContainer");o(this,"hpBarFill");o(this,"hpBarFlowOffset",0);o(this,"hpText");o(this,"currentShield",0);o(this,"shieldBarFill");o(this,"shieldBarFlowOffset",0);o(this,"shieldReflectDamage",0);o(this,"shieldText");o(this,"keyPlus");o(this,"keyMinus");o(this,"keyShift");o(this,"keyCtrl");o(this,"keyZero");o(this,"keyF5");o(this,"keyF6");o(this,"keyF7");o(this,"keyF8");o(this,"keyF9");o(this,"keyF10");o(this,"keyF11");o(this,"keyF12");o(this,"monsterManager");o(this,"isHurt",!1);o(this,"hurtEndTime",0);o(this,"lowHpVignette");o(this,"skillCooldowns",new Map);o(this,"isAttacking",!1);o(this,"attackEndTime",0);o(this,"gameBgm");o(this,"currentBgmKey","")}create(){this.cameras.main.setBackgroundColor("#111111");const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const h=t*.9,n=e*(1-.05*2),d=16/9,c=h/n;let g,p;c>d?(p=n,g=n*d):(g=h,p=h/d),this.gameBounds={x:(t-g)/2,y:(e-p)/2,width:g,height:p}}this.mapWidth=this.gameBounds.width*u.MAP_SCALE,this.mapHeight=this.gameBounds.height*u.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.worldContainer.add(this.character),this.monsterManager=new Y(this,this.worldContainer,this.gameBounds,this.mapWidth,this.mapHeight),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const s=this.make.graphics({x:0,y:0});s.fillStyle(16777215),s.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const i=s.createGeometryMask();this.worldContainer.setMask(i),this.uiContainer=this.add.container(0,0),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const a=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(a),this.uiContainer.setMask(a),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.ZERO),this.keyF5=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(v.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createLowHpVignette()}update(t,e){if(this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const s=this.time.now;this.isHurt&&s>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&s>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isMoving||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isMoving&&!this.isKeyboardMoving&&this.moveCharacter(e));const i=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);i.damage>0&&this.takeDamage(i.damage,i.hitMonsters),this.tryActivateSkills(s)}tryActivateSkills(t){if(this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const i=s.definition;let a=i.cooldown||1e3;i.id==="active_architect"&&(a=a-s.level*500);const l=this.skillManager.calculateFinalCooldown(a),h=this.skillCooldowns.get(i.id)||0;t-h>=l&&(this.activateSkill(s,t),this.skillCooldowns.set(i.id,t))}}activateSkill(t,e){const s=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+u.ATTACK_DURATION,this.setCharacterState("attack",!0),s.flashColor&&this.character.setTint(s.flashColor),s.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${s.name}`)}}activateSoulRender(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let s=e[0],i=1/0;for(const p of e){const m=p.x-this.characterX,S=p.y-this.characterY,f=Math.sqrt(m*m+S*S);f<i&&(i=f,s=p)}const a=Math.atan2(s.y-this.characterY,s.x-this.characterX);this.facingRight=Math.cos(a)>=0,this.updateCharacterSprite();const l=this.gameBounds.height*.3,h=60/2*(Math.PI/180),n=2+t.level,d=u.DAMAGE_UNIT*n,c=this.skillManager.calculateFinalDamage(d),g=[];for(const p of e){const m=p.x-this.characterX,S=p.y-this.characterY;if(Math.sqrt(m*m+S*S)>l)continue;let k=Math.atan2(S,m)-a;for(;k>Math.PI;)k-=Math.PI*2;for(;k<-Math.PI;)k+=Math.PI*2;Math.abs(k)<=h&&g.push(p.id)}if(this.drawSectorEffect(a,l,h,t.definition.color),g.length>0){const p=this.monsterManager.damageMonsters(g,c);p.totalExp>0&&this.addExp(p.totalExp),this.shakeScreen(g.length),console.log(`Soul Render hit ${g.length} monsters for ${c} damage, killed ${p.killCount}, exp +${p.totalExp}`)}}drawSectorEffect(t,e,s,i){const a=this.add.graphics();this.worldContainer.add(a);const l=t-s,h=t+s;a.fillStyle(i,.4),a.beginPath(),a.moveTo(this.characterX,this.characterY),a.arc(this.characterX,this.characterY,e,l,h,!1),a.closePath(),a.fillPath(),a.lineStyle(3,i,.8),a.beginPath(),a.moveTo(this.characterX,this.characterY),a.arc(this.characterX,this.characterY,e,l,h,!1),a.closePath(),a.strokePath(),this.tweens.add({targets:a,alpha:0,duration:200,onComplete:()=>{a.destroy()}})}activateCoder(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=this.gameBounds.height*.1,i=2+t.level*.5,a=s*i,l=1+t.level*.5,h=u.DAMAGE_UNIT*l,n=this.skillManager.calculateFinalDamage(h),d=[];for(const c of e){const g=c.x-this.characterX,p=c.y-this.characterY;Math.sqrt(g*g+p*p)<=a&&d.push(c.id)}if(this.drawCircleEffect(a,t.definition.color),d.length>0){const c=this.monsterManager.damageMonsters(d,n);c.totalExp>0&&this.addExp(c.totalExp),this.shakeScreen(d.length),console.log(`Coder hit ${d.length} monsters for ${n} damage, killed ${c.killCount}, exp +${c.totalExp}`)}}drawCircleEffect(t,e){const s=this.add.graphics();this.worldContainer.add(s),s.fillStyle(e,.3),s.fillCircle(this.characterX,this.characterY,t),s.lineStyle(3,e,.8),s.strokeCircle(this.characterX,this.characterY,t);const i=this.add.graphics();this.worldContainer.add(i);let a=t*.3;this.tweens.add({targets:{r:a},r:t,duration:200,onUpdate:l=>{const h=l.getValue();i.clear();const n=.6*(1-(h-t*.3)/(t*.7));i.lineStyle(4,e,n),i.strokeCircle(this.characterX,this.characterY,h)},onComplete:()=>{i.destroy()}}),this.tweens.add({targets:s,alpha:0,duration:250,onComplete:()=>{s.destroy()}})}activateVfx(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=t.level+1,i=this.gameBounds.height*1,a=this.gameBounds.height*.05,l=u.DAMAGE_UNIT*1,h=this.skillManager.calculateFinalDamage(l),n=new Set,d=e.map((p,m)=>m),c=[];for(let p=0;p<s;p++){let m;if(d.length>0){const S=Math.floor(Math.random()*d.length),f=d[S];d.splice(S,1);const x=e[f];m=Math.atan2(x.y-this.characterY,x.x-this.characterX)}else m=Math.random()*Math.PI*2;c.push(m);for(const S of e){const f=S.x-this.characterX,x=S.y-this.characterY;if(Math.sqrt(f*f+x*x)>i)continue;const y=Math.cos(m),w=Math.sin(m);if(f*y+x*w<0)continue;Math.abs(f*w-x*y)<=a/2&&n.add(S.id)}this.drawBeamEffect(m,i,a,t.definition.color)}c.length>0&&(this.facingRight=Math.cos(c[0])>=0,this.updateCharacterSprite());const g=Array.from(n);if(g.length>0){const p=this.monsterManager.damageMonsters(g,h);p.totalExp>0&&this.addExp(p.totalExp),this.shakeScreen(g.length),console.log(`VFX (${s} beams) hit ${g.length} monsters for ${h} damage, killed ${p.killCount}, exp +${p.totalExp}`)}}drawBeamEffect(t,e,s,i){const a=this.add.graphics();this.worldContainer.add(a);const l=this.characterX+Math.cos(t)*e,h=this.characterY+Math.sin(t)*e,n=Math.sin(t)*s/2,d=-Math.cos(t)*s/2;a.fillStyle(i,.5),a.beginPath(),a.moveTo(this.characterX-n,this.characterY-d),a.lineTo(l-n,h-d),a.lineTo(l+n,h+d),a.lineTo(this.characterX+n,this.characterY+d),a.closePath(),a.fillPath(),a.lineStyle(3,16777215,.8),a.beginPath(),a.moveTo(this.characterX,this.characterY),a.lineTo(l,h),a.strokePath(),a.lineStyle(2,i,.8),a.beginPath(),a.moveTo(this.characterX-n,this.characterY-d),a.lineTo(l-n,h-d),a.lineTo(l+n,h+d),a.lineTo(this.characterX+n,this.characterY+d),a.closePath(),a.strokePath(),this.tweens.add({targets:a,alpha:0,duration:150,onComplete:()=>{a.destroy()}})}activateArchitect(t){const e=Math.floor(this.currentHp*.3);this.currentShield=e,this.shieldReflectDamage=u.DAMAGE_UNIT*1,this.drawShieldBarFill(),this.drawShieldActivateEffect(),console.log(`Architect activated: Shield ${e}, Reflect damage ${this.shieldReflectDamage}`)}drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,i=this.characterSize*.8,a=16768324;t.lineStyle(3,a,.8),t.strokeCircle(e,s,i*.3),t.fillStyle(a,.2),t.fillCircle(e,s,i*.3);const l=i*.3;this.tweens.add({targets:{radius:l},radius:i,duration:300,ease:"Cubic.easeOut",onUpdate:h=>{const n=h.getValue();if(n===null)return;t.clear();const d=.8*(1-(n-l)/(i-l));t.lineStyle(3,65535,d),t.strokeCircle(e,s,n),t.fillStyle(65535,d*.25),t.fillCircle(e,s,n)},onComplete:()=>{t.destroy()}})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&v.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:s}of t)if(e&&v.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(s);return}}if(this.keyShift.isDown&&v.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=D.find(h=>h.id===t);if(!e)return;const s=this.skillManager.getSkillLevel(t),i=e.type==="passive";if(s>=e.maxLevel){console.log(`Test: ${e.name} is already MAX`);return}if(i&&s<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${e.name}`);return}const a=s<0?-1:s,l=e.maxLevel-a;this.currentLevel+=l,this.monsterManager.setPlayerLevel(this.currentLevel);for(let h=0;h<l;h++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${e.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const s of e)for(let i=0;i<=s.maxLevel;i++)this.skillManager.learnOrUpgradeSkill(s.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(u.BASE_EXP*Math.pow(u.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=u.BASE_HP+u.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const s=this.currentHp/e;this.currentHp=Math.floor(this.maxHp*s)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(v.Input.Keyboard.JustDown(this.cursors.A)&&this.setSelectedSkill(0),v.Input.Keyboard.JustDown(this.cursors.S)&&this.setSelectedSkill(1),v.Input.Keyboard.JustDown(this.cursors.D)&&this.setSelectedSkill(2),v.Input.Keyboard.JustDown(this.cursors.W)&&this.confirmSkillSelection())}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,e){const s=this.skillCardBgs[t],i=this.skillOptions[t];!s||!i||(e?(s.setFillStyle(3355443),s.setStrokeStyle(3,16777215),this.tweens.add({targets:i,scaleX:1.05,scaleY:1.05,duration:100})):(s.setFillStyle(2236962),s.setStrokeStyle(2,6710886),this.tweens.add({targets:i,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let e=0,s=0;if(this.cursors.W.isDown&&(s=-1),this.cursors.S.isDown&&(s=1),this.cursors.A.isDown&&(e=-1),this.cursors.D.isDown&&(e=1),e!==0||s!==0){if(this.isKeyboardMoving=!0,this.isMoving=!1,e!==0&&(this.facingRight=e>0),e!==0&&s!==0){const a=1/Math.sqrt(2);e*=a,s*=a}const i=this.moveSpeed*t/1e3;this.characterX+=e*i,this.characterY+=s*i,this.characterX=v.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=v.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateTargetFromPointer(t),this.isMoving=!0)}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateTargetFromPointer(t)}onPointerUp(){this.isPointerDown=!1}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateTargetFromPointer(t){const e=t.x-this.gameBounds.x,s=t.y-this.gameBounds.y,i=e+this.cameraOffsetX,a=s+this.cameraOffsetY;this.targetX=v.Math.Clamp(i,this.characterSize,this.mapWidth-this.characterSize),this.targetY=v.Math.Clamp(a,this.characterSize,this.mapHeight-this.characterSize)}moveCharacter(t){const e=this.targetX-this.characterX,s=this.targetY-this.characterY,i=Math.sqrt(e*e+s*s);if(this.updateCharacterFacing(this.targetX),i<5)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const a=this.moveSpeed*t/1e3;if(a>=i)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const l=a/i;this.characterX+=e*l,this.characterY+=s*l,this.setCharacterState("run")}}this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,s=this.cameraOffsetY+this.gameBounds.height/2,i=this.characterX-e,a=this.characterY-s,l=this.gameBounds.width*u.CAMERA_DEAD_ZONE,h=this.gameBounds.height*u.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(i)>l/2&&(i>0?this.cameraOffsetX+=i-l/2:this.cameraOffsetX+=i+l/2),Math.abs(a)>h/2&&(a>0?this.cameraOffsetY+=a-h/2:this.cameraOffsetY+=a+h/2)),this.cameraOffsetX=v.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=v.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const s=t.filter(i=>i!==this.currentBgmKey);e=s[Math.floor(Math.random()*s.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const s=t/this.background.width,i=e/this.background.height,a=Math.max(s,i);this.background.setScale(a)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(100);const e=this.gameBounds.height*.01*2,s=Math.min(1,this.gameBounds.width/u.BASE_WIDTH),i=Math.max(.4,s),a=Math.floor(u.BASE_ICON_SIZE*i),l=Math.floor(u.BASE_ICON_GAP*i),h=Math.floor(u.BASE_GROUP_GAP*i),n=Math.floor(u.BASE_BOTTOM_MARGIN*i),d=u.ACTIVE_SKILLS,c=u.PASSIVE_SKILLS,g=d*a+(d-1)*l,p=c*a+(c-1)*l,m=g+h+p,S=this.gameBounds.x+(this.gameBounds.width-m)/2,x=this.gameBounds.y+this.gameBounds.height-a-n-e-8,k=this.add.rectangle(S+m/2,x+e/2,m,e,0);k.setStrokeStyle(1,3355443),this.hpBarContainer.add(k),this.hpBarFill=this.add.graphics(),this.hpBarContainer.add(this.hpBarFill);const y=Math.floor(this.gameBounds.height*.03);this.hpText=this.add.text(S+m/2,x+e/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:"monospace",fontSize:`${y}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.hpText.setOrigin(.5,.5),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){this.hpBarFill.clear();const e=this.gameBounds.height*.01*2,s=Math.min(1,this.gameBounds.width/u.BASE_WIDTH),i=Math.max(.4,s),a=Math.floor(u.BASE_ICON_SIZE*i),l=Math.floor(u.BASE_ICON_GAP*i),h=Math.floor(u.BASE_GROUP_GAP*i),n=Math.floor(u.BASE_BOTTOM_MARGIN*i),d=u.ACTIVE_SKILLS,c=u.PASSIVE_SKILLS,g=d*a+(d-1)*l,p=c*a+(c-1)*l,m=g+h+p,S=this.gameBounds.x+(this.gameBounds.width-m)/2,x=this.gameBounds.y+this.gameBounds.height-a-n-e-8,k=this.currentHp/this.maxHp,y=m*k;if(y<=0)return;const w=Math.ceil(y/2)+1;for(let C=0;C<w;C++){const M=S+C*2;if(M>=S+y)break;const B=(M-S)/m,A=this.hpBarFlowOffset,b=(B+A)%1,E=(Math.sin(b*Math.PI*2-Math.PI/2)+1)/2,I=Math.floor(136-34*E),F=Math.floor(0+0*E),H=Math.floor(34+102*E),_=I<<16|F<<8|H;this.hpBarFill.fillStyle(_,1);const X=Math.min(2,S+y-M);this.hpBarFill.fillRect(M,x,X,e)}this.hpBarFill.fillStyle(16777215,.15),this.hpBarFill.fillRect(S,x,y,e*.4)}updateHpBarFlow(t){this.hpBarFlowOffset+=.08*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.drawHpBarFill()}updateHpText(){this.hpText&&this.hpText.setText(`${this.currentHp} / ${this.maxHp}`)}createShieldBar(){this.shieldBarFill=this.add.graphics(),this.shieldBarFill.setDepth(101),this.shieldText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#ffdd44",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(.5,.5),this.shieldText.setDepth(102),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldBarFill),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){if(this.shieldBarFill.clear(),this.currentShield<=0){this.shieldText.setVisible(!1);return}const t=this.gameBounds.height*.01,e=t*2,s=t*1.5,i=Math.min(1,this.gameBounds.width/u.BASE_WIDTH),a=Math.max(.4,i),l=Math.floor(u.BASE_ICON_SIZE*a),h=Math.floor(u.BASE_ICON_GAP*a),n=Math.floor(u.BASE_GROUP_GAP*a),d=Math.floor(u.BASE_BOTTOM_MARGIN*a),c=u.ACTIVE_SKILLS,g=u.PASSIVE_SKILLS,p=c*l+(c-1)*h,m=g*l+(g-1)*h,S=p+n+m,f=this.gameBounds.x+(this.gameBounds.width-S)/2,y=this.gameBounds.y+this.gameBounds.height-l-d-e-8-s,w=this.maxHp*.3,C=this.currentShield/w,M=S*Math.min(1,C);if(M<=0)return;this.shieldBarFill.fillStyle(0,.8),this.shieldBarFill.fillRect(f,y,S,s),this.shieldBarFill.lineStyle(1,3355443),this.shieldBarFill.strokeRect(f,y,S,s);const B=Math.ceil(M/2)+1;for(let b=0;b<B;b++){const E=f+b*2;if(E>=f+M)break;const I=(E-f)/S,F=this.shieldBarFlowOffset,H=(I+F)%1,_=(Math.sin(H*Math.PI*2-Math.PI/2)+1)/2,X=255,U=Math.floor(204+17*_),z=Math.floor(0+68*_),N=X<<16|U<<8|z;this.shieldBarFill.fillStyle(N,.9);const Z=Math.min(2,f+M-E);this.shieldBarFill.fillRect(E,y,Z,s)}this.shieldBarFill.fillStyle(16777215,.25),this.shieldBarFill.fillRect(f,y,M,s*.4),this.shieldBarFill.lineStyle(1,16768324,.5),this.shieldBarFill.strokeRect(f,y,M,s);const A=Math.floor(w);this.shieldText.setText(`${this.currentShield} / ${A}`),this.shieldText.setPosition(f+S/2,y+s/2),this.shieldText.setVisible(!0)}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.15;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}takeDamage(t,e=[]){let i=this.skillManager.calculateFinalDamageTaken(t),a=0;if(this.currentShield>0&&(this.currentShield>=i?(a=i,this.currentShield-=i,i=0):(a=this.currentShield,i-=this.currentShield,this.currentShield=0),this.drawShieldBarFill(),a>0&&this.flashShieldEffect(),this.shieldReflectDamage>0&&e.length>0)){const l=e.map(n=>n.id),h=this.monsterManager.damageMonsters(l,this.shieldReflectDamage);h.totalExp>0&&this.addExp(h.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${e.length} monsters, killed ${h.killCount}`)}i>0?(this.currentHp-=i,this.currentHp<0&&(this.currentHp=0),this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+u.HURT_DURATION,this.isMoving=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${i} damage (${a} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${a} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&console.log("Player died!")}flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,i=this.characterSize*.6,a=16768324;t.lineStyle(4,a,.8),t.strokeCircle(e,s,i),t.fillStyle(a,.3),t.fillCircle(e,s,i),this.tweens.add({targets:t,alpha:0,duration:150,onComplete:()=>{t.destroy()}})}flashCharacter(){this.character.setTint(16764108),this.time.delayedCall(50,()=>{this.character.setTint(16737894)}),this.time.delayedCall(100,()=>{this.character.clearTint()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){this.lowHpVignette=this.add.graphics(),this.lowHpVignette.setDepth(1e3),this.lowHpVignette.setAlpha(0),this.uiContainer.add(this.lowHpVignette)}updateLowHpVignette(){this.currentHp/this.maxHp<=.3?(this.drawVignette(),this.tweens.killTweensOf(this.lowHpVignette),this.lowHpVignette.setAlpha(.6),this.tweens.add({targets:this.lowHpVignette,alpha:.3,duration:300,ease:"Sine.easeInOut"})):(this.tweens.killTweensOf(this.lowHpVignette),this.lowHpVignette.setAlpha(0))}drawVignette(){this.lowHpVignette.clear();const t=this.gameBounds.width,e=this.gameBounds.height,s=this.gameBounds.x,i=this.gameBounds.y,a=Math.min(t,e)*.15,l=10;for(let h=0;h<l;h++){const n=h/l,d=(1-n)*.5,c=a*n;this.lowHpVignette.lineStyle(a/l,16711680,d),this.lowHpVignette.strokeRect(s+c,i+c,t-c*2,e-c*2)}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(100);const t=this.gameBounds.height*.01,e=this.gameBounds.width,s=this.gameBounds.x,i=this.gameBounds.y+this.gameBounds.height-t,a=this.add.rectangle(s+e/2,i+t/2,e,t,0);this.expBarContainer.add(a),this.expBarFill=this.add.graphics(),this.expBarContainer.add(this.expBarFill),this.drawExpBarFill();const l=Math.floor(this.gameBounds.height*.03);this.levelText=this.add.text(this.gameBounds.x+10,i-l-5,`Lv.${this.currentLevel}`,{fontFamily:"monospace",fontSize:`${l}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText)}drawExpBarFill(){this.expBarFill.clear();const t=this.gameBounds.height*.01,e=this.gameBounds.width,s=this.gameBounds.x,i=this.gameBounds.y+this.gameBounds.height-t,a=this.currentExp/this.maxExp,l=e*a;if(l<=0)return;const h=Math.ceil(l/2)+1;for(let n=0;n<h;n++){const d=s+n*2;if(d>=s+l)break;const c=(d-s)/e,g=this.expBarFlowOffset,p=(c+g)%1,m=(Math.sin(p*Math.PI*2-Math.PI/2)+1)/2,S=Math.floor(68+68*m),f=Math.floor(136-68*m),k=S<<16|f<<8|255;this.expBarFill.fillStyle(k,1);const y=Math.min(2,s+l-d);this.expBarFill.fillRect(d,i,y,t)}this.expBarFill.fillStyle(16777215,.2),this.expBarFill.fillRect(s,i,l,t*.4)}updateExpBarFlow(t){this.expBarFlowOffset+=.1*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,e=Math.ceil(this.mapWidth/t),s=Math.ceil(this.mapHeight/t);for(let h=0;h<s;h++)for(let n=0;n<e;n++){const d=n*t,c=h*t;(h+n)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(d,c,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(d,c,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const i=this.mapWidth/2,a=this.mapHeight/2,l=t;this.floorGrid.strokeRect(i-l/2,a-l/2,l,l);for(let h=0;h<s;h+=5)for(let n=0;n<e;n+=5){const d=n*t+t/2,c=h*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(d,c,4)}}createSkillBar(){const t=this.gameBounds,e=Math.min(1,t.width/u.BASE_WIDTH),s=Math.max(.4,e),i=Math.floor(u.BASE_ICON_SIZE*s),a=Math.floor(u.BASE_ICON_GAP*s),l=Math.floor(u.BASE_GROUP_GAP*s),h=Math.floor(u.BASE_BOTTOM_MARGIN*s),n=Math.max(1,Math.floor(2*s)),d=u.ACTIVE_SKILLS,c=u.PASSIVE_SKILLS,g=d*i+(d-1)*a,p=c*i+(c-1)*a,m=g+l+p,S=t.x+(t.width-m)/2+i/2,f=t.y+t.height-i/2-h;for(let k=0;k<d;k++){const y=S+k*(i+a),w=this.add.container(y,f),C=this.add.rectangle(0,0,i,i);C.setStrokeStyle(n,16777215),C.setFillStyle(0,0),w.add(C);const M=this.add.rectangle(0,0,i-4,i-4,3355443,0);w.add(M);const B=this.add.text(0,i*.3,"",{fontFamily:"monospace",fontSize:`${Math.floor(i*.25)}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2});B.setOrigin(.5,.5),w.add(B),this.skillIcons.push(C),this.skillIconContainers.push(w),this.skillLevelTexts.push(B),this.uiContainer.add(w)}const x=S+g+l;for(let k=0;k<c;k++){const y=x+k*(i+a),w=this.add.container(y,f),C=this.add.rectangle(0,0,i,i);C.setStrokeStyle(n,16777215),C.setFillStyle(0,0),w.add(C);const M=this.add.rectangle(0,0,i-4,i-4,3355443,0);w.add(M);const B=this.add.text(0,i*.3,"",{fontFamily:"monospace",fontSize:`${Math.floor(i*.25)}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2});B.setOrigin(.5,.5),w.add(B),this.skillIcons.push(C),this.skillIconContainers.push(w),this.skillLevelTexts.push(B),this.uiContainer.add(w)}}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),s=[...t,...e];for(let i=0;i<this.skillIconContainers.length;i++){const a=this.skillIconContainers[i],l=this.skillLevelTexts[i],h=s[i],n=a.list[1];h?(n.setFillStyle(h.definition.color,.5),l.setText(G.formatLevel(h.level,h.definition.maxLevel))):(n.setFillStyle(3355443,0),l.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.07)}px`,color:"#ffffff",fontStyle:"bold"});s.setOrigin(.5,.5),this.skillPanelContainer.add(s);const i=e+this.gameBounds.height*.06,a=this.add.text(this.gameBounds.x+this.gameBounds.width/2,i,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.025)}px`,color:"#aaaaaa"});a.setOrigin(.5,.5),this.skillPanelContainer.add(a),this.createSkillOptions();const l=this.gameBounds.y+this.gameBounds.height*.92,h=this.add.text(this.gameBounds.x+this.gameBounds.width/2,l,"點選或按 W 確定",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.022)}px`,color:"#666666"});h.setOrigin(.5,.5),this.skillPanelContainer.add(h)}createSkillOptions(){if(this.skillOptions.forEach(d=>d.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,e=this.gameBounds.height*.5,s=this.gameBounds.width*.05,i=this.currentSkillChoices.length,a=t*i+s*(i-1),l=this.gameBounds.x+(this.gameBounds.width-a)/2+t/2,h=this.gameBounds.y+this.gameBounds.height*.55,n=["A","S","D"];for(let d=0;d<this.currentSkillChoices.length;d++){const c=this.currentSkillChoices[d],g=this.skillManager.getSkillLevel(c.id),p=g<0,m=p?"-":g,S=p?0:g+1,f=l+d*(t+s),x=this.add.container(f,h),k=this.add.rectangle(0,0,t,e,2236962);k.setStrokeStyle(2,6710886),x.add(k);const y=this.add.text(0,-e*.42,c.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:"monospace",fontSize:`${Math.floor(e*.045)}px`,color:c.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});y.setOrigin(.5,.5),x.add(y);const w=t*.5,C=-e*.18,M=this.add.rectangle(0,C,w,w,c.color,.3);M.setStrokeStyle(2,c.color),x.add(M);const B=e*.06,A=this.add.text(0,B,c.name,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.08)}px`,color:"#ffffff",fontStyle:"bold"});if(A.setOrigin(.5,.5),x.add(A),c.subtitle){const _=this.add.text(0,e*.12,c.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#999999"});_.setOrigin(.5,.5),x.add(_)}let b;S>=c.maxLevel?b=`Lv.${m} → MAX`:p?b=`NEW → Lv.${S}`:b=`Lv.${m} → Lv.${S}`;const E=this.add.text(0,e*.2,b,{fontFamily:"monospace",fontSize:`${Math.floor(e*.05)}px`,color:S>=c.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});E.setOrigin(.5,.5),x.add(E);const I=this.add.text(0,e*.32,c.description,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#aaaaaa",wordWrap:{width:t*.85},align:"center"});I.setOrigin(.5,.5),x.add(I);const F=this.add.text(0,e*.42,`[ ${n[d]} ]`,{fontFamily:"monospace",fontSize:`${Math.floor(e*.06)}px`,color:"#ffff00",fontStyle:"bold"});F.setOrigin(.5,.5),x.add(F),k.setInteractive({useHandCursor:!0});const H=d;k.on("pointerover",()=>{this.setSelectedSkill(H)}),k.on("pointerdown",()=>{this.setSelectedSkill(H),this.confirmSkillSelection()}),this.skillPanelContainer.add(x),this.skillOptions.push(x),this.skillCardBgs.push(k)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out!");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isMoving=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,e)=>{e===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,e)=>{t.setScale(e===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:e*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,e){if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`);return}const i=this.skillManager.getPlayerSkill(e);console.log(`Skill upgraded: ${e} -> Lv.${i==null?void 0:i.level}`),this.updateSkillBarDisplay(),(i==null?void 0:i.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const a=this.skillOptions[t];this.tweens.add({targets:a,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel()}})}};o(u,"MAP_SCALE",10),o(u,"BASE_ICON_SIZE",100),o(u,"BASE_ICON_GAP",10),o(u,"BASE_GROUP_GAP",30),o(u,"BASE_BOTTOM_MARGIN",20),o(u,"ACTIVE_SKILLS",4),o(u,"PASSIVE_SKILLS",3),o(u,"BASE_WIDTH",1920),o(u,"CAMERA_DEAD_ZONE",.3),o(u,"BASE_HP",200),o(u,"HP_PER_LEVEL",50),o(u,"BASE_EXP",100),o(u,"EXP_GROWTH_RATE",1.2),o(u,"DAMAGE_UNIT",10),o(u,"HURT_DURATION",200),o(u,"ATTACK_DURATION",150);let K=u;const tt=7,et={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},st={charHeight:tt,chars:et};class it{constructor(){o(this,"font");this.font=st}textToPixels(r,t,e){const s=[],i=r.letterSpacing??1,a=r.color.replace("#",""),l=parseInt(a.substring(0,2),16),h=parseInt(a.substring(2,4),16),n=parseInt(a.substring(4,6),16),d=l<<16|h<<8|n;let c=0;const g=r.text.toUpperCase().split("");for(let k=0;k<g.length;k++){const y=this.font.chars[g[k]];y&&(c+=y.width,k<g.length-1&&(c+=i))}const p=Math.floor(t*r.position.x),m=Math.floor(e*r.position.y),S=p-Math.floor(c/2),f=m-Math.floor(this.font.charHeight/2);let x=S;for(const k of g){const y=this.font.chars[k];if(y){for(let w=0;w<y.pixels.length;w++){const C=y.pixels[w];for(let M=0;M<C.length;M++)if(C[M]==="#"){const B=x+M,A=f+w;B>=0&&B<t&&A>=0&&A<e&&s.push({gridX:B,gridY:A,color:d})}}x+=y.width+i}}return s}processConfig(r,t,e){const s=new Map;for(const i of r.texts){const a=this.textToPixels(i,t,e);s.set(i.id,a)}return s}}const at=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],rt={texts:at},L=class L extends v.Scene{constructor(){super("GridScene");o(this,"cells",[]);o(this,"cols",0);o(this,"rows",0);o(this,"cellWidth",10);o(this,"cellHeight",10);o(this,"gap",1);o(this,"isAnimating",!1);o(this,"isReady",!1);o(this,"textRenderer");o(this,"textPixels",new Map);o(this,"cursorGlowRadius",4);o(this,"glowPhase",0);o(this,"textBreathPhase",0);o(this,"isLoading",!0);o(this,"loadingCells",new Set);o(this,"backgroundImage");o(this,"titleBgm");this.textRenderer=new it}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const e=Math.floor(t.x/(this.cellWidth+this.gap)),s=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(e,s)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const s=this.input.activePointer;s&&this.updateCursorGlow(s.x,s.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),s=e<<16|e<<8|e,i=.5+.5*Math.sin(this.textBreathPhase*3),a=t>.6?i*.8:0,l=new Set;this.cells.forEach(h=>{h.isText&&l.add(`${h.x},${h.y}`)}),this.cells.forEach(h=>{if(h.isText)h.graphics.setFillStyle(s),h.graphics.setAlpha(.95);else{const n=`${h.x-1},${h.y-1}`;l.has(n)&&a>0&&(h.graphics.setFillStyle(8939263),h.graphics.setAlpha(a))}})}updateCursorGlow(t,e){const s=Math.floor(t/(this.cellWidth+this.gap)),i=Math.floor(e/(this.cellHeight+this.gap)),a=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(l=>{const h=l.x-s,n=l.y-i,d=Math.sqrt(h*h+n*n);if(d<=this.cursorGlowRadius){const g=(1-d/this.cursorGlowRadius)*a,p=l.originalColor>>16&255,m=l.originalColor>>8&255,S=l.originalColor&255,f=Math.min(255,Math.floor(p+(255-p)*g)),x=Math.min(255,Math.floor(m+(255-m)*g)),k=Math.min(255,Math.floor(S+(255-S)*g)),y=f<<16|x<<8|k;l.graphics.setFillStyle(y)}else l.graphics.setFillStyle(l.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,e/2,"background");const s=t/this.backgroundImage.width,i=e/this.backgroundImage.height,a=Math.max(s,i);this.backgroundImage.setScale(a),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(i=>{this.cells[i]&&(this.cells[i].originalColor=2236962,this.cells[i].isText=!1,this.cells[i].graphics.setFillStyle(2236962),this.cells[i].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(i=>{const a=i.gridY*this.cols+i.gridX;this.cells[a]&&(this.cells[a].originalColor=i.color,this.cells[a].isText=!0,this.cells[a].graphics.setFillStyle(i.color),this.cells[a].graphics.setAlpha(.95),this.loadingCells.add(a))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const e=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,e.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].graphics.setFillStyle(e.color),this.cells[s].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,s=Math.min(1,t/L.BASE_WIDTH),i=Math.max(L.MIN_CELL_SIZE,Math.floor(L.BASE_CELL_SIZE*s));this.gap=1,this.cellWidth=i,this.cellHeight=i,this.cols=Math.ceil((t+this.gap)/(i+this.gap)),this.rows=Math.ceil((e+this.gap)/(i+this.gap));const a=.05,l=t*(1-a*2),h=e*(1-a*2),n=16/9,d=l/h;let c,g;d>n?(g=h,c=h*n):(c=l,g=l/n);const p=(t-c)/2,m=(e-g)/2;this.registry.set("gameBounds",{x:p,y:m,width:c,height:g}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${i}, gameBounds: ${c.toFixed(0)}x${g.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const s=e*(this.cellWidth+this.gap)+this.cellWidth/2,i=t*(this.cellHeight+this.gap)+this.cellHeight/2,a=this.add.rectangle(s,i,this.cellWidth,this.cellHeight,2236962);a.setAlpha(0),this.cells.push({x:e,y:t,graphics:a,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(rt,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].originalColor=e.color,this.cells[s].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let f=0;f<this.cells.length;f++)t.add(f);const e=20,s=50,i=10,l=Math.floor(200/i),h=3e3;let n=0,d=!1;const c=(f,x)=>x*this.cols+f,g=f=>({x:f%this.cols,y:Math.floor(f/this.cols)}),p=f=>{const x=this.cells[f];x.graphics.setAlpha(1),x.graphics.setFillStyle(16777215),this.tweens.add({targets:x.graphics,fillColor:{from:16777215,to:x.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},m=f=>{const{x,y:k}=g(f),y=l,w=[];for(let B=0;B<=y;B++)w[B]=[];for(let B=-y;B<=y;B++)for(let A=-y;A<=y;A++){const b=x+A,E=k+B;if(b>=0&&b<this.cols&&E>=0&&E<this.rows){const I=Math.sqrt(A*A+B*B),F=Math.floor(I);if(F<=y){const H=c(b,E);w[F].push(H)}}}let C=0;const M=()=>{C>y||(w[C].forEach(B=>{t.has(B)&&(t.delete(B),p(B))}),C++,C<=y&&this.time.delayedCall(i,M))};M()},S=()=>{if(d)return;if(n>=h||t.size===0){this.finishEntry(t),d=!0;return}const f=Array.from(t),x=Math.min(e,f.length);for(let k=0;k<x&&f.length!==0;k++){const y=Math.floor(Math.random()*f.length),w=f[y];f.splice(y,1),t.has(w)&&m(w)}n+=s,t.size>0&&n<h?this.time.delayedCall(s,S):d||(this.finishEntry(t),d=!0)};S()}finishEntry(t){t.forEach(e=>{const s=this.cells[e];s.graphics.setAlpha(.2),s.graphics.setFillStyle(s.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const s=this.cameras.main.width,i=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const a=t*(this.cellWidth+this.gap)+this.cellWidth/2,l=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:a,y:l,radius:0}),this.cells.forEach(g=>{g.graphics.setFillStyle(0),g.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const h=5;let n=0;this.cells.forEach(g=>{const p=g.x-t,m=g.y-e,S=Math.sqrt(p*p+m*m);g.delay=Math.floor(S*h),g.delay>n&&(n=g.delay)});const d=Math.sqrt(Math.max(a,s-a)**2+Math.max(l,i-l)**2)+50,c=n+150;this.tweens.addCounter({from:0,to:d,duration:c,ease:"Linear",onUpdate:g=>{const p=g.getValue()??0;this.registry.events.emit("reveal-update",{x:a,y:l,radius:p})}}),this.cells.forEach(g=>{this.time.delayedCall(g.delay,()=>{g.graphics.setFillStyle(16777215),g.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:p=>{const m=p.getValue()??0;let S,f;m<15?(S=16777215,f=1):m<30?(S=16776960,f=1):m<50?(S=16746496,f=1):m<70?(S=16720384,f=1-(m-50)/50):(S=6684672,f=1-(m-50)/50),g.graphics.setFillStyle(S),g.graphics.setAlpha(Math.max(0,f))},onComplete:()=>{g.graphics.setVisible(!1)}})})}),this.time.delayedCall(n+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};o(L,"BASE_CELL_SIZE",10),o(L,"MIN_CELL_SIZE",4),o(L,"BASE_WIDTH",1920);let W=L,T=null;function ot(){return window.innerWidth>window.innerHeight}function $(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function lt(){if(T)return;const P={type:v.AUTO,width:window.innerWidth,height:$(),parent:"app",backgroundColor:"#111111",scale:{mode:v.Scale.RESIZE,autoCenter:v.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[W,j,K]};T=new v.Game(P),T.events.once("ready",()=>{T&&T.sound&&(T.sound.volume=.5)})}function V(){(window.innerWidth>900||ot())&&lt()}V();window.addEventListener("resize",V);window.addEventListener("orientationchange",()=>{setTimeout(V,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{T&&T.scale.resize(window.innerWidth,$())});document.addEventListener("fullscreenchange",()=>{T&&setTimeout(()=>{T.scale.resize(window.innerWidth,$())},100)});window.addEventListener("volumechange",P=>{T&&T.sound&&(T.sound.volume=P.detail.volume)});
