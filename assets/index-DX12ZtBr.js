var it=Object.defineProperty;var at=(D,c,t)=>c in D?it(D,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):D[c]=t;var h=(D,c,t)=>at(D,typeof c!="symbol"?c+"":c,t);import{P as A}from"./phaser-0RJB29YE.js";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class ot extends A.Scene{constructor(){super("BootScene")}preload(){}create(){const c=this.cameras.main.width,t=this.cameras.main.height;this.add.text(c/2,t/2,"Loading...",{font:"20px monospace",color:"#ffffff"}).setOrigin(.5,.5),this.scene.start("MainScene")}}const Z=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5},{id:"active_coder",name:"編碼者",subtitle:"遊戲先知",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5},{id:"active_vfx",name:"視效師",subtitle:"超級導演",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5},{id:"active_architect",name:"架構師",subtitle:"靈魂統領",description:"產生 30% HP 護盾並反傷攻擊者，護盾消失時回復等值 HP",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5},{id:"passive_titanium_liver",name:"鈦金肝",description:"提升 10% HP 總量，每級再 +10%",type:"passive",color:11189196,maxLevel:5},{id:"passive_sync_rate",name:"精神同步率強化",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5},{id:"passive_retina_module",name:"視網膜增強模組",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10092390,maxLevel:5},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"提升 25% 攻擊、5% 防禦，每級再疊加",type:"passive",color:16737945,maxLevel:5}],U=class U{constructor(){h(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return Z.filter(c=>c.type==="active")}getPassiveSkillDefinitions(){return Z.filter(c=>c.type==="passive")}getPlayerSkill(c){return this.playerSkills.get(c)}getPlayerActiveSkills(){const c=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&c.push(e)});const t=[];for(let e=0;e<4;e++)t.push(c[e]||null);return t}getPlayerPassiveSkills(){const c=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&c.push(e)});const t=[];for(let e=0;e<U.MAX_PASSIVE_SLOTS;e++)t.push(c[e]||null);return t}getOwnedPassiveCount(){let c=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&c++}),c}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=U.MAX_PASSIVE_SLOTS}getSkillLevel(c){const t=this.playerSkills.get(c);return t?t.level:-1}isSkillMaxLevel(c){const t=this.playerSkills.get(c);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(c){const t=Z.find(s=>s.id===c);if(!t)return!1;const e=this.playerSkills.get(c);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(c,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(c=>{const t=this.playerSkills.get(c.id);return!t||t.level<c.maxLevel})}getUpgradeablePassiveSkills(){const c=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return c?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const c=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){const i=this.shuffleArray([...c]);for(let l=0;l<Math.min(3,i.length);l++)e.push(i[l]);return e}const s=this.shuffleArray([...c]);for(let i=0;i<Math.min(2,s.length);i++)e.push(s[i]);const a=this.shuffleArray([...t]);return a.length>0&&e.push(a[0]),e}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(c){for(let t=c.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[c[t],c[e]]=[c[e],c[t]]}return c}static formatLevel(c,t=5){return c<=0?"Lv.0":c>=t?"MAX":`Lv.${c}`}getTitaniumLiverHpBonus(){const c=this.playerSkills.get("passive_titanium_liver");return c?(c.level+1)*.1:0}getSyncRateSpeedBonus(){const c=this.playerSkills.get("passive_sync_rate");return c?(c.level+1)*.1:0}getSyncRateCooldownReduction(){const c=this.playerSkills.get("passive_sync_rate");return c?(c.level+1)*.08:0}getRetinaModuleExpBonus(){const c=this.playerSkills.get("passive_retina_module");return c?(c.level+1)*.3:0}getAiEnhancementDamageBonus(){const c=this.playerSkills.get("passive_ai_enhancement");return c?(c.level+1)*.25:0}getAiEnhancementDefenseBonus(){const c=this.playerSkills.get("passive_ai_enhancement");return c?(c.level+1)*.05:0}calculateFinalMaxHp(c){const t=this.getTitaniumLiverHpBonus();return Math.floor(c*(1+t))}calculateFinalMoveSpeed(c){const t=this.getSyncRateSpeedBonus();return c*(1+t)}calculateFinalCooldown(c){const t=this.getSyncRateCooldownReduction();return c*(1-t)}calculateFinalExp(c){const t=this.getRetinaModuleExpBonus();return Math.floor(c*(1+t))}calculateFinalDamage(c){const t=this.getAiEnhancementDamageBonus();return Math.floor(c*(1+t))}calculateFinalDamageTaken(c){const t=this.getAiEnhancementDefenseBonus();return Math.floor(c*(1-t))}};h(U,"MAX_PASSIVE_SLOTS",3);let V=U;const lt=[{id:"slime",name:"史萊姆",color:6750054,speed:1.5,damage:1,size:.08,hp:30,exp:20}],z=class z{constructor(c,t,e,s,a){h(this,"scene");h(this,"monsters",[]);h(this,"nextMonsterId",0);h(this,"container");h(this,"spawnInterval",2e3);h(this,"lastSpawnTime",0);h(this,"isSpawning",!1);h(this,"gameBounds");h(this,"mapWidth");h(this,"mapHeight");h(this,"playerLevel",0);this.scene=c,this.container=t,this.gameBounds=e,this.mapWidth=s,this.mapHeight=a}setPlayerLevel(c){this.playerLevel=c}calculateMonsterHp(c){return Math.floor(c*Math.pow(z.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(){const c=Math.max(1,this.playerLevel);return z.DAMAGE_UNIT*c}calculateMonsterExp(c){const t=Math.floor(this.playerLevel/5);return c*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(c,t,e,s,a){const i=this.scene.time.now;let l=0;const o=[];if(this.isSpawning&&i-this.lastSpawnTime>=this.spawnInterval){const d=1+Math.floor(this.playerLevel/5);for(let n=0;n<d;n++)this.spawnMonster(t,e,s,a);this.lastSpawnTime=i}const r=this.gameBounds.height*.1,f=this.gameBounds.height*.1;return this.monsters.forEach(d=>{const n=t-d.x,g=e-d.y,m=Math.sqrt(n*n+g*g);if(m>f){const S=d.definition.speed*this.gameBounds.height*.1*c/1e3/m;d.x+=n*S,d.y+=g*S}else i-d.lastDamageTime>=3e3&&(l+=this.calculateMonsterDamage(),d.lastDamageTime=i,o.push(d));this.drawMonster(d,r,s,a)}),{damage:l,hitMonsters:o}}spawnMonster(c,t,e,s){const a=["top","left","right"],i=a[Math.floor(Math.random()*a.length)];let l,o;const r=100,f=e,d=e+this.gameBounds.width,n=s;switch(i){case"top":l=f+Math.random()*this.gameBounds.width,o=n-r;break;case"left":l=f-r,o=n+Math.random()*this.gameBounds.height;break;case"right":l=d+r,o=n+Math.random()*this.gameBounds.height;break}l=Phaser.Math.Clamp(l,0,this.mapWidth),o=Phaser.Math.Clamp(o,0,this.mapHeight);const g=lt[0],m=this.scene.add.graphics(),u=this.calculateMonsterHp(g.hp),p={id:this.nextMonsterId++,definition:g,x:l,y:o,hp:u,graphics:m,lastDamageTime:0};this.monsters.push(p),this.container.add(m)}drawMonster(c,t,e,s){const a=c.graphics;a.clear();const i=c.x,l=c.y;a.fillStyle(c.definition.color,.8),a.fillCircle(i,l-t/2,t/2),a.fillStyle(0,1),a.fillCircle(i-t*.15,l-t*.6,t*.08),a.fillCircle(i+t*.15,l-t*.6,t*.08)}removeMonster(c){const t=this.monsters.findIndex(e=>e.id===c);t!==-1&&(this.monsters[t].graphics.destroy(),this.monsters.splice(t,1))}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters.forEach(c=>{c.graphics.destroy()}),this.monsters=[]}setSpawnInterval(c){this.spawnInterval=c}damageMonster(c,t){const e=this.monsters.find(s=>s.id===c);if(!e)return{killed:!1,exp:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const s=this.calculateMonsterExp(e.definition.exp);return this.removeMonster(c),{killed:!0,exp:s}}return{killed:!1,exp:0}}flashMonster(c){const t=c.definition.color,e=c.graphics,s=this.gameBounds.height*.1;e.clear(),e.fillStyle(16777215,1),e.fillCircle(c.x,c.y-s/2,s/2),this.scene.time.delayedCall(50,()=>{c.hp>0&&(e.clear(),e.fillStyle(t,.8),e.fillCircle(c.x,c.y-s/2,s/2),e.fillStyle(0,1),e.fillCircle(c.x-s*.15,c.y-s*.6,s*.08),e.fillCircle(c.x+s*.15,c.y-s*.6,s*.08))})}damageMonsters(c,t){let e=0,s=0;for(const a of c){const i=this.damageMonster(a,t);i.killed&&(e+=i.exp,s++)}return{totalExp:e,killCount:s}}};h(z,"HP_GROWTH_RATE",1.1),h(z,"DAMAGE_UNIT",10);let J=z;const M=class M extends A.Scene{constructor(){super("MainScene");h(this,"character");h(this,"characterState","idle");h(this,"facingRight",!0);h(this,"skillIcons",[]);h(this,"gameBounds");h(this,"boundsBorder");h(this,"background");h(this,"gameAreaContainer");h(this,"revealMask");h(this,"mapWidth");h(this,"mapHeight");h(this,"characterX");h(this,"characterY");h(this,"characterSize");h(this,"isMoving",!1);h(this,"isPointerDown",!1);h(this,"targetX");h(this,"targetY");h(this,"baseMoveSpeed",0);h(this,"moveSpeed",0);h(this,"floorGrid");h(this,"worldContainer");h(this,"uiContainer");h(this,"cameraOffsetX",0);h(this,"cameraOffsetY",0);h(this,"cursors");h(this,"isKeyboardMoving",!1);h(this,"skillPanelContainer");h(this,"isPaused",!1);h(this,"skillOptions",[]);h(this,"skillCardBgs",[]);h(this,"selectedSkillIndex",0);h(this,"currentSkillChoices",[]);h(this,"skillManager",new V);h(this,"skillIconContainers",[]);h(this,"skillLevelTexts",[]);h(this,"skillInfoPanel");h(this,"skillInfoBg");h(this,"skillInfoText");h(this,"skillInfoHideTimer");h(this,"currentExp",0);h(this,"maxExp",100);h(this,"currentLevel",0);h(this,"expBarContainer");h(this,"expBarFill");h(this,"expBarFlowOffset",0);h(this,"levelText");h(this,"currentHp",200);h(this,"maxHp",200);h(this,"hpBarContainer");h(this,"hpBarFill");h(this,"hpBarFlowOffset",0);h(this,"hpText");h(this,"currentShield",0);h(this,"maxShield",0);h(this,"shieldBarFill");h(this,"shieldBarFlowOffset",0);h(this,"shieldReflectDamage",0);h(this,"shieldText");h(this,"keyPlus");h(this,"keyMinus");h(this,"keyShift");h(this,"keyCtrl");h(this,"keyZero");h(this,"keyBackspace");h(this,"keyF5");h(this,"keyF6");h(this,"keyF7");h(this,"keyF8");h(this,"keyF9");h(this,"keyF10");h(this,"keyF11");h(this,"keyF12");h(this,"showLegacySkillEffects",!1);h(this,"monsterManager");h(this,"isHurt",!1);h(this,"hurtEndTime",0);h(this,"lowHpVignette");h(this,"skillCooldowns",new Map);h(this,"isAttacking",!1);h(this,"attackEndTime",0);h(this,"gameBgm");h(this,"currentBgmKey","");h(this,"skillGridContainer");h(this,"skillGridCells",[]);h(this,"skillGridCols",0);h(this,"skillGridRows",0);h(this,"skillGridCellSize",10)}create(){this.cameras.main.setBackgroundColor("#111111");const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const o=t*.9,r=e*(1-.05*2),f=16/9,d=o/r;let n,g;d>f?(g=r,n=r*f):(n=o,g=o/f),this.gameBounds={x:(t-n)/2,y:(e-g)/2,width:n,height:g}}this.mapWidth=this.gameBounds.width*M.MAP_SCALE,this.mapHeight=this.gameBounds.height*M.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.worldContainer.add(this.character),this.monsterManager=new J(this,this.worldContainer,this.gameBounds,this.mapWidth,this.mapHeight),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const s=this.make.graphics({x:0,y:0});s.fillStyle(16777215),s.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const a=s.createGeometryMask();this.worldContainer.setMask(a),this.uiContainer=this.add.container(0,0),this.createSkillGrid(),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const i=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(i),this.uiContainer.setMask(i),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(A.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createLowHpVignette()}update(t,e){if(this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const s=this.time.now;this.isHurt&&s>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&s>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isMoving||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isMoving&&!this.isKeyboardMoving&&this.moveCharacter(e));const a=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);a.damage>0&&this.takeDamage(a.damage,a.hitMonsters),this.updateSkillRangePreview(s),this.tryActivateSkills(s)}updateSkillRangePreview(t){if(this.clearSkillGrid(),this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const l=this.skillManager.calculateFinalCooldown(i),o=this.skillCooldowns.get(a.id)||0;t-o>=l&&this.showSkillPreview(s)}}showSkillPreview(t){const e=t.definition,s=e.color,a=.2;switch(e.id){case"active_soul_render":{const i=this.monsterManager.getMonsters();if(i.length===0)return;let l=0,o=1/0;for(const n of i){const g=n.x-this.characterX,m=n.y-this.characterY,u=Math.sqrt(g*g+m*m);u<o&&(o=u,l=Math.atan2(m,g))}const r=this.gameBounds.height*.3,d=(60+t.level*10)/2*(Math.PI/180);this.showSkillRangeSector(this.characterX,this.characterY,r,l,d,s,a);break}case"active_coder":{const i=this.gameBounds.height*.1,l=2+t.level*.5,o=i*l;this.showSkillRangeCircle(this.characterX,this.characterY,o,s,a);break}case"active_vfx":{const i=this.monsterManager.getMonsters();if(i.length===0)return;const l=Math.min(t.level+1,i.length),o=this.gameBounds.height*1,r=this.gameBounds.height*.05,f=[...i].sort((d,n)=>{const g=Math.sqrt((d.x-this.characterX)**2+(d.y-this.characterY)**2),m=Math.sqrt((n.x-this.characterX)**2+(n.y-this.characterY)**2);return g-m});for(let d=0;d<l;d++){const n=f[d],g=n.x-this.characterX,m=n.y-this.characterY,u=Math.sqrt(g*g+m*m);if(u>0){const p=this.characterX+g/u*o,S=this.characterY+m/u*o;this.showSkillRangeLine(this.characterX,this.characterY,p,S,r,s,a)}}break}case"active_architect":{const i=this.gameBounds.height*.15;this.showSkillRangeCircle(this.characterX,this.characterY,i,s,a);break}}}tryActivateSkills(t){if(this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const l=this.skillManager.calculateFinalCooldown(i),o=this.skillCooldowns.get(a.id)||0;t-o>=l&&(this.activateSkill(s,t),this.skillCooldowns.set(a.id,t))}}activateSkill(t,e){const s=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+M.ATTACK_DURATION,this.setCharacterState("attack",!0),s.flashColor&&this.character.setTint(s.flashColor),s.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${s.name}`)}}activateSoulRender(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let s=e[0],a=1/0;for(const m of e){const u=m.x-this.characterX,p=m.y-this.characterY,S=Math.sqrt(u*u+p*p);S<a&&(a=S,s=m)}const i=Math.atan2(s.y-this.characterY,s.x-this.characterX);this.facingRight=Math.cos(i)>=0,this.updateCharacterSprite();const l=this.gameBounds.height*.3,r=(60+t.level*10)/2*(Math.PI/180),f=2+t.level,d=M.DAMAGE_UNIT*f,n=this.skillManager.calculateFinalDamage(d),g=[];for(const m of e){const u=m.x-this.characterX,p=m.y-this.characterY;if(Math.sqrt(u*u+p*p)>l)continue;let x=Math.atan2(p,u)-i;for(;x>Math.PI;)x-=Math.PI*2;for(;x<-Math.PI;)x+=Math.PI*2;Math.abs(x)<=r&&g.push(m.id)}if(this.showLegacySkillEffects&&this.drawSectorEffect(i,l,r,t.definition.color),g.length>0){const m=e.filter(p=>g.includes(p.id)).map(p=>({x:p.x,y:p.y})),u=this.monsterManager.damageMonsters(g,n);u.totalExp>0&&this.addExp(u.totalExp),this.flashGridAtPositions(m,t.definition.flashColor||t.definition.color,2),this.showLegacySkillEffects&&this.drawCrossStarBurst(m,t.definition.flashColor||t.definition.color),this.shakeScreen(g.length),console.log(`Soul Render hit ${g.length} monsters for ${n} damage, killed ${u.killCount}, exp +${u.totalExp}`)}}drawSectorEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=t-s,o=t+s,r=this.characterX,f=this.characterY,d=15,n=1e3,g=this.time.now,m=()=>{const p=this.time.now-g,S=Math.min(p/n,1);i.clear();const y=.3,x=S<y?0:(S-y)/(1-y);for(let C=d;C>=1;C--){const w=e*C/d,I=.8*(1-(C-1)/d)*(1-x);I>.01&&(i.fillStyle(a,I),i.beginPath(),i.moveTo(r,f),i.arc(r,f,w,l,o,!1),i.closePath(),i.fillPath())}const k=8;for(let C=k;C>=1;C--){const w=e*.6*C/k,B=.95*(1-(C-1)/k)*(1-x);B>.01&&(i.fillStyle(16777215,B),i.beginPath(),i.moveTo(r,f),i.arc(r,f,w,l,o,!1),i.closePath(),i.fillPath())}const v=1*(1-x);v>.01&&(i.lineStyle(6,a,v),i.beginPath(),i.moveTo(r,f),i.arc(r,f,e,l,o,!1),i.closePath(),i.strokePath(),i.lineStyle(3,16777215,v*.8),i.beginPath(),i.moveTo(r,f),i.arc(r,f,e*.97,l,o,!1),i.closePath(),i.strokePath(),i.lineStyle(4,16777215,v*.9),i.beginPath(),i.moveTo(r,f),i.lineTo(r+Math.cos(t)*e,f+Math.sin(t)*e),i.strokePath()),S>=1&&i.destroy()},u=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{i.active&&i.destroy(),u.remove()})}activateCoder(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=this.gameBounds.height*.1,a=2+t.level*.5,i=s*a,l=1+t.level,o=M.DAMAGE_UNIT*l,r=this.skillManager.calculateFinalDamage(o),f=[];for(const d of e){const n=d.x-this.characterX,g=d.y-this.characterY;Math.sqrt(n*n+g*g)<=i&&f.push(d.id)}if(this.showLegacySkillEffects&&this.drawCircleEffect(i,t.definition.color),f.length>0){const d=e.filter(g=>f.includes(g.id)).map(g=>({x:g.x,y:g.y})),n=this.monsterManager.damageMonsters(f,r);n.totalExp>0&&this.addExp(n.totalExp),this.flashGridAtPositions(d,t.definition.flashColor||t.definition.color,2),this.showLegacySkillEffects&&this.drawCrossStarBurst(d,t.definition.flashColor||t.definition.color),this.shakeScreen(f.length),console.log(`Coder hit ${f.length} monsters for ${r} damage, killed ${n.killCount}, exp +${n.totalExp}`)}}drawCircleEffect(t,e){const s=this.add.graphics();this.worldContainer.add(s);const a=this.characterX,i=this.characterY,l=15,o=1e3,r=this.time.now,f=()=>{const n=this.time.now-r,g=Math.min(n/o,1);s.clear();const m=.3,u=g<m?0:(g-m)/(1-m);for(let y=l;y>=1;y--){const x=t*y/l,k=t*(y-1)/l,C=.7*(1-(y-1)/l)*(1-u);C>.01&&(s.fillStyle(e,C),s.beginPath(),s.arc(a,i,x,0,Math.PI*2,!1),k>0&&s.arc(a,i,k,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const p=8;for(let y=p;y>=1;y--){const x=t*.5*y/p,k=t*.5*(y-1)/p,v=.95*(1-(y-1)/p)*(1-u);v>.01&&(s.fillStyle(16777215,v),s.beginPath(),s.arc(a,i,x,0,Math.PI*2,!1),k>0&&s.arc(a,i,k,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const S=1*(1-u);S>.01&&(s.lineStyle(6,e,S),s.strokeCircle(a,i,t),s.lineStyle(3,16777215,S*.8),s.strokeCircle(a,i,t*.96),s.lineStyle(2,16777215,S*.5),s.strokeCircle(a,i,t*.7),s.strokeCircle(a,i,t*.4)),g>=1&&s.destroy()},d=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{s.active&&s.destroy(),d.remove()})}activateVfx(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=t.level+1,a=this.gameBounds.height*1,i=this.gameBounds.height*.05,l=1+t.level,o=M.DAMAGE_UNIT*l,r=this.skillManager.calculateFinalDamage(o),f=new Set,d=e.map((m,u)=>u),n=[];for(let m=0;m<s;m++){let u;if(d.length>0){const p=Math.floor(Math.random()*d.length),S=d[p];d.splice(p,1);const y=e[S];u=Math.atan2(y.y-this.characterY,y.x-this.characterX)}else u=Math.random()*Math.PI*2;n.push(u);for(const p of e){const S=p.x-this.characterX,y=p.y-this.characterY;if(Math.sqrt(S*S+y*y)>a)continue;const k=Math.cos(u),v=Math.sin(u);if(S*k+y*v<0)continue;Math.abs(S*v-y*k)<=i/2&&f.add(p.id)}this.showLegacySkillEffects&&this.drawBeamEffect(u,a,i,t.definition.color)}n.length>0&&(this.facingRight=Math.cos(n[0])>=0,this.updateCharacterSprite());const g=Array.from(f);if(g.length>0){const m=e.filter(p=>g.includes(p.id)).map(p=>({x:p.x,y:p.y})),u=this.monsterManager.damageMonsters(g,r);u.totalExp>0&&this.addExp(u.totalExp),this.flashGridAtPositions(m,t.definition.flashColor||t.definition.color,2),this.showLegacySkillEffects&&this.drawCrossStarBurst(m,t.definition.flashColor||t.definition.color),this.shakeScreen(g.length),console.log(`VFX (${s} beams) hit ${g.length} monsters for ${r} damage, killed ${u.killCount}, exp +${u.totalExp}`)}}drawBeamEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=this.characterX,o=this.characterY,r=l+Math.cos(t)*e,f=o+Math.sin(t)*e,d=s*1.5,n=Math.sin(t)*d/2,g=-Math.cos(t)*d/2,m=Math.sin(t)*d*.4/2,u=-Math.cos(t)*d*.4/2,p=15,S=1e3,y=this.time.now,x=()=>{const v=this.time.now-y,C=Math.min(v/S,1);i.clear();const w=.3,B=C<w?0:(C-w)/(1-w);for(let P=0;P<p;P++){const b=P/p,L=(P+1)/p,E=l+(r-l)*b,H=o+(f-o)*b,R=l+(r-l)*L,F=o+(f-o)*L,O=.85*(1-b*.6)*(1-B);O>.01&&(i.fillStyle(a,O),i.beginPath(),i.moveTo(E-n,H-g),i.lineTo(R-n,F-g),i.lineTo(R+n,F+g),i.lineTo(E+n,H+g),i.closePath(),i.fillPath())}for(let P=0;P<p;P++){const b=P/p,L=(P+1)/p,E=l+(r-l)*b,H=o+(f-o)*b,R=l+(r-l)*L,F=o+(f-o)*L,G=.98*(1-b*.5)*(1-B);G>.01&&(i.fillStyle(16777215,G),i.beginPath(),i.moveTo(E-m,H-u),i.lineTo(R-m,F-u),i.lineTo(R+m,F+u),i.lineTo(E+m,H+u),i.closePath(),i.fillPath())}const I=1*(1-B);I>.01&&(i.lineStyle(6,16777215,I),i.beginPath(),i.moveTo(l,o),i.lineTo(r,f),i.strokePath());const T=1*(1-B);T>.01&&(i.lineStyle(4,a,T),i.beginPath(),i.moveTo(l-n,o-g),i.lineTo(r-n,f-g),i.lineTo(r+n,f+g),i.lineTo(l+n,o+g),i.closePath(),i.strokePath(),i.lineStyle(2,16777215,T*.6),i.beginPath(),i.moveTo(l-n*1.1,o-g*1.1),i.lineTo(r-n*1.1,f-g*1.1),i.lineTo(r+n*1.1,f+g*1.1),i.lineTo(l+n*1.1,o+g*1.1),i.closePath(),i.strokePath()),C>=1&&i.destroy()},k=this.time.addEvent({delay:16,callback:x,callbackScope:this,repeat:Math.ceil(S/16)});this.time.delayedCall(S+50,()=>{i.active&&i.destroy(),k.remove()})}drawCrossStarBurst(t,e){const a=this.gameBounds.height*.1*1,i=600;for(const l of t){const o=this.add.graphics();this.worldContainer.add(o);const r=this.time.now,f=()=>{const n=this.time.now-r,g=Math.min(n/i,1);o.clear();const m=g<.2?g/.2:1,u=g<.4?0:(g-.4)/.6,p=a*m,S=1-u;if(S>.01&&p>0){const y=p*.2,x=p,k=p*.4;o.fillStyle(16777215,S),o.fillCircle(l.x,l.y,k);for(let w=0;w<4;w++){const B=w*Math.PI/2,I=Math.cos(B),T=Math.sin(B),P=-T,b=I,L=6;for(let E=0;E<L;E++){const H=E/L,R=(E+1)/L,F=y*(1-H*.8),G=y*(1-R*.8),O=l.x+I*x*H,X=l.y+T*x*H,$=l.x+I*x*R,Y=l.y+T*x*R,K=S*(1-H*.7);o.fillStyle(e,K*.8),o.beginPath(),o.moveTo(O+P*F,X+b*F),o.lineTo($+P*G,Y+b*G),o.lineTo($-P*G,Y-b*G),o.lineTo(O-P*F,X-b*F),o.closePath(),o.fillPath();const N=F*.5,q=G*.5;o.fillStyle(16777215,K*.9),o.beginPath(),o.moveTo(O+P*N,X+b*N),o.lineTo($+P*q,Y+b*q),o.lineTo($-P*q,Y-b*q),o.lineTo(O-P*N,X-b*N),o.closePath(),o.fillPath()}}const v=x*.5,C=y*.6;for(let w=0;w<4;w++){const B=w*Math.PI/2+Math.PI/4,I=Math.cos(B),T=Math.sin(B),P=-T,b=I,L=4;for(let E=0;E<L;E++){const H=E/L,R=(E+1)/L,F=C*(1-H*.9),G=C*(1-R*.9),O=l.x+I*v*H,X=l.y+T*v*H,$=l.x+I*v*R,Y=l.y+T*v*R,K=S*(1-H*.8)*.7;o.fillStyle(e,K),o.beginPath(),o.moveTo(O+P*F,X+b*F),o.lineTo($+P*G,Y+b*G),o.lineTo($-P*G,Y-b*G),o.lineTo(O-P*F,X-b*F),o.closePath(),o.fillPath()}}}g>=1&&o.destroy()};f();const d=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(i/16)});this.time.delayedCall(i+50,()=>{o.active&&o.destroy(),d.remove()})}}activateArchitect(t){const e=Math.floor(this.maxHp*.3);this.currentShield=e,this.maxShield=e;const s=1+t.level*1.5;this.shieldReflectDamage=M.DAMAGE_UNIT*s,this.drawShieldBarFill(),this.showLegacySkillEffects&&this.drawShieldActivateEffect(),console.log(`Architect activated: Shield ${e}, Reflect damage ${this.shieldReflectDamage} (${s} units)`)}drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1.2,i=16763904,l=800,o=this.time.now,r=()=>{const d=this.time.now-o,n=Math.min(d/l,1);t.clear();const g=n<.2?n/.2:1,m=n<.2?0:(n-.2)/.8,u=a*(.3+.7*g),p=1-m;if(p>.01){for(let k=8;k>=1;k--){const v=u*k/8,C=p*(1-(k-1)/8)*.6;C>.01&&(t.fillStyle(i,C),t.fillCircle(e,s,v))}const y=4;for(let k=y;k>=1;k--){const v=u*.4*k/y,C=p*(1-(k-1)/y)*.9;C>.01&&(t.fillStyle(16777215,C),t.fillCircle(e,s,v))}t.lineStyle(5,i,p*.9),t.strokeCircle(e,s,u),t.lineStyle(2,16777215,p*.7),t.strokeCircle(e,s,u*.95);const x=u*.7;t.lineStyle(3,16777215,p*.5),t.beginPath();for(let k=0;k<6;k++){const v=k*Math.PI/3,C=e+Math.cos(v)*x,w=s+Math.sin(v)*x;k===0?t.moveTo(C,w):t.lineTo(C,w)}t.closePath(),t.strokePath()}n>=1&&t.destroy()};r();const f=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),f.remove()})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&A.Input.Keyboard.JustDown(this.keyBackspace)){this.showLegacySkillEffects=!this.showLegacySkillEffects,console.log(`Legacy skill effects: ${this.showLegacySkillEffects?"ON":"OFF"}`);return}if(this.keyShift.isDown&&A.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:s}of t)if(e&&A.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(s);return}}if(this.keyShift.isDown&&A.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=Z.find(o=>o.id===t);if(!e)return;const s=this.skillManager.getSkillLevel(t),a=e.type==="passive";if(s>=e.maxLevel){console.log(`Test: ${e.name} is already MAX`);return}if(a&&s<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${e.name}`);return}const i=s<0?-1:s,l=e.maxLevel-i;this.currentLevel+=l,this.monsterManager.setPlayerLevel(this.currentLevel);for(let o=0;o<l;o++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(M.BASE_EXP*Math.pow(M.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${e.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const s of e)for(let a=0;a<=s.maxLevel;a++)this.skillManager.learnOrUpgradeSkill(s.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(M.BASE_EXP*Math.pow(M.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(M.BASE_EXP*Math.pow(M.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=M.BASE_HP+M.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const s=this.currentHp/e;this.currentHp=Math.floor(this.maxHp*s)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(A.Input.Keyboard.JustDown(this.cursors.A)&&this.setSelectedSkill(0),A.Input.Keyboard.JustDown(this.cursors.S)&&this.setSelectedSkill(1),A.Input.Keyboard.JustDown(this.cursors.D)&&this.setSelectedSkill(2),A.Input.Keyboard.JustDown(this.cursors.W)&&this.confirmSkillSelection())}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,e){const s=this.skillCardBgs[t],a=this.skillOptions[t];!s||!a||(e?(s.setFillStyle(3355443),s.setStrokeStyle(3,16777215),this.tweens.add({targets:a,scaleX:1.05,scaleY:1.05,duration:100})):(s.setFillStyle(2236962),s.setStrokeStyle(2,6710886),this.tweens.add({targets:a,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let e=0,s=0;if(this.cursors.W.isDown&&(s=-1),this.cursors.S.isDown&&(s=1),this.cursors.A.isDown&&(e=-1),this.cursors.D.isDown&&(e=1),e!==0||s!==0){if(this.isKeyboardMoving=!0,this.isMoving=!1,e!==0&&(this.facingRight=e>0),e!==0&&s!==0){const i=1/Math.sqrt(2);e*=i,s*=i}const a=this.moveSpeed*t/1e3;this.characterX+=e*a,this.characterY+=s*a,this.characterX=A.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=A.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateTargetFromPointer(t),this.isMoving=!0)}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateTargetFromPointer(t)}onPointerUp(){this.isPointerDown=!1}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateTargetFromPointer(t){const e=t.x-this.gameBounds.x,s=t.y-this.gameBounds.y,a=e+this.cameraOffsetX,i=s+this.cameraOffsetY;this.targetX=A.Math.Clamp(a,this.characterSize,this.mapWidth-this.characterSize),this.targetY=A.Math.Clamp(i,this.characterSize,this.mapHeight-this.characterSize)}moveCharacter(t){const e=this.targetX-this.characterX,s=this.targetY-this.characterY,a=Math.sqrt(e*e+s*s);if(this.updateCharacterFacing(this.targetX),a<5)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const i=this.moveSpeed*t/1e3;if(i>=a)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const l=i/a;this.characterX+=e*l,this.characterY+=s*l,this.setCharacterState("run")}}this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,s=this.cameraOffsetY+this.gameBounds.height/2,a=this.characterX-e,i=this.characterY-s,l=this.gameBounds.width*M.CAMERA_DEAD_ZONE,o=this.gameBounds.height*M.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(a)>l/2&&(a>0?this.cameraOffsetX+=a-l/2:this.cameraOffsetX+=a+l/2),Math.abs(i)>o/2&&(i>0?this.cameraOffsetY+=i-o/2:this.cameraOffsetY+=i+o/2)),this.cameraOffsetX=A.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=A.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const s=t.filter(a=>a!==this.currentBgmKey);e=s[Math.floor(Math.random()*s.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const s=t/this.background.width,a=e/this.background.height,i=Math.max(s,a);this.background.setScale(i)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(100);const e=this.gameBounds.height*.01*2,s=Math.min(1,this.gameBounds.width/M.BASE_WIDTH),a=Math.max(.4,s),i=Math.floor(M.BASE_ICON_SIZE*a),l=Math.floor(M.BASE_ICON_GAP*a),o=Math.floor(M.BASE_GROUP_GAP*a),r=Math.floor(M.BASE_BOTTOM_MARGIN*a),f=M.ACTIVE_SKILLS,d=M.PASSIVE_SKILLS,n=f*i+(f-1)*l,g=d*i+(d-1)*l,m=n+o+g,u=this.gameBounds.x+(this.gameBounds.width-m)/2,S=this.gameBounds.y+this.gameBounds.height-i-r-e-8,y=this.add.rectangle(u+m/2,S+e/2,m,e,0);y.setStrokeStyle(1,3355443),this.hpBarContainer.add(y),this.hpBarFill=this.add.graphics(),this.hpBarContainer.add(this.hpBarFill);const x=Math.floor(this.gameBounds.height*.03);this.hpText=this.add.text(u+m/2,S+e/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:"monospace",fontSize:`${x}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.hpText.setOrigin(.5,.5),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){this.hpBarFill.clear();const e=this.gameBounds.height*.01*2,s=Math.min(1,this.gameBounds.width/M.BASE_WIDTH),a=Math.max(.4,s),i=Math.floor(M.BASE_ICON_SIZE*a),l=Math.floor(M.BASE_ICON_GAP*a),o=Math.floor(M.BASE_GROUP_GAP*a),r=Math.floor(M.BASE_BOTTOM_MARGIN*a),f=M.ACTIVE_SKILLS,d=M.PASSIVE_SKILLS,n=f*i+(f-1)*l,g=d*i+(d-1)*l,m=n+o+g,u=this.gameBounds.x+(this.gameBounds.width-m)/2,S=this.gameBounds.y+this.gameBounds.height-i-r-e-8,y=this.currentHp/this.maxHp,x=m*y;if(x<=0)return;const k=Math.ceil(x/2)+1;for(let v=0;v<k;v++){const C=u+v*2;if(C>=u+x)break;const w=(C-u)/m,B=this.hpBarFlowOffset,I=(w+B)%1,T=(Math.sin(I*Math.PI*2-Math.PI/2)+1)/2,P=Math.floor(136-34*T),b=Math.floor(0+0*T),L=Math.floor(34+102*T),E=P<<16|b<<8|L;this.hpBarFill.fillStyle(E,1);const H=Math.min(2,u+x-C);this.hpBarFill.fillRect(C,S,H,e)}this.hpBarFill.fillStyle(16777215,.15),this.hpBarFill.fillRect(u,S,x,e*.4)}updateHpBarFlow(t){this.hpBarFlowOffset+=.08*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.drawHpBarFill()}updateHpText(){this.hpText&&this.hpText.setText(`${this.currentHp} / ${this.maxHp}`)}createShieldBar(){this.shieldBarFill=this.add.graphics(),this.shieldBarFill.setDepth(101);const t=Math.floor(this.gameBounds.height*.025);this.shieldText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:`${t}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(.5,.5),this.shieldText.setDepth(102),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldBarFill),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){if(this.shieldBarFill.clear(),this.currentShield<=0){this.shieldText.setVisible(!1);return}const t=this.gameBounds.height*.01,e=t*2,s=t*1.5,a=Math.min(1,this.gameBounds.width/M.BASE_WIDTH),i=Math.max(.4,a),l=Math.floor(M.BASE_ICON_SIZE*i),o=Math.floor(M.BASE_ICON_GAP*i),r=Math.floor(M.BASE_GROUP_GAP*i),f=Math.floor(M.BASE_BOTTOM_MARGIN*i),d=M.ACTIVE_SKILLS,n=M.PASSIVE_SKILLS,g=d*l+(d-1)*o,m=n*l+(n-1)*o,u=g+r+m,p=this.gameBounds.x+(this.gameBounds.width-u)/2,x=this.gameBounds.y+this.gameBounds.height-l-f-e-8-s;if(this.maxShield<=0)return;const k=this.currentShield/this.maxShield,v=u*Math.min(1,k);if(v<=0)return;this.shieldBarFill.fillStyle(0,.8),this.shieldBarFill.fillRect(p,x,u,s),this.shieldBarFill.lineStyle(1,3355443),this.shieldBarFill.strokeRect(p,x,u,s);const C=Math.ceil(v/2)+1;for(let w=0;w<C;w++){const B=p+w*2;if(B>=p+v)break;const I=(B-p)/u,T=this.shieldBarFlowOffset,P=(I+T)%1,b=(Math.sin(P*Math.PI*2-Math.PI/2)+1)/2,L=255,E=Math.floor(204+17*b),H=Math.floor(0+68*b),R=L<<16|E<<8|H;this.shieldBarFill.fillStyle(R,.9);const F=Math.min(2,p+v-B);this.shieldBarFill.fillRect(B,x,F,s)}this.shieldBarFill.fillStyle(16777215,.25),this.shieldBarFill.fillRect(p,x,v,s*.4),this.shieldBarFill.lineStyle(1,16768324,.5),this.shieldBarFill.strokeRect(p,x,v,s),this.shieldText.setText(`${this.currentShield} / ${this.maxShield}`),this.shieldText.setPosition(p+u/2,x+s/2),this.shieldText.setVisible(!0)}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.15;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}takeDamage(t,e=[]){let a=this.skillManager.calculateFinalDamageTaken(t),i=0;if(this.currentShield>0){const l=this.currentShield>0;if(this.currentShield>=a?(i=a,this.currentShield-=a,a=0):(i=this.currentShield,a-=this.currentShield,this.currentShield=0),l&&this.currentShield===0&&this.maxShield>0){const o=this.maxShield;this.currentHp=Math.min(this.currentHp+o,this.maxHp),console.log(`Shield broken! Healed ${o} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette()}if(this.drawShieldBarFill(),i>0&&this.showLegacySkillEffects&&this.flashShieldEffect(),this.shieldReflectDamage>0&&e.length>0){const o=e.map(f=>f.id),r=this.monsterManager.damageMonsters(o,this.shieldReflectDamage);r.totalExp>0&&this.addExp(r.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${e.length} monsters, killed ${r.killCount}`)}}a>0?(this.currentHp-=a,this.currentHp<0&&(this.currentHp=0),this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+M.HURT_DURATION,this.isMoving=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${a} damage (${i} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${i} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&console.log("Player died!")}flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1,i=16768324,l=600;let o=this.time.now;const r=()=>{const d=this.time.now-o,n=Math.min(d/l,1);t.clear();const g=.3,u=1-(n<g?0:(n-g)/(1-g));if(u>.01){for(let y=6;y>=1;y--){const x=a*y/6,k=u*(1-(y-1)/6)*.5;k>.01&&(t.fillStyle(i,k),t.fillCircle(e,s,x))}const S=a*.4;t.fillStyle(16777215,u*.8),t.fillCircle(e,s,S),t.lineStyle(5,i,u*.9),t.strokeCircle(e,s,a),t.lineStyle(2,16777215,u*.7),t.strokeCircle(e,s,a*.95)}n>=1&&t.destroy()},f=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),f.remove()})}flashCharacter(){this.character.setTint(16764108),this.time.delayedCall(50,()=>{this.character.setTint(16737894)}),this.time.delayedCall(100,()=>{this.character.clearTint()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){this.lowHpVignette=this.add.graphics(),this.lowHpVignette.setDepth(1e3),this.lowHpVignette.setAlpha(0),this.uiContainer.add(this.lowHpVignette)}updateLowHpVignette(){this.currentHp/this.maxHp<=.3?(this.drawVignette(),this.tweens.killTweensOf(this.lowHpVignette),this.lowHpVignette.setAlpha(.6),this.tweens.add({targets:this.lowHpVignette,alpha:.3,duration:300,ease:"Sine.easeInOut"})):(this.tweens.killTweensOf(this.lowHpVignette),this.lowHpVignette.setAlpha(0))}drawVignette(){this.lowHpVignette.clear();const t=this.gameBounds.width,e=this.gameBounds.height,s=this.gameBounds.x,a=this.gameBounds.y,i=Math.min(t,e)*.15,l=10;for(let o=0;o<l;o++){const r=o/l,f=(1-r)*.5,d=i*r;this.lowHpVignette.lineStyle(i/l,16711680,f),this.lowHpVignette.strokeRect(s+d,a+d,t-d*2,e-d*2)}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(100);const t=this.gameBounds.height*.01,e=this.gameBounds.width,s=this.gameBounds.x,a=this.gameBounds.y+this.gameBounds.height-t,i=this.add.rectangle(s+e/2,a+t/2,e,t,0);this.expBarContainer.add(i),this.expBarFill=this.add.graphics(),this.expBarContainer.add(this.expBarFill),this.drawExpBarFill();const l=Math.floor(this.gameBounds.height*.03);this.levelText=this.add.text(this.gameBounds.x+10,a-l-5,`Lv.${this.currentLevel}`,{fontFamily:"monospace",fontSize:`${l}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText)}drawExpBarFill(){this.expBarFill.clear();const t=this.gameBounds.height*.01,e=this.gameBounds.width,s=this.gameBounds.x,a=this.gameBounds.y+this.gameBounds.height-t,i=this.currentExp/this.maxExp,l=e*i;if(l<=0)return;const o=Math.ceil(l/2)+1;for(let r=0;r<o;r++){const f=s+r*2;if(f>=s+l)break;const d=(f-s)/e,n=this.expBarFlowOffset,g=(d+n)%1,m=(Math.sin(g*Math.PI*2-Math.PI/2)+1)/2,u=Math.floor(68+68*m),p=Math.floor(136-68*m),y=u<<16|p<<8|255;this.expBarFill.fillStyle(y,1);const x=Math.min(2,s+l-f);this.expBarFill.fillRect(f,a,x,t)}this.expBarFill.fillStyle(16777215,.2),this.expBarFill.fillRect(s,a,l,t*.4)}updateExpBarFlow(t){this.expBarFlowOffset+=.1*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,e=Math.ceil(this.mapWidth/t),s=Math.ceil(this.mapHeight/t);for(let o=0;o<s;o++)for(let r=0;r<e;r++){const f=r*t,d=o*t;(o+r)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(f,d,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(f,d,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const a=this.mapWidth/2,i=this.mapHeight/2,l=t;this.floorGrid.strokeRect(a-l/2,i-l/2,l,l);for(let o=0;o<s;o+=5)for(let r=0;r<e;r+=5){const f=r*t+t/2,d=o*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(f,d,4)}}createSkillBar(){const t=this.gameBounds,e=Math.min(1,t.width/M.BASE_WIDTH),s=Math.max(.4,e),a=Math.floor(M.BASE_ICON_SIZE*s),i=Math.floor(M.BASE_ICON_GAP*s),l=Math.floor(M.BASE_GROUP_GAP*s),o=Math.floor(M.BASE_BOTTOM_MARGIN*s),r=Math.max(1,Math.floor(2*s)),f=M.ACTIVE_SKILLS,d=M.PASSIVE_SKILLS,n=f*a+(f-1)*i,g=d*a+(d-1)*i,m=n+l+g,u=t.x+(t.width-m)/2+a/2,p=t.y+t.height-a/2-o;for(let y=0;y<f;y++){const x=u+y*(a+i),k=this.add.container(x,p),v=this.add.rectangle(0,0,a,a);v.setStrokeStyle(r,16777215),v.setFillStyle(0,0),k.add(v);const C=this.add.rectangle(0,0,a-4,a-4,3355443,0);k.add(C);const w=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${Math.floor(a*.25)}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2});w.setOrigin(.5,.5),k.add(w),this.skillIcons.push(v),this.skillIconContainers.push(k),this.skillLevelTexts.push(w),this.uiContainer.add(k)}const S=u+n+l;for(let y=0;y<d;y++){const x=S+y*(a+i),k=this.add.container(x,p),v=this.add.rectangle(0,0,a,a);v.setStrokeStyle(r,16777215),v.setFillStyle(0,0),k.add(v);const C=this.add.rectangle(0,0,a-4,a-4,3355443,0);k.add(C);const w=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${Math.floor(a*.25)}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2});w.setOrigin(.5,.5),k.add(w),this.skillIcons.push(v),this.skillIconContainers.push(k),this.skillLevelTexts.push(w),this.uiContainer.add(k)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}createSkillInfoPanel(){const t=this.gameBounds,e=200,s=80,a=10,i=t.x+a,l=t.y+t.height-s-a-60;this.skillInfoPanel=this.add.container(i,l),this.skillInfoPanel.setDepth(200),this.skillInfoBg=this.add.rectangle(0,0,e,s,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg),this.skillInfoText=this.add.text(a,a,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff",wordWrap:{width:e-a*2}}),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=M.ACTIVE_SKILLS;for(let e=0;e<this.skillIconContainers.length;e++){const s=this.skillIconContainers[e],a=e<t,i=a?e:e-t;s.setSize(s.getBounds().width,s.getBounds().height),s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this.showSkillInfo(a,i)})}}showSkillInfo(t,e){const a=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[e];if(!a){this.skillInfoPanel.setVisible(!1);return}const i=[];i.push(`【${a.definition.name}】${V.formatLevel(a.level,a.definition.maxLevel)}`),t?this.appendActiveSkillInfo(i,a):this.appendPassiveSkillInfo(i,a),this.skillInfoText.setText(i.join(`
`));const l=this.skillInfoText.getBounds(),o=10;this.skillInfoBg.setSize(Math.max(180,l.width+o*2),l.height+o*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,e){const s=e.level,a=this.skillManager.getAiEnhancementDamageBonus(),i=this.skillManager.getSyncRateCooldownReduction();switch(e.definition.id){case"active_soul_render":{const l=60+s*10,o=2+s,r=M.DAMAGE_UNIT*o,f=Math.floor(r*(1+a)),n=((e.definition.cooldown||1e3)*(1-i)/1e3).toFixed(1);t.push(`扇形角度: ${l}°`),t.push(`傷害: ${f}`),t.push(`冷卻: ${n}s`);break}case"active_coder":{const l=2+s*.5,o=1+s,r=M.DAMAGE_UNIT*o,f=Math.floor(r*(1+a)),n=((e.definition.cooldown||1500)*(1-i)/1e3).toFixed(1);t.push(`範圍: ${l} 單位`),t.push(`傷害: ${f}`),t.push(`冷卻: ${n}s`);break}case"active_vfx":{const l=s+1,o=1+s,r=M.DAMAGE_UNIT*o,f=Math.floor(r*(1+a)),n=((e.definition.cooldown||2500)*(1-i)/1e3).toFixed(1);t.push(`光束數: ${l} 道`),t.push(`傷害: ${f}`),t.push(`冷卻: ${n}s`);break}case"active_architect":{const l=Math.floor(this.maxHp*.3),o=1+s*1.5,r=M.DAMAGE_UNIT*o,d=((e.definition.cooldown||1e4)*(1-i)/1e3).toFixed(1);t.push(`護盾: ${l}`),t.push(`反傷: ${r}`),t.push(`冷卻: ${d}s`);break}}}appendPassiveSkillInfo(t,e){switch(e.definition.id){case"passive_titanium_liver":{const s=this.skillManager.getTitaniumLiverHpBonus();t.push(`HP 加成: +${Math.round(s*100)}%`),t.push(`最大 HP: ${this.maxHp}`);break}case"passive_sync_rate":{const s=this.skillManager.getSyncRateSpeedBonus(),a=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(s*100)}%`),t.push(`冷卻減少: -${Math.round(a*100)}%`);break}case"passive_retina_module":{const s=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(s*100)}%`);break}case"passive_ai_enhancement":{const s=this.skillManager.getAiEnhancementDamageBonus(),a=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(s*100)}%`),t.push(`防禦加成: +${Math.round(a*100)}%`);break}}}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),s=[...t,...e];for(let a=0;a<this.skillIconContainers.length;a++){const i=this.skillIconContainers[a],l=this.skillLevelTexts[a],o=s[a],r=i.list[1];o?(r.setFillStyle(o.definition.color,.5),l.setText(V.formatLevel(o.level,o.definition.maxLevel))):(r.setFillStyle(3355443,0),l.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.07)}px`,color:"#ffffff",fontStyle:"bold"});s.setOrigin(.5,.5),this.skillPanelContainer.add(s);const a=e+this.gameBounds.height*.06,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.025)}px`,color:"#aaaaaa"});i.setOrigin(.5,.5),this.skillPanelContainer.add(i),this.createSkillOptions();const l=this.gameBounds.y+this.gameBounds.height*.92,o=this.add.text(this.gameBounds.x+this.gameBounds.width/2,l,"點選或按 W 確定",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.022)}px`,color:"#666666"});o.setOrigin(.5,.5),this.skillPanelContainer.add(o)}createSkillOptions(){if(this.skillOptions.forEach(f=>f.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,e=this.gameBounds.height*.5,s=this.gameBounds.width*.05,a=this.currentSkillChoices.length,i=t*a+s*(a-1),l=this.gameBounds.x+(this.gameBounds.width-i)/2+t/2,o=this.gameBounds.y+this.gameBounds.height*.55,r=["A","S","D"];for(let f=0;f<this.currentSkillChoices.length;f++){const d=this.currentSkillChoices[f],n=this.skillManager.getSkillLevel(d.id),g=n<0,m=g?"-":n,u=g?0:n+1,p=l+f*(t+s),S=this.add.container(p,o),y=this.add.rectangle(0,0,t,e,2236962);y.setStrokeStyle(2,6710886),S.add(y);const x=this.add.text(0,-e*.42,d.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:"monospace",fontSize:`${Math.floor(e*.045)}px`,color:d.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});x.setOrigin(.5,.5),S.add(x);const k=t*.5,v=-e*.18,C=this.add.rectangle(0,v,k,k,d.color,.3);C.setStrokeStyle(2,d.color),S.add(C);const w=e*.06,B=this.add.text(0,w,d.name,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.08)}px`,color:"#ffffff",fontStyle:"bold"});if(B.setOrigin(.5,.5),S.add(B),d.subtitle){const E=this.add.text(0,e*.12,d.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#999999"});E.setOrigin(.5,.5),S.add(E)}let I;u>=d.maxLevel?I=`Lv.${m} → MAX`:g?I=`NEW → Lv.${u}`:I=`Lv.${m} → Lv.${u}`;const T=this.add.text(0,e*.2,I,{fontFamily:"monospace",fontSize:`${Math.floor(e*.05)}px`,color:u>=d.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});T.setOrigin(.5,.5),S.add(T);const P=this.add.text(0,e*.32,d.description,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#aaaaaa",wordWrap:{width:t*.85},align:"center"});P.setOrigin(.5,.5),S.add(P);const b=this.add.text(0,e*.42,`[ ${r[f]} ]`,{fontFamily:"monospace",fontSize:`${Math.floor(e*.06)}px`,color:"#ffff00",fontStyle:"bold"});b.setOrigin(.5,.5),S.add(b),y.setInteractive({useHandCursor:!0});const L=f;y.on("pointerover",()=>{this.setSelectedSkill(L)}),y.on("pointerdown",()=>{this.setSelectedSkill(L),this.confirmSkillSelection()}),this.skillPanelContainer.add(S),this.skillOptions.push(S),this.skillCardBgs.push(y)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out! Continue leveling for HP growth.");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isMoving=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,e)=>{e===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,e)=>{t.setScale(e===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:e*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,e){if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`);return}const a=this.skillManager.getPlayerSkill(e);console.log(`Skill upgraded: ${e} -> Lv.${a==null?void 0:a.level}`),this.updateSkillBarDisplay(),(a==null?void 0:a.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const i=this.skillOptions[t];this.tweens.add({targets:i,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel()}})}createSkillGrid(){const t=this.cameras.main.width,e=1920,s=10,a=4,i=Math.min(1,t/e);this.skillGridCellSize=Math.max(a,Math.floor(s*i));const l=M.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+l)/(this.skillGridCellSize+l)),this.skillGridRows=Math.ceil((this.gameBounds.height+l)/(this.skillGridCellSize+l)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(50);for(let o=0;o<this.skillGridRows;o++)for(let r=0;r<this.skillGridCols;r++){const f=r*(this.skillGridCellSize+l)+this.skillGridCellSize/2,d=o*(this.skillGridCellSize+l)+this.skillGridCellSize/2,n=this.add.rectangle(f,d,this.skillGridCellSize,this.skillGridCellSize,16777215,0);n.setVisible(!1),this.skillGridCells.push(n),this.skillGridContainer.add(n)}this.uiContainer.add(this.skillGridContainer)}worldToScreen(t,e){return{x:t-this.cameraOffsetX,y:e-this.cameraOffsetY}}showSkillRangeCircle(t,e,s,a,i=.3){const l=this.worldToScreen(t,e),o=l.x,r=l.y,f=M.SKILL_GRID_GAP,d=this.skillGridCellSize+f,n=Math.max(0,Math.floor((o-s)/d)),g=Math.min(this.skillGridCols-1,Math.ceil((o+s)/d)),m=Math.max(0,Math.floor((r-s)/d)),u=Math.min(this.skillGridRows-1,Math.ceil((r+s)/d));for(let p=m;p<=u;p++)for(let S=n;S<=g;S++){const y=S*d+this.skillGridCellSize/2,x=p*d+this.skillGridCellSize/2,k=y-o,v=x-r;if(Math.sqrt(k*k+v*v)<=s){const w=p*this.skillGridCols+S,B=this.skillGridCells[w];B&&(B.setFillStyle(a,i),B.setVisible(!0))}}}showSkillRangeSector(t,e,s,a,i,l,o=.3){const r=this.worldToScreen(t,e),f=r.x,d=r.y,n=M.SKILL_GRID_GAP,g=this.skillGridCellSize+n,m=Math.max(0,Math.floor((f-s)/g)),u=Math.min(this.skillGridCols-1,Math.ceil((f+s)/g)),p=Math.max(0,Math.floor((d-s)/g)),S=Math.min(this.skillGridRows-1,Math.ceil((d+s)/g));for(let y=p;y<=S;y++)for(let x=m;x<=u;x++){const k=x*g+this.skillGridCellSize/2,v=y*g+this.skillGridCellSize/2,C=k-f,w=v-d,B=Math.sqrt(C*C+w*w);if(B<=s&&B>0){const I=Math.atan2(w,C);let T=Math.abs(I-a);if(T>Math.PI&&(T=2*Math.PI-T),T<=i){const P=y*this.skillGridCols+x,b=this.skillGridCells[P];b&&(b.setFillStyle(l,o),b.setVisible(!0))}}}}showSkillRangeLine(t,e,s,a,i,l,o=.3){const r=this.worldToScreen(t,e),f=this.worldToScreen(s,a),d=M.SKILL_GRID_GAP,n=this.skillGridCellSize+d,g=f.x-r.x,m=f.y-r.y,u=Math.sqrt(g*g+m*m);if(u===0)return;const p=g/u,S=m/u,y=-S,x=p,k=i/2,v=[{x:r.x+y*k,y:r.y+x*k},{x:r.x-y*k,y:r.y-x*k},{x:f.x+y*k,y:f.y+x*k},{x:f.x-y*k,y:f.y-x*k}],C=Math.min(...v.map(E=>E.x)),w=Math.max(...v.map(E=>E.x)),B=Math.min(...v.map(E=>E.y)),I=Math.max(...v.map(E=>E.y)),T=Math.max(0,Math.floor(C/n)),P=Math.min(this.skillGridCols-1,Math.ceil(w/n)),b=Math.max(0,Math.floor(B/n)),L=Math.min(this.skillGridRows-1,Math.ceil(I/n));for(let E=b;E<=L;E++)for(let H=T;H<=P;H++){const R=H*n+this.skillGridCellSize/2,F=E*n+this.skillGridCellSize/2,G=Math.max(0,Math.min(1,((R-r.x)*p+(F-r.y)*S)/u)),O=r.x+G*g,X=r.y+G*m;if(Math.sqrt((R-O)**2+(F-X)**2)<=k){const Y=E*this.skillGridCols+H,K=this.skillGridCells[Y];K&&(K.setFillStyle(l,o),K.setVisible(!0))}}}clearSkillGrid(){this.skillGridCells.forEach(t=>{t.setVisible(!1)})}flashGridAt(t,e,s,a=1){const i=this.worldToScreen(t,e),l=M.SKILL_GRID_GAP,o=this.skillGridCellSize+l,r=Math.floor(i.x/o),f=Math.floor(i.y/o),d=600,n=200,g=this.time.now,m=[];for(let S=-a;S<=a;S++)for(let y=-a;y<=a;y++){const x=r+y,k=f+S;if(x<0||x>=this.skillGridCols||k<0||k>=this.skillGridRows)continue;const v=Math.sqrt(S*S+y*y);if(v<=a){const C=k*this.skillGridCols+x,w=this.skillGridCells[C];w&&m.push({cell:w,dist:v})}}if(m.length===0)return;const u=()=>{const S=this.time.now-g,y=Math.min(S/d,1);let x=0;S>n&&(x=(S-n)/(d-n));for(const{cell:k,dist:v}of m){const C=v/Math.max(a,1),B=(1-C*.4)*(1-x);if(B>.01)if(S<n){const T=(1-C)*.5;if(k.setFillStyle(s,B),k.setVisible(!0),v<a*.5){const P=s>>16&255,b=s>>8&255,L=s&255,E=Math.min(255,P+Math.floor((255-P)*T)),H=Math.min(255,b+Math.floor((255-b)*T)),R=Math.min(255,L+Math.floor((255-L)*T)),F=E<<16|H<<8|R;k.setFillStyle(F,B)}}else k.setFillStyle(s,B),k.setVisible(!0);else k.setVisible(!1)}if(y>=1)for(const{cell:k}of m)k.setVisible(!1),k.setAlpha(1)};u();const p=this.time.addEvent({delay:16,callback:u,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{p.remove();for(const{cell:S}of m)S.setVisible(!1),S.setAlpha(1)})}flashGridAtPositions(t,e,s=1){t.forEach(a=>{this.flashGridAt(a.x,a.y,e,s)})}};h(M,"MAP_SCALE",10),h(M,"BASE_ICON_SIZE",100),h(M,"BASE_ICON_GAP",10),h(M,"BASE_GROUP_GAP",30),h(M,"BASE_BOTTOM_MARGIN",20),h(M,"ACTIVE_SKILLS",4),h(M,"PASSIVE_SKILLS",3),h(M,"BASE_WIDTH",1920),h(M,"CAMERA_DEAD_ZONE",.3),h(M,"BASE_HP",200),h(M,"HP_PER_LEVEL",50),h(M,"BASE_EXP",100),h(M,"EXP_GROWTH_RATE",1.2),h(M,"DAMAGE_UNIT",10),h(M,"HURT_DURATION",200),h(M,"ATTACK_DURATION",150),h(M,"SKILL_GRID_GAP",1);let j=M;const nt=7,ht={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},rt={charHeight:nt,chars:ht};class ct{constructor(){h(this,"font");this.font=rt}textToPixels(c,t,e){const s=[],a=c.letterSpacing??1,i=c.color.replace("#",""),l=parseInt(i.substring(0,2),16),o=parseInt(i.substring(2,4),16),r=parseInt(i.substring(4,6),16),f=l<<16|o<<8|r;let d=0;const n=c.text.toUpperCase().split("");for(let y=0;y<n.length;y++){const x=this.font.chars[n[y]];x&&(d+=x.width,y<n.length-1&&(d+=a))}const g=Math.floor(t*c.position.x),m=Math.floor(e*c.position.y),u=g-Math.floor(d/2),p=m-Math.floor(this.font.charHeight/2);let S=u;for(const y of n){const x=this.font.chars[y];if(x){for(let k=0;k<x.pixels.length;k++){const v=x.pixels[k];for(let C=0;C<v.length;C++)if(v[C]==="#"){const w=S+C,B=p+k;w>=0&&w<t&&B>=0&&B<e&&s.push({gridX:w,gridY:B,color:f})}}S+=x.width+a}}return s}processConfig(c,t,e){const s=new Map;for(const a of c.texts){const i=this.textToPixels(a,t,e);s.set(a.id,i)}return s}}const dt=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],ft={texts:dt},W=class W extends A.Scene{constructor(){super("GridScene");h(this,"cells",[]);h(this,"cols",0);h(this,"rows",0);h(this,"cellWidth",10);h(this,"cellHeight",10);h(this,"gap",1);h(this,"isAnimating",!1);h(this,"isReady",!1);h(this,"textRenderer");h(this,"textPixels",new Map);h(this,"cursorGlowRadius",4);h(this,"glowPhase",0);h(this,"textBreathPhase",0);h(this,"isLoading",!0);h(this,"loadingCells",new Set);h(this,"backgroundImage");h(this,"titleBgm");this.textRenderer=new ct}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const e=Math.floor(t.x/(this.cellWidth+this.gap)),s=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(e,s)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const s=this.input.activePointer;s&&this.updateCursorGlow(s.x,s.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),s=e<<16|e<<8|e,a=.5+.5*Math.sin(this.textBreathPhase*3),i=t>.6?a*.8:0,l=new Set;this.cells.forEach(o=>{o.isText&&l.add(`${o.x},${o.y}`)}),this.cells.forEach(o=>{if(o.isText)o.graphics.setFillStyle(s),o.graphics.setAlpha(.95);else{const r=`${o.x-1},${o.y-1}`;l.has(r)&&i>0&&(o.graphics.setFillStyle(8939263),o.graphics.setAlpha(i))}})}updateCursorGlow(t,e){const s=Math.floor(t/(this.cellWidth+this.gap)),a=Math.floor(e/(this.cellHeight+this.gap)),i=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(l=>{const o=l.x-s,r=l.y-a,f=Math.sqrt(o*o+r*r);if(f<=this.cursorGlowRadius){const n=(1-f/this.cursorGlowRadius)*i,g=l.originalColor>>16&255,m=l.originalColor>>8&255,u=l.originalColor&255,p=Math.min(255,Math.floor(g+(255-g)*n)),S=Math.min(255,Math.floor(m+(255-m)*n)),y=Math.min(255,Math.floor(u+(255-u)*n)),x=p<<16|S<<8|y;l.graphics.setFillStyle(x)}else l.graphics.setFillStyle(l.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,e/2,"background");const s=t/this.backgroundImage.width,a=e/this.backgroundImage.height,i=Math.max(s,a);this.backgroundImage.setScale(i),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(a=>{this.cells[a]&&(this.cells[a].originalColor=2236962,this.cells[a].isText=!1,this.cells[a].graphics.setFillStyle(2236962),this.cells[a].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(a=>{const i=a.gridY*this.cols+a.gridX;this.cells[i]&&(this.cells[i].originalColor=a.color,this.cells[i].isText=!0,this.cells[i].graphics.setFillStyle(a.color),this.cells[i].graphics.setAlpha(.95),this.loadingCells.add(i))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const e=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,e.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].graphics.setFillStyle(e.color),this.cells[s].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,s=Math.min(1,t/W.BASE_WIDTH),a=Math.max(W.MIN_CELL_SIZE,Math.floor(W.BASE_CELL_SIZE*s));this.gap=1,this.cellWidth=a,this.cellHeight=a,this.cols=Math.ceil((t+this.gap)/(a+this.gap)),this.rows=Math.ceil((e+this.gap)/(a+this.gap));const i=.05,l=t*(1-i*2),o=e*(1-i*2),r=16/9,f=l/o;let d,n;f>r?(n=o,d=o*r):(d=l,n=l/r);const g=(t-d)/2,m=(e-n)/2;this.registry.set("gameBounds",{x:g,y:m,width:d,height:n}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${a}, gameBounds: ${d.toFixed(0)}x${n.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const s=e*(this.cellWidth+this.gap)+this.cellWidth/2,a=t*(this.cellHeight+this.gap)+this.cellHeight/2,i=this.add.rectangle(s,a,this.cellWidth,this.cellHeight,2236962);i.setAlpha(0),this.cells.push({x:e,y:t,graphics:i,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(ft,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].originalColor=e.color,this.cells[s].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let p=0;p<this.cells.length;p++)t.add(p);const e=20,s=50,a=10,l=Math.floor(200/a),o=3e3;let r=0,f=!1;const d=(p,S)=>S*this.cols+p,n=p=>({x:p%this.cols,y:Math.floor(p/this.cols)}),g=p=>{const S=this.cells[p];S.graphics.setAlpha(1),S.graphics.setFillStyle(16777215),this.tweens.add({targets:S.graphics,fillColor:{from:16777215,to:S.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},m=p=>{const{x:S,y}=n(p),x=l,k=[];for(let w=0;w<=x;w++)k[w]=[];for(let w=-x;w<=x;w++)for(let B=-x;B<=x;B++){const I=S+B,T=y+w;if(I>=0&&I<this.cols&&T>=0&&T<this.rows){const P=Math.sqrt(B*B+w*w),b=Math.floor(P);if(b<=x){const L=d(I,T);k[b].push(L)}}}let v=0;const C=()=>{v>x||(k[v].forEach(w=>{t.has(w)&&(t.delete(w),g(w))}),v++,v<=x&&this.time.delayedCall(a,C))};C()},u=()=>{if(f)return;if(r>=o||t.size===0){this.finishEntry(t),f=!0;return}const p=Array.from(t),S=Math.min(e,p.length);for(let y=0;y<S&&p.length!==0;y++){const x=Math.floor(Math.random()*p.length),k=p[x];p.splice(x,1),t.has(k)&&m(k)}r+=s,t.size>0&&r<o?this.time.delayedCall(s,u):f||(this.finishEntry(t),f=!0)};u()}finishEntry(t){t.forEach(e=>{const s=this.cells[e];s.graphics.setAlpha(.2),s.graphics.setFillStyle(s.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const s=this.cameras.main.width,a=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const i=t*(this.cellWidth+this.gap)+this.cellWidth/2,l=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:i,y:l,radius:0}),this.cells.forEach(n=>{n.graphics.setFillStyle(0),n.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const o=5;let r=0;this.cells.forEach(n=>{const g=n.x-t,m=n.y-e,u=Math.sqrt(g*g+m*m);n.delay=Math.floor(u*o),n.delay>r&&(r=n.delay)});const f=Math.sqrt(Math.max(i,s-i)**2+Math.max(l,a-l)**2)+50,d=r+150;this.tweens.addCounter({from:0,to:f,duration:d,ease:"Linear",onUpdate:n=>{const g=n.getValue()??0;this.registry.events.emit("reveal-update",{x:i,y:l,radius:g})}}),this.cells.forEach(n=>{this.time.delayedCall(n.delay,()=>{n.graphics.setFillStyle(16777215),n.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:g=>{const m=g.getValue()??0;let u,p;m<15?(u=16777215,p=1):m<30?(u=16776960,p=1):m<50?(u=16746496,p=1):m<70?(u=16720384,p=1-(m-50)/50):(u=6684672,p=1-(m-50)/50),n.graphics.setFillStyle(u),n.graphics.setAlpha(Math.max(0,p))},onComplete:()=>{n.graphics.setVisible(!1)}})})}),this.time.delayedCall(r+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};h(W,"BASE_CELL_SIZE",10),h(W,"MIN_CELL_SIZE",4),h(W,"BASE_WIDTH",1920);let Q=W;const st=document.getElementById("version-info");st&&(st.textContent="v0.1.0a");let _=null;function gt(){return window.innerWidth>window.innerHeight}function tt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function pt(){if(_)return;const D={type:A.AUTO,width:window.innerWidth,height:tt(),parent:"app",backgroundColor:"#111111",scale:{mode:A.Scale.RESIZE,autoCenter:A.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[Q,ot,j]};_=new A.Game(D),_.events.once("ready",()=>{_&&_.sound&&(_.sound.volume=.5)})}function et(){(window.innerWidth>900||gt())&&pt()}et();window.addEventListener("resize",et);window.addEventListener("orientationchange",()=>{setTimeout(et,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{_&&_.scale.resize(window.innerWidth,tt())});document.addEventListener("fullscreenchange",()=>{_&&setTimeout(()=>{_.scale.resize(window.innerWidth,tt())},100)});window.addEventListener("volumechange",D=>{_&&_.sound&&(_.sound.volume=D.detail.volume)});
