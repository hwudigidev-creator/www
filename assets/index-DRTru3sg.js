var Tt=Object.defineProperty;var Bt=(tt,S,t)=>S in tt?Tt(tt,S,{enumerable:!0,configurable:!0,writable:!0,value:t}):tt[S]=t;var v=(tt,S,t)=>Bt(tt,typeof S!="symbol"?S+"":S,t);import{P as O}from"./phaser-0RJB29YE.js";(function(){const S=document.createElement("link").relList;if(S&&S.supports&&S.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const e of o.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&s(e)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class At extends O.Scene{constructor(){super("BootScene")}preload(){}create(){this.scene.start("MainScene")}}const ft=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5,levelUpMessages:["60° 扇形、2 傷害","70° 扇形、3 傷害","80° 扇形、4 傷害","90° 扇形、5 傷害","100° 扇形、6 傷害","110° 扇形、7 傷害，已達最大等級！"],maxExtraAbility:{name:"穿透",description:"攻擊後 {value} 機率發射扇形波",baseValue:0,perLevel:.004,unit:"%",isPercentage:!0}},{id:"active_coder",name:"遊戲先知",subtitle:"編碼者",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5,levelUpMessages:["2 單位範圍、1 傷害","2.5 單位範圍、2 傷害","3 單位範圍、3 傷害","3.5 單位範圍、4 傷害","4 單位範圍、5 傷害","4.5 單位範圍、6 傷害，已達最大等級！"],maxExtraAbility:{name:"爆發",description:"擊殺時 {value} 機率再發動",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"active_vfx",name:"超級導演",subtitle:"視效師",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5,levelUpMessages:["1 道光束、1 傷害","2 道光束、2 傷害","3 道光束、3 傷害","4 道光束、4 傷害","5 道光束、5 傷害","6 道光束、6 傷害，已達最大等級！"],maxExtraAbility:{name:"連鎖",description:"擊殺時 {value} 機率再發射",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"active_architect",name:"靈魂統領",subtitle:"架構師",description:"產生 30% HP 護盾（霸體）並反傷攻擊者，護盾消失時回復等值 HP",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5,levelUpMessages:["30% HP 護盾、1 反傷","30% HP 護盾、2.5 反傷","30% HP 護盾、4 反傷","30% HP 護盾、5.5 反傷","30% HP 護盾、7 反傷","30% HP 護盾、8.5 反傷，已達最大等級！"],maxExtraAbility:{name:"堅守",description:"護盾覆蓋時 {value} 機率炸開",baseValue:0,perLevel:.01,unit:"%",isPercentage:!0}},{id:"passive_titanium_liver",name:"鈦金肝",description:"提升 10% HP 總量並每 15 秒回復 1% 最大 HP，每級再 +10% HP、回復間隔 -1 秒",type:"passive",color:11189196,maxLevel:5,levelUpMessages:["+10% HP、每 15 秒回血","+20% HP、每 14 秒回血","+30% HP、每 13 秒回血","+40% HP、每 12 秒回血","+50% HP、每 11 秒回血","+60% HP、每 10 秒回血，已達最大等級！"],maxExtraAbility:{name:"不死",description:"抵銷一次死亡，觸發暗影爆炸",baseValue:1,perLevel:0,unit:"次",isPercentage:!1}},{id:"passive_sync_rate",name:"精神同步率強化",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5,levelUpMessages:["+10% 移速、-8% 冷卻","+20% 移速、-16% 冷卻","+30% 移速、-24% 冷卻","+40% 移速、-32% 冷卻","+50% 移速、-40% 冷卻","+60% 移速、-48% 冷卻，已達最大等級！"],maxExtraAbility:{name:"迅捷",description:"閃避機率 +{value}",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"passive_retina_module",name:"視網膜增強模組",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10035763,maxLevel:5,levelUpMessages:["+30% 經驗","+60% 經驗","+90% 經驗","+120% 經驗","+150% 經驗","+180% 經驗，已達最大等級！"],maxExtraAbility:{name:"洞察",description:"暴擊率 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"提升 25% 攻擊、15% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5,levelUpMessages:["+25% 攻擊、+15% 防禦","+50% 攻擊、+30% 防禦","+75% 攻擊、+45% 防禦","+100% 攻擊、+60% 防禦","+125% 攻擊、+75% 防禦","+150% 攻擊、+90% 防禦，已達最大等級！"],maxExtraAbility:{name:"超載",description:"暴擊傷害 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}}],lt=class lt{constructor(){v(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return ft.filter(S=>S.type==="active")}getPassiveSkillDefinitions(){return ft.filter(S=>S.type==="passive")}getPlayerSkill(S){return this.playerSkills.get(S)}getPlayerActiveSkills(){const S=[];this.playerSkills.forEach(s=>{s.definition.type==="active"&&S.push(s)});const t=[];for(let s=0;s<4;s++)t.push(S[s]||null);return t}getPlayerPassiveSkills(){const S=[];this.playerSkills.forEach(s=>{s.definition.type==="passive"&&S.push(s)});const t=[];for(let s=0;s<lt.MAX_PASSIVE_SLOTS;s++)t.push(S[s]||null);return t}getOwnedPassiveCount(){let S=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&S++}),S}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=lt.MAX_PASSIVE_SLOTS}getSkillLevel(S){const t=this.playerSkills.get(S);return t?t.level:-1}isSkillMaxLevel(S){const t=this.playerSkills.get(S);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(S){const t=ft.find(i=>i.id===S);if(!t)return!1;const s=this.playerSkills.get(S);if(s){if(s.level>=t.maxLevel)return!1;s.level++}else this.playerSkills.set(S,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(S=>{const t=this.playerSkills.get(S.id);return!t||t.level<S.maxLevel})}getUpgradeablePassiveSkills(){const S=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const s=this.playerSkills.get(t.id);return S?s&&s.level<t.maxLevel:!s||s.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const S=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),s=[];if(!this.hasAnyActiveSkill()){const e=this.shuffleArray([...S]);for(let l=0;l<Math.min(3,e.length);l++)s.push(e[l]);return s}const i=this.shuffleArray([...S]);for(let e=0;e<Math.min(2,i.length);e++)s.push(i[e]);const o=this.shuffleArray([...t]);return o.length>0&&s.push(o[0]),s}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(S){for(let t=S.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[S[t],S[s]]=[S[s],S[t]]}return S}static formatLevel(S,t=5){return S<=0?"Lv.0":S>=t?"MAX":`Lv.${S}`}getTitaniumLiverHpBonus(){const S=this.playerSkills.get("passive_titanium_liver");return S?(S.level+1)*.1:0}getTitaniumLiverRegenInterval(){const S=this.playerSkills.get("passive_titanium_liver");return S?(15-S.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const S=this.playerSkills.get("passive_sync_rate");return S?(S.level+1)*.1:0}getSyncRateCooldownReduction(){const S=this.playerSkills.get("passive_sync_rate");return S?(S.level+1)*.08:0}getRetinaModuleExpBonus(){const S=this.playerSkills.get("passive_retina_module");return S?(S.level+1)*.3:0}getAiEnhancementDamageBonus(){const S=this.playerSkills.get("passive_ai_enhancement");return S?(S.level+1)*.25:0}getAiEnhancementDefenseBonus(){const S=this.playerSkills.get("passive_ai_enhancement");return S?(S.level+1)*.15:0}calculateFinalMaxHp(S){const t=this.getTitaniumLiverHpBonus();return Math.floor(S*(1+t))}calculateFinalMoveSpeed(S){const t=this.getSyncRateSpeedBonus();return S*(1+t)}calculateFinalCooldown(S){const t=this.getSyncRateCooldownReduction();return S*(1-t)}calculateFinalExp(S){const t=this.getRetinaModuleExpBonus();return Math.floor(S*(1+t))}calculateFinalDamage(S){const t=this.getAiEnhancementDamageBonus();return Math.floor(S*(1+t))}calculateFinalDamageWithCrit(S,t){const s=this.getAiEnhancementDamageBonus();let i=Math.floor(S*(1+s));const o=this.getRetinaModuleCritChance(t);let e=!1;if(o>0&&Math.random()<o){e=!0;const l=1.5,n=this.getAiEnhancementCritDamage(t),a=l+n;i=Math.floor(i*a)}return{damage:i,isCrit:e}}calculateFinalDamageTaken(S){const t=this.getAiEnhancementDefenseBonus();return Math.floor(S*(1-t))}getMaxExtraAbilityValue(S,t){const s=this.playerSkills.get(S);if(!s||s.level<s.definition.maxLevel)return 0;const i=s.definition.maxExtraAbility;return i?i.baseValue+i.perLevel*t:0}getMaxExtraAbilityText(S,t){const s=this.playerSkills.get(S);if(!s||s.level<s.definition.maxLevel)return null;const i=s.definition.maxExtraAbility;if(!i)return null;const o=this.getMaxExtraAbilityValue(S,t),e=i.isPercentage?(o*100).toFixed(1):o.toFixed(1);return`【${i.name}】${i.description.replace("{value}",e+i.unit)}`}getAllMaxExtraAbilities(S){const t=[];return this.playerSkills.forEach((s,i)=>{const o=this.getMaxExtraAbilityText(i,S);o&&t.push({skillId:i,text:o})}),t}getSoulRenderWaveChance(S){return this.getMaxExtraAbilityValue("active_soul_render",S)}getCoderBurstChance(S){return this.getMaxExtraAbilityValue("active_coder",S)}getVfxChainChance(S){return this.getMaxExtraAbilityValue("active_vfx",S)}getArchitectExplosionChance(S){return this.getMaxExtraAbilityValue("active_architect",S)}hasTitaniumLiverRevive(){const S=this.playerSkills.get("passive_titanium_liver");return S?S.level>=S.definition.maxLevel:!1}getSyncRateDodgeChance(S){return this.getMaxExtraAbilityValue("passive_sync_rate",S)}getRetinaModuleCritChance(S){return this.getMaxExtraAbilityValue("passive_retina_module",S)}getAiEnhancementCritDamage(S){return this.getMaxExtraAbilityValue("passive_ai_enhancement",S)}};v(lt,"MAX_PASSIVE_SLOTS",3);let nt=lt;const dt=[{id:"slime",name:"史萊姆",color:6750054,speed:1,damage:1,size:.05,hp:30,exp:20},{id:"boss_slime",name:"BOSS 史萊姆",color:4856427,speed:.6,damage:3,size:.15,hp:30,exp:200},{id:"bat",name:"蝙蝠",color:8930474,speed:8,damage:.5,size:.025,hp:10,exp:5}],st=class st{constructor(S,t,s,i){v(this,"scene");v(this,"monsters",[]);v(this,"nextMonsterId",0);v(this,"clipMask",null);v(this,"spawnInterval",2e3);v(this,"lastSpawnTime",0);v(this,"isSpawning",!1);v(this,"batSwarmInterval",3e4);v(this,"lastBatSwarmTime",0);v(this,"batSwarmCount",8);v(this,"bossSpawnedAtLevels",new Set);v(this,"gameBounds");v(this,"mapWidth");v(this,"mapHeight");v(this,"playerLevel",0);v(this,"gridCellSize",4);v(this,"gridScaleMultiplier",3);v(this,"monsterGridContainer");v(this,"monsterGridCells",[]);v(this,"screenGridCols",0);v(this,"screenGridRows",0);this.scene=S,this.gameBounds=t,this.mapWidth=s,this.mapHeight=i,this.updateGridCellSize(),this.createMonsterGrid()}setPlayerLevel(S){return this.playerLevel=S,S>=10&&S%10===0&&!this.bossSpawnedAtLevels.has(S)?(this.bossSpawnedAtLevels.add(S),!0):!1}spawnBoss(S,t){const s=this.playerLevel,i=dt.find(g=>g.id==="boss_slime");if(!i)return;const o=["top","left","right"],e=o[Math.floor(Math.random()*o.length)];let l,n;const a=150,c=S,h=S+this.gameBounds.width,r=t;switch(e){case"top":l=c+Math.random()*this.gameBounds.width,n=r-a;break;case"left":l=c-a,n=r+Math.random()*this.gameBounds.height;break;case"right":l=h+a,n=r+Math.random()*this.gameBounds.height;break}const y=this.calculateMonsterHp(i.hp)*s,C={id:this.nextMonsterId++,definition:i,x:l,y:n,hp:y,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:1.5+Math.random()*.5,squashStretch:1,flashStartTime:0,isBoss:!0,bossHpMultiplier:s};this.monsters.push(C),console.log(`BOSS Slime spawned at level ${s}! HP: ${y}`)}setGridScaleMultiplier(S){this.gridScaleMultiplier=S,this.updateGridCellSize(),this.recreateMonsterGrid()}updateGridCellSize(){const S=this.scene.cameras.main.width,t=1920,s=20/this.gridScaleMultiplier,i=6/this.gridScaleMultiplier,o=Math.min(1,S/t);this.gridCellSize=Math.max(i,Math.floor(s*o))}setClipMask(S){this.clipMask=S,this.monsterGridContainer&&this.monsterGridContainer.setMask(S)}createMonsterGrid(){this.monsterGridContainer=this.scene.add.container(this.gameBounds.x,this.gameBounds.y),this.monsterGridContainer.setDepth(5),this.clipMask&&this.monsterGridContainer.setMask(this.clipMask),this.screenGridCols=Math.ceil(this.gameBounds.width/this.gridCellSize)+1,this.screenGridRows=Math.ceil(this.gameBounds.height/this.gridCellSize)+1;for(let S=0;S<this.screenGridRows;S++)for(let t=0;t<this.screenGridCols;t++){const s=t*this.gridCellSize,i=S*this.gridCellSize,o=this.scene.add.rectangle(s,i,this.gridCellSize,this.gridCellSize,0,0);o.setOrigin(0,0),o.setVisible(!1),this.monsterGridContainer.add(o),this.monsterGridCells.push({rect:o,screenCol:t,screenRow:S})}}recreateMonsterGrid(){this.monsterGridCells.forEach(S=>S.rect.destroy()),this.monsterGridCells=[],this.monsterGridContainer&&this.monsterGridContainer.destroy(),this.createMonsterGrid()}calculateMonsterHp(S){return Math.floor(S*Math.pow(st.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(S){const t=Math.max(1,this.playerLevel);return st.DAMAGE_UNIT*t*S.definition.damage}calculateMonsterExp(S){const t=Math.floor(this.playerLevel/5);return S*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now,this.lastBatSwarmTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(S,t,s,i,o){const e=this.scene.time.now;let l=0;const n=[];if(this.isSpawning&&e-this.lastSpawnTime>=this.spawnInterval){const h=1+Math.floor(this.playerLevel/5);for(let r=0;r<h;r++)this.spawnMonster(t,s,i,o);this.lastSpawnTime=e}this.isSpawning&&e-this.lastBatSwarmTime>=this.batSwarmInterval&&(this.spawnBatSwarm(i,o),this.lastBatSwarmTime=e);const a=this.gameBounds.height*.1,c=[];return this.monsters.forEach(h=>{if(h.isBat&&h.directionX!==void 0&&h.directionY!==void 0){const y=h.definition.speed*this.gameBounds.height*.1*S/1e3;h.x+=h.directionX*y,h.y+=h.directionY*y;const C=this.gameBounds.height*.3,g=i-C,k=i+this.gameBounds.width+C,u=o-C,p=o+this.gameBounds.height+C;(h.x<g||h.x>k||h.y<u||h.y>p)&&c.push(h.id);const f=t-h.x,w=s-h.y;Math.sqrt(f*f+w*w)<=a&&e-h.lastDamageTime>=3e3&&(l+=this.calculateMonsterDamage(h),h.lastDamageTime=e,n.push(h))}else{const d=t-h.x,y=s-h.y,C=Math.sqrt(d*d+y*y);if(C>a){const u=h.definition.speed*this.gameBounds.height*.1*S/1e3/C;h.x+=d*u,h.y+=y*u}else e-h.lastDamageTime>=3e3&&(l+=this.calculateMonsterDamage(h),h.lastDamageTime=e,n.push(h))}h.bouncePhase+=h.bounceSpeed*S/1e3,h.bouncePhase>Math.PI*2&&(h.bouncePhase-=Math.PI*2);const r=.08;h.squashStretch=1+Math.sin(h.bouncePhase)*r}),c.forEach(h=>{this.monsters=this.monsters.filter(r=>r.id!==h)}),this.renderMonstersToGrid(i,o),{damage:l,hitMonsters:n}}spawnMonster(S,t,s,i){const o=["top","left","right"],e=o[Math.floor(Math.random()*o.length)];let l,n;const a=100,c=s,h=s+this.gameBounds.width,r=i;switch(e){case"top":l=c+Math.random()*this.gameBounds.width,n=r-a;break;case"left":l=c-a,n=r+Math.random()*this.gameBounds.height;break;case"right":l=h+a,n=r+Math.random()*this.gameBounds.height;break}l=Phaser.Math.Clamp(l,0,this.mapWidth),n=Phaser.Math.Clamp(n,0,this.mapHeight);const d=dt[0],y=this.calculateMonsterHp(d.hp),C={id:this.nextMonsterId++,definition:d,x:l,y:n,hp:y,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:3+Math.random()*2,squashStretch:1,flashStartTime:0};this.monsters.push(C)}spawnBatSwarm(S,t){const s=["topLeft","topRight","bottomLeft","bottomRight"],i=s[Math.floor(Math.random()*s.length)],o=S,e=S+this.gameBounds.width,l=t,n=t+this.gameBounds.height,a=this.gameBounds.height*.15;let c,h,r,d;switch(i){case"topLeft":c=o-a,h=l-a,r=e+a*2,d=n+a*2;break;case"topRight":c=e+a,h=l-a,r=o-a*2,d=n+a*2;break;case"bottomLeft":c=o-a,h=n+a,r=e+a*2,d=l-a*2;break;case"bottomRight":default:c=e+a,h=n+a,r=o-a*2,d=l-a*2;break}const y=dt.find(k=>k.id==="bat")||dt[0],C=[],g=this.gameBounds.height*.04;for(let k=0;k<this.batSwarmCount;k++){let u,p,f=0;const w=50;do{const E=Math.random()*Math.PI*2,A=Math.random()*a;if(u=c+Math.cos(E)*A,p=h+Math.sin(E)*A,f++,!C.some(I=>{const R=I.x-u,H=I.y-p;return Math.sqrt(R*R+H*H)<g})||f>=w)break}while(!0);C.push({x:u,y:p});const m=r-u,M=d-p,x=Math.sqrt(m*m+M*M),b=m/x,P=M/x,T={id:this.nextMonsterId++,definition:y,x:u,y:p,hp:st.BAT_FIXED_HP,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:5+Math.random()*3,squashStretch:1,flashStartTime:0,isBat:!0,directionX:b,directionY:P};this.monsters.push(T)}console.log(`Bat swarm spawned from ${i}! Count: ${this.batSwarmCount}`)}renderMonstersToGrid(S,t){const s=this.gridCellSize,i=this.scene.time.now,o=new Map;this.monsters.forEach(e=>{const l=this.gameBounds.height*e.definition.size,n=e.squashStretch,a=1/e.squashStretch,c=e.x-S,h=e.y-t,r=Math.floor(c/s),d=Math.floor(h/s),y=Math.ceil(l/s/2),C=Math.ceil(y*a),g=Math.ceil(y*n),k=e.definition.color;let u=k>>16&255,p=k>>8&255,f=k&255,w=!1;const m=300;if(e.flashStartTime>0){const E=i-e.flashStartTime;if(E<m){w=!0;const A=Math.floor(E/60)%2,B=E<m/2?1:1-(E-m/2)/(m/2);A===0?(u=Math.min(255,Math.floor(u+(255-u)*B)),p=Math.min(255,Math.floor(p+(255-p)*B)),f=Math.min(255,Math.floor(f+(255-f)*B))):(u=Math.min(255,Math.floor(u+(255-u)*B)),p=Math.floor(p*(1-B*.8)),f=Math.floor(f*(1-B*.8)))}else e.flashStartTime=0}if(e.isBat){const A=(Math.sin(e.bouncePhase*3)*.5+.5)*.8-.2,B=Math.max(2,Math.ceil(C*.6)),I=Math.max(2,Math.ceil(g*.8)),R=Math.max(3,Math.ceil(C*3)),H=Math.max(2,Math.ceil(g*1.5)),F=(D,z,$,W)=>{if(D>=0&&D<this.screenGridCols&&z>=0&&z<this.screenGridRows){const N=`${D},${z}`,Z=o.get(N);(!Z||W>Z.alpha)&&o.set(N,{color:$,alpha:W})}},_=u<<16|p<<8|f,L=Math.floor(u*.7)<<16|Math.floor(p*.7)<<8|Math.floor(f*.7),X=Math.floor(u*.5)<<16|Math.floor(p*.5)<<8|Math.floor(f*.5);for(let D=-I;D<=I;D++)for(let z=-B;z<=B;z++){const $=z/B,W=D/I;$*$+W*W<=1&&F(r+z,d+D,_,.95)}const Y=Math.max(1,Math.floor(B*.6)),V=Math.max(1,Math.floor(I*.6));for(let D=0;D<=V;D++){const z=Math.max(1,V-D);for(let $=0;$<z;$++)F(r-Y+$,d-I-D-1,_,.9)}for(let D=0;D<=V;D++){const z=Math.max(1,V-D);for(let $=0;$<z;$++)F(r+Y-$,d-I-D-1,_,.9)}for(let D=1;D<=R;D++){const z=D/R,$=Math.floor(H*z*(1-z*.3)),W=Math.floor(A*z*H),N=-$+W,Z=Math.floor($*.3)+W;for(let q=N;q<=Z;q++){const j=Math.floor(Math.sin(z*Math.PI*2+e.bouncePhase)*.5),J=.85-z*.3,et=q<(N+Z)/2?L:X;F(r-B-D,d+q+j,et,J)}if(D%2===0&&D<R-1){const q=Math.floor((N+Z)/2+W);F(r-B-D,d+q,_,.9)}}for(let D=1;D<=R;D++){const z=D/R,$=Math.floor(H*z*(1-z*.3)),W=Math.floor(A*z*H),N=-$+W,Z=Math.floor($*.3)+W;for(let q=N;q<=Z;q++){const j=Math.floor(Math.sin(z*Math.PI*2+e.bouncePhase)*.5),J=.85-z*.3,et=q<(N+Z)/2?L:X;F(r+B+D,d+q+j,et,J)}if(D%2===0&&D<R-1){const q=Math.floor((N+Z)/2+W);F(r+B+D,d+q,_,.9)}}const K=d-Math.floor(I*.3),U=Math.max(1,Math.floor(B*.4));F(r-U,K,16711680,1),F(r+U,K,16711680,1);return}else{for(let E=-g;E<=0;E++)for(let A=-C;A<=C;A++){const B=A/C,I=E/g,R=B*B+I*I;if(R<=1.1){const F=(.5+(1-Math.pow(Math.min(1,R),.5))*.5)*(R<=1?1:(1.1-R)/.1),_=w?1:1+(1-I)*.4,L=Math.min(255,Math.floor(u*_)),X=Math.min(255,Math.floor(p*_)),Y=Math.min(255,Math.floor(f*_)),V=L<<16|X<<8|Y,K=r+A,U=d+E;if(K>=0&&K<this.screenGridCols&&U>=0&&U<this.screenGridRows){const D=`${K},${U}`,z=o.get(D);(!z||F>z.alpha)&&o.set(D,{color:V,alpha:F})}}}for(let E=-C;E<=C;E++){const A=E/C;if(Math.abs(A)<=1){const B=w?1:.7,I=Math.floor(u*B),R=Math.floor(p*B),H=Math.floor(f*B),F=I<<16|R<<8|H,_=r+E,L=d;if(_>=0&&_<this.screenGridCols&&L>=0&&L<this.screenGridRows){const X=`${_},${L}`;o.set(X,{color:F,alpha:.9})}}}}const M=Math.max(1,Math.floor(C*.35)),x=Math.floor(g*.5),b=r-M,P=r+M,T=d-x;if(b>=0&&b<this.screenGridCols&&T>=0&&T<this.screenGridRows&&o.set(`${b},${T}`,{color:0,alpha:1}),P>=0&&P<this.screenGridCols&&T>=0&&T<this.screenGridRows&&o.set(`${P},${T}`,{color:0,alpha:1}),!w){const E=Math.floor(C*.4),A=Math.floor(g*.7),B=r-E,I=d-A;B>=0&&B<this.screenGridCols&&I>=0&&I<this.screenGridRows&&o.set(`${B},${I}`,{color:16777215,alpha:.8})}});for(const e of this.monsterGridCells){const l=`${e.screenCol},${e.screenRow}`,n=o.get(l);n?(e.rect.setFillStyle(n.color,n.alpha),e.rect.setVisible(!0)):e.rect.setVisible(!1)}}removeMonster(S){const t=this.monsters.findIndex(s=>s.id===S);t!==-1&&this.monsters.splice(t,1)}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters=[]}setSpawnInterval(S){this.spawnInterval=S}damageMonster(S,t){const s=this.monsters.find(i=>i.id===S);if(!s)return{killed:!1,exp:0};if(s.hp-=t,this.flashMonster(s),s.hp<=0){const i=s.isBat?st.BAT_FIXED_EXP:this.calculateMonsterExp(s.definition.exp);return this.playDeathSmoke(s.x,s.y),this.removeMonster(S),{killed:!0,exp:i}}return{killed:!1,exp:0}}flashMonster(S){S.flashStartTime=this.scene.time.now}playDeathSmoke(S,t){const s=this.scene;s.flashDeathEffect&&s.flashDeathEffect(S,t)}damageMonsters(S,t){let s=0,i=0;const o=[];for(const e of S){const l=this.monsters.find(c=>c.id===e),n=l?{x:l.x,y:l.y}:null,a=this.damageMonster(e,t);a.killed&&n&&(s+=a.exp,i++,o.push(n))}return{totalExp:s,killCount:i,killedPositions:o}}};v(st,"BAT_FIXED_HP",10),v(st,"BAT_FIXED_EXP",5),v(st,"HP_GROWTH_RATE",1.1),v(st,"DAMAGE_UNIT",10);let Ct=st;const G=class G extends O.Scene{constructor(){super("MainScene");v(this,"character");v(this,"characterState","idle");v(this,"facingRight",!0);v(this,"skillIcons",[]);v(this,"skillIconGridGraphics",[]);v(this,"skillIconGridData",[]);v(this,"gameBounds");v(this,"boundsBorder");v(this,"background");v(this,"gameAreaContainer");v(this,"revealMask");v(this,"mapWidth");v(this,"mapHeight");v(this,"characterX");v(this,"characterY");v(this,"characterSize");v(this,"isPointerDown",!1);v(this,"moveDirX",0);v(this,"moveDirY",0);v(this,"baseMoveSpeed",0);v(this,"moveSpeed",0);v(this,"floorGrid");v(this,"worldContainer");v(this,"characterContainer");v(this,"uiContainer");v(this,"cameraOffsetX",0);v(this,"cameraOffsetY",0);v(this,"cursors");v(this,"isKeyboardMoving",!1);v(this,"skillPanelContainer");v(this,"isPaused",!1);v(this,"skillOptions",[]);v(this,"skillCardBgs",[]);v(this,"selectedSkillIndex",0);v(this,"currentSkillChoices",[]);v(this,"skillCutInContainer");v(this,"skillManager",new nt);v(this,"skillIconContainers",[]);v(this,"skillLevelTexts",[]);v(this,"skillInfoPanel");v(this,"skillInfoBg");v(this,"skillInfoText");v(this,"skillInfoHideTimer");v(this,"currentExp",0);v(this,"maxExp",100);v(this,"currentLevel",0);v(this,"expBarContainer");v(this,"expBarFlowOffset",0);v(this,"levelText");v(this,"currentHp",200);v(this,"maxHp",200);v(this,"hpBarContainer");v(this,"hpBarFlowOffset",0);v(this,"hpText");v(this,"currentShield",0);v(this,"maxShield",0);v(this,"shieldBarFlowOffset",0);v(this,"shieldReflectDamage",0);v(this,"shieldText");v(this,"shieldAuraGraphics");v(this,"shieldSparkleTimer",0);v(this,"hpRegenTimer",0);v(this,"reviveUsed",!1);v(this,"displayedHp",200);v(this,"hpDamageDelay",0);v(this,"isMobile",!1);v(this,"keyPlus");v(this,"keyMinus");v(this,"keyShift");v(this,"keyCtrl");v(this,"keyZero");v(this,"keyBackspace");v(this,"keyF5");v(this,"keyF6");v(this,"keyF7");v(this,"keyF8");v(this,"keyF9");v(this,"keyF10");v(this,"keyF11");v(this,"keyF12");v(this,"showLegacySkillEffects",!1);v(this,"monsterManager");v(this,"isHurt",!1);v(this,"hurtEndTime",0);v(this,"lowHpBreathTimer",0);v(this,"isLowHp",!1);v(this,"vignetteEdgeCells",new Set);v(this,"skillCooldowns",new Map);v(this,"isAttacking",!1);v(this,"attackEndTime",0);v(this,"gameBgm");v(this,"currentBgmKey","");v(this,"skillGridContainer");v(this,"skillGridCells",[]);v(this,"skillGridCols",0);v(this,"skillGridRows",0);v(this,"skillGridCellSize",10);v(this,"gridScaleMultiplier",3)}create(){this.cameras.main.setBackgroundColor("#111111"),this.isMobile=this.sys.game.device.input.touch&&window.innerWidth<1024,this.gridScaleMultiplier=this.isMobile?2:3;const t=this.cameras.main.width,s=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const n=t*.9,a=s*(1-.05*2),c=16/9,h=n/a;let r,d;h>c?(d=a,r=a*c):(r=n,d=n/c),this.gameBounds={x:(t-r)/2,y:(s-d)/2,width:r,height:d}}this.mapWidth=this.gameBounds.width*G.MAP_SCALE,this.mapHeight=this.gameBounds.height*G.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,s),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const i=this.make.graphics({x:0,y:0});i.fillStyle(16777215),i.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const o=i.createGeometryMask();this.worldContainer.setMask(o),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(100),this.monsterManager=new Ct(this,this.gameBounds,this.mapWidth,this.mapHeight),this.monsterManager.setGridScaleMultiplier(this.gridScaleMultiplier),this.monsterManager.setClipMask(o),this.createSkillGrid(),window.addEventListener("gridscalechange",l=>{this.gridScaleMultiplier=l.detail.scale,this.recreateSkillGrid(),this.monsterManager.setGridScaleMultiplier(l.detail.scale)}),this.characterContainer.setDepth(60),this.characterContainer.setMask(o),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const e=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(e),this.uiContainer.setMask(e),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createSkillCutIn(),this.createLowHpVignette()}update(t,s){if(this.updateHpBarFlow(s),this.updateShieldBarFlow(s),this.updateExpBarFlow(s),this.updateShieldAura(s),this.updateHpRegen(s),this.updateLowHpVignetteBreathing(s),this.updateSkillCooldownDisplay(),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const i=this.time.now;this.isHurt&&i>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&i>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isPointerDown||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(s),this.isPointerDown&&!this.isKeyboardMoving&&this.moveCharacter(s));const o=this.monsterManager.update(s,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);o.damage>0&&this.takeDamage(o.damage,o.hitMonsters),this.updateSkillRangePreview(i),this.tryActivateSkills(i)}updateSkillRangePreview(t){if(this.clearSkillGrid(),this.isHurt)return;const s=this.skillManager.getPlayerActiveSkills();for(const i of s){if(!i)continue;const o=i.definition;let e=o.cooldown||1e3;o.id==="active_architect"&&(e=e-i.level*500);const l=this.skillManager.calculateFinalCooldown(e),n=this.skillCooldowns.get(o.id)||0;t-n>=l&&this.showSkillPreview(i)}}showSkillPreview(t){const s=t.definition,i=s.color,o=.2;switch(s.id){case"active_soul_render":{const e=this.monsterManager.getMonsters();if(e.length===0)return;let l=0,n=1/0;for(const r of e){const d=r.x-this.characterX,y=r.y-this.characterY,C=Math.sqrt(d*d+y*y);C<n&&(n=C,l=Math.atan2(y,d))}const a=this.gameBounds.height*.3,h=(60+t.level*10)/2*(Math.PI/180);this.showSkillRangeSector(this.characterX,this.characterY,a,l,h,i,o);break}case"active_coder":{const e=this.gameBounds.height*.1,l=2+t.level*.5,n=e*l;this.showSkillRangeCircle(this.characterX,this.characterY,n,i,o);break}case"active_vfx":{const e=this.monsterManager.getMonsters();if(e.length===0)return;const l=Math.min(t.level+1,e.length),n=this.gameBounds.height*1,a=this.gameBounds.height*.05,c=[...e].sort((h,r)=>{const d=Math.sqrt((h.x-this.characterX)**2+(h.y-this.characterY)**2),y=Math.sqrt((r.x-this.characterX)**2+(r.y-this.characterY)**2);return d-y});for(let h=0;h<l;h++){const r=c[h],d=r.x-this.characterX,y=r.y-this.characterY,C=Math.sqrt(d*d+y*y);if(C>0){const g=this.characterX+d/C*n,k=this.characterY+y/C*n;this.showSkillRangeLine(this.characterX,this.characterY,g,k,a,i,o)}}break}case"active_architect":{const e=this.gameBounds.height*.15;this.showSkillRangeCircle(this.characterX,this.characterY,e,i,o);break}}}tryActivateSkills(t){if(this.isHurt)return;const s=this.skillManager.getPlayerActiveSkills();for(const i of s){if(!i)continue;const o=i.definition;let e=o.cooldown||1e3;o.id==="active_architect"&&(e=e-i.level*500);const l=this.skillManager.calculateFinalCooldown(e),n=this.skillCooldowns.get(o.id)||0;t-n>=l&&(this.activateSkill(i,t),this.skillCooldowns.set(o.id,t))}}activateSkill(t,s){const i=t.definition;switch(this.isAttacking=!0,this.attackEndTime=s+G.ATTACK_DURATION,this.setCharacterState("attack",!0),i.flashColor&&this.character.setTint(i.flashColor),i.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${i.name}`)}}activateSoulRender(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;let i=s[0],o=1/0;for(const g of s){const k=g.x-this.characterX,u=g.y-this.characterY,p=Math.sqrt(k*k+u*u);p<o&&(o=p,i=g)}const e=Math.atan2(i.y-this.characterY,i.x-this.characterX);this.facingRight=Math.cos(e)>=0,this.updateCharacterSprite();const l=this.gameBounds.height*.3,a=(60+t.level*10)/2*(Math.PI/180),c=2+t.level,h=G.DAMAGE_UNIT*c,{damage:r,isCrit:d}=this.skillManager.calculateFinalDamageWithCrit(h,this.currentLevel),y=[];for(const g of s){const k=this.gameBounds.height*g.definition.size*.5,u=g.x-this.characterX,p=g.y-this.characterY,f=Math.sqrt(u*u+p*p);if(f-k>l)continue;let m=Math.atan2(p,u)-e;for(;m>Math.PI;)m-=Math.PI*2;for(;m<-Math.PI;)m+=Math.PI*2;const M=f>0?Math.atan2(k,f):Math.PI;Math.abs(m)<=a+M&&y.push(g.id)}if(this.showLegacySkillEffects&&this.drawSectorEffect(e,l,a,t.definition.color),this.drawSectorEdge(e,l,a,t.definition.color),this.flashSkillAreaSector(this.characterX,this.characterY,l,e,a,t.definition.flashColor||t.definition.color),y.length>0){const g=s.filter(p=>y.includes(p.id)).map(p=>({x:p.x,y:p.y})),k=this.monsterManager.damageMonsters(y,r);k.totalExp>0&&this.addExp(k.totalExp),d?this.flashCritCrossAtPositions(g):this.flashWhiteCrossAtPositions(g),this.showLegacySkillEffects&&this.drawCrossStarBurst(g,t.definition.flashColor||t.definition.color),this.shakeScreen(y.length);const u=d?" [CRIT!]":"";console.log(`Soul Render hit ${y.length} monsters for ${r} damage${u}, killed ${k.killCount}, exp +${k.totalExp}`)}const C=this.skillManager.getSoulRenderWaveChance(this.currentLevel);C>0&&Math.random()<C&&this.triggerSoulRenderWave(e,l,a,r,t)}drawSectorEffect(t,s,i,o){const e=this.add.graphics();this.worldContainer.add(e);const l=t-i,n=t+i,a=this.characterX,c=this.characterY,h=15,r=1e3,d=this.time.now,y=()=>{const g=this.time.now-d,k=Math.min(g/r,1);e.clear();const u=.3,p=k<u?0:(k-u)/(1-u);for(let m=h;m>=1;m--){const M=s*m/h,b=.8*(1-(m-1)/h)*(1-p);b>.01&&(e.fillStyle(o,b),e.beginPath(),e.moveTo(a,c),e.arc(a,c,M,l,n,!1),e.closePath(),e.fillPath())}const f=8;for(let m=f;m>=1;m--){const M=s*.6*m/f,x=.95*(1-(m-1)/f)*(1-p);x>.01&&(e.fillStyle(16777215,x),e.beginPath(),e.moveTo(a,c),e.arc(a,c,M,l,n,!1),e.closePath(),e.fillPath())}const w=1*(1-p);w>.01&&(e.lineStyle(6,o,w),e.beginPath(),e.moveTo(a,c),e.arc(a,c,s,l,n,!1),e.closePath(),e.strokePath(),e.lineStyle(3,16777215,w*.8),e.beginPath(),e.moveTo(a,c),e.arc(a,c,s*.97,l,n,!1),e.closePath(),e.strokePath(),e.lineStyle(4,16777215,w*.9),e.beginPath(),e.moveTo(a,c),e.lineTo(a+Math.cos(t)*s,c+Math.sin(t)*s),e.strokePath()),k>=1&&e.destroy()},C=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{e.active&&e.destroy(),C.remove()})}drawSectorEdge(t,s,i,o){const e=this.add.graphics();this.skillGridContainer.add(e),e.setDepth(55);const l=t-i,n=t+i,a=this.characterX,c=this.characterY,h=500,r=300,d=this.time.now,y=15,C=(u,p,f,w,m)=>{for(let M=0;M<y;M++){const x=M/y,b=(M+1)/y,P=(x+b)/2,T=Math.min(1,P/.15),E=Math.min(1,(1-P)/.15),A=Math.min(T,E),B=f*A*A;if(B>.01){const I=s*x,R=s*b,H=w+Math.cos(u)*I,F=m+Math.sin(u)*I,_=w+Math.cos(u)*R,L=m+Math.sin(u)*R;e.lineStyle(p,16777215,B),e.beginPath(),e.moveTo(H,F),e.lineTo(_,L),e.strokePath()}}},g=()=>{const u=this.time.now-d,p=Math.min(u/h,1);e.clear();const f=this.worldToScreen(a,c),w=f.x,m=f.y;let M=0;u>r&&(M=(u-r)/(h-r));const x=1*(1-M);x>.01&&(C(l,2,x,w,m),C(n,2,x,w,m)),p>=1&&e.destroy()};g();const k=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{e.active&&e.destroy(),k.remove()})}drawCircleEdge(t,s,i,o){const e=this.add.graphics();this.skillGridContainer.add(e),e.setDepth(55);const l=i??this.characterX,n=o??this.characterY,a=500,c=300,h=this.time.now,r=3,d=Math.PI*2/r,y=24,C=()=>{const k=this.time.now-h,u=Math.min(k/a,1);e.clear();const p=this.worldToScreen(l,n),f=p.x,w=p.y;let m=0;k>c&&(m=(k-c)/(a-c));const M=1*(1-m);if(M>.01)for(let x=0;x<r;x++){const b=x*d-Math.PI/2;for(let P=0;P<y;P++){const T=P/y,E=.2+.8*Math.abs(Math.cos(T*Math.PI)),A=M*E,B=b+P/y*d,I=b+(P+1)/y*d,R=f+Math.cos(B)*t,H=w+Math.sin(B)*t,F=f+Math.cos(I)*t,_=w+Math.sin(I)*t;e.lineStyle(2,16777215,A),e.beginPath(),e.moveTo(R,H),e.lineTo(F,_),e.strokePath()}}u>=1&&e.destroy()};C();const g=this.time.addEvent({delay:16,callback:C,callbackScope:this,repeat:Math.ceil(a/16)});this.time.delayedCall(a+50,()=>{e.active&&e.destroy(),g.remove()})}drawBeamEdge(t,s,i,o,e,l){const n=this.add.graphics();this.worldContainer.add(n);const a=e??this.characterX,c=l??this.characterY,h=Math.cos(t),r=Math.sin(t),d=800,y=380,C=this.time.now,g=20,k=()=>{const p=this.time.now-C,f=Math.min(p/d,1);n.clear();let w=0;p>y&&(w=(p-y)/(d-y));const m=.6*(1-w*.5);if(m>.01)for(let M=0;M<g;M++){const x=M/g,b=(M+1)/g,P=(x+b)/2,T=Math.min(1,P/.15),E=Math.min(1,(1-P)/.15),A=Math.min(T,E),B=m*A*A;if(B>.01){const I=a+h*s*x,R=c+r*s*x,H=a+h*s*b,F=c+r*s*b;n.lineStyle(2,16777215,B),n.beginPath(),n.moveTo(I,R),n.lineTo(H,F),n.strokePath()}}f>=1&&n.destroy()};k();const u=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{n.active&&n.destroy(),u.remove()})}activateCoder(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;const i=this.gameBounds.height*.1,o=2+t.level*.5,e=i*o,l=1+t.level,n=G.DAMAGE_UNIT*l,{damage:a,isCrit:c}=this.skillManager.calculateFinalDamageWithCrit(n,this.currentLevel),h=[];for(const r of s){const d=this.gameBounds.height*r.definition.size*.5,y=r.x-this.characterX,C=r.y-this.characterY;Math.sqrt(y*y+C*C)-d<=e&&h.push(r.id)}if(this.showLegacySkillEffects&&this.drawCircleEffect(e,t.definition.color),this.drawCircleEdge(e,t.definition.color),this.flashSkillAreaCircle(this.characterX,this.characterY,e,t.definition.flashColor||t.definition.color),h.length>0){const r=s.filter(g=>h.includes(g.id)).map(g=>({x:g.x,y:g.y})),d=this.monsterManager.damageMonsters(h,a);d.totalExp>0&&this.addExp(d.totalExp),c?this.flashCritCrossAtPositions(r):this.flashWhiteCrossAtPositions(r),this.showLegacySkillEffects&&this.drawCrossStarBurst(r,t.definition.flashColor||t.definition.color),this.shakeScreen(h.length);const y=c?" [CRIT!]":"";console.log(`Coder hit ${h.length} monsters for ${a} damage${y}, killed ${d.killCount}, exp +${d.totalExp}`);const C=this.skillManager.getCoderBurstChance(this.currentLevel);C>0&&d.killedPositions.length>0&&this.triggerCoderBurst(d.killedPositions,e,a,t,C)}}triggerSoulRenderWave(t,s,i,o,e){const l=this.gameBounds.height*.1,n=l*5,a=s*i*2,c=e.definition.flashColor||e.definition.color,h=this.characterX,r=this.characterY,d=new Set;this.flashSkillAreaSectorMoving(h,r,s,t,i,c,n);const y=500,C=this.time.now,g=l*.5,k=()=>{const u=this.time.now-C,p=Math.min(u/y,1),f=s+n*p,w=a/(2*f),m=this.monsterManager.getMonsters(),M=[];for(const x of m){if(d.has(x.id))continue;const b=this.gameBounds.height*x.definition.size*.5,P=x.x-h,T=x.y-r,E=Math.sqrt(P*P+T*T);if(Math.abs(E-f)>g+b)continue;let B=Math.atan2(T,P)-t;for(;B>Math.PI;)B-=Math.PI*2;for(;B<-Math.PI;)B+=Math.PI*2;const I=E>0?Math.atan2(b,E):Math.PI;Math.abs(B)<=w+I&&(M.push(x.id),d.add(x.id))}if(M.length>0){const x=m.filter(P=>M.includes(P.id)).map(P=>({x:P.x,y:P.y})),b=this.monsterManager.damageMonsters(M,o);b.totalExp>0&&this.addExp(b.totalExp),this.flashWhiteCrossAtPositions(x)}p<1&&this.time.delayedCall(16,k)};k()}flashSkillAreaSectorMoving(t,s,i,o,e,l,n){const a=this.worldToScreen(t,s),c=a.x,h=a.y,r=G.SKILL_GRID_GAP,d=this.skillGridCellSize+r,y=500,C=this.time.now,g=Math.cos(o),k=Math.sin(o),u=i+n+i,p=[],f=Math.max(0,Math.floor((c-u)/d)),w=Math.min(this.skillGridCols-1,Math.ceil((c+u)/d)),m=Math.max(0,Math.floor((h-u)/d)),M=Math.min(this.skillGridRows-1,Math.ceil((h+u)/d));for(let P=m;P<=M;P++)for(let T=f;T<=w;T++){const E=T*d+this.skillGridCellSize/2,A=P*d+this.skillGridCellSize/2;p.push({col:T,row:P,screenX:E,screenY:A})}if(p.length===0)return;const x=[];for(const{col:P,row:T}of p){const E=P*d+this.skillGridCellSize/2,A=T*d+this.skillGridCellSize/2,B=this.add.rectangle(E,A,this.skillGridCellSize,this.skillGridCellSize,l,0);B.setVisible(!1),this.skillGridContainer.add(B),x.push(B)}const b=()=>{const P=this.time.now-C,T=Math.min(P/y,1),E=n*T,A=c+g*E,B=h+k*E,I=.5,R=T>I?(T-I)/(1-I):0;let H=0;for(const{screenX:F,screenY:_}of p){const L=x[H++];if(!L)continue;const X=F-A,Y=_-B,V=Math.sqrt(X*X+Y*Y),K=i*.5;if(V>=K&&V<=i){let D=Math.atan2(Y,X)-o;for(;D>Math.PI;)D-=Math.PI*2;for(;D<-Math.PI;)D+=Math.PI*2;if(Math.abs(D)<=e){const z=(V-K)/(i-K),$=Math.abs(D)/e,W=Math.max(z,$),N=Math.max(0,Math.min(1,(W-.3)/.7)),Z=N*N*(3-2*N),j=(.15+Z*.6)*(1-R);if(j>.01){const J=.5+Z*.5,et=l>>16&255,at=l>>8&255,gt=l&255,rt=Math.floor(et*J),ht=Math.floor(at*J),ct=Math.floor(gt*J),it=rt<<16|ht<<8|ct;L.setFillStyle(it,j),L.setVisible(!0)}else L.setVisible(!1)}else L.setVisible(!1)}else L.setVisible(!1)}if(T>=1)for(const F of x)F.destroy();else this.time.delayedCall(16,b)};b()}triggerCoderBurst(t,s,i,o,e){const l=this.monsterManager.getMonsters();if(l.length===0)return;const n=s*.5;for(const a of t){if(Math.random()>=e)continue;const c=[];for(const h of l){const r=this.gameBounds.height*h.definition.size*.5,d=h.x-a.x,y=h.y-a.y;Math.sqrt(d*d+y*y)-r<=n&&c.push(h.id)}if(this.drawCircleEdge(n,o.definition.color,a.x,a.y),this.flashSkillAreaCircle(a.x,a.y,n,o.definition.flashColor||o.definition.color),c.length>0){const h=l.filter(d=>c.includes(d.id)).map(d=>({x:d.x,y:d.y})),r=this.monsterManager.damageMonsters(c,i);r.totalExp>0&&this.addExp(r.totalExp),this.flashWhiteCrossAtPositions(h),console.log(`Coder Burst hit ${c.length} monsters for ${i} damage`)}}}drawCircleEffect(t,s){const i=this.add.graphics();this.worldContainer.add(i);const o=this.characterX,e=this.characterY,l=15,n=1e3,a=this.time.now,c=()=>{const r=this.time.now-a,d=Math.min(r/n,1);i.clear();const y=.3,C=d<y?0:(d-y)/(1-y);for(let u=l;u>=1;u--){const p=t*u/l,f=t*(u-1)/l,m=.7*(1-(u-1)/l)*(1-C);m>.01&&(i.fillStyle(s,m),i.beginPath(),i.arc(o,e,p,0,Math.PI*2,!1),f>0&&i.arc(o,e,f,0,Math.PI*2,!0),i.closePath(),i.fillPath())}const g=8;for(let u=g;u>=1;u--){const p=t*.5*u/g,f=t*.5*(u-1)/g,w=.95*(1-(u-1)/g)*(1-C);w>.01&&(i.fillStyle(16777215,w),i.beginPath(),i.arc(o,e,p,0,Math.PI*2,!1),f>0&&i.arc(o,e,f,0,Math.PI*2,!0),i.closePath(),i.fillPath())}const k=1*(1-C);k>.01&&(i.lineStyle(6,s,k),i.strokeCircle(o,e,t),i.lineStyle(3,16777215,k*.8),i.strokeCircle(o,e,t*.96),i.lineStyle(2,16777215,k*.5),i.strokeCircle(o,e,t*.7),i.strokeCircle(o,e,t*.4)),d>=1&&i.destroy()},h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{i.active&&i.destroy(),h.remove()})}activateVfx(t){const s=this.monsterManager.getMonsters();if(s.length===0)return;const i=t.level+1,o=this.gameBounds.height*1,e=this.gameBounds.height*.05,l=1+t.level,n=G.DAMAGE_UNIT*l,{damage:a,isCrit:c}=this.skillManager.calculateFinalDamageWithCrit(n,this.currentLevel),h=new Set,r=s.map((C,g)=>g),d=[];for(let C=0;C<i;C++){let g;if(r.length>0){const p=Math.floor(Math.random()*r.length),f=r[p];r.splice(p,1);const w=s[f];g=Math.atan2(w.y-this.characterY,w.x-this.characterX)}else g=Math.random()*Math.PI*2;d.push(g);for(const p of s){const f=this.gameBounds.height*p.definition.size*.5,w=p.x-this.characterX,m=p.y-this.characterY;if(Math.sqrt(w*w+m*m)-f>o)continue;const x=Math.cos(g),b=Math.sin(g);if(w*x+m*b<-f)continue;Math.abs(w*b-m*x)<=e/2+f&&h.add(p.id)}this.showLegacySkillEffects&&this.drawBeamEffect(g,o,e,t.definition.color),this.drawBeamEdge(g,o,e,t.definition.color);const k=this.characterX+Math.cos(g)*o,u=this.characterY+Math.sin(g)*o;this.flashSkillAreaLine(this.characterX,this.characterY,k,u,e,t.definition.flashColor||t.definition.color)}d.length>0&&(this.facingRight=Math.cos(d[0])>=0,this.updateCharacterSprite());const y=Array.from(h);if(y.length>0){const g=s.filter(f=>y.includes(f.id)).map(f=>({x:f.x,y:f.y})),k=this.monsterManager.damageMonsters(y,a);k.totalExp>0&&this.addExp(k.totalExp),c?this.flashCritCrossAtPositions(g):this.flashWhiteCrossAtPositions(g),this.showLegacySkillEffects&&this.drawCrossStarBurst(g,t.definition.flashColor||t.definition.color),this.shakeScreen(y.length);const u=c?" [CRIT!]":"";console.log(`VFX (${i} beams) hit ${y.length} monsters for ${a} damage${u}, killed ${k.killCount}, exp +${k.totalExp}`);const p=this.skillManager.getVfxChainChance(this.currentLevel);p>0&&k.killedPositions.length>0&&this.triggerVfxChain(k.killedPositions,a,p,t)}}triggerVfxChain(t,s,i,o){const e=this.monsterManager.getMonsters();if(e.length===0)return;const l=this.gameBounds.height*1,n=this.gameBounds.height*.05;for(const a of t){if(Math.random()>=i)continue;const c=e.filter(g=>{const k=g.x-a.x,u=g.y-a.y;return Math.sqrt(k*k+u*u)>10});if(c.length===0)continue;const h=c[Math.floor(Math.random()*c.length)],r=Math.atan2(h.y-a.y,h.x-a.x),d=[];for(const g of e){const k=this.gameBounds.height*g.definition.size*.5,u=g.x-a.x,p=g.y-a.y;if(Math.sqrt(u*u+p*p)-k>l)continue;const w=Math.cos(r),m=Math.sin(r);if(u*w+p*m<-k)continue;Math.abs(u*m-p*w)<=n/2+k&&d.push(g.id)}this.drawBeamEdge(r,l,n,o.definition.color,a.x,a.y);const y=a.x+Math.cos(r)*l,C=a.y+Math.sin(r)*l;if(this.flashSkillAreaLine(a.x,a.y,y,C,n,o.definition.flashColor||o.definition.color),d.length>0){const g=e.filter(u=>d.includes(u.id)).map(u=>({x:u.x,y:u.y})),k=this.monsterManager.damageMonsters(d,s);k.totalExp>0&&this.addExp(k.totalExp),this.flashWhiteCrossAtPositions(g),console.log(`VFX Chain hit ${d.length} monsters for ${s} damage`)}}}drawBeamEffect(t,s,i,o){const e=this.add.graphics();this.worldContainer.add(e);const l=this.characterX,n=this.characterY,a=l+Math.cos(t)*s,c=n+Math.sin(t)*s,h=i*1.5,r=Math.sin(t)*h/2,d=-Math.cos(t)*h/2,y=Math.sin(t)*h*.4/2,C=-Math.cos(t)*h*.4/2,g=15,k=1e3,u=this.time.now,p=()=>{const w=this.time.now-u,m=Math.min(w/k,1);e.clear();const M=.3,x=m<M?0:(m-M)/(1-M);for(let T=0;T<g;T++){const E=T/g,A=(T+1)/g,B=l+(a-l)*E,I=n+(c-n)*E,R=l+(a-l)*A,H=n+(c-n)*A,_=.85*(1-E*.6)*(1-x);_>.01&&(e.fillStyle(o,_),e.beginPath(),e.moveTo(B-r,I-d),e.lineTo(R-r,H-d),e.lineTo(R+r,H+d),e.lineTo(B+r,I+d),e.closePath(),e.fillPath())}for(let T=0;T<g;T++){const E=T/g,A=(T+1)/g,B=l+(a-l)*E,I=n+(c-n)*E,R=l+(a-l)*A,H=n+(c-n)*A,F=.98*(1-E*.5)*(1-x);F>.01&&(e.fillStyle(16777215,F),e.beginPath(),e.moveTo(B-y,I-C),e.lineTo(R-y,H-C),e.lineTo(R+y,H+C),e.lineTo(B+y,I+C),e.closePath(),e.fillPath())}const b=1*(1-x);b>.01&&(e.lineStyle(6,16777215,b),e.beginPath(),e.moveTo(l,n),e.lineTo(a,c),e.strokePath());const P=1*(1-x);P>.01&&(e.lineStyle(4,o,P),e.beginPath(),e.moveTo(l-r,n-d),e.lineTo(a-r,c-d),e.lineTo(a+r,c+d),e.lineTo(l+r,n+d),e.closePath(),e.strokePath(),e.lineStyle(2,16777215,P*.6),e.beginPath(),e.moveTo(l-r*1.1,n-d*1.1),e.lineTo(a-r*1.1,c-d*1.1),e.lineTo(a+r*1.1,c+d*1.1),e.lineTo(l+r*1.1,n+d*1.1),e.closePath(),e.strokePath()),m>=1&&e.destroy()},f=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(k/16)});this.time.delayedCall(k+50,()=>{e.active&&e.destroy(),f.remove()})}drawCrossStarBurst(t,s){const o=this.gameBounds.height*.1*1,e=600;for(const l of t){const n=this.add.graphics();this.worldContainer.add(n);const a=this.time.now,c=()=>{const r=this.time.now-a,d=Math.min(r/e,1);n.clear();const y=d<.2?d/.2:1,C=d<.4?0:(d-.4)/.6,g=o*y,k=1-C;if(k>.01&&g>0){const u=g*.2,p=g,f=g*.4;n.fillStyle(16777215,k),n.fillCircle(l.x,l.y,f);for(let M=0;M<4;M++){const x=M*Math.PI/2,b=Math.cos(x),P=Math.sin(x),T=-P,E=b,A=6;for(let B=0;B<A;B++){const I=B/A,R=(B+1)/A,H=u*(1-I*.8),F=u*(1-R*.8),_=l.x+b*p*I,L=l.y+P*p*I,X=l.x+b*p*R,Y=l.y+P*p*R,V=k*(1-I*.7);n.fillStyle(s,V*.8),n.beginPath(),n.moveTo(_+T*H,L+E*H),n.lineTo(X+T*F,Y+E*F),n.lineTo(X-T*F,Y-E*F),n.lineTo(_-T*H,L-E*H),n.closePath(),n.fillPath();const K=H*.5,U=F*.5;n.fillStyle(16777215,V*.9),n.beginPath(),n.moveTo(_+T*K,L+E*K),n.lineTo(X+T*U,Y+E*U),n.lineTo(X-T*U,Y-E*U),n.lineTo(_-T*K,L-E*K),n.closePath(),n.fillPath()}}const w=p*.5,m=u*.6;for(let M=0;M<4;M++){const x=M*Math.PI/2+Math.PI/4,b=Math.cos(x),P=Math.sin(x),T=-P,E=b,A=4;for(let B=0;B<A;B++){const I=B/A,R=(B+1)/A,H=m*(1-I*.9),F=m*(1-R*.9),_=l.x+b*w*I,L=l.y+P*w*I,X=l.x+b*w*R,Y=l.y+P*w*R,V=k*(1-I*.8)*.7;n.fillStyle(s,V),n.beginPath(),n.moveTo(_+T*H,L+E*H),n.lineTo(X+T*F,Y+E*F),n.lineTo(X-T*F,Y-E*F),n.lineTo(_-T*H,L-E*H),n.closePath(),n.fillPath()}}}d>=1&&n.destroy()};c();const h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(e/16)});this.time.delayedCall(e+50,()=>{n.active&&n.destroy(),h.remove()})}}activateArchitect(t){const s=this.skillManager.getArchitectExplosionChance(this.currentLevel);s>0&&this.currentShield>0&&Math.random()<s&&this.triggerShieldExplosion(t);const i=Math.floor(this.maxHp*.3);this.currentShield=i,this.maxShield=i;const o=1+t.level*1.5;this.shieldReflectDamage=G.DAMAGE_UNIT*o,this.drawShieldBarFill(),this.showLegacySkillEffects&&this.drawShieldActivateEffect();const e=this.gameBounds.height*.15;this.flashSkillAreaCircle(this.characterX,this.characterY,e,t.definition.flashColor||t.definition.color),console.log(`Architect activated: Shield ${i}, Reflect damage ${this.shieldReflectDamage} (${o} units)`)}triggerShieldExplosion(t){const i=this.gameBounds.height*.1*3,o=t.definition.color,e=t.definition.flashColor||o,l=this.shieldReflectDamage;if(this.maxShield>0){const c=this.maxShield;this.currentHp=Math.min(this.currentHp+c,this.maxHp),console.log(`Shield explosion! Healed ${c} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(c)}this.drawCircleEdge(i,o),this.flashSkillAreaCircle(this.characterX,this.characterY,i,e);const n=this.monsterManager.getMonsters(),a=[];for(const c of n){const h=this.gameBounds.height*c.definition.size*.5,r=c.x-this.characterX,d=c.y-this.characterY;Math.sqrt(r*r+d*d)-h<=i&&a.push(c.id)}if(a.length>0){const c=n.filter(r=>a.includes(r.id)).map(r=>({x:r.x,y:r.y})),h=this.monsterManager.damageMonsters(a,l);h.totalExp>0&&this.addExp(h.totalExp),this.flashWhiteCrossAtPositions(c),this.shakeScreen(a.length),console.log(`Shield Explosion hit ${a.length} monsters for ${l} damage`)}}drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const s=this.characterX,i=this.characterY-this.characterSize/2,o=this.characterSize*1.2,e=16763904,l=800,n=this.time.now,a=()=>{const h=this.time.now-n,r=Math.min(h/l,1);t.clear();const d=r<.2?r/.2:1,y=r<.2?0:(r-.2)/.8,C=o*(.3+.7*d),g=1-y;if(g>.01){for(let f=8;f>=1;f--){const w=C*f/8,m=g*(1-(f-1)/8)*.6;m>.01&&(t.fillStyle(e,m),t.fillCircle(s,i,w))}const u=4;for(let f=u;f>=1;f--){const w=C*.4*f/u,m=g*(1-(f-1)/u)*.9;m>.01&&(t.fillStyle(16777215,m),t.fillCircle(s,i,w))}t.lineStyle(5,e,g*.9),t.strokeCircle(s,i,C),t.lineStyle(2,16777215,g*.7),t.strokeCircle(s,i,C*.95);const p=C*.7;t.lineStyle(3,16777215,g*.5),t.beginPath();for(let f=0;f<6;f++){const w=f*Math.PI/3,m=s+Math.cos(w)*p,M=i+Math.sin(w)*p;f===0?t.moveTo(m,M):t.lineTo(m,M)}t.closePath(),t.strokePath()}r>=1&&t.destroy()};a();const c=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),c.remove()})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyBackspace)){this.showLegacySkillEffects=!this.showLegacySkillEffects,console.log(`Legacy skill effects: ${this.showLegacySkillEffects?"ON":"OFF"}`);return}if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:s,skillId:i}of t)if(s&&O.Input.Keyboard.JustDown(s)){this.maxOutSingleSkill(i);return}}if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const s=ft.find(n=>n.id===t);if(!s)return;const i=this.skillManager.getSkillLevel(t),o=s.type==="passive";if(i>=s.maxLevel){console.log(`Test: ${s.name} is already MAX`);return}if(o&&i<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${s.name}`);return}const e=i<0?-1:i,l=s.maxLevel-e;this.currentLevel+=l,this.monsterManager.setPlayerLevel(this.currentLevel);for(let n=0;n<l;n++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${s.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const s=this.skillManager.getActiveSkillDefinitions();for(const i of s)for(let o=0;o<=i.maxLevel;o++)this.skillManager.learnOrUpgradeSkill(i.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel)&&this.monsterManager.spawnBoss(this.cameraOffsetX,this.cameraOffsetY),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=G.BASE_HP+G.HP_PER_LEVEL*this.currentLevel,s=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>s&&s>0){const i=this.currentHp/s;this.currentHp=Math.floor(this.maxHp*i)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(O.Input.Keyboard.JustDown(this.cursors.A)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),O.Input.Keyboard.JustDown(this.cursors.S)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1)),O.Input.Keyboard.JustDown(this.cursors.D)&&(this.selectedSkillIndex===2?this.confirmSkillSelection():this.setSelectedSkill(2)))}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,s){const i=this.skillCardBgs[t],o=this.skillOptions[t];!i||!o||(s?(i.setFillStyle(3355443),i.setStrokeStyle(3,16777215),this.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:100})):(i.setFillStyle(2236962),i.setStrokeStyle(2,6710886),this.tweens.add({targets:o,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let s=0,i=0;if(this.cursors.W.isDown&&(i=-1),this.cursors.S.isDown&&(i=1),this.cursors.A.isDown&&(s=-1),this.cursors.D.isDown&&(s=1),s!==0||i!==0){if(this.isKeyboardMoving=!0,this.isPointerDown=!1,s!==0&&(this.facingRight=s>0),s!==0&&i!==0){const e=1/Math.sqrt(2);s*=e,i*=e}const o=this.moveSpeed*t/1e3;this.characterX+=s*o,this.characterY+=i*o,this.characterX=O.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=O.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isPointerDown||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateMoveDirectionFromPointer(t))}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateMoveDirectionFromPointer(t)}onPointerUp(){this.isPointerDown=!1,this.isKeyboardMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateMoveDirectionFromPointer(t){const s=t.x-this.gameBounds.x,i=t.y-this.gameBounds.y,o=s+this.cameraOffsetX,e=i+this.cameraOffsetY,l=o-this.characterX,n=e-this.characterY,a=Math.sqrt(l*l+n*n);a>0?(this.moveDirX=l/a,this.moveDirY=n/a):(this.moveDirX=0,this.moveDirY=0)}moveCharacter(t){const s=this.moveSpeed*t/1e3,i=this.characterX+this.moveDirX*s,o=this.characterY+this.moveDirY*s;this.characterX=O.Math.Clamp(i,this.characterSize,this.mapWidth-this.characterSize),this.characterY=O.Math.Clamp(o,this.characterSize,this.mapHeight-this.characterSize),this.moveDirX!==0&&this.updateCharacterFacing(this.characterX+this.moveDirX),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const s=this.cameraOffsetX+this.gameBounds.width/2,i=this.cameraOffsetY+this.gameBounds.height/2,o=this.characterX-s,e=this.characterY-i,l=this.gameBounds.width*G.CAMERA_DEAD_ZONE,n=this.gameBounds.height*G.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(o)>l/2&&(o>0?this.cameraOffsetX+=o-l/2:this.cameraOffsetX+=o+l/2),Math.abs(e)>n/2&&(e>0?this.cameraOffsetY+=e-n/2:this.cameraOffsetY+=e+n/2)),this.cameraOffsetX=O.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=O.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let s;if(this.currentBgmKey&&t.length>1){const i=t.filter(o=>o!==this.currentBgmKey);s=i[Math.floor(Math.random()*i.length)]}else s=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=s,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(s)&&(this.gameBgm=this.sound.add(s,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,s){this.background=this.add.image(t/2,s/2,"background");const i=t/this.background.width,o=s/this.background.height,e=Math.max(i,o);this.background.setScale(e)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,s=this.gameBounds.y+t*2,i=Math.max(G.MIN_FONT_SIZE_MEDIUM,Math.floor(this.gameBounds.height*.03));this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,s+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${i}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setResolution(2),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[1,2,3],s=[1,2],i=this.skillGridCols-2,o=this.currentHp/this.maxHp,e=Math.floor(i*o),l=this.displayedHp/this.maxHp,n=Math.floor(i*l);for(const a of t)for(let c=0;c<i;c++){const h=c+1,r=a*this.skillGridCols+h,d=this.skillGridCells[r];d&&(d.setFillStyle(0,.9),d.setVisible(!0),d.setDepth(1e3))}if(n>e)for(const a of t)for(let c=e;c<n;c++){const h=c+1,r=a*this.skillGridCols+h,d=this.skillGridCells[r];if(!d)continue;const y=t.indexOf(a),C=y===0?.85:y===1?.75:.65;d.setFillStyle(16777215,C)}if(e>0)for(const a of t)for(let c=0;c<e;c++){const h=c+1,r=a*this.skillGridCols+h,d=this.skillGridCells[r];if(!d)continue;const y=c/i,C=this.hpBarFlowOffset,g=(y+C)%1,k=(Math.sin(g*Math.PI*2-Math.PI/2)+1)/2,u=Math.floor(136-34*k),p=0,f=Math.floor(34+102*k),w=u<<16|p<<8|f,m=t.indexOf(a),M=m===0?.95:m===1?.85:.75;d.setFillStyle(w,M)}if(this.currentShield>0&&this.maxShield>0){const a=this.currentShield/this.maxShield,c=Math.floor(i*a);for(const h of s)for(let r=0;r<i;r++){const d=r+1,y=h*this.skillGridCols+d,C=this.skillGridCells[y];if(C&&r<c){const g=r/i,k=this.shieldBarFlowOffset,u=(g+k)%1,p=(Math.sin(u*Math.PI*2-Math.PI/2)+1)/2,f=255,w=Math.floor(204+51*p),m=Math.floor(0+204*p),M=f<<16|w<<8|m,x=h===s[0]?.95:.8;C.setFillStyle(M,x)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.updateDamageDisplay(t),this.drawHpBarFill()}updateDamageDisplay(t){if(this.displayedHp>this.currentHp)if(this.hpDamageDelay>0)this.hpDamageDelay-=t;else{const i=(this.displayedHp-this.currentHp)*G.HP_DAMAGE_LERP_SPEED*(t/1e3);this.displayedHp-=Math.max(1,i),this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}else this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}+${this.currentShield}/${this.maxHp}`):this.hpText.setText(`${this.currentHp}/${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,s=this.gameBounds.y+t*2,i=Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025));this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,s+t/2,"",{fontFamily:"monospace",fontSize:`${i}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const s=.6;this.shieldBarFlowOffset+=s*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0)return;const s=this.characterX,i=this.characterY,o=this.characterSize*.8,e=this.characterSize*.35,l=i-this.characterSize*.15;for(let a=5;a>=0;a--){const c=1+a*.08,h=.12-a*.018,r=3+a*2;this.shieldAuraGraphics.lineStyle(r,16777215,h),this.shieldAuraGraphics.strokeEllipse(s,l,o*c,e*c)}this.shieldSparkleTimer+=t;const n=80;this.shieldSparkleTimer>=n&&(this.shieldSparkleTimer-=n,this.createShieldSparkle(s,l,o,e))}createShieldSparkle(t,s,i,o){const e=Math.random()*Math.PI*2,l=t+Math.cos(e)*(i/2),n=s+Math.sin(e)*(o/2),a=this.add.graphics();this.characterContainer.add(a);const c=this.gameBounds.height/10,h=c*.08,r=c*.2,d=c*.5,y=600+Math.random()*200,C=this.time.now,g=()=>{const u=this.time.now-C,p=Math.min(u/y,1);a.clear();const f=n-d*p,w=Math.pow(p,.5),m=h+(r-h)*w,M=1-p;M>.01&&(a.fillStyle(16768324,M*.9),a.fillRect(l-m/2,f-m/2,m,m),a.lineStyle(1,16777215,M*.6),a.strokeRect(l-m/2,f-m/2,m,m)),p>=1&&a.destroy()};g();const k=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(y/16)});this.time.delayedCall(y+50,()=>{a.active&&a.destroy(),k.remove()})}updateHpRegen(t){const s=this.skillManager.getTitaniumLiverRegenInterval();if(!(s<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=s){this.hpRegenTimer-=s;const i=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+i,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(i),console.log(`HP Regen: +${i} HP (${this.currentHp}/${this.maxHp})`)}}}showHpHealEffect(t){const s=this.characterX,i=this.characterY-this.characterSize*.3,o=Math.min(8,Math.max(3,Math.floor(t/10)+3));for(let e=0;e<o;e++)this.time.delayedCall(e*40,()=>{this.createHpHealParticle(s,i)})}createHpHealParticle(t,s){const i=Math.random()*Math.PI*2,o=this.characterSize*.4,e=this.characterSize*.25,l=t+Math.cos(i)*o*(.3+Math.random()*.7),n=s+Math.sin(i)*e*(.3+Math.random()*.7),a=this.add.graphics();this.characterContainer.add(a);const c=this.gameBounds.height/10,h=c*(.1+Math.random()*.08),r=c*(.5+Math.random()*.3),d=700+Math.random()*300,y=this.time.now,C=[6702335,8939263,7820782,10057727],g=C[Math.floor(Math.random()*C.length)],k=()=>{const p=this.time.now-y,f=Math.min(p/d,1);a.clear();const w=n-r*f;let m,M;if(f<.2?(m=.6+f*2,M=1-f*5):(m=1-(f-.2)/.8,M=0),m>.01){const x=g>>16&255,b=g>>8&255,P=g&255,T=Math.round(x+(255-x)*M),E=Math.round(b+(255-b)*M),A=Math.round(P+(255-P)*M),B=T<<16|E<<8|A;a.fillStyle(B,m*.9),a.fillRect(l-h/2,w-h/2,h,h),a.lineStyle(1,16777215,m*.7),a.strokeRect(l-h/2,w-h/2,h,h)}f>=1&&a.destroy()};k();const u=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{a.active&&a.destroy(),u.remove()})}takeDamage(t,s=[]){const i=this.skillManager.getSyncRateDodgeChance(this.currentLevel);if(i>0&&Math.random()<i){console.log(`Dodged! (${(i*100).toFixed(1)}% chance)`),this.flashDodgeEffect();return}let e=this.skillManager.calculateFinalDamageTaken(t),l=0;if(this.currentShield>0){const n=this.currentShield>0;if(this.currentShield>=e?(l=e,this.currentShield-=e,e=0):(l=this.currentShield,e-=this.currentShield,this.currentShield=0),n&&this.currentShield===0&&this.maxShield>0){const a=this.maxShield;this.currentHp=Math.min(this.currentHp+a,this.maxHp),console.log(`Shield broken! Healed ${a} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(a)}if(this.drawShieldBarFill(),l>0&&(this.showLegacySkillEffects&&this.flashShieldEffect(),this.flashShieldHitEffect()),this.shieldReflectDamage>0&&s.length>0){const a=s.map(h=>h.id),c=this.monsterManager.damageMonsters(a,this.shieldReflectDamage);c.totalExp>0&&this.addExp(c.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${s.length} monsters, killed ${c.killCount}`)}}e>0?(this.currentHp-=e,this.currentHp<0&&(this.currentHp=0),this.hpDamageDelay=G.HP_DAMAGE_DELAY,this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+G.HURT_DURATION,this.isPointerDown=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${e} damage (${l} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${l} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&(!this.reviveUsed&&this.skillManager.hasTitaniumLiverRevive()?(this.reviveUsed=!0,this.currentHp=this.maxHp,this.displayedHp=this.maxHp,console.log("【不死】觸發！復活並回滿 HP！"),this.triggerShadowExplosion(),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.flashReviveEffect()):console.log("Player died!"))}flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const s=this.characterX,i=this.characterY-this.characterSize/2,o=this.characterSize*1,e=16768324,l=600;let n=this.time.now;const a=()=>{const h=this.time.now-n,r=Math.min(h/l,1);t.clear();const d=.3,C=1-(r<d?0:(r-d)/(1-d));if(C>.01){for(let u=6;u>=1;u--){const p=o*u/6,f=C*(1-(u-1)/6)*.5;f>.01&&(t.fillStyle(e,f),t.fillCircle(s,i,p))}const k=o*.4;t.fillStyle(16777215,C*.8),t.fillCircle(s,i,k),t.lineStyle(5,e,C*.9),t.strokeCircle(s,i,o),t.lineStyle(2,16777215,C*.7),t.strokeCircle(s,i,o*.95)}r>=1&&t.destroy()},c=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),c.remove()})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),s=t.x,i=t.y,o=G.SKILL_GRID_GAP,e=this.skillGridCellSize+o,l=16763904,n=this.gameBounds.height*.2,a=400,c=200,h=this.time.now,r=[],d=Math.max(0,Math.floor((s-n)/e)),y=Math.min(this.skillGridCols-1,Math.ceil((s+n)/e)),C=Math.max(0,Math.floor((i-n)/e)),g=Math.min(this.skillGridRows-1,Math.ceil((i+n)/e));for(let f=C;f<=g;f++)for(let w=d;w<=y;w++){const m=w*e+this.skillGridCellSize/2,M=f*e+this.skillGridCellSize/2,x=m-s,b=M-i,P=Math.sqrt(x*x+b*b);P<=n&&r.push({col:w,row:f,dist:P})}if(r.length===0)return;const k=[];for(const{col:f,row:w}of r){const m=f*e+this.skillGridCellSize/2,M=w*e+this.skillGridCellSize/2,x=this.add.rectangle(m,M,this.skillGridCellSize,this.skillGridCellSize,l,0);x.setVisible(!1),this.skillGridContainer.add(x),k.push(x)}const u=()=>{const f=this.time.now-h,w=Math.min(f/a,1),m=Math.min(f/c,1),M=n*m,x=n*.3,b=Math.max(0,M-x);let P=0;f>c&&(P=(f-c)/(a-c));let T=0;for(const{dist:E}of r){const A=k[T++];if(A)if(E>=b&&E<=M){const B=(b+M)/2,I=Math.abs(E-B),R=x/2,H=I/R,_=.9*(1-H*.5)*(1-P);if(_>.01){if(f<c&&H<.3){const L=l>>16&255,X=l>>8&255,Y=l&255,V=Math.min(255,L+Math.floor((255-L)*.5)),K=Math.min(255,X+Math.floor((255-X)*.5)),U=Math.min(255,Y+Math.floor((255-Y)*.5)),D=V<<16|K<<8|U;A.setFillStyle(D,_)}else A.setFillStyle(l,_);A.setVisible(!0)}else A.setVisible(!1)}else A.setVisible(!1)}if(w>=1)for(const E of k)E.destroy()};u();const p=this.time.addEvent({delay:16,callback:u,callbackScope:this,repeat:Math.ceil(a/16)});this.time.delayedCall(a+50,()=>{p.remove();for(const f of k)f.active&&f.destroy()})}flashCharacter(){this.character.setTint(16777215),this.time.delayedCall(50,()=>{this.character.setTint(16724787)}),this.time.delayedCall(100,()=>{this.character.setTint(16777215)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashDodgeEffect(){this.character.setTint(6737151),this.time.delayedCall(50,()=>{this.character.setTint(16777215)}),this.time.delayedCall(100,()=>{this.character.setTint(6737151)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashReviveEffect(){const t=[6684774,2228258,8913032,4456516,11141290];let s=0;const i=()=>{s<t.length?(this.character.setTint(t[s]),s++,this.time.delayedCall(80,i)):this.character.clearTint()};i()}triggerShadowExplosion(){const s=this.gameBounds.height*.1*5,i=this.monsterManager.getMonsters(),o=[];for(const e of i){const l=e.x-this.characterX,n=e.y-this.characterY,a=Math.sqrt(l*l+n*n),c=this.gameBounds.height*e.definition.size*.5;a-c<=s&&o.push(e.id)}if(o.length>0){const e=i.filter(a=>o.includes(a.id)).map(a=>({x:a.x,y:a.y})),n=this.monsterManager.damageMonsters(o,999999);n.totalExp>0&&this.addExp(n.totalExp),this.flashShadowCrossAtPositions(e),console.log(`【暗影爆炸】秒殺 ${o.length} 隻怪物，獲得 ${n.totalExp} 經驗`)}this.drawShadowExplosionEffect(s),this.drawCircleEdge(s,6684774),this.flashSkillAreaCircle(this.characterX,this.characterY,s,8913032),this.cameras.main.shake(200,.01)}drawShadowExplosionEffect(t){const s=this.add.graphics();this.worldContainer.add(s);const i=this.characterX,o=this.characterY,e=4456516,l=800,n=this.time.now,a=()=>{const h=this.time.now-n,r=Math.min(h/l,1);s.clear();const d=t*r,y=.6*(1-r);y>.01&&(s.fillStyle(e,y),s.fillCircle(i,o,d),s.lineStyle(4,8913032,y*.8),s.strokeCircle(i,o,d)),r>=1&&s.destroy()};a();const c=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{c.remove(),s.active&&s.destroy()})}flashShadowCrossAtPositions(t){t.forEach(s=>{this.flashShadowCrossAt(s.x,s.y)})}flashShadowCrossAt(t,s){const i=this.worldToScreen(t,s),o=G.SKILL_GRID_GAP,e=this.skillGridCellSize+o,l=Math.floor(i.x/e),n=Math.floor(i.y/e),a=l*e+this.skillGridCellSize/2,c=n*e+this.skillGridCellSize/2,h=5,r=500,d=this.time.now,y=Math.random()<.5?1:-1,C=(Math.PI/4+Math.random()*Math.PI/4)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:m,dr:M}of k)for(let x=1;x<=h;x++)g.push({offsetX:m*x*e,offsetY:M*x*e,dist:x});if(g.length===0)return;const u=8913032,p=[];for(let m=0;m<g.length;m++){const M=this.add.rectangle(a,c,this.skillGridCellSize,this.skillGridCellSize,u,0);M.setVisible(!1),this.skillGridContainer.add(M),p.push(M)}const f=()=>{const m=this.time.now-d,M=Math.min(m/r,1),x=C*M,b=Math.cos(x),P=Math.sin(x),T=h*M;for(let E=0;E<g.length;E++){const{offsetX:A,offsetY:B,dist:I}=g[E],R=p[E];if(!R)continue;const H=a+A*b-B*P,F=c+A*P+B*b;if(R.setPosition(H,F),I>=T){const L=1-I/h*.2;let X=1;T>0&&I<T+1&&(X=I-T);const Y=L*Math.max(0,X);Y>.01?(R.setFillStyle(u,Y),R.setVisible(!0)):R.setVisible(!1)}else R.setVisible(!1)}if(M>=1)for(const E of p)E.destroy()};f();const w=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{w.remove();for(const m of p)m.active&&m.destroy()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){console.log(`Vignette initialized (grid: ${this.skillGridCols}x${this.skillGridRows})`)}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const s=Math.floor(t/this.skillGridCols),i=t%this.skillGridCols;if(s===0||s===this.skillGridRows-1||i===0||i===this.skillGridCols-1||s>=1&&s<=3)continue;const o=this.skillGridCells[t];o&&(o.setFillStyle(16777215,0),o.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const s=1500;this.lowHpBreathTimer>=s&&(this.lowHpBreathTimer-=s);const i=this.lowHpBreathTimer/s,o=Math.sin(i*Math.PI*2)*.5+.5;this.drawGridVignette(o)}drawGridVignette(t){const s=.2+t*.2;let i;this.currentShield>0?i=16768324:i=16720418;const o=this.skillGridCols/2,e=this.skillGridRows/2,l=this.skillGridCols/2*2,n=this.skillGridRows/2*2,a=4,c=this.skillGridRows-3;for(let h=a;h<c;h++)for(let r=1;r<this.skillGridCols-1;r++){const d=h*this.skillGridCols+r,y=this.skillGridCells[d];if(!y)continue;const C=(r-o)/l,g=(h-e)/n,k=Math.sqrt(C*C+g*g);if(k>.5){const u=Math.min(1,(k-.5)/.25),p=s*u;p>.01&&(y.setFillStyle(i,p),y.setVisible(!0),this.vignetteEdgeCells.add(d))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(1002);const t=Math.max(G.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.03)),s=this.skillGridCellSize,i=this.gameBounds.y+this.gameBounds.height-s*2;this.levelText=this.add.text(this.gameBounds.x+10,i-5,`Lv.${this.currentLevel}`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setResolution(2),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText),this.uiContainer.add(this.expBarContainer)}drawExpBarFill(){const t=[this.skillGridRows-3,this.skillGridRows-2],s=this.skillGridCols-2;for(const e of t)for(let l=0;l<s;l++){const n=l+1,a=e*this.skillGridCols+n,c=this.skillGridCells[a];c&&(c.setFillStyle(0,.9),c.setVisible(!0),c.setDepth(1e3))}const i=this.currentExp/this.maxExp,o=Math.floor(s*i);if(!(o<=0))for(const e of t)for(let l=0;l<o;l++){const n=l+1,a=e*this.skillGridCols+n,c=this.skillGridCells[a];if(!c)continue;const h=l/s,r=this.expBarFlowOffset,d=(h+r)%1,y=(Math.sin(d*Math.PI*2-Math.PI/2)+1)/2,C=Math.floor(68+68*y),g=Math.floor(136-68*y),u=C<<16|g<<8|255,p=e===this.skillGridRows-2?.95:.8;c.setFillStyle(u,p)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawBorderFrame(){for(let i=0;i<this.skillGridCols;i++){const o=0*this.skillGridCols+i,e=this.skillGridCells[o];e&&(e.setFillStyle(3355443,.95),e.setVisible(!0),e.setDepth(1001))}for(let i=0;i<this.skillGridCols;i++){const o=(this.skillGridRows-1)*this.skillGridCols+i,e=this.skillGridCells[o];e&&(e.setFillStyle(3355443,.95),e.setVisible(!0),e.setDepth(1001))}for(let i=1;i<this.skillGridRows-1;i++){const o=i*this.skillGridCols+0,e=this.skillGridCells[o];e&&(e.setFillStyle(3355443,.95),e.setVisible(!0),e.setDepth(1001))}for(let i=1;i<this.skillGridRows-1;i++){const o=i*this.skillGridCols+(this.skillGridCols-1),e=this.skillGridCells[o];e&&(e.setFillStyle(3355443,.95),e.setVisible(!0),e.setDepth(1001))}}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,s=Math.ceil(this.mapWidth/t),i=Math.ceil(this.mapHeight/t);for(let n=0;n<i;n++)for(let a=0;a<s;a++){const c=a*t,h=n*t;(n+a)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(c,h,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(c,h,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const o=this.mapWidth/2,e=this.mapHeight/2,l=t;this.floorGrid.strokeRect(o-l/2,e-l/2,l,l);for(let n=0;n<i;n+=5)for(let a=0;a<s;a+=5){const c=a*t+t/2,h=n*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(c,h,4)}}createSkillBar(){const t=this.skillGridCellSize,s=G.SKILL_GRID_GAP,i=8,o=i*(t+s)-s,e=1,l=2,n=G.ACTIVE_SKILLS,a=G.PASSIVE_SKILLS,c=n*i+(n-1)*e,h=a*i+(a-1)*e,d=(c+l+h)*(t+s)-s,y=this.gameBounds.x+(this.gameBounds.width-d)/2,C=2*(t+s),g=t+s,k=this.gameBounds.y+this.gameBounds.height-C-o-g;let u=y;for(let p=0;p<n;p++){const f=u+o/2,w=k+o/2,m=this.add.container(f,w),M=this.add.rectangle(0,0,o,o);M.setStrokeStyle(0,16777215,0),M.setFillStyle(0,0),m.add(M);const x=this.add.rectangle(0,0,o-4,o-4,3355443,0);m.add(x);const b=Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(o*.2)),P=this.add.text(0,o*.3,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${b}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});P.setResolution(2),P.setOrigin(.5,.5),m.add(P),this.skillIcons.push(M),this.skillIconContainers.push(m),this.skillLevelTexts.push(P),m.setDepth(1002),this.uiContainer.add(m),this.drawSkillIconGrid(u,k,i,p),u+=o+e*(t+s)}u+=(l-e)*(t+s);for(let p=0;p<a;p++){const f=u+o/2,w=k+o/2,m=this.add.container(f,w),M=this.add.rectangle(0,0,o,o);M.setStrokeStyle(0,16777215,0),M.setFillStyle(0,0),m.add(M);const x=this.add.rectangle(0,0,o-4,o-4,3355443,0);m.add(x);const b=Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(o*.2)),P=this.add.text(0,o*.3,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${b}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});P.setResolution(2),P.setOrigin(.5,.5),m.add(P),this.skillIcons.push(M),this.skillIconContainers.push(m),this.skillLevelTexts.push(P),m.setDepth(1002),this.uiContainer.add(m),this.drawSkillIconGrid(u,k,i,n+p),u+=o+e*(t+s)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}drawSkillIconGrid(t,s,i,o){const e=this.add.graphics();e.setDepth(1001),this.uiContainer.add(e),this.skillIconGridData[o]={startX:t,startY:s,gridSize:i},this.redrawSkillIconGrid(o,0),this.skillIconGridGraphics[o]=e}redrawSkillIconGrid(t,s){const i=this.skillIconGridGraphics[t],o=this.skillIconGridData[t];if(!i||!o)return;i.clear();const e=this.skillGridCellSize,l=G.SKILL_GRID_GAP,{startX:n,startY:a,gridSize:c}=o,h=G.ACTIVE_SKILLS,r=t<h,d=r?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),y=r?t:t-h;if(!d[y]){i.fillStyle(0,.5);for(let f=0;f<c;f++)for(let w=0;w<c;w++){const m=n+w*(e+l),M=a+f*(e+l);i.fillRect(m,M,e,e)}return}const g=[],k=Math.floor(c/2);for(let f=k;f<c;f++)g.push({row:0,col:f});for(let f=1;f<c;f++)g.push({row:f,col:c-1});for(let f=c-2;f>=0;f--)g.push({row:c-1,col:f});for(let f=c-2;f>=1;f--)g.push({row:f,col:0});g.push({row:0,col:0});for(let f=1;f<k;f++)g.push({row:0,col:f});const u=g.length,p=Math.floor(u*s);for(let f=0;f<u;f++){const{row:w,col:m}=g[f],M=n+m*(e+l),x=a+w*(e+l);if(f<p){const b=this.getSkillColorForIndex(t);i.fillStyle(b,.4)}else i.fillStyle(0,.5);i.fillRect(M,x,e,e)}}getSkillColorForIndex(t){const s=G.ACTIVE_SKILLS,i=t<s,o=i?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),e=i?t:t-s,l=o[e];return l?l.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,s=this.skillManager.getPlayerActiveSkills();for(let e=0;e<s.length;e++){const l=s[e];if(!l){this.redrawSkillIconGrid(e,0);continue}const n=l.definition;let a=n.cooldown||1e3;n.id==="active_architect"&&(a=a-l.level*500);const c=this.skillManager.calculateFinalCooldown(a),h=this.skillCooldowns.get(n.id)||0,r=t-h;if(r>=c)this.redrawSkillIconGrid(e,1);else{const d=r/c;this.redrawSkillIconGrid(e,d)}}const i=this.skillManager.getPlayerPassiveSkills(),o=G.ACTIVE_SKILLS;for(let e=0;e<i.length;e++){const l=i[e];if(!l){this.redrawSkillIconGrid(o+e,0);continue}const n=l.definition;let a=1;switch(n.id){case"passive_titanium_liver":{const c=this.skillManager.getTitaniumLiverRegenInterval();c>0&&this.currentHp<this.maxHp&&(a=this.hpRegenTimer/c);break}}this.redrawSkillIconGrid(o+e,a)}}createSkillInfoPanel(){const t=this.gameBounds,s=200,i=80,o=t.width*.05,e=t.x+o,l=t.y+t.height-i-o-60;this.skillInfoPanel=this.add.container(e,l),this.skillInfoPanel.setDepth(1003),this.skillInfoBg=this.add.rectangle(0,0,s,i,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg);const n=10,a=Math.max(G.MIN_FONT_SIZE_SMALL,12);this.skillInfoText=this.add.text(n,n,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${a}px`,color:"#ffffff",wordWrap:{width:s-n*2}}),this.skillInfoText.setResolution(2),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=G.ACTIVE_SKILLS;for(let s=0;s<this.skillIconContainers.length;s++){const i=this.skillIconContainers[s],o=s<t,e=o?s:s-t;i.setSize(i.getBounds().width,i.getBounds().height),i.setInteractive({useHandCursor:!0}),i.on("pointerdown",()=>{this.showSkillInfo(o,e)})}}showSkillInfo(t,s){const o=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[s];if(!o){this.skillInfoPanel.setVisible(!1);return}const e=[];e.push(`【${o.definition.name}】${nt.formatLevel(o.level,o.definition.maxLevel)}`),t?this.appendActiveSkillInfo(e,o):this.appendPassiveSkillInfo(e,o),this.skillInfoText.setText(e.join(`
`));const l=this.skillInfoText.getBounds(),n=10;this.skillInfoBg.setSize(Math.max(180,l.width+n*2),l.height+n*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,s){const i=s.level,o=this.skillManager.getAiEnhancementDamageBonus(),e=this.skillManager.getSyncRateCooldownReduction();switch(s.definition.id){case"active_soul_render":{const l=60+i*10,n=2+i,a=G.DAMAGE_UNIT*n,c=Math.floor(a*(1+o)),r=((s.definition.cooldown||1e3)*(1-e)/1e3).toFixed(1);t.push(`扇形角度: ${l}°`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_coder":{const l=2+i*.5,n=1+i,a=G.DAMAGE_UNIT*n,c=Math.floor(a*(1+o)),r=((s.definition.cooldown||1500)*(1-e)/1e3).toFixed(1);t.push(`範圍: ${l} 單位`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_vfx":{const l=i+1,n=1+i,a=G.DAMAGE_UNIT*n,c=Math.floor(a*(1+o)),r=((s.definition.cooldown||2500)*(1-e)/1e3).toFixed(1);t.push(`光束數: ${l} 道`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_architect":{const n=Math.floor(this.maxHp*.3),a=1+i*1.5,c=G.DAMAGE_UNIT*a,r=((s.definition.cooldown||1e4)*(1-e)/1e3).toFixed(1);t.push(`護盾: ${n} (霸體)`),t.push(`反傷: ${c}`),t.push(`回血: ${n}`),t.push(`冷卻: ${r}s`);break}}this.appendMaxExtraAbility(t,s)}appendMaxExtraAbility(t,s){const i=this.skillManager.getMaxExtraAbilityText(s.definition.id,this.currentLevel);i&&(t.push(""),t.push(i))}appendPassiveSkillInfo(t,s){switch(s.definition.id){case"passive_titanium_liver":{const i=this.skillManager.getTitaniumLiverHpBonus(),o=this.skillManager.getTitaniumLiverRegenInterval()/1e3;if(t.push(`HP 加成: +${Math.round(i*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${o} 秒 +1% HP`),this.skillManager.hasTitaniumLiverRevive()){const e=this.reviveUsed?"(已使用)":"(待命)";t.push(`【不死】抵銷一次死亡 ${e}`)}break}case"passive_sync_rate":{const i=this.skillManager.getSyncRateSpeedBonus(),o=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(i*100)}%`),t.push(`冷卻減少: -${Math.round(o*100)}%`);break}case"passive_retina_module":{const i=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(i*100)}%`);break}case"passive_ai_enhancement":{const i=this.skillManager.getAiEnhancementDamageBonus(),o=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(i*100)}%`),t.push(`防禦加成: +${Math.round(o*100)}%`);break}}this.appendMaxExtraAbility(t,s)}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),s=this.skillManager.getPlayerPassiveSkills(),i=[...t,...s];for(let o=0;o<this.skillIconContainers.length;o++){const e=this.skillIconContainers[o],l=this.skillLevelTexts[o],n=i[o],a=e.list[1];n?(a.setFillStyle(n.definition.color,.5),l.setText(nt.formatLevel(n.level,n.definition.maxLevel))):(a.setFillStyle(3355443,0),l.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,s=!1){this.characterState!==t&&(this.isHurt&&!s&&t!=="hurt"||this.isAttacking&&!s&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const s=this.gameBounds.y+this.gameBounds.height*.12,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,s,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});i.setResolution(2),i.setOrigin(.5,.5),this.skillPanelContainer.add(i);const o=s+this.gameBounds.height*.06,e=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});e.setResolution(2),e.setOrigin(.5,.5),this.skillPanelContainer.add(e),this.createSkillOptions();const l=this.gameBounds.y+this.gameBounds.height*.92,n=this.isMobile?"點兩次確認":"重複按同一鍵確認",a=this.add.text(this.gameBounds.x+this.gameBounds.width/2,l,n,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});a.setResolution(2),a.setOrigin(.5,.5),this.skillPanelContainer.add(a)}createSkillCutIn(){this.skillCutInContainer=this.add.container(0,0),this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setDepth(1e3),this.uiContainer.add(this.skillCutInContainer)}showSkillCutIn(t,s){this.skillCutInContainer.removeAll(!0);const i=this.gameBounds.height*.12,o=this.gameBounds.y+this.gameBounds.height*.25,e=this.gameBounds.width*.15,l=this.gameBounds.width-e*2,n=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,o,l,i,0,.75);this.skillCutInContainer.add(n);const a=this.add.graphics(),c=this.gameBounds.x,h=this.gameBounds.x+e,r=20;for(let b=0;b<r;b++){const P=b/r*.75,T=c+e/r*b,E=e/r+1;a.fillStyle(0,P),a.fillRect(T,o-i/2,E,i)}this.skillCutInContainer.add(a);const d=this.add.graphics(),y=this.gameBounds.x+this.gameBounds.width-e;for(let b=0;b<r;b++){const P=(1-b/r)*.75,T=y+e/r*b,E=e/r+1;d.fillStyle(0,P),d.fillRect(T,o-i/2,E,i)}this.skillCutInContainer.add(d);const C=3,g=this.add.graphics(),k=o-i/2-C/2;for(let b=0;b<r;b++){const P=b/r*.8,T=c+e/r*b,E=e/r+1;g.fillStyle(t.color,P),g.fillRect(T,k,E,C)}g.fillStyle(t.color,.8),g.fillRect(h,k,l,C);for(let b=0;b<r;b++){const P=(1-b/r)*.8,T=y+e/r*b,E=e/r+1;g.fillStyle(t.color,P),g.fillRect(T,k,E,C)}this.skillCutInContainer.add(g);const u=this.add.graphics(),p=o+i/2-C/2;for(let b=0;b<r;b++){const P=b/r*.8,T=c+e/r*b,E=e/r+1;u.fillStyle(t.color,P),u.fillRect(T,p,E,C)}u.fillStyle(t.color,.8),u.fillRect(h,p,l,C);for(let b=0;b<r;b++){const P=(1-b/r)*.8,T=y+e/r*b,E=e/r+1;u.fillStyle(t.color,P),u.fillRect(T,p,E,C)}this.skillCutInContainer.add(u);const f=s>=t.maxLevel?"MAX":`Lv.${s}`,w=`${t.name} 提升到 ${f}`,m=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o-i*.18,w,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_LARGE,Math.floor(i*.35))}px`,color:"#ffffff",fontStyle:"bold"});m.setResolution(2),m.setOrigin(.5,.5),this.skillCutInContainer.add(m);let M=t.description;t.levelUpMessages&&t.levelUpMessages[s]&&(M=t.levelUpMessages[s]);const x=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o+i*.22,M,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.22))}px`,color:O.Display.Color.IntegerToColor(t.color).rgba});x.setResolution(2),x.setOrigin(.5,.5),this.skillCutInContainer.add(x),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(1500,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0)}})})}})}createSkillOptions(){if(this.skillOptions.forEach(c=>c.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,s=this.gameBounds.height*(this.isMobile?.55:.5),i=this.gameBounds.width*.05,o=this.currentSkillChoices.length,e=t*o+i*(o-1),l=this.gameBounds.x+(this.gameBounds.width-e)/2+t/2,n=this.gameBounds.y+this.gameBounds.height*.55,a=["A","S","D"];for(let c=0;c<this.currentSkillChoices.length;c++){const h=this.currentSkillChoices[c],r=this.skillManager.getSkillLevel(h.id),d=r<0,y=d?"-":r,C=d?0:r+1,g=l+c*(t+i),k=this.add.container(g,n),u=this.add.rectangle(0,0,t,s,2236962);u.setStrokeStyle(2,6710886),k.add(u);const p=this.add.text(0,-s*.42,h.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(s*.045))}px`,color:h.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});p.setResolution(2),p.setOrigin(.5,.5),k.add(p);const f=t*.5,w=-s*.18,m=this.add.rectangle(0,w,f,f,h.color,.3);m.setStrokeStyle(2,h.color),k.add(m);const M=s*.06,x=this.add.text(0,M,h.name,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(x.setResolution(2),x.setOrigin(.5,.5),k.add(x),h.subtitle){const B=this.add.text(0,s*.12,h.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(s*.04))}px`,color:"#999999"});B.setResolution(2),B.setOrigin(.5,.5),k.add(B)}let b;C>=h.maxLevel?b=`Lv.${y} → MAX`:d?b=`NEW → Lv.${C}`:b=`Lv.${y} → Lv.${C}`;const P=this.add.text(0,s*.2,b,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(s*.05))}px`,color:C>=h.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});P.setResolution(2),P.setOrigin(.5,.5),k.add(P);const T=this.isMobile?s*.36:s*.32,E=this.add.text(0,T,h.description,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(G.MIN_FONT_SIZE_SMALL,Math.floor(s*.04))}px`,color:"#dddddd",wordWrap:{width:t*.85},align:"center"});if(E.setResolution(2),E.setOrigin(.5,0),k.add(E),!this.isMobile){const B=this.add.text(0,s*.42,`[ ${a[c]} ]`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(G.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.06))}px`,color:"#ffff00",fontStyle:"bold"});B.setResolution(2),B.setOrigin(.5,.5),k.add(B)}u.setInteractive({useHandCursor:!0});const A=c;u.on("pointerover",()=>{this.setSelectedSkill(A)}),u.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===A?this.confirmSkillSelection():this.setSelectedSkill(A):(this.setSelectedSkill(A),this.confirmSkillSelection())}),this.skillPanelContainer.add(k),this.skillOptions.push(k),this.skillCardBgs.push(u)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out! Continue leveling for HP growth.");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isPointerDown=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,s)=>{s===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,s)=>{t.setScale(s===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:s*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,s){const i=this.currentSkillChoices[t];if(!this.skillManager.learnOrUpgradeSkill(s)){console.warn(`Failed to learn/upgrade skill: ${s}`);return}const e=this.skillManager.getPlayerSkill(s),l=(e==null?void 0:e.level)??0;console.log(`Skill upgraded: ${s} -> Lv.${l}`),this.updateSkillBarDisplay(),(e==null?void 0:e.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const n=this.skillOptions[t];this.tweens.add({targets:n,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel(),this.showSkillCutIn(i,l)}})}createSkillGrid(){const t=this.cameras.main.width,s=1920,i=20/this.gridScaleMultiplier,o=6/this.gridScaleMultiplier,e=Math.min(1,t/s);this.skillGridCellSize=Math.max(o,Math.floor(i*e));const l=G.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+l)/(this.skillGridCellSize+l)),this.skillGridRows=Math.ceil((this.gameBounds.height+l)/(this.skillGridCellSize+l)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(3);for(let n=0;n<this.skillGridRows;n++)for(let a=0;a<this.skillGridCols;a++){const c=a*(this.skillGridCellSize+l)+this.skillGridCellSize/2,h=n*(this.skillGridCellSize+l)+this.skillGridCellSize/2,r=this.add.rectangle(c,h,this.skillGridCellSize,this.skillGridCellSize,16777215,0);r.setVisible(!1),this.skillGridCells.push(r),this.skillGridContainer.add(r)}this.drawBorderFrame()}recreateSkillGrid(){this.skillGridCells.forEach(t=>t.destroy()),this.skillGridCells=[],this.skillGridContainer&&this.skillGridContainer.destroy(),this.createSkillGrid(),this.recreateSkillBar(),this.bringUIToTop()}bringUIToTop(){this.characterContainer&&this.uiContainer.bringToTop(this.characterContainer),this.hpBarContainer&&this.uiContainer.bringToTop(this.hpBarContainer),this.shieldText&&this.uiContainer.bringToTop(this.shieldText),this.expBarContainer&&this.uiContainer.bringToTop(this.expBarContainer),this.skillIconContainers.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillIconGridGraphics.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillInfoPanel&&this.uiContainer.bringToTop(this.skillInfoPanel),this.skillPanelContainer&&this.uiContainer.bringToTop(this.skillPanelContainer)}recreateSkillBar(){this.skillIcons.forEach(t=>t.destroy()),this.skillIcons=[],this.skillIconContainers.forEach(t=>t.destroy()),this.skillIconContainers=[],this.skillLevelTexts.forEach(t=>t.destroy()),this.skillLevelTexts=[],this.skillIconGridGraphics.forEach(t=>t.destroy()),this.skillIconGridGraphics=[],this.skillIconGridData=[],this.skillInfoPanel&&this.skillInfoPanel.destroy(),this.createSkillBar()}worldToScreen(t,s){return{x:t-this.cameraOffsetX,y:s-this.cameraOffsetY}}showSkillRangeCircle(t,s,i,o,e=.3){const l=this.worldToScreen(t,s),n=l.x,a=l.y,c=G.SKILL_GRID_GAP,h=this.skillGridCellSize+c,r=Math.max(0,Math.floor((n-i)/h)),d=Math.min(this.skillGridCols-1,Math.ceil((n+i)/h)),y=Math.max(0,Math.floor((a-i)/h)),C=Math.min(this.skillGridRows-1,Math.ceil((a+i)/h));for(let g=y;g<=C;g++)for(let k=r;k<=d;k++){const u=k*h+this.skillGridCellSize/2,p=g*h+this.skillGridCellSize/2,f=u-n,w=p-a;if(Math.sqrt(f*f+w*w)<=i){const M=g*this.skillGridCols+k,x=this.skillGridCells[M];x&&(x.setFillStyle(o,e),x.setVisible(!0))}}}showSkillRangeSector(t,s,i,o,e,l,n=.3){const a=this.worldToScreen(t,s),c=a.x,h=a.y,r=G.SKILL_GRID_GAP,d=this.skillGridCellSize+r,y=Math.max(0,Math.floor((c-i)/d)),C=Math.min(this.skillGridCols-1,Math.ceil((c+i)/d)),g=Math.max(0,Math.floor((h-i)/d)),k=Math.min(this.skillGridRows-1,Math.ceil((h+i)/d));for(let u=g;u<=k;u++)for(let p=y;p<=C;p++){const f=p*d+this.skillGridCellSize/2,w=u*d+this.skillGridCellSize/2,m=f-c,M=w-h,x=Math.sqrt(m*m+M*M);if(x<=i&&x>0){const b=Math.atan2(M,m);let P=Math.abs(b-o);if(P>Math.PI&&(P=2*Math.PI-P),P<=e){const T=u*this.skillGridCols+p,E=this.skillGridCells[T];E&&(E.setFillStyle(l,n),E.setVisible(!0))}}}}showSkillRangeLine(t,s,i,o,e,l,n=.3){const a=this.worldToScreen(t,s),c=this.worldToScreen(i,o),h=G.SKILL_GRID_GAP,r=this.skillGridCellSize+h,d=c.x-a.x,y=c.y-a.y,C=Math.sqrt(d*d+y*y);if(C===0)return;const g=d/C,k=y/C,u=-k,p=g,f=e/2,w=[{x:a.x+u*f,y:a.y+p*f},{x:a.x-u*f,y:a.y-p*f},{x:c.x+u*f,y:c.y+p*f},{x:c.x-u*f,y:c.y-p*f}],m=Math.min(...w.map(B=>B.x)),M=Math.max(...w.map(B=>B.x)),x=Math.min(...w.map(B=>B.y)),b=Math.max(...w.map(B=>B.y)),P=Math.max(0,Math.floor(m/r)),T=Math.min(this.skillGridCols-1,Math.ceil(M/r)),E=Math.max(0,Math.floor(x/r)),A=Math.min(this.skillGridRows-1,Math.ceil(b/r));for(let B=E;B<=A;B++)for(let I=P;I<=T;I++){const R=I*r+this.skillGridCellSize/2,H=B*r+this.skillGridCellSize/2,F=Math.max(0,Math.min(1,((R-a.x)*g+(H-a.y)*k)/C)),_=a.x+F*d,L=a.y+F*y;if(Math.sqrt((R-_)**2+(H-L)**2)<=f){const Y=B*this.skillGridCols+I,V=this.skillGridCells[Y];V&&(V.setFillStyle(l,n),V.setVisible(!0))}}}clearSkillGrid(){this.skillGridCells.forEach((t,s)=>{if(this.vignetteEdgeCells.has(s)&&(this.isLowHp||this.currentShield>0))return;const i=Math.floor(s/this.skillGridCols),o=s%this.skillGridCols;i===0||i===this.skillGridRows-1||o===0||o===this.skillGridCols-1||i>=1&&i<=3||i>=this.skillGridRows-3||t.setVisible(!1)})}flashGridAt(t,s,i,o=1){const e=this.worldToScreen(t,s),l=G.SKILL_GRID_GAP,n=this.skillGridCellSize+l,a=Math.floor(e.x/n),c=Math.floor(e.y/n),h=600,r=200,d=this.time.now,y=[];for(let k=-o;k<=o;k++)for(let u=-o;u<=o;u++){const p=a+u,f=c+k;if(p<0||p>=this.skillGridCols||f<0||f>=this.skillGridRows)continue;const w=Math.sqrt(k*k+u*u);if(w<=o){const m=f*this.skillGridCols+p,M=this.skillGridCells[m];M&&y.push({cell:M,dist:w})}}if(y.length===0)return;const C=()=>{const k=this.time.now-d,u=Math.min(k/h,1);let p=0;k>r&&(p=(k-r)/(h-r));for(const{cell:f,dist:w}of y){const m=w/Math.max(o,1),x=(1-m*.4)*(1-p);if(x>.01)if(k<r){const P=(1-m)*.5;if(f.setFillStyle(i,x),f.setVisible(!0),w<o*.5){const T=i>>16&255,E=i>>8&255,A=i&255,B=Math.min(255,T+Math.floor((255-T)*P)),I=Math.min(255,E+Math.floor((255-E)*P)),R=Math.min(255,A+Math.floor((255-A)*P)),H=B<<16|I<<8|R;f.setFillStyle(H,x)}}else f.setFillStyle(i,x),f.setVisible(!0);else f.setVisible(!1)}if(u>=1)for(const{cell:f}of y)f.setVisible(!1),f.setAlpha(1)};C();const g=this.time.addEvent({delay:16,callback:C,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{g.remove();for(const{cell:k}of y)k.setVisible(!1),k.setAlpha(1)})}flashGridAtPositions(t,s,i=1){t.forEach(o=>{this.flashGridAt(o.x,o.y,s,i)})}flashWhiteCrossAt(t,s){const i=this.worldToScreen(t,s),o=G.SKILL_GRID_GAP,e=this.skillGridCellSize+o,l=Math.floor(i.x/e),n=Math.floor(i.y/e),a=l*e+this.skillGridCellSize/2,c=n*e+this.skillGridCellSize/2,h=3,r=300,d=this.time.now,y=Math.random()<.5?1:-1,C=(Math.PI/9+Math.random()*Math.PI/6)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:w,dr:m}of k)for(let M=1;M<=h;M++)g.push({offsetX:w*M*e,offsetY:m*M*e,dist:M});if(g.length===0)return;const u=[];for(let w=0;w<g.length;w++){const m=this.add.rectangle(a,c,this.skillGridCellSize,this.skillGridCellSize,16777215,0);m.setVisible(!1),this.skillGridContainer.add(m),u.push(m)}const p=()=>{const w=this.time.now-d,m=Math.min(w/r,1),M=C*m,x=Math.cos(M),b=Math.sin(M),P=h*m;for(let T=0;T<g.length;T++){const{offsetX:E,offsetY:A,dist:B}=g[T],I=u[T];if(!I)continue;const R=a+E*x-A*b,H=c+E*b+A*x;if(I.setPosition(R,H),B>=P){const _=1-B/h*.5;let L=1;P>0&&B<P+1&&(L=B-P);const X=_*Math.max(0,L);X>.01?(I.setFillStyle(16777215,X),I.setVisible(!0)):I.setVisible(!1)}else I.setVisible(!1)}if(m>=1)for(const T of u)T.destroy()};p();const f=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{f.remove();for(const w of u)w.active&&w.destroy()})}flashCritCrossAt(t,s){const i=this.worldToScreen(t,s),o=G.SKILL_GRID_GAP,e=this.skillGridCellSize+o,l=Math.floor(i.x/e),n=Math.floor(i.y/e),a=l*e+this.skillGridCellSize/2,c=n*e+this.skillGridCellSize/2,h=4,r=400,d=this.time.now,y=Math.random()<.5?1:-1,C=(Math.PI/6+Math.random()*Math.PI/6)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:m,dr:M}of k)for(let x=1;x<=h;x++)g.push({offsetX:m*x*e,offsetY:M*x*e,dist:x});if(g.length===0)return;const u=16746496,p=[];for(let m=0;m<g.length;m++){const M=this.add.rectangle(a,c,this.skillGridCellSize,this.skillGridCellSize,u,0);M.setVisible(!1),this.skillGridContainer.add(M),p.push(M)}const f=()=>{const m=this.time.now-d,M=Math.min(m/r,1),x=C*M,b=Math.cos(x),P=Math.sin(x),T=h*M;for(let E=0;E<g.length;E++){const{offsetX:A,offsetY:B,dist:I}=g[E],R=p[E];if(!R)continue;const H=a+A*b-B*P,F=c+A*P+B*b;if(R.setPosition(H,F),I>=T){const L=1-I/h*.3;let X=1;T>0&&I<T+1&&(X=I-T);const Y=L*Math.max(0,X);Y>.01?(R.setFillStyle(u,Y),R.setVisible(!0)):R.setVisible(!1)}else R.setVisible(!1)}if(M>=1)for(const E of p)E.destroy()};f();const w=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{w.remove();for(const m of p)m.active&&m.destroy()})}flashWhiteCrossAtPositions(t){t.forEach(s=>{this.flashWhiteCrossAt(s.x,s.y)})}flashCritCrossAtPositions(t){t.forEach(s=>{this.flashCritCrossAt(s.x,s.y)})}flashDeathEffect(t,s){const i=this.worldToScreen(t,s),o=G.SKILL_GRID_GAP,e=this.skillGridCellSize+o,l=Math.floor(i.x/e),n=Math.floor(i.y/e),a=3,c=400,h=this.time.now,r=[];for(let p=0;p<a;p++){const f=Math.random()*Math.PI*2,w=2+Math.random()*2;r.push({col:l+Math.round(Math.cos(f)*w),row:n+Math.round(Math.sin(f)*w),radius:3+Math.floor(Math.random()*3)})}const d=new Map;for(const p of r){const f=p.radius;for(let w=-f;w<=f;w++)for(let m=-f;m<=f;m++){const M=Math.sqrt(w*w+m*m);if(M<=f){const x=p.col+m,b=p.row+w;if(x>=0&&x<this.skillGridCols&&b>=0&&b<this.skillGridRows){const P=`${x},${b}`,T=d.get(P);(!T||M<T.dist)&&d.set(P,{col:x,row:b,dist:M})}}}}const y=Array.from(d.values());if(y.length===0)return;const C=Math.max(...y.map(p=>p.dist)),g=[];for(const{col:p,row:f,dist:w}of y){const m=p*e+this.skillGridCellSize/2,M=f*e+this.skillGridCellSize/2,x=this.add.rectangle(m,M,this.skillGridCellSize,this.skillGridCellSize,16777215,0);x.setVisible(!1),this.skillGridContainer.add(x),g.push({rect:x,dist:w})}const k=()=>{const p=this.time.now-h,f=Math.min(p/c,1);for(const{rect:w,dist:m}of g){const M=m/(C+1),x=M+.5;let b=0;if(f>=M&&f<=x&&(f<M+.1?b=(f-M)/.1:b=1-(f-M-.1)/(x-M-.1),b=Math.max(0,Math.min(.8,b))),b>.01){const P=200+Math.floor(Math.random()*55),T=P<<16|P<<8|P;w.setFillStyle(T,b),w.setVisible(!0)}else w.setVisible(!1)}if(f>=1)for(const{rect:w}of g)w.destroy()};k();const u=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{u.remove();for(const{rect:p}of g)p.active&&p.destroy()})}flashSkillAreaSector(t,s,i,o,e,l){const n=t,a=s,c=G.SKILL_GRID_GAP,h=this.skillGridCellSize+c,r=500,d=150,y=150,C=this.time.now,g=[],k=n-i,u=n+i,p=a-i,f=a+i;for(let x=p;x<=f;x+=h)for(let b=k;b<=u;b+=h){const P=Math.round(b/h)*h,T=Math.round(x/h)*h,E=P-n,A=T-a,B=Math.sqrt(E*E+A*A);if(B<=i&&B>0){const I=Math.atan2(A,E);let R=Math.abs(I-o);R>Math.PI&&(R=2*Math.PI-R),R<=e&&g.push({worldX:P,worldY:T,dist:B,angleDist:R})}}if(g.length===0)return;const w=[];for(const{worldX:x,worldY:b}of g){const P=this.add.rectangle(x,b,this.skillGridCellSize,this.skillGridCellSize,l,0);P.setVisible(!1),P.setDepth(50),this.worldContainer.add(P),w.push(P)}const m=()=>{const x=this.time.now-C,b=Math.min(x/r,1),P=Math.min(x/d,1),T=i*P;let E=0;x>d+y&&(E=(x-d-y)/(r-d-y));const A=i*E;let B=0;for(const{dist:I,angleDist:R}of g){const H=w[B++];if(H)if(I<=T&&I>=A){const F=I/i,_=R/e,Y=Math.max(F,_),V=Math.max(0,Math.min(1,(Y-.3)/.7)),K=V*V*(3-2*V),U=.15+K*.6;let D=1;if(A>0){const $=i*.15;I<A+$&&(D=(I-A)/$)}const z=U*D;if(z>.01){const $=.5+K*.5,W=l>>16&255,N=l>>8&255,Z=l&255;let q=W,j=N,J=Z;if(Y>.85&&x<d+y){const at=(Y-.85)/.15;q=Math.min(255,W+Math.floor((255-W)*at*.3)),j=Math.min(255,N+Math.floor((255-N)*at*.3)),J=Math.min(255,Z+Math.floor((255-Z)*at*.3))}else q=Math.floor(W*$),j=Math.floor(N*$),J=Math.floor(Z*$);const et=q<<16|j<<8|J;H.setFillStyle(et,z),H.setVisible(!0)}else H.setVisible(!1)}else H.setVisible(!1)}if(b>=1)for(const I of w)I.destroy()};m();const M=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{M.remove();for(const x of w)x.active&&x.destroy()})}flashSkillAreaCircle(t,s,i,o){const e=t,l=s,n=G.SKILL_GRID_GAP,a=this.skillGridCellSize+n,c=500,h=150,r=150,d=this.time.now,y=[],C=e-i,g=e+i,k=l-i,u=l+i;for(let m=k;m<=u;m+=a)for(let M=C;M<=g;M+=a){const x=Math.round(M/a)*a,b=Math.round(m/a)*a,P=x-e,T=b-l,E=Math.sqrt(P*P+T*T);E<=i&&y.push({worldX:x,worldY:b,dist:E})}if(y.length===0)return;const p=[];for(const{worldX:m,worldY:M}of y){const x=this.add.rectangle(m,M,this.skillGridCellSize,this.skillGridCellSize,o,0);x.setVisible(!1),x.setDepth(50),this.worldContainer.add(x),p.push(x)}const f=()=>{const m=this.time.now-d,M=Math.min(m/c,1),x=Math.min(m/h,1),b=i*x;let P=0;m>h+r&&(P=(m-h-r)/(c-h-r));const T=i*P;let E=0;for(const{dist:A}of y){const B=p[E++];if(B)if(A<=b&&A>=T){const I=A/i,R=Math.max(0,Math.min(1,(I-.3)/.7)),H=R*R*(3-2*R),F=.15+H*.6;let _=1;if(T>0){const X=i*.15;A<T+X&&(_=(A-T)/X)}const L=F*_;if(L>.01){const X=.5+H*.5,Y=o>>16&255,V=o>>8&255,K=o&255;let U=Y,D=V,z=K;if(I>.85&&m<h+r){const W=(I-.85)/.15;U=Math.min(255,Y+Math.floor((255-Y)*W*.3)),D=Math.min(255,V+Math.floor((255-V)*W*.3)),z=Math.min(255,K+Math.floor((255-K)*W*.3))}else U=Math.floor(Y*X),D=Math.floor(V*X),z=Math.floor(K*X);const $=U<<16|D<<8|z;B.setFillStyle($,L),B.setVisible(!0)}else B.setVisible(!1)}else B.setVisible(!1)}if(M>=1)for(const A of p)A.destroy()};f();const w=this.time.addEvent({delay:16,callback:f,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{w.remove();for(const m of p)m.active&&m.destroy()})}flashSkillAreaLine(t,s,i,o,e,l){const n=t,a=s,c=i,h=o,r=G.SKILL_GRID_GAP,d=this.skillGridCellSize+r,y=c-n,C=h-a,g=Math.sqrt(y*y+C*C);if(g===0)return;const k=y/g,u=C/g,p=-u,f=k,w=e/2,m=800,M=80,x=300,b=m-M-x,P=this.time.now,T=[],E=[{x:n+p*w,y:a+f*w},{x:n-p*w,y:a-f*w},{x:c+p*w,y:h+f*w},{x:c-p*w,y:h-f*w}],A=Math.min(...E.map(L=>L.x)),B=Math.max(...E.map(L=>L.x)),I=Math.min(...E.map(L=>L.y)),R=Math.max(...E.map(L=>L.y));for(let L=I;L<=R;L+=d)for(let X=A;X<=B;X+=d){const Y=Math.round(X/d)*d,V=Math.round(L/d)*d,K=Y-n,U=V-a,D=K*k+U*u;if(D<0||D>g)continue;const z=n+k*D,$=a+u*D,W=Math.sqrt((Y-z)**2+(V-$)**2);W<=w&&T.push({worldX:Y,worldY:V,distAlong:D,distToLine:W})}if(T.length===0)return;const H=[];for(const{worldX:L,worldY:X}of T){const Y=this.add.rectangle(L,X,this.skillGridCellSize,this.skillGridCellSize,l,0);Y.setVisible(!1),Y.setDepth(50),this.worldContainer.add(Y),H.push(Y)}const F=()=>{const L=this.time.now-P,X=Math.min(L/m,1),Y=Math.min(L/M,1),V=g*Y;let K=0;L>M+x&&(K=(L-M-x)/b);const U=g*K,D=1-K;let z=0;for(const{distAlong:$,distToLine:W}of T){const N=H[z++];if(!N)continue;const Z=w*D;if($<=V&&$>=U&&W<=Z){const q=Z>0?W/Z:1,j=1-q*q;let J=.2+j*.5;const et=$/g,at=Math.min(1,et/.15),gt=Math.min(1,(1-et)/.15),rt=Math.min(at,gt);J*=rt*rt;let ht=1;if(U>0){const it=g*.1;$<U+it&&(ht=($-U)/it)}const ct=J*ht;if(ct>.01){const it=.6+j*.4,pt=l>>16&255,mt=l>>8&255,ut=l&255;let Mt,St,yt;if(q<.2&&L<M+x){const kt=1-q/.2;Mt=Math.min(255,pt+Math.floor((255-pt)*kt*.3)),St=Math.min(255,mt+Math.floor((255-mt)*kt*.3)),yt=Math.min(255,ut+Math.floor((255-ut)*kt*.3))}else Mt=Math.floor(pt*it),St=Math.floor(mt*it),yt=Math.floor(ut*it);const Et=Mt<<16|St<<8|yt;N.setFillStyle(Et,ct),N.setVisible(!0)}else N.setVisible(!1)}else N.setVisible(!1)}if(X>=1)for(const $ of H)$.destroy()};F();const _=this.time.addEvent({delay:16,callback:F,callbackScope:this,repeat:Math.ceil(m/16)});this.time.delayedCall(m+50,()=>{_.remove();for(const L of H)L.active&&L.destroy()})}};v(G,"MAP_SCALE",10),v(G,"ACTIVE_SKILLS",4),v(G,"PASSIVE_SKILLS",3),v(G,"CAMERA_DEAD_ZONE",.3),v(G,"HP_DAMAGE_DELAY",1e3),v(G,"HP_DAMAGE_LERP_SPEED",3),v(G,"MIN_FONT_SIZE_LARGE",14),v(G,"MIN_FONT_SIZE_MEDIUM",12),v(G,"MIN_FONT_SIZE_SMALL",10),v(G,"BASE_HP",200),v(G,"HP_PER_LEVEL",50),v(G,"BASE_EXP",100),v(G,"EXP_GROWTH_RATE",1.2),v(G,"DAMAGE_UNIT",10),v(G,"HURT_DURATION",200),v(G,"ATTACK_DURATION",150),v(G,"SKILL_GRID_GAP",1);let xt=G;const It=7,Gt={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},Rt={charHeight:It,chars:Gt};class Lt{constructor(){v(this,"font");this.font=Rt}textToPixels(S,t,s){const i=[],o=S.letterSpacing??1,e=S.color.replace("#",""),l=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),a=parseInt(e.substring(4,6),16),c=l<<16|n<<8|a;let h=0;const r=S.text.toUpperCase().split("");for(let u=0;u<r.length;u++){const p=this.font.chars[r[u]];p&&(h+=p.width,u<r.length-1&&(h+=o))}const d=Math.floor(t*S.position.x),y=Math.floor(s*S.position.y),C=d-Math.floor(h/2),g=y-Math.floor(this.font.charHeight/2);let k=C;for(const u of r){const p=this.font.chars[u];if(p){for(let f=0;f<p.pixels.length;f++){const w=p.pixels[f];for(let m=0;m<w.length;m++)if(w[m]==="#"){const M=k+m,x=g+f;M>=0&&M<t&&x>=0&&x<s&&i.push({gridX:M,gridY:x,color:c})}}k+=p.width+o}}return i}processConfig(S,t,s){const i=new Map;for(const o of S.texts){const e=this.textToPixels(o,t,s);i.set(o.id,e)}return i}}const Ht=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],Dt={texts:Ht},ot=class ot extends O.Scene{constructor(){super("GridScene");v(this,"cells",[]);v(this,"cols",0);v(this,"rows",0);v(this,"cellWidth",10);v(this,"cellHeight",10);v(this,"gap",1);v(this,"isAnimating",!1);v(this,"isReady",!1);v(this,"textRenderer");v(this,"textPixels",new Map);v(this,"cursorGlowRadius",4);v(this,"glowPhase",0);v(this,"textBreathPhase",0);v(this,"isLoading",!0);v(this,"loadingCells",new Set);v(this,"backgroundImage");v(this,"titleBgm");this.textRenderer=new Lt}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const s=Math.floor(t.x/(this.cellWidth+this.gap)),i=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(s,i)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,s){if(!this.isReady||this.isAnimating)return;this.glowPhase+=s*.002,this.textBreathPhase+=s*.004;const i=this.input.activePointer;i&&this.updateCursorGlow(i.x,i.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),s=Math.floor(204+51*t),i=s<<16|s<<8|s,o=.5+.5*Math.sin(this.textBreathPhase*3),e=t>.6?o*.8:0,l=new Set;this.cells.forEach(n=>{n.isText&&l.add(`${n.x},${n.y}`)}),this.cells.forEach(n=>{if(n.isText)n.graphics.setFillStyle(i),n.graphics.setAlpha(.95);else{const a=`${n.x-1},${n.y-1}`;l.has(a)&&e>0&&(n.graphics.setFillStyle(8939263),n.graphics.setAlpha(e))}})}updateCursorGlow(t,s){const i=Math.floor(t/(this.cellWidth+this.gap)),o=Math.floor(s/(this.cellHeight+this.gap)),e=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(l=>{const n=l.x-i,a=l.y-o,c=Math.sqrt(n*n+a*a);if(c<=this.cursorGlowRadius){const r=(1-c/this.cursorGlowRadius)*e,d=l.originalColor>>16&255,y=l.originalColor>>8&255,C=l.originalColor&255,g=Math.min(255,Math.floor(d+(255-d)*r)),k=Math.min(255,Math.floor(y+(255-y)*r)),u=Math.min(255,Math.floor(C+(255-C)*r)),p=g<<16|k<<8|u;l.graphics.setFillStyle(p)}else l.graphics.setFillStyle(l.originalColor)})}createBackground(){const t=this.cameras.main.width,s=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,s/2,"background");const i=t/this.backgroundImage.width,o=s/this.backgroundImage.height,e=Math.max(i,o);this.backgroundImage.setScale(e),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(o=>{this.cells[o]&&(this.cells[o].originalColor=2236962,this.cells[o].isText=!1,this.cells[o].graphics.setFillStyle(2236962),this.cells[o].graphics.setAlpha(.2))}),this.loadingCells.clear();const s=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:s,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(o=>{const e=o.gridY*this.cols+o.gridX;this.cells[e]&&(this.cells[e].originalColor=o.color,this.cells[e].isText=!0,this.cells[e].graphics.setFillStyle(o.color),this.cells[e].graphics.setAlpha(.95),this.loadingCells.add(e))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const s=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,s.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(s=>{const i=s.gridY*this.cols+s.gridX;this.cells[i]&&(this.cells[i].graphics.setFillStyle(s.color),this.cells[i].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,s=this.cameras.main.height,i=Math.min(1,t/ot.BASE_WIDTH),o=Math.max(ot.MIN_CELL_SIZE,Math.floor(ot.BASE_CELL_SIZE*i));this.gap=1,this.cellWidth=o,this.cellHeight=o,this.cols=Math.ceil((t+this.gap)/(o+this.gap)),this.rows=Math.ceil((s+this.gap)/(o+this.gap));const e=.05,l=t*(1-e*2),n=s*(1-e*2),a=16/9,c=l/n;let h,r;c>a?(r=n,h=n*a):(h=l,r=l/a);const d=(t-h)/2,y=(s-r)/2;this.registry.set("gameBounds",{x:d,y,width:h,height:r}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${o}, gameBounds: ${h.toFixed(0)}x${r.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.cols;s++){const i=s*(this.cellWidth+this.gap)+this.cellWidth/2,o=t*(this.cellHeight+this.gap)+this.cellHeight/2,e=this.add.rectangle(i,o,this.cellWidth,this.cellHeight,2236962);e.setAlpha(0),this.cells.push({x:s,y:t,graphics:e,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(Dt,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(s=>{const i=s.gridY*this.cols+s.gridX;this.cells[i]&&(this.cells[i].originalColor=s.color,this.cells[i].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let g=0;g<this.cells.length;g++)t.add(g);const s=20,i=50,o=10,l=Math.floor(200/o),n=3e3;let a=0,c=!1;const h=(g,k)=>k*this.cols+g,r=g=>({x:g%this.cols,y:Math.floor(g/this.cols)}),d=g=>{const k=this.cells[g];k.graphics.setAlpha(1),k.graphics.setFillStyle(16777215),this.tweens.add({targets:k.graphics,fillColor:{from:16777215,to:k.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},y=g=>{const{x:k,y:u}=r(g),p=l,f=[];for(let M=0;M<=p;M++)f[M]=[];for(let M=-p;M<=p;M++)for(let x=-p;x<=p;x++){const b=k+x,P=u+M;if(b>=0&&b<this.cols&&P>=0&&P<this.rows){const T=Math.sqrt(x*x+M*M),E=Math.floor(T);if(E<=p){const A=h(b,P);f[E].push(A)}}}let w=0;const m=()=>{w>p||(f[w].forEach(M=>{t.has(M)&&(t.delete(M),d(M))}),w++,w<=p&&this.time.delayedCall(o,m))};m()},C=()=>{if(c)return;if(a>=n||t.size===0){this.finishEntry(t),c=!0;return}const g=Array.from(t),k=Math.min(s,g.length);for(let u=0;u<k&&g.length!==0;u++){const p=Math.floor(Math.random()*g.length),f=g[p];g.splice(p,1),t.has(f)&&y(f)}a+=i,t.size>0&&a<n?this.time.delayedCall(i,C):c||(this.finishEntry(t),c=!0)};C()}finishEntry(t){t.forEach(s=>{const i=this.cells[s];i.graphics.setAlpha(.2),i.graphics.setFillStyle(i.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,s){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const i=this.cameras.main.width,o=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const e=t*(this.cellWidth+this.gap)+this.cellWidth/2,l=s*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:e,y:l,radius:0}),this.cells.forEach(r=>{r.graphics.setFillStyle(0),r.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const n=5;let a=0;this.cells.forEach(r=>{const d=r.x-t,y=r.y-s,C=Math.sqrt(d*d+y*y);r.delay=Math.floor(C*n),r.delay>a&&(a=r.delay)});const c=Math.sqrt(Math.max(e,i-e)**2+Math.max(l,o-l)**2)+50,h=a+150;this.tweens.addCounter({from:0,to:c,duration:h,ease:"Linear",onUpdate:r=>{const d=r.getValue()??0;this.registry.events.emit("reveal-update",{x:e,y:l,radius:d})}}),this.cells.forEach(r=>{this.time.delayedCall(r.delay,()=>{r.graphics.setFillStyle(16777215),r.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:d=>{const y=d.getValue()??0;let C,g;y<15?(C=16777215,g=1):y<30?(C=16776960,g=1):y<50?(C=16746496,g=1):y<70?(C=16720384,g=1-(y-50)/50):(C=6684672,g=1-(y-50)/50),r.graphics.setFillStyle(C),r.graphics.setAlpha(Math.max(0,g))},onComplete:()=>{r.graphics.setVisible(!1)}})})}),this.time.delayedCall(a+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};v(ot,"BASE_CELL_SIZE",10),v(ot,"MIN_CELL_SIZE",4),v(ot,"BASE_WIDTH",1920);let wt=ot;const Pt=document.getElementById("version-info");Pt&&(Pt.textContent="v0.5.0a");let Q=null;function Ft(){return window.innerWidth>window.innerHeight}function vt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function _t(){if(Q)return;const tt={type:O.AUTO,width:window.innerWidth,height:vt(),parent:"app",backgroundColor:"#111111",pixelArt:!0,scale:{mode:O.Scale.RESIZE,autoCenter:O.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[wt,At,xt]};Q=new O.Game(tt),Q.events.once("ready",()=>{Q&&Q.sound&&(Q.sound.volume=.5)})}function bt(){(window.innerWidth>900||Ft())&&_t()}bt();window.addEventListener("resize",bt);window.addEventListener("orientationchange",()=>{setTimeout(bt,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{Q&&Q.scale.resize(window.innerWidth,vt())});document.addEventListener("fullscreenchange",()=>{Q&&setTimeout(()=>{Q.scale.resize(window.innerWidth,vt())},100)});window.addEventListener("volumechange",tt=>{Q&&Q.sound&&(Q.sound.volume=tt.detail.volume)});
