var Bt=Object.defineProperty;var Et=(Z,S,t)=>S in Z?Bt(Z,S,{enumerable:!0,configurable:!0,writable:!0,value:t}):Z[S]=t;var p=(Z,S,t)=>Et(Z,typeof S!="symbol"?S+"":S,t);import{P as F}from"./phaser-0RJB29YE.js";(function(){const S=document.createElement("link").relList;if(S&&S.supports&&S.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class At extends F.Scene{constructor(){super("BootScene")}preload(){}create(){const S=this.cameras.main.width,t=this.cameras.main.height;this.add.text(S/2,t/2,"Loading...",{font:"20px monospace",color:"#ffffff"}).setOrigin(.5,.5),this.scene.start("MainScene")}}const ht=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5,levelUpMessages:["60° 扇形、2 傷害","70° 扇形、3 傷害","80° 扇形、4 傷害","90° 扇形、5 傷害","100° 扇形、6 傷害","110° 扇形、7 傷害，已達最大等級！"]},{id:"active_coder",name:"遊戲先知",subtitle:"編碼者",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5,levelUpMessages:["2 單位範圍、1 傷害","2.5 單位範圍、2 傷害","3 單位範圍、3 傷害","3.5 單位範圍、4 傷害","4 單位範圍、5 傷害","4.5 單位範圍、6 傷害，已達最大等級！"]},{id:"active_vfx",name:"超級導演",subtitle:"視效師",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5,levelUpMessages:["1 道光束、1 傷害","2 道光束、2 傷害","3 道光束、3 傷害","4 道光束、4 傷害","5 道光束、5 傷害","6 道光束、6 傷害，已達最大等級！"]},{id:"active_architect",name:"靈魂統領",subtitle:"架構師",description:"產生 30% HP 護盾（霸體）並反傷攻擊者，護盾消失時回復等值 HP",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5,levelUpMessages:["30% HP 護盾、1 反傷","30% HP 護盾、2.5 反傷","30% HP 護盾、4 反傷","30% HP 護盾、5.5 反傷","30% HP 護盾、7 反傷","30% HP 護盾、8.5 反傷，已達最大等級！"]},{id:"passive_titanium_liver",name:"鈦金肝",description:"提升 10% HP 總量並每 15 秒回復 1% 最大 HP，每級再 +10% HP、回復間隔 -1 秒",type:"passive",color:11189196,maxLevel:5,levelUpMessages:["+10% HP、每 15 秒回血","+20% HP、每 14 秒回血","+30% HP、每 13 秒回血","+40% HP、每 12 秒回血","+50% HP、每 11 秒回血","+60% HP、每 10 秒回血，已達最大等級！"]},{id:"passive_sync_rate",name:"精神同步率強化",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5,levelUpMessages:["+10% 移速、-8% 冷卻","+20% 移速、-16% 冷卻","+30% 移速、-24% 冷卻","+40% 移速、-32% 冷卻","+50% 移速、-40% 冷卻","+60% 移速、-48% 冷卻，已達最大等級！"]},{id:"passive_retina_module",name:"視網膜增強模組",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10035763,maxLevel:5,levelUpMessages:["+30% 經驗","+60% 經驗","+90% 經驗","+120% 經驗","+150% 經驗","+180% 經驗，已達最大等級！"]},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"提升 25% 攻擊、15% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5,levelUpMessages:["+25% 攻擊、+15% 防禦","+50% 攻擊、+30% 防禦","+75% 攻擊、+45% 防禦","+100% 攻擊、+60% 防禦","+125% 攻擊、+75% 防禦","+150% 攻擊、+90% 防禦，已達最大等級！"]}],nt=class nt{constructor(){p(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return ht.filter(S=>S.type==="active")}getPassiveSkillDefinitions(){return ht.filter(S=>S.type==="passive")}getPlayerSkill(S){return this.playerSkills.get(S)}getPlayerActiveSkills(){const S=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&S.push(e)});const t=[];for(let e=0;e<4;e++)t.push(S[e]||null);return t}getPlayerPassiveSkills(){const S=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&S.push(e)});const t=[];for(let e=0;e<nt.MAX_PASSIVE_SLOTS;e++)t.push(S[e]||null);return t}getOwnedPassiveCount(){let S=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&S++}),S}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=nt.MAX_PASSIVE_SLOTS}getSkillLevel(S){const t=this.playerSkills.get(S);return t?t.level:-1}isSkillMaxLevel(S){const t=this.playerSkills.get(S);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(S){const t=ht.find(s=>s.id===S);if(!t)return!1;const e=this.playerSkills.get(S);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(S,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(S=>{const t=this.playerSkills.get(S.id);return!t||t.level<S.maxLevel})}getUpgradeablePassiveSkills(){const S=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return S?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const S=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){const i=this.shuffleArray([...S]);for(let o=0;o<Math.min(3,i.length);o++)e.push(i[o]);return e}const s=this.shuffleArray([...S]);for(let i=0;i<Math.min(2,s.length);i++)e.push(s[i]);const a=this.shuffleArray([...t]);return a.length>0&&e.push(a[0]),e}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(S){for(let t=S.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[S[t],S[e]]=[S[e],S[t]]}return S}static formatLevel(S,t=5){return S<=0?"Lv.0":S>=t?"MAX":`Lv.${S}`}getTitaniumLiverHpBonus(){const S=this.playerSkills.get("passive_titanium_liver");return S?(S.level+1)*.1:0}getTitaniumLiverRegenInterval(){const S=this.playerSkills.get("passive_titanium_liver");return S?(15-S.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const S=this.playerSkills.get("passive_sync_rate");return S?(S.level+1)*.1:0}getSyncRateCooldownReduction(){const S=this.playerSkills.get("passive_sync_rate");return S?(S.level+1)*.08:0}getRetinaModuleExpBonus(){const S=this.playerSkills.get("passive_retina_module");return S?(S.level+1)*.3:0}getAiEnhancementDamageBonus(){const S=this.playerSkills.get("passive_ai_enhancement");return S?(S.level+1)*.25:0}getAiEnhancementDefenseBonus(){const S=this.playerSkills.get("passive_ai_enhancement");return S?(S.level+1)*.15:0}calculateFinalMaxHp(S){const t=this.getTitaniumLiverHpBonus();return Math.floor(S*(1+t))}calculateFinalMoveSpeed(S){const t=this.getSyncRateSpeedBonus();return S*(1+t)}calculateFinalCooldown(S){const t=this.getSyncRateCooldownReduction();return S*(1-t)}calculateFinalExp(S){const t=this.getRetinaModuleExpBonus();return Math.floor(S*(1+t))}calculateFinalDamage(S){const t=this.getAiEnhancementDamageBonus();return Math.floor(S*(1+t))}calculateFinalDamageTaken(S){const t=this.getAiEnhancementDefenseBonus();return Math.floor(S*(1-t))}};p(nt,"MAX_PASSIVE_SLOTS",3);let ot=nt;const Gt=[{id:"slime",name:"史萊姆",color:6750054,speed:1.5,damage:1,size:.08,hp:30,exp:20}],lt=class lt{constructor(S,t,e,s,a){p(this,"scene");p(this,"monsters",[]);p(this,"nextMonsterId",0);p(this,"container");p(this,"spawnInterval",2e3);p(this,"lastSpawnTime",0);p(this,"isSpawning",!1);p(this,"gameBounds");p(this,"mapWidth");p(this,"mapHeight");p(this,"playerLevel",0);this.scene=S,this.container=t,this.gameBounds=e,this.mapWidth=s,this.mapHeight=a}setPlayerLevel(S){this.playerLevel=S}calculateMonsterHp(S){return Math.floor(S*Math.pow(lt.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(){const S=Math.max(1,this.playerLevel);return lt.DAMAGE_UNIT*S}calculateMonsterExp(S){const t=Math.floor(this.playerLevel/5);return S*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(S,t,e,s,a){const i=this.scene.time.now;let o=0;const l=[];if(this.isSpawning&&i-this.lastSpawnTime>=this.spawnInterval){const c=1+Math.floor(this.playerLevel/5);for(let n=0;n<c;n++)this.spawnMonster(t,e,s,a);this.lastSpawnTime=i}const r=this.gameBounds.height*.1,h=this.gameBounds.height*.1;return this.monsters.forEach(c=>{const n=t-c.x,f=e-c.y,u=Math.sqrt(n*n+f*f);if(u>h){const k=c.definition.speed*this.gameBounds.height*.1*S/1e3/u;c.x+=n*k,c.y+=f*k}else i-c.lastDamageTime>=3e3&&(o+=this.calculateMonsterDamage(),c.lastDamageTime=i,l.push(c));this.drawMonster(c,r,s,a)}),{damage:o,hitMonsters:l}}spawnMonster(S,t,e,s){const a=["top","left","right"],i=a[Math.floor(Math.random()*a.length)];let o,l;const r=100,h=e,c=e+this.gameBounds.width,n=s;switch(i){case"top":o=h+Math.random()*this.gameBounds.width,l=n-r;break;case"left":o=h-r,l=n+Math.random()*this.gameBounds.height;break;case"right":o=c+r,l=n+Math.random()*this.gameBounds.height;break}o=Phaser.Math.Clamp(o,0,this.mapWidth),l=Phaser.Math.Clamp(l,0,this.mapHeight);const f=Gt[0],u=this.scene.add.graphics(),g=this.calculateMonsterHp(f.hp),m={id:this.nextMonsterId++,definition:f,x:o,y:l,hp:g,graphics:u,lastDamageTime:0};this.monsters.push(m),this.container.add(u)}drawMonster(S,t,e,s){const a=S.graphics;a.clear();const i=S.x,o=S.y;a.fillStyle(S.definition.color,.8),a.fillCircle(i,o-t/2,t/2),a.fillStyle(0,1),a.fillCircle(i-t*.15,o-t*.6,t*.08),a.fillCircle(i+t*.15,o-t*.6,t*.08)}removeMonster(S){const t=this.monsters.findIndex(e=>e.id===S);t!==-1&&(this.monsters[t].graphics.destroy(),this.monsters.splice(t,1))}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters.forEach(S=>{S.graphics.destroy()}),this.monsters=[]}setSpawnInterval(S){this.spawnInterval=S}damageMonster(S,t){const e=this.monsters.find(s=>s.id===S);if(!e)return{killed:!1,exp:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const s=this.calculateMonsterExp(e.definition.exp);return this.removeMonster(S),{killed:!0,exp:s}}return{killed:!1,exp:0}}flashMonster(S){const t=S.definition.color,e=S.graphics,s=this.gameBounds.height*.1;e.clear(),e.fillStyle(16777215,1),e.fillCircle(S.x,S.y-s/2,s/2),this.scene.time.delayedCall(50,()=>{S.hp>0&&(e.clear(),e.fillStyle(t,.8),e.fillCircle(S.x,S.y-s/2,s/2),e.fillStyle(0,1),e.fillCircle(S.x-s*.15,S.y-s*.6,s*.08),e.fillCircle(S.x+s*.15,S.y-s*.6,s*.08))})}damageMonsters(S,t){let e=0,s=0;for(const a of S){const i=this.damageMonster(a,t);i.killed&&(e+=i.exp,s++)}return{totalExp:e,killCount:s}}};p(lt,"HP_GROWTH_RATE",1.1),p(lt,"DAMAGE_UNIT",10);let St=lt;const I=class I extends F.Scene{constructor(){super("MainScene");p(this,"character");p(this,"characterState","idle");p(this,"facingRight",!0);p(this,"skillIcons",[]);p(this,"skillIconGridGraphics",[]);p(this,"skillIconGridData",[]);p(this,"gameBounds");p(this,"boundsBorder");p(this,"background");p(this,"gameAreaContainer");p(this,"revealMask");p(this,"mapWidth");p(this,"mapHeight");p(this,"characterX");p(this,"characterY");p(this,"characterSize");p(this,"isMoving",!1);p(this,"isPointerDown",!1);p(this,"targetX");p(this,"targetY");p(this,"baseMoveSpeed",0);p(this,"moveSpeed",0);p(this,"floorGrid");p(this,"worldContainer");p(this,"characterContainer");p(this,"uiContainer");p(this,"cameraOffsetX",0);p(this,"cameraOffsetY",0);p(this,"cursors");p(this,"isKeyboardMoving",!1);p(this,"skillPanelContainer");p(this,"isPaused",!1);p(this,"skillOptions",[]);p(this,"skillCardBgs",[]);p(this,"selectedSkillIndex",0);p(this,"currentSkillChoices",[]);p(this,"skillCutInContainer");p(this,"skillManager",new ot);p(this,"skillIconContainers",[]);p(this,"skillLevelTexts",[]);p(this,"skillInfoPanel");p(this,"skillInfoBg");p(this,"skillInfoText");p(this,"skillInfoHideTimer");p(this,"currentExp",0);p(this,"maxExp",100);p(this,"currentLevel",0);p(this,"expBarContainer");p(this,"expBarFlowOffset",0);p(this,"levelText");p(this,"currentHp",200);p(this,"maxHp",200);p(this,"hpBarContainer");p(this,"hpBarFlowOffset",0);p(this,"hpText");p(this,"currentShield",0);p(this,"maxShield",0);p(this,"shieldBarFlowOffset",0);p(this,"shieldReflectDamage",0);p(this,"shieldText");p(this,"shieldAuraGraphics");p(this,"shieldSparkleTimer",0);p(this,"hpRegenTimer",0);p(this,"displayedHp",200);p(this,"hpDamageDelay",0);p(this,"isMobile",!1);p(this,"keyPlus");p(this,"keyMinus");p(this,"keyShift");p(this,"keyCtrl");p(this,"keyZero");p(this,"keyBackspace");p(this,"keyF5");p(this,"keyF6");p(this,"keyF7");p(this,"keyF8");p(this,"keyF9");p(this,"keyF10");p(this,"keyF11");p(this,"keyF12");p(this,"showLegacySkillEffects",!1);p(this,"monsterManager");p(this,"isHurt",!1);p(this,"hurtEndTime",0);p(this,"lowHpBreathTimer",0);p(this,"isLowHp",!1);p(this,"vignetteEdgeCells",new Set);p(this,"skillCooldowns",new Map);p(this,"isAttacking",!1);p(this,"attackEndTime",0);p(this,"gameBgm");p(this,"currentBgmKey","");p(this,"skillGridContainer");p(this,"skillGridCells",[]);p(this,"skillGridCols",0);p(this,"skillGridRows",0);p(this,"skillGridCellSize",10);p(this,"gridScaleMultiplier",3)}create(){this.cameras.main.setBackgroundColor("#111111"),this.isMobile=this.sys.game.device.input.touch&&window.innerWidth<1024,this.gridScaleMultiplier=this.isMobile?2:3;const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const l=t*.9,r=e*(1-.05*2),h=16/9,c=l/r;let n,f;c>h?(f=r,n=r*h):(n=l,f=l/h),this.gameBounds={x:(t-n)/2,y:(e-f)/2,width:n,height:f}}this.mapWidth=this.gameBounds.width*I.MAP_SCALE,this.mapHeight=this.gameBounds.height*I.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.monsterManager=new St(this,this.worldContainer,this.gameBounds,this.mapWidth,this.mapHeight),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const s=this.make.graphics({x:0,y:0});s.fillStyle(16777215),s.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const a=s.createGeometryMask();this.worldContainer.setMask(a),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(10),this.createSkillGrid(),window.addEventListener("gridscalechange",o=>{this.gridScaleMultiplier=o.detail.scale,this.recreateSkillGrid()}),this.characterContainer.setDepth(60),this.characterContainer.setMask(a),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const i=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(i),this.uiContainer.setMask(i),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createSkillCutIn(),this.createLowHpVignette()}update(t,e){if(this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.updateShieldAura(e),this.updateHpRegen(e),this.updateLowHpVignetteBreathing(e),this.updateSkillCooldownDisplay(),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const s=this.time.now;this.isHurt&&s>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&s>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isMoving||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isMoving&&!this.isKeyboardMoving&&this.moveCharacter(e));const a=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);a.damage>0&&this.takeDamage(a.damage,a.hitMonsters),this.updateSkillRangePreview(s),this.tryActivateSkills(s)}updateSkillRangePreview(t){if(this.clearSkillGrid(),this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const o=this.skillManager.calculateFinalCooldown(i),l=this.skillCooldowns.get(a.id)||0;t-l>=o&&this.showSkillPreview(s)}}showSkillPreview(t){const e=t.definition,s=e.color,a=.2;switch(e.id){case"active_soul_render":{const i=this.monsterManager.getMonsters();if(i.length===0)return;let o=0,l=1/0;for(const n of i){const f=n.x-this.characterX,u=n.y-this.characterY,g=Math.sqrt(f*f+u*u);g<l&&(l=g,o=Math.atan2(u,f))}const r=this.gameBounds.height*.3,c=(60+t.level*10)/2*(Math.PI/180);this.showSkillRangeSector(this.characterX,this.characterY,r,o,c,s,a);break}case"active_coder":{const i=this.gameBounds.height*.1,o=2+t.level*.5,l=i*o;this.showSkillRangeCircle(this.characterX,this.characterY,l,s,a);break}case"active_vfx":{const i=this.monsterManager.getMonsters();if(i.length===0)return;const o=Math.min(t.level+1,i.length),l=this.gameBounds.height*1,r=this.gameBounds.height*.05,h=[...i].sort((c,n)=>{const f=Math.sqrt((c.x-this.characterX)**2+(c.y-this.characterY)**2),u=Math.sqrt((n.x-this.characterX)**2+(n.y-this.characterY)**2);return f-u});for(let c=0;c<o;c++){const n=h[c],f=n.x-this.characterX,u=n.y-this.characterY,g=Math.sqrt(f*f+u*u);if(g>0){const m=this.characterX+f/g*l,k=this.characterY+u/g*l;this.showSkillRangeLine(this.characterX,this.characterY,m,k,r,s,a)}}break}case"active_architect":{const i=this.gameBounds.height*.15;this.showSkillRangeCircle(this.characterX,this.characterY,i,s,a);break}}}tryActivateSkills(t){if(this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const o=this.skillManager.calculateFinalCooldown(i),l=this.skillCooldowns.get(a.id)||0;t-l>=o&&(this.activateSkill(s,t),this.skillCooldowns.set(a.id,t))}}activateSkill(t,e){const s=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+I.ATTACK_DURATION,this.setCharacterState("attack",!0),s.flashColor&&this.character.setTint(s.flashColor),s.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${s.name}`)}}activateSoulRender(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let s=e[0],a=1/0;for(const u of e){const g=u.x-this.characterX,m=u.y-this.characterY,k=Math.sqrt(g*g+m*m);k<a&&(a=k,s=u)}const i=Math.atan2(s.y-this.characterY,s.x-this.characterX);this.facingRight=Math.cos(i)>=0,this.updateCharacterSprite();const o=this.gameBounds.height*.3,r=(60+t.level*10)/2*(Math.PI/180),h=2+t.level,c=I.DAMAGE_UNIT*h,n=this.skillManager.calculateFinalDamage(c),f=[];for(const u of e){const g=u.x-this.characterX,m=u.y-this.characterY;if(Math.sqrt(g*g+m*m)>o)continue;let M=Math.atan2(m,g)-i;for(;M>Math.PI;)M-=Math.PI*2;for(;M<-Math.PI;)M+=Math.PI*2;Math.abs(M)<=r&&f.push(u.id)}if(this.showLegacySkillEffects&&this.drawSectorEffect(i,o,r,t.definition.color),this.drawSectorEdge(i,o,r,t.definition.color),this.flashSkillAreaSector(this.characterX,this.characterY,o,i,r,t.definition.flashColor||t.definition.color),f.length>0){const u=e.filter(m=>f.includes(m.id)).map(m=>({x:m.x,y:m.y})),g=this.monsterManager.damageMonsters(f,n);g.totalExp>0&&this.addExp(g.totalExp),this.flashWhiteCrossAtPositions(u),this.showLegacySkillEffects&&this.drawCrossStarBurst(u,t.definition.flashColor||t.definition.color),this.shakeScreen(f.length),console.log(`Soul Render hit ${f.length} monsters for ${n} damage, killed ${g.killCount}, exp +${g.totalExp}`)}}drawSectorEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const o=t-s,l=t+s,r=this.characterX,h=this.characterY,c=15,n=1e3,f=this.time.now,u=()=>{const m=this.time.now-f,k=Math.min(m/n,1);i.clear();const y=.3,M=k<y?0:(k-y)/(1-y);for(let x=c;x>=1;x--){const C=e*x/c,v=.8*(1-(x-1)/c)*(1-M);v>.01&&(i.fillStyle(a,v),i.beginPath(),i.moveTo(r,h),i.arc(r,h,C,o,l,!1),i.closePath(),i.fillPath())}const d=8;for(let x=d;x>=1;x--){const C=e*.6*x/d,T=.95*(1-(x-1)/d)*(1-M);T>.01&&(i.fillStyle(16777215,T),i.beginPath(),i.moveTo(r,h),i.arc(r,h,C,o,l,!1),i.closePath(),i.fillPath())}const w=1*(1-M);w>.01&&(i.lineStyle(6,a,w),i.beginPath(),i.moveTo(r,h),i.arc(r,h,e,o,l,!1),i.closePath(),i.strokePath(),i.lineStyle(3,16777215,w*.8),i.beginPath(),i.moveTo(r,h),i.arc(r,h,e*.97,o,l,!1),i.closePath(),i.strokePath(),i.lineStyle(4,16777215,w*.9),i.beginPath(),i.moveTo(r,h),i.lineTo(r+Math.cos(t)*e,h+Math.sin(t)*e),i.strokePath()),k>=1&&i.destroy()},g=this.time.addEvent({delay:16,callback:u,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{i.active&&i.destroy(),g.remove()})}drawSectorEdge(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const o=t-s,l=t+s,r=this.characterX,h=this.characterY,c=500,n=300,f=this.time.now,u=15,g=(y,M,d,w,x=1)=>{for(let C=0;C<u;C++){const T=C/u,v=(C+1)/u,b=(T+v)/2,B=Math.min(1,b/.15),P=Math.min(1,(1-b)/.15),A=Math.min(B,P),E=w*A*A;if(E>.01){const L=e*T*x,H=e*v*x,R=r+Math.cos(y)*L,_=h+Math.sin(y)*L,X=r+Math.cos(y)*H,Y=h+Math.sin(y)*H;i.lineStyle(d,M,E),i.beginPath(),i.moveTo(R,_),i.lineTo(X,Y),i.strokePath()}}},m=()=>{const y=this.time.now-f,M=Math.min(y/c,1);i.clear();let d=0;y>n&&(d=(y-n)/(c-n));const w=.6*(1-d);w>.01&&(g(o,a,3,w),g(l,a,3,w),g(o,16777215,1.5,w*.5,.98),g(l,16777215,1.5,w*.5,.98)),M>=1&&i.destroy()};m();const k=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{i.active&&i.destroy(),k.remove()})}drawCircleEdge(t,e){const s=this.add.graphics();this.worldContainer.add(s);const a=this.characterX,i=this.characterY,o=500,l=300,r=this.time.now,h=()=>{const n=this.time.now-r,f=Math.min(n/o,1);s.clear();let u=0;n>l&&(u=(n-l)/(o-l));const g=.6*(1-u);g>.01&&(s.lineStyle(3,e,g),s.strokeCircle(a,i,t),s.lineStyle(1.5,16777215,g*.5),s.strokeCircle(a,i,t*.98)),f>=1&&s.destroy()};h();const c=this.time.addEvent({delay:16,callback:h,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{s.active&&s.destroy(),c.remove()})}drawBeamEdge(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const o=this.characterX,l=this.characterY,r=Math.cos(t),h=Math.sin(t),c=800,n=380,f=this.time.now,u=20,g=()=>{const k=this.time.now-f,y=Math.min(k/c,1);i.clear();let M=0;k>n&&(M=(k-n)/(c-n));const d=.6*(1-M*.5);if(d>.01)for(let w=0;w<u;w++){const x=w/u,C=(w+1)/u,T=(x+C)/2,v=Math.min(1,T/.15),b=Math.min(1,(1-T)/.15),B=Math.min(v,b),P=d*B*B;if(P>.01){const A=o+r*e*x,E=l+h*e*x,L=o+r*e*C,H=l+h*e*C;i.lineStyle(2,16777215,P),i.beginPath(),i.moveTo(A,E),i.lineTo(L,H),i.strokePath()}}y>=1&&i.destroy()};g();const m=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{i.active&&i.destroy(),m.remove()})}activateCoder(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=this.gameBounds.height*.1,a=2+t.level*.5,i=s*a,o=1+t.level,l=I.DAMAGE_UNIT*o,r=this.skillManager.calculateFinalDamage(l),h=[];for(const c of e){const n=c.x-this.characterX,f=c.y-this.characterY;Math.sqrt(n*n+f*f)<=i&&h.push(c.id)}if(this.showLegacySkillEffects&&this.drawCircleEffect(i,t.definition.color),this.drawCircleEdge(i,t.definition.color),this.flashSkillAreaCircle(this.characterX,this.characterY,i,t.definition.flashColor||t.definition.color),h.length>0){const c=e.filter(f=>h.includes(f.id)).map(f=>({x:f.x,y:f.y})),n=this.monsterManager.damageMonsters(h,r);n.totalExp>0&&this.addExp(n.totalExp),this.flashWhiteCrossAtPositions(c),this.showLegacySkillEffects&&this.drawCrossStarBurst(c,t.definition.flashColor||t.definition.color),this.shakeScreen(h.length),console.log(`Coder hit ${h.length} monsters for ${r} damage, killed ${n.killCount}, exp +${n.totalExp}`)}}drawCircleEffect(t,e){const s=this.add.graphics();this.worldContainer.add(s);const a=this.characterX,i=this.characterY,o=15,l=1e3,r=this.time.now,h=()=>{const n=this.time.now-r,f=Math.min(n/l,1);s.clear();const u=.3,g=f<u?0:(f-u)/(1-u);for(let y=o;y>=1;y--){const M=t*y/o,d=t*(y-1)/o,x=.7*(1-(y-1)/o)*(1-g);x>.01&&(s.fillStyle(e,x),s.beginPath(),s.arc(a,i,M,0,Math.PI*2,!1),d>0&&s.arc(a,i,d,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const m=8;for(let y=m;y>=1;y--){const M=t*.5*y/m,d=t*.5*(y-1)/m,w=.95*(1-(y-1)/m)*(1-g);w>.01&&(s.fillStyle(16777215,w),s.beginPath(),s.arc(a,i,M,0,Math.PI*2,!1),d>0&&s.arc(a,i,d,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const k=1*(1-g);k>.01&&(s.lineStyle(6,e,k),s.strokeCircle(a,i,t),s.lineStyle(3,16777215,k*.8),s.strokeCircle(a,i,t*.96),s.lineStyle(2,16777215,k*.5),s.strokeCircle(a,i,t*.7),s.strokeCircle(a,i,t*.4)),f>=1&&s.destroy()},c=this.time.addEvent({delay:16,callback:h,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{s.active&&s.destroy(),c.remove()})}activateVfx(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=t.level+1,a=this.gameBounds.height*1,i=this.gameBounds.height*.05,o=1+t.level,l=I.DAMAGE_UNIT*o,r=this.skillManager.calculateFinalDamage(l),h=new Set,c=e.map((u,g)=>g),n=[];for(let u=0;u<s;u++){let g;if(c.length>0){const y=Math.floor(Math.random()*c.length),M=c[y];c.splice(y,1);const d=e[M];g=Math.atan2(d.y-this.characterY,d.x-this.characterX)}else g=Math.random()*Math.PI*2;n.push(g);for(const y of e){const M=y.x-this.characterX,d=y.y-this.characterY;if(Math.sqrt(M*M+d*d)>a)continue;const x=Math.cos(g),C=Math.sin(g);if(M*x+d*C<0)continue;Math.abs(M*C-d*x)<=i/2&&h.add(y.id)}this.showLegacySkillEffects&&this.drawBeamEffect(g,a,i,t.definition.color),this.drawBeamEdge(g,a,i,t.definition.color);const m=this.characterX+Math.cos(g)*a,k=this.characterY+Math.sin(g)*a;this.flashSkillAreaLine(this.characterX,this.characterY,m,k,i,t.definition.flashColor||t.definition.color)}n.length>0&&(this.facingRight=Math.cos(n[0])>=0,this.updateCharacterSprite());const f=Array.from(h);if(f.length>0){const u=e.filter(m=>f.includes(m.id)).map(m=>({x:m.x,y:m.y})),g=this.monsterManager.damageMonsters(f,r);g.totalExp>0&&this.addExp(g.totalExp),this.flashWhiteCrossAtPositions(u),this.showLegacySkillEffects&&this.drawCrossStarBurst(u,t.definition.flashColor||t.definition.color),this.shakeScreen(f.length),console.log(`VFX (${s} beams) hit ${f.length} monsters for ${r} damage, killed ${g.killCount}, exp +${g.totalExp}`)}}drawBeamEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const o=this.characterX,l=this.characterY,r=o+Math.cos(t)*e,h=l+Math.sin(t)*e,c=s*1.5,n=Math.sin(t)*c/2,f=-Math.cos(t)*c/2,u=Math.sin(t)*c*.4/2,g=-Math.cos(t)*c*.4/2,m=15,k=1e3,y=this.time.now,M=()=>{const w=this.time.now-y,x=Math.min(w/k,1);i.clear();const C=.3,T=x<C?0:(x-C)/(1-C);for(let B=0;B<m;B++){const P=B/m,A=(B+1)/m,E=o+(r-o)*P,L=l+(h-l)*P,H=o+(r-o)*A,R=l+(h-l)*A,X=.85*(1-P*.6)*(1-T);X>.01&&(i.fillStyle(a,X),i.beginPath(),i.moveTo(E-n,L-f),i.lineTo(H-n,R-f),i.lineTo(H+n,R+f),i.lineTo(E+n,L+f),i.closePath(),i.fillPath())}for(let B=0;B<m;B++){const P=B/m,A=(B+1)/m,E=o+(r-o)*P,L=l+(h-l)*P,H=o+(r-o)*A,R=l+(h-l)*A,_=.98*(1-P*.5)*(1-T);_>.01&&(i.fillStyle(16777215,_),i.beginPath(),i.moveTo(E-u,L-g),i.lineTo(H-u,R-g),i.lineTo(H+u,R+g),i.lineTo(E+u,L+g),i.closePath(),i.fillPath())}const v=1*(1-T);v>.01&&(i.lineStyle(6,16777215,v),i.beginPath(),i.moveTo(o,l),i.lineTo(r,h),i.strokePath());const b=1*(1-T);b>.01&&(i.lineStyle(4,a,b),i.beginPath(),i.moveTo(o-n,l-f),i.lineTo(r-n,h-f),i.lineTo(r+n,h+f),i.lineTo(o+n,l+f),i.closePath(),i.strokePath(),i.lineStyle(2,16777215,b*.6),i.beginPath(),i.moveTo(o-n*1.1,l-f*1.1),i.lineTo(r-n*1.1,h-f*1.1),i.lineTo(r+n*1.1,h+f*1.1),i.lineTo(o+n*1.1,l+f*1.1),i.closePath(),i.strokePath()),x>=1&&i.destroy()},d=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(k/16)});this.time.delayedCall(k+50,()=>{i.active&&i.destroy(),d.remove()})}drawCrossStarBurst(t,e){const a=this.gameBounds.height*.1*1,i=600;for(const o of t){const l=this.add.graphics();this.worldContainer.add(l);const r=this.time.now,h=()=>{const n=this.time.now-r,f=Math.min(n/i,1);l.clear();const u=f<.2?f/.2:1,g=f<.4?0:(f-.4)/.6,m=a*u,k=1-g;if(k>.01&&m>0){const y=m*.2,M=m,d=m*.4;l.fillStyle(16777215,k),l.fillCircle(o.x,o.y,d);for(let C=0;C<4;C++){const T=C*Math.PI/2,v=Math.cos(T),b=Math.sin(T),B=-b,P=v,A=6;for(let E=0;E<A;E++){const L=E/A,H=(E+1)/A,R=y*(1-L*.8),_=y*(1-H*.8),X=o.x+v*M*L,Y=o.y+b*M*L,K=o.x+v*M*H,G=o.y+b*M*H,D=k*(1-L*.7);l.fillStyle(e,D*.8),l.beginPath(),l.moveTo(X+B*R,Y+P*R),l.lineTo(K+B*_,G+P*_),l.lineTo(K-B*_,G-P*_),l.lineTo(X-B*R,Y-P*R),l.closePath(),l.fillPath();const z=R*.5,O=_*.5;l.fillStyle(16777215,D*.9),l.beginPath(),l.moveTo(X+B*z,Y+P*z),l.lineTo(K+B*O,G+P*O),l.lineTo(K-B*O,G-P*O),l.lineTo(X-B*z,Y-P*z),l.closePath(),l.fillPath()}}const w=M*.5,x=y*.6;for(let C=0;C<4;C++){const T=C*Math.PI/2+Math.PI/4,v=Math.cos(T),b=Math.sin(T),B=-b,P=v,A=4;for(let E=0;E<A;E++){const L=E/A,H=(E+1)/A,R=x*(1-L*.9),_=x*(1-H*.9),X=o.x+v*w*L,Y=o.y+b*w*L,K=o.x+v*w*H,G=o.y+b*w*H,D=k*(1-L*.8)*.7;l.fillStyle(e,D),l.beginPath(),l.moveTo(X+B*R,Y+P*R),l.lineTo(K+B*_,G+P*_),l.lineTo(K-B*_,G-P*_),l.lineTo(X-B*R,Y-P*R),l.closePath(),l.fillPath()}}}f>=1&&l.destroy()};h();const c=this.time.addEvent({delay:16,callback:h,callbackScope:this,repeat:Math.ceil(i/16)});this.time.delayedCall(i+50,()=>{l.active&&l.destroy(),c.remove()})}}activateArchitect(t){const e=Math.floor(this.maxHp*.3);this.currentShield=e,this.maxShield=e;const s=1+t.level*1.5;this.shieldReflectDamage=I.DAMAGE_UNIT*s,this.drawShieldBarFill(),this.showLegacySkillEffects&&this.drawShieldActivateEffect();const a=this.gameBounds.height*.15;this.flashSkillAreaCircle(this.characterX,this.characterY,a,t.definition.flashColor||t.definition.color),console.log(`Architect activated: Shield ${e}, Reflect damage ${this.shieldReflectDamage} (${s} units)`)}drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1.2,i=16763904,o=800,l=this.time.now,r=()=>{const c=this.time.now-l,n=Math.min(c/o,1);t.clear();const f=n<.2?n/.2:1,u=n<.2?0:(n-.2)/.8,g=a*(.3+.7*f),m=1-u;if(m>.01){for(let d=8;d>=1;d--){const w=g*d/8,x=m*(1-(d-1)/8)*.6;x>.01&&(t.fillStyle(i,x),t.fillCircle(e,s,w))}const y=4;for(let d=y;d>=1;d--){const w=g*.4*d/y,x=m*(1-(d-1)/y)*.9;x>.01&&(t.fillStyle(16777215,x),t.fillCircle(e,s,w))}t.lineStyle(5,i,m*.9),t.strokeCircle(e,s,g),t.lineStyle(2,16777215,m*.7),t.strokeCircle(e,s,g*.95);const M=g*.7;t.lineStyle(3,16777215,m*.5),t.beginPath();for(let d=0;d<6;d++){const w=d*Math.PI/3,x=e+Math.cos(w)*M,C=s+Math.sin(w)*M;d===0?t.moveTo(x,C):t.lineTo(x,C)}t.closePath(),t.strokePath()}n>=1&&t.destroy()};r();const h=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{t.active&&t.destroy(),h.remove()})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyBackspace)){this.showLegacySkillEffects=!this.showLegacySkillEffects,console.log(`Legacy skill effects: ${this.showLegacySkillEffects?"ON":"OFF"}`);return}if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:s}of t)if(e&&F.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(s);return}}if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=ht.find(l=>l.id===t);if(!e)return;const s=this.skillManager.getSkillLevel(t),a=e.type==="passive";if(s>=e.maxLevel){console.log(`Test: ${e.name} is already MAX`);return}if(a&&s<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${e.name}`);return}const i=s<0?-1:s,o=e.maxLevel-i;this.currentLevel+=o,this.monsterManager.setPlayerLevel(this.currentLevel);for(let l=0;l<o;l++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(I.BASE_EXP*Math.pow(I.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${e.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const s of e)for(let a=0;a<=s.maxLevel;a++)this.skillManager.learnOrUpgradeSkill(s.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(I.BASE_EXP*Math.pow(I.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(I.BASE_EXP*Math.pow(I.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=I.BASE_HP+I.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const s=this.currentHp/e;this.currentHp=Math.floor(this.maxHp*s)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(F.Input.Keyboard.JustDown(this.cursors.A)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),F.Input.Keyboard.JustDown(this.cursors.S)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1)),F.Input.Keyboard.JustDown(this.cursors.D)&&(this.selectedSkillIndex===2?this.confirmSkillSelection():this.setSelectedSkill(2)))}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,e){const s=this.skillCardBgs[t],a=this.skillOptions[t];!s||!a||(e?(s.setFillStyle(3355443),s.setStrokeStyle(3,16777215),this.tweens.add({targets:a,scaleX:1.05,scaleY:1.05,duration:100})):(s.setFillStyle(2236962),s.setStrokeStyle(2,6710886),this.tweens.add({targets:a,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let e=0,s=0;if(this.cursors.W.isDown&&(s=-1),this.cursors.S.isDown&&(s=1),this.cursors.A.isDown&&(e=-1),this.cursors.D.isDown&&(e=1),e!==0||s!==0){if(this.isKeyboardMoving=!0,this.isMoving=!1,e!==0&&(this.facingRight=e>0),e!==0&&s!==0){const i=1/Math.sqrt(2);e*=i,s*=i}const a=this.moveSpeed*t/1e3;this.characterX+=e*a,this.characterY+=s*a,this.characterX=F.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=F.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateTargetFromPointer(t),this.isMoving=!0)}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateTargetFromPointer(t)}onPointerUp(){this.isPointerDown=!1}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateTargetFromPointer(t){const e=t.x-this.gameBounds.x,s=t.y-this.gameBounds.y,a=e+this.cameraOffsetX,i=s+this.cameraOffsetY;this.targetX=F.Math.Clamp(a,this.characterSize,this.mapWidth-this.characterSize),this.targetY=F.Math.Clamp(i,this.characterSize,this.mapHeight-this.characterSize)}moveCharacter(t){const e=this.targetX-this.characterX,s=this.targetY-this.characterY,a=Math.sqrt(e*e+s*s);if(this.updateCharacterFacing(this.targetX),a<5)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const i=this.moveSpeed*t/1e3;if(i>=a)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const o=i/a;this.characterX+=e*o,this.characterY+=s*o,this.setCharacterState("run")}}this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,s=this.cameraOffsetY+this.gameBounds.height/2,a=this.characterX-e,i=this.characterY-s,o=this.gameBounds.width*I.CAMERA_DEAD_ZONE,l=this.gameBounds.height*I.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(a)>o/2&&(a>0?this.cameraOffsetX+=a-o/2:this.cameraOffsetX+=a+o/2),Math.abs(i)>l/2&&(i>0?this.cameraOffsetY+=i-l/2:this.cameraOffsetY+=i+l/2)),this.cameraOffsetX=F.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=F.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const s=t.filter(a=>a!==this.currentBgmKey);e=s[Math.floor(Math.random()*s.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const s=t/this.background.width,a=e/this.background.height,i=Math.max(s,a);this.background.setScale(i)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.max(I.MIN_FONT_SIZE_MEDIUM,Math.floor(this.gameBounds.height*.03));this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:"monospace",fontSize:`${s}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[0,1],e=this.skillGridCols,s=this.currentHp/this.maxHp,a=Math.floor(e*s),i=this.displayedHp/this.maxHp,o=Math.floor(e*i);for(const l of t)for(let r=0;r<this.skillGridCols;r++){const h=l*this.skillGridCols+r,c=this.skillGridCells[h];c&&(c.setFillStyle(0,.9),c.setVisible(!0),c.setDepth(1e3))}if(o>a)for(const l of t)for(let r=a;r<o;r++){const h=l*this.skillGridCols+r,c=this.skillGridCells[h];if(!c)continue;const n=l===0?.85:.7;c.setFillStyle(16777215,n)}if(!(a<=0)){for(const l of t)for(let r=0;r<a;r++){const h=l*this.skillGridCols+r,c=this.skillGridCells[h];if(!c)continue;const n=r/e,f=this.hpBarFlowOffset,u=(n+f)%1,g=(Math.sin(u*Math.PI*2-Math.PI/2)+1)/2,m=Math.floor(136-34*g),k=0,y=Math.floor(34+102*g),M=m<<16|k<<8|y,d=l===0?.95:.8;c.setFillStyle(M,d)}if(this.currentShield>0&&this.maxShield>0){const l=this.currentShield/this.maxShield,r=Math.floor(e*l);for(let h=0;h<r;h++){const c=0*this.skillGridCols+h,n=this.skillGridCells[c];if(!n)continue;const f=h/e,u=this.shieldBarFlowOffset,g=(f+u)%1,m=(Math.sin(g*Math.PI*2-Math.PI/2)+1)/2,k=255,y=Math.floor(204+51*m),M=Math.floor(0+204*m),d=k<<16|y<<8|M;n.setFillStyle(d,.95)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.updateDamageDisplay(t),this.drawHpBarFill()}updateDamageDisplay(t){if(this.displayedHp>this.currentHp)if(this.hpDamageDelay>0)this.hpDamageDelay-=t;else{const s=(this.displayedHp-this.currentHp)*I.HP_DAMAGE_LERP_SPEED*(t/1e3);this.displayedHp-=Math.max(1,s),this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}else this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}(+${this.currentShield}) / ${this.maxHp}`):this.hpText.setText(`${this.currentHp} / ${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025));this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,e+t/2,"",{fontFamily:"monospace",fontSize:`${s}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.6;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0)return;const e=this.characterX,s=this.characterY,a=this.characterSize*.8,i=this.characterSize*.35,o=s-this.characterSize*.15;for(let r=5;r>=0;r--){const h=1+r*.08,c=.12-r*.018,n=3+r*2;this.shieldAuraGraphics.lineStyle(n,16777215,c),this.shieldAuraGraphics.strokeEllipse(e,o,a*h,i*h)}this.shieldSparkleTimer+=t;const l=80;this.shieldSparkleTimer>=l&&(this.shieldSparkleTimer-=l,this.createShieldSparkle(e,o,a,i))}createShieldSparkle(t,e,s,a){const i=Math.random()*Math.PI*2,o=t+Math.cos(i)*(s/2),l=e+Math.sin(i)*(a/2),r=this.add.graphics();this.characterContainer.add(r);const h=this.gameBounds.height/10,c=h*.08,n=h*.2,f=h*.5,u=600+Math.random()*200,g=this.time.now,m=()=>{const y=this.time.now-g,M=Math.min(y/u,1);r.clear();const d=l-f*M,w=Math.pow(M,.5),x=c+(n-c)*w,C=1-M;C>.01&&(r.fillStyle(16768324,C*.9),r.fillRect(o-x/2,d-x/2,x,x),r.lineStyle(1,16777215,C*.6),r.strokeRect(o-x/2,d-x/2,x,x)),M>=1&&r.destroy()};m();const k=this.time.addEvent({delay:16,callback:m,callbackScope:this,repeat:Math.ceil(u/16)});this.time.delayedCall(u+50,()=>{r.active&&r.destroy(),k.remove()})}updateHpRegen(t){const e=this.skillManager.getTitaniumLiverRegenInterval();if(!(e<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=e){this.hpRegenTimer-=e;const s=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+s,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(s),console.log(`HP Regen: +${s} HP (${this.currentHp}/${this.maxHp})`)}}}showHpHealEffect(t){const e=this.characterX,s=this.characterY-this.characterSize*.3,a=Math.min(8,Math.max(3,Math.floor(t/10)+3));for(let i=0;i<a;i++)this.time.delayedCall(i*40,()=>{this.createHpHealParticle(e,s)})}createHpHealParticle(t,e){const s=Math.random()*Math.PI*2,a=this.characterSize*.4,i=this.characterSize*.25,o=t+Math.cos(s)*a*(.3+Math.random()*.7),l=e+Math.sin(s)*i*(.3+Math.random()*.7),r=this.add.graphics();this.characterContainer.add(r);const h=this.gameBounds.height/10,c=h*(.1+Math.random()*.08),n=h*(.5+Math.random()*.3),f=700+Math.random()*300,u=this.time.now,g=[6702335,8939263,7820782,10057727],m=g[Math.floor(Math.random()*g.length)],k=()=>{const M=this.time.now-u,d=Math.min(M/f,1);r.clear();const w=l-n*d;let x,C;if(d<.2?(x=.6+d*2,C=1-d*5):(x=1-(d-.2)/.8,C=0),x>.01){const T=m>>16&255,v=m>>8&255,b=m&255,B=Math.round(T+(255-T)*C),P=Math.round(v+(255-v)*C),A=Math.round(b+(255-b)*C),E=B<<16|P<<8|A;r.fillStyle(E,x*.9),r.fillRect(o-c/2,w-c/2,c,c),r.lineStyle(1,16777215,x*.7),r.strokeRect(o-c/2,w-c/2,c,c)}d>=1&&r.destroy()};k();const y=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{r.active&&r.destroy(),y.remove()})}takeDamage(t,e=[]){let a=this.skillManager.calculateFinalDamageTaken(t),i=0;if(this.currentShield>0){const o=this.currentShield>0;if(this.currentShield>=a?(i=a,this.currentShield-=a,a=0):(i=this.currentShield,a-=this.currentShield,this.currentShield=0),o&&this.currentShield===0&&this.maxShield>0){const l=this.maxShield;this.currentHp=Math.min(this.currentHp+l,this.maxHp),console.log(`Shield broken! Healed ${l} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(l)}if(this.drawShieldBarFill(),i>0&&(this.showLegacySkillEffects&&this.flashShieldEffect(),this.flashShieldHitEffect()),this.shieldReflectDamage>0&&e.length>0){const l=e.map(h=>h.id),r=this.monsterManager.damageMonsters(l,this.shieldReflectDamage);r.totalExp>0&&this.addExp(r.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${e.length} monsters, killed ${r.killCount}`)}}a>0?(this.currentHp-=a,this.currentHp<0&&(this.currentHp=0),this.hpDamageDelay=I.HP_DAMAGE_DELAY,this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+I.HURT_DURATION,this.isMoving=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${a} damage (${i} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${i} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&console.log("Player died!")}flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1,i=16768324,o=600;let l=this.time.now;const r=()=>{const c=this.time.now-l,n=Math.min(c/o,1);t.clear();const f=.3,g=1-(n<f?0:(n-f)/(1-f));if(g>.01){for(let y=6;y>=1;y--){const M=a*y/6,d=g*(1-(y-1)/6)*.5;d>.01&&(t.fillStyle(i,d),t.fillCircle(e,s,M))}const k=a*.4;t.fillStyle(16777215,g*.8),t.fillCircle(e,s,k),t.lineStyle(5,i,g*.9),t.strokeCircle(e,s,a),t.lineStyle(2,16777215,g*.7),t.strokeCircle(e,s,a*.95)}n>=1&&t.destroy()},h=this.time.addEvent({delay:16,callback:r,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{t.active&&t.destroy(),h.remove()})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),e=t.x,s=t.y,a=I.SKILL_GRID_GAP,i=this.skillGridCellSize+a,o=16763904,l=this.gameBounds.height*.2,r=400,h=200,c=this.time.now,n=[],f=Math.max(0,Math.floor((e-l)/i)),u=Math.min(this.skillGridCols-1,Math.ceil((e+l)/i)),g=Math.max(0,Math.floor((s-l)/i)),m=Math.min(this.skillGridRows-1,Math.ceil((s+l)/i));for(let d=g;d<=m;d++)for(let w=f;w<=u;w++){const x=w*i+this.skillGridCellSize/2,C=d*i+this.skillGridCellSize/2,T=x-e,v=C-s,b=Math.sqrt(T*T+v*v);b<=l&&n.push({col:w,row:d,dist:b})}if(n.length===0)return;const k=[];for(const{col:d,row:w}of n){const x=d*i+this.skillGridCellSize/2,C=w*i+this.skillGridCellSize/2,T=this.add.rectangle(x,C,this.skillGridCellSize,this.skillGridCellSize,o,0);T.setVisible(!1),this.skillGridContainer.add(T),k.push(T)}const y=()=>{const d=this.time.now-c,w=Math.min(d/r,1),x=Math.min(d/h,1),C=l*x,T=l*.3,v=Math.max(0,C-T);let b=0;d>h&&(b=(d-h)/(r-h));let B=0;for(const{dist:P}of n){const A=k[B++];if(A)if(P>=v&&P<=C){const E=(v+C)/2,L=Math.abs(P-E),H=T/2,R=L/H,X=.9*(1-R*.5)*(1-b);if(X>.01){if(d<h&&R<.3){const Y=o>>16&255,K=o>>8&255,G=o&255,D=Math.min(255,Y+Math.floor((255-Y)*.5)),z=Math.min(255,K+Math.floor((255-K)*.5)),O=Math.min(255,G+Math.floor((255-G)*.5)),V=D<<16|z<<8|O;A.setFillStyle(V,X)}else A.setFillStyle(o,X);A.setVisible(!0)}else A.setVisible(!1)}else A.setVisible(!1)}if(w>=1)for(const P of k)P.destroy()};y();const M=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{M.remove();for(const d of k)d.active&&d.destroy()})}flashCharacter(){this.character.setTint(16764108),this.time.delayedCall(50,()=>{this.character.setTint(16737894)}),this.time.delayedCall(100,()=>{this.character.clearTint()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){console.log(`Vignette initialized (grid: ${this.skillGridCols}x${this.skillGridRows})`)}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const e=this.skillGridCells[t];e&&(e.setFillStyle(16777215,0),e.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const e=1500;this.lowHpBreathTimer>=e&&(this.lowHpBreathTimer-=e);const s=this.lowHpBreathTimer/e,a=Math.sin(s*Math.PI*2)*.5+.5;this.drawGridVignette(a)}drawGridVignette(t){const e=.2+t*.2;let s;this.currentShield>0?s=16768324:s=16720418;const a=this.skillGridCols/2,i=this.skillGridRows/2,o=this.skillGridCols/2*2,l=this.skillGridRows/2*2,r=2,h=this.skillGridRows-2;for(let c=r;c<h;c++)for(let n=0;n<this.skillGridCols;n++){const f=c*this.skillGridCols+n,u=this.skillGridCells[f];if(!u)continue;const g=(n-a)/o,m=(c-i)/l,k=Math.sqrt(g*g+m*m);if(k>.5){const y=Math.min(1,(k-.5)/.25),M=e*y;M>.01&&(u.setFillStyle(s,M),u.setVisible(!0),this.vignetteEdgeCells.add(f))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(1002);const t=Math.max(I.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.03)),e=this.skillGridCellSize,s=this.gameBounds.y+this.gameBounds.height-e*2;this.levelText=this.add.text(this.gameBounds.x+10,s-5,`Lv.${this.currentLevel}`,{fontFamily:"monospace",fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText),this.uiContainer.add(this.expBarContainer)}drawExpBarFill(){const t=[this.skillGridRows-2,this.skillGridRows-1];for(const i of t)for(let o=0;o<this.skillGridCols;o++){const l=i*this.skillGridCols+o,r=this.skillGridCells[l];r&&(r.setFillStyle(0,.9),r.setVisible(!0),r.setDepth(1e3))}const e=this.currentExp/this.maxExp,s=this.skillGridCols,a=Math.floor(s*e);if(!(a<=0))for(const i of t)for(let o=0;o<a;o++){const l=i*this.skillGridCols+o,r=this.skillGridCells[l];if(!r)continue;const h=o/s,c=this.expBarFlowOffset,n=(h+c)%1,f=(Math.sin(n*Math.PI*2-Math.PI/2)+1)/2,u=Math.floor(68+68*f),g=Math.floor(136-68*f),k=u<<16|g<<8|255,y=i===this.skillGridRows-2?.95:.8;r.setFillStyle(k,y)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,e=Math.ceil(this.mapWidth/t),s=Math.ceil(this.mapHeight/t);for(let l=0;l<s;l++)for(let r=0;r<e;r++){const h=r*t,c=l*t;(l+r)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(h,c,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(h,c,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const a=this.mapWidth/2,i=this.mapHeight/2,o=t;this.floorGrid.strokeRect(a-o/2,i-o/2,o,o);for(let l=0;l<s;l+=5)for(let r=0;r<e;r+=5){const h=r*t+t/2,c=l*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(h,c,4)}}createSkillBar(){const t=this.skillGridCellSize,e=I.SKILL_GRID_GAP,s=8,a=s*(t+e)-e,i=1,o=2,l=I.ACTIVE_SKILLS,r=I.PASSIVE_SKILLS,h=l*s+(l-1)*i,c=r*s+(r-1)*i,f=(h+o+c)*(t+e)-e,u=this.gameBounds.x+(this.gameBounds.width-f)/2,g=2*(t+e),m=t+e,k=this.gameBounds.y+this.gameBounds.height-g-a-m;let y=u;for(let M=0;M<l;M++){const d=y+a/2,w=k+a/2,x=this.add.container(d,w),C=this.add.rectangle(0,0,a,a);C.setStrokeStyle(0,16777215,0),C.setFillStyle(0,0),x.add(C);const T=this.add.rectangle(0,0,a-4,a-4,3355443,0);x.add(T);const v=Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(a*.2)),b=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${v}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});b.setOrigin(.5,.5),x.add(b),this.skillIcons.push(C),this.skillIconContainers.push(x),this.skillLevelTexts.push(b),x.setDepth(1002),this.uiContainer.add(x),this.drawSkillIconGrid(y,k,s,M),y+=a+i*(t+e)}y+=(o-i)*(t+e);for(let M=0;M<r;M++){const d=y+a/2,w=k+a/2,x=this.add.container(d,w),C=this.add.rectangle(0,0,a,a);C.setStrokeStyle(0,16777215,0),C.setFillStyle(0,0),x.add(C);const T=this.add.rectangle(0,0,a-4,a-4,3355443,0);x.add(T);const v=Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(a*.2)),b=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${v}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});b.setOrigin(.5,.5),x.add(b),this.skillIcons.push(C),this.skillIconContainers.push(x),this.skillLevelTexts.push(b),x.setDepth(1002),this.uiContainer.add(x),this.drawSkillIconGrid(y,k,s,l+M),y+=a+i*(t+e)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}drawSkillIconGrid(t,e,s,a){const i=this.add.graphics();i.setDepth(1001),this.uiContainer.add(i),this.skillIconGridData[a]={startX:t,startY:e,gridSize:s},this.redrawSkillIconGrid(a,0),this.skillIconGridGraphics[a]=i}redrawSkillIconGrid(t,e){const s=this.skillIconGridGraphics[t],a=this.skillIconGridData[t];if(!s||!a)return;s.clear();const i=this.skillGridCellSize,o=I.SKILL_GRID_GAP,{startX:l,startY:r,gridSize:h}=a,c=I.ACTIVE_SKILLS,n=t<c,f=n?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),u=n?t:t-c;if(!f[u]){s.fillStyle(0,.5);for(let d=0;d<h;d++)for(let w=0;w<h;w++){const x=l+w*(i+o),C=r+d*(i+o);s.fillRect(x,C,i,i)}return}const m=[],k=Math.floor(h/2);for(let d=k;d<h;d++)m.push({row:0,col:d});for(let d=1;d<h;d++)m.push({row:d,col:h-1});for(let d=h-2;d>=0;d--)m.push({row:h-1,col:d});for(let d=h-2;d>=1;d--)m.push({row:d,col:0});m.push({row:0,col:0});for(let d=1;d<k;d++)m.push({row:0,col:d});const y=m.length,M=Math.floor(y*e);for(let d=0;d<y;d++){const{row:w,col:x}=m[d],C=l+x*(i+o),T=r+w*(i+o);if(d<M){const v=this.getSkillColorForIndex(t);s.fillStyle(v,.4)}else s.fillStyle(0,.5);s.fillRect(C,T,i,i)}}getSkillColorForIndex(t){const e=I.ACTIVE_SKILLS,s=t<e,a=s?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),i=s?t:t-e,o=a[i];return o?o.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,e=this.skillManager.getPlayerActiveSkills();for(let i=0;i<e.length;i++){const o=e[i];if(!o){this.redrawSkillIconGrid(i,0);continue}const l=o.definition;let r=l.cooldown||1e3;l.id==="active_architect"&&(r=r-o.level*500);const h=this.skillManager.calculateFinalCooldown(r),c=this.skillCooldowns.get(l.id)||0,n=t-c;if(n>=h)this.redrawSkillIconGrid(i,1);else{const f=n/h;this.redrawSkillIconGrid(i,f)}}const s=this.skillManager.getPlayerPassiveSkills(),a=I.ACTIVE_SKILLS;for(let i=0;i<s.length;i++){const o=s[i];if(!o){this.redrawSkillIconGrid(a+i,0);continue}const l=o.definition;let r=1;switch(l.id){case"passive_titanium_liver":{const h=this.skillManager.getTitaniumLiverRegenInterval();h>0&&this.currentHp<this.maxHp&&(r=this.hpRegenTimer/h);break}}this.redrawSkillIconGrid(a+i,r)}}createSkillInfoPanel(){const t=this.gameBounds,e=200,s=80,a=10,i=t.x+a,o=t.y+t.height-s-a-60;this.skillInfoPanel=this.add.container(i,o),this.skillInfoPanel.setDepth(1003),this.skillInfoBg=this.add.rectangle(0,0,e,s,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg),this.skillInfoText=this.add.text(a,a,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff",wordWrap:{width:e-a*2}}),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=I.ACTIVE_SKILLS;for(let e=0;e<this.skillIconContainers.length;e++){const s=this.skillIconContainers[e],a=e<t,i=a?e:e-t;s.setSize(s.getBounds().width,s.getBounds().height),s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this.showSkillInfo(a,i)})}}showSkillInfo(t,e){const a=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[e];if(!a){this.skillInfoPanel.setVisible(!1);return}const i=[];i.push(`【${a.definition.name}】${ot.formatLevel(a.level,a.definition.maxLevel)}`),t?this.appendActiveSkillInfo(i,a):this.appendPassiveSkillInfo(i,a),this.skillInfoText.setText(i.join(`
`));const o=this.skillInfoText.getBounds(),l=10;this.skillInfoBg.setSize(Math.max(180,o.width+l*2),o.height+l*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,e){const s=e.level,a=this.skillManager.getAiEnhancementDamageBonus(),i=this.skillManager.getSyncRateCooldownReduction();switch(e.definition.id){case"active_soul_render":{const o=60+s*10,l=2+s,r=I.DAMAGE_UNIT*l,h=Math.floor(r*(1+a)),n=((e.definition.cooldown||1e3)*(1-i)/1e3).toFixed(1);t.push(`扇形角度: ${o}°`),t.push(`傷害: ${h}`),t.push(`冷卻: ${n}s`);break}case"active_coder":{const o=2+s*.5,l=1+s,r=I.DAMAGE_UNIT*l,h=Math.floor(r*(1+a)),n=((e.definition.cooldown||1500)*(1-i)/1e3).toFixed(1);t.push(`範圍: ${o} 單位`),t.push(`傷害: ${h}`),t.push(`冷卻: ${n}s`);break}case"active_vfx":{const o=s+1,l=1+s,r=I.DAMAGE_UNIT*l,h=Math.floor(r*(1+a)),n=((e.definition.cooldown||2500)*(1-i)/1e3).toFixed(1);t.push(`光束數: ${o} 道`),t.push(`傷害: ${h}`),t.push(`冷卻: ${n}s`);break}case"active_architect":{const o=Math.floor(this.maxHp*.3),l=1+s*1.5,r=I.DAMAGE_UNIT*l,c=((e.definition.cooldown||1e4)*(1-i)/1e3).toFixed(1);t.push(`護盾: ${o} (霸體)`),t.push(`反傷: ${r}`),t.push(`回血: ${o}`),t.push(`冷卻: ${c}s`);break}}}appendPassiveSkillInfo(t,e){switch(e.definition.id){case"passive_titanium_liver":{const s=this.skillManager.getTitaniumLiverHpBonus(),a=this.skillManager.getTitaniumLiverRegenInterval()/1e3;t.push(`HP 加成: +${Math.round(s*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${a} 秒 +1% HP`);break}case"passive_sync_rate":{const s=this.skillManager.getSyncRateSpeedBonus(),a=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(s*100)}%`),t.push(`冷卻減少: -${Math.round(a*100)}%`);break}case"passive_retina_module":{const s=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(s*100)}%`);break}case"passive_ai_enhancement":{const s=this.skillManager.getAiEnhancementDamageBonus(),a=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(s*100)}%`),t.push(`防禦加成: +${Math.round(a*100)}%`);break}}}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),s=[...t,...e];for(let a=0;a<this.skillIconContainers.length;a++){const i=this.skillIconContainers[a],o=this.skillLevelTexts[a],l=s[a],r=i.list[1];l?(r.setFillStyle(l.definition.color,.5),o.setText(ot.formatLevel(l.level,l.definition.maxLevel))):(r.setFillStyle(3355443,0),o.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});s.setOrigin(.5,.5),this.skillPanelContainer.add(s);const a=e+this.gameBounds.height*.06,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});i.setOrigin(.5,.5),this.skillPanelContainer.add(i),this.createSkillOptions();const o=this.gameBounds.y+this.gameBounds.height*.92,l=this.isMobile?"點兩次確認":"重複按同一鍵確認",r=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o,l,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});r.setOrigin(.5,.5),this.skillPanelContainer.add(r)}createSkillCutIn(){this.skillCutInContainer=this.add.container(0,0),this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setDepth(1e3),this.uiContainer.add(this.skillCutInContainer)}showSkillCutIn(t,e){this.skillCutInContainer.removeAll(!0);const s=this.gameBounds.height*.12,a=this.gameBounds.y+this.gameBounds.height*.25,i=this.gameBounds.width*.15,o=this.gameBounds.width-i*2,l=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,a,o,s,0,.75);this.skillCutInContainer.add(l);const r=this.add.graphics(),h=this.gameBounds.x,c=this.gameBounds.x+i,n=20;for(let v=0;v<n;v++){const b=v/n*.75,B=h+i/n*v,P=i/n+1;r.fillStyle(0,b),r.fillRect(B,a-s/2,P,s)}this.skillCutInContainer.add(r);const f=this.add.graphics(),u=this.gameBounds.x+this.gameBounds.width-i;for(let v=0;v<n;v++){const b=(1-v/n)*.75,B=u+i/n*v,P=i/n+1;f.fillStyle(0,b),f.fillRect(B,a-s/2,P,s)}this.skillCutInContainer.add(f);const g=3,m=this.add.graphics(),k=a-s/2-g/2;for(let v=0;v<n;v++){const b=v/n*.8,B=h+i/n*v,P=i/n+1;m.fillStyle(t.color,b),m.fillRect(B,k,P,g)}m.fillStyle(t.color,.8),m.fillRect(c,k,o,g);for(let v=0;v<n;v++){const b=(1-v/n)*.8,B=u+i/n*v,P=i/n+1;m.fillStyle(t.color,b),m.fillRect(B,k,P,g)}this.skillCutInContainer.add(m);const y=this.add.graphics(),M=a+s/2-g/2;for(let v=0;v<n;v++){const b=v/n*.8,B=h+i/n*v,P=i/n+1;y.fillStyle(t.color,b),y.fillRect(B,M,P,g)}y.fillStyle(t.color,.8),y.fillRect(c,M,o,g);for(let v=0;v<n;v++){const b=(1-v/n)*.8,B=u+i/n*v,P=i/n+1;y.fillStyle(t.color,b),y.fillRect(B,M,P,g)}this.skillCutInContainer.add(y);const d=e>=t.maxLevel?"MAX":`Lv.${e}`,w=`${t.name} 提升到 ${d}`,x=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a-s*.18,w,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_LARGE,Math.floor(s*.35))}px`,color:"#ffffff",fontStyle:"bold"});x.setOrigin(.5,.5),this.skillCutInContainer.add(x);let C=t.description;t.levelUpMessages&&t.levelUpMessages[e]&&(C=t.levelUpMessages[e]);const T=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a+s*.22,C,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_MEDIUM,Math.floor(s*.22))}px`,color:F.Display.Color.IntegerToColor(t.color).rgba});T.setOrigin(.5,.5),this.skillCutInContainer.add(T),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(1500,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0)}})})}})}createSkillOptions(){if(this.skillOptions.forEach(h=>h.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,e=this.gameBounds.height*(this.isMobile?.55:.5),s=this.gameBounds.width*.05,a=this.currentSkillChoices.length,i=t*a+s*(a-1),o=this.gameBounds.x+(this.gameBounds.width-i)/2+t/2,l=this.gameBounds.y+this.gameBounds.height*.55,r=["A","S","D"];for(let h=0;h<this.currentSkillChoices.length;h++){const c=this.currentSkillChoices[h],n=this.skillManager.getSkillLevel(c.id),f=n<0,u=f?"-":n,g=f?0:n+1,m=o+h*(t+s),k=this.add.container(m,l),y=this.add.rectangle(0,0,t,e,2236962);y.setStrokeStyle(2,6710886),k.add(y);const M=this.add.text(0,-e*.42,c.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:"monospace",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(e*.045))}px`,color:c.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});M.setOrigin(.5,.5),k.add(M);const d=t*.5,w=-e*.18,x=this.add.rectangle(0,w,d,d,c.color,.3);x.setStrokeStyle(2,c.color),k.add(x);const C=e*.06,T=this.add.text(0,C,c.name,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(T.setOrigin(.5,.5),k.add(T),c.subtitle){const E=this.add.text(0,e*.12,c.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(e*.04))}px`,color:"#999999"});E.setOrigin(.5,.5),k.add(E)}let v;g>=c.maxLevel?v=`Lv.${u} → MAX`:f?v=`NEW → Lv.${g}`:v=`Lv.${u} → Lv.${g}`;const b=this.add.text(0,e*.2,v,{fontFamily:"monospace",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(e*.05))}px`,color:g>=c.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});b.setOrigin(.5,.5),k.add(b);const B=this.isMobile?e*.36:e*.32,P=this.add.text(0,B,c.description,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.max(I.MIN_FONT_SIZE_SMALL,Math.floor(e*.04))}px`,color:"#dddddd",wordWrap:{width:t*.85},align:"center"});if(P.setOrigin(.5,.5),k.add(P),!this.isMobile){const E=this.add.text(0,e*.42,`[ ${r[h]} ]`,{fontFamily:"monospace",fontSize:`${Math.max(I.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.06))}px`,color:"#ffff00",fontStyle:"bold"});E.setOrigin(.5,.5),k.add(E)}y.setInteractive({useHandCursor:!0});const A=h;y.on("pointerover",()=>{this.setSelectedSkill(A)}),y.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===A?this.confirmSkillSelection():this.setSelectedSkill(A):(this.setSelectedSkill(A),this.confirmSkillSelection())}),this.skillPanelContainer.add(k),this.skillOptions.push(k),this.skillCardBgs.push(y)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out! Continue leveling for HP growth.");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isMoving=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,e)=>{e===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,e)=>{t.setScale(e===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:e*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,e){const s=this.currentSkillChoices[t];if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`);return}const i=this.skillManager.getPlayerSkill(e),o=(i==null?void 0:i.level)??0;console.log(`Skill upgraded: ${e} -> Lv.${o}`),this.updateSkillBarDisplay(),(i==null?void 0:i.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const l=this.skillOptions[t];this.tweens.add({targets:l,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel(),this.showSkillCutIn(s,o)}})}createSkillGrid(){const t=this.cameras.main.width,e=1920,s=20/this.gridScaleMultiplier,a=6/this.gridScaleMultiplier,i=Math.min(1,t/e);this.skillGridCellSize=Math.max(a,Math.floor(s*i));const o=I.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+o)/(this.skillGridCellSize+o)),this.skillGridRows=Math.ceil((this.gameBounds.height+o)/(this.skillGridCellSize+o)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(50);for(let l=0;l<this.skillGridRows;l++)for(let r=0;r<this.skillGridCols;r++){const h=r*(this.skillGridCellSize+o)+this.skillGridCellSize/2,c=l*(this.skillGridCellSize+o)+this.skillGridCellSize/2,n=this.add.rectangle(h,c,this.skillGridCellSize,this.skillGridCellSize,16777215,0);n.setVisible(!1),this.skillGridCells.push(n),this.skillGridContainer.add(n)}this.uiContainer.addAt(this.skillGridContainer,0)}recreateSkillGrid(){this.skillGridCells.forEach(t=>t.destroy()),this.skillGridCells=[],this.skillGridContainer&&this.skillGridContainer.destroy(),this.createSkillGrid(),this.recreateSkillBar(),this.bringUIToTop()}bringUIToTop(){this.characterContainer&&this.uiContainer.bringToTop(this.characterContainer),this.hpBarContainer&&this.uiContainer.bringToTop(this.hpBarContainer),this.shieldText&&this.uiContainer.bringToTop(this.shieldText),this.expBarContainer&&this.uiContainer.bringToTop(this.expBarContainer),this.skillIconContainers.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillIconGridGraphics.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillInfoPanel&&this.uiContainer.bringToTop(this.skillInfoPanel),this.skillPanelContainer&&this.uiContainer.bringToTop(this.skillPanelContainer)}recreateSkillBar(){this.skillIcons.forEach(t=>t.destroy()),this.skillIcons=[],this.skillIconContainers.forEach(t=>t.destroy()),this.skillIconContainers=[],this.skillLevelTexts.forEach(t=>t.destroy()),this.skillLevelTexts=[],this.skillIconGridGraphics.forEach(t=>t.destroy()),this.skillIconGridGraphics=[],this.skillIconGridData=[],this.skillInfoPanel&&this.skillInfoPanel.destroy(),this.createSkillBar()}worldToScreen(t,e){return{x:t-this.cameraOffsetX,y:e-this.cameraOffsetY}}showSkillRangeCircle(t,e,s,a,i=.3){const o=this.worldToScreen(t,e),l=o.x,r=o.y,h=I.SKILL_GRID_GAP,c=this.skillGridCellSize+h,n=Math.max(0,Math.floor((l-s)/c)),f=Math.min(this.skillGridCols-1,Math.ceil((l+s)/c)),u=Math.max(0,Math.floor((r-s)/c)),g=Math.min(this.skillGridRows-1,Math.ceil((r+s)/c));for(let m=u;m<=g;m++)for(let k=n;k<=f;k++){const y=k*c+this.skillGridCellSize/2,M=m*c+this.skillGridCellSize/2,d=y-l,w=M-r;if(Math.sqrt(d*d+w*w)<=s){const C=m*this.skillGridCols+k,T=this.skillGridCells[C];T&&(T.setFillStyle(a,i),T.setVisible(!0))}}}showSkillRangeSector(t,e,s,a,i,o,l=.3){const r=this.worldToScreen(t,e),h=r.x,c=r.y,n=I.SKILL_GRID_GAP,f=this.skillGridCellSize+n,u=Math.max(0,Math.floor((h-s)/f)),g=Math.min(this.skillGridCols-1,Math.ceil((h+s)/f)),m=Math.max(0,Math.floor((c-s)/f)),k=Math.min(this.skillGridRows-1,Math.ceil((c+s)/f));for(let y=m;y<=k;y++)for(let M=u;M<=g;M++){const d=M*f+this.skillGridCellSize/2,w=y*f+this.skillGridCellSize/2,x=d-h,C=w-c,T=Math.sqrt(x*x+C*C);if(T<=s&&T>0){const v=Math.atan2(C,x);let b=Math.abs(v-a);if(b>Math.PI&&(b=2*Math.PI-b),b<=i){const B=y*this.skillGridCols+M,P=this.skillGridCells[B];P&&(P.setFillStyle(o,l),P.setVisible(!0))}}}}showSkillRangeLine(t,e,s,a,i,o,l=.3){const r=this.worldToScreen(t,e),h=this.worldToScreen(s,a),c=I.SKILL_GRID_GAP,n=this.skillGridCellSize+c,f=h.x-r.x,u=h.y-r.y,g=Math.sqrt(f*f+u*u);if(g===0)return;const m=f/g,k=u/g,y=-k,M=m,d=i/2,w=[{x:r.x+y*d,y:r.y+M*d},{x:r.x-y*d,y:r.y-M*d},{x:h.x+y*d,y:h.y+M*d},{x:h.x-y*d,y:h.y-M*d}],x=Math.min(...w.map(E=>E.x)),C=Math.max(...w.map(E=>E.x)),T=Math.min(...w.map(E=>E.y)),v=Math.max(...w.map(E=>E.y)),b=Math.max(0,Math.floor(x/n)),B=Math.min(this.skillGridCols-1,Math.ceil(C/n)),P=Math.max(0,Math.floor(T/n)),A=Math.min(this.skillGridRows-1,Math.ceil(v/n));for(let E=P;E<=A;E++)for(let L=b;L<=B;L++){const H=L*n+this.skillGridCellSize/2,R=E*n+this.skillGridCellSize/2,_=Math.max(0,Math.min(1,((H-r.x)*m+(R-r.y)*k)/g)),X=r.x+_*f,Y=r.y+_*u;if(Math.sqrt((H-X)**2+(R-Y)**2)<=d){const G=E*this.skillGridCols+L,D=this.skillGridCells[G];D&&(D.setFillStyle(o,l),D.setVisible(!0))}}}clearSkillGrid(){this.skillGridCells.forEach((t,e)=>{if(this.vignetteEdgeCells.has(e)&&(this.isLowHp||this.currentShield>0))return;const s=Math.floor(e/this.skillGridCols);s<2||s>=this.skillGridRows-2||t.setVisible(!1)})}flashGridAt(t,e,s,a=1){const i=this.worldToScreen(t,e),o=I.SKILL_GRID_GAP,l=this.skillGridCellSize+o,r=Math.floor(i.x/l),h=Math.floor(i.y/l),c=600,n=200,f=this.time.now,u=[];for(let k=-a;k<=a;k++)for(let y=-a;y<=a;y++){const M=r+y,d=h+k;if(M<0||M>=this.skillGridCols||d<0||d>=this.skillGridRows)continue;const w=Math.sqrt(k*k+y*y);if(w<=a){const x=d*this.skillGridCols+M,C=this.skillGridCells[x];C&&u.push({cell:C,dist:w})}}if(u.length===0)return;const g=()=>{const k=this.time.now-f,y=Math.min(k/c,1);let M=0;k>n&&(M=(k-n)/(c-n));for(const{cell:d,dist:w}of u){const x=w/Math.max(a,1),T=(1-x*.4)*(1-M);if(T>.01)if(k<n){const b=(1-x)*.5;if(d.setFillStyle(s,T),d.setVisible(!0),w<a*.5){const B=s>>16&255,P=s>>8&255,A=s&255,E=Math.min(255,B+Math.floor((255-B)*b)),L=Math.min(255,P+Math.floor((255-P)*b)),H=Math.min(255,A+Math.floor((255-A)*b)),R=E<<16|L<<8|H;d.setFillStyle(R,T)}}else d.setFillStyle(s,T),d.setVisible(!0);else d.setVisible(!1)}if(y>=1)for(const{cell:d}of u)d.setVisible(!1),d.setAlpha(1)};g();const m=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{m.remove();for(const{cell:k}of u)k.setVisible(!1),k.setAlpha(1)})}flashGridAtPositions(t,e,s=1){t.forEach(a=>{this.flashGridAt(a.x,a.y,e,s)})}flashWhiteCrossAt(t,e){const s=this.worldToScreen(t,e),a=I.SKILL_GRID_GAP,i=this.skillGridCellSize+a,o=Math.floor(s.x/i),l=Math.floor(s.y/i),r=3,h=300,c=this.time.now,n=[];o>=0&&o<this.skillGridCols&&l>=0&&l<this.skillGridRows&&n.push({col:o,row:l,dist:0});const f=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:k,dr:y}of f)for(let M=1;M<=r;M++){const d=o+k*M,w=l+y*M;d>=0&&d<this.skillGridCols&&w>=0&&w<this.skillGridRows&&n.push({col:d,row:w,dist:M})}if(n.length===0)return;const u=[];for(const{col:k,row:y}of n){const M=k*i+this.skillGridCellSize/2,d=y*i+this.skillGridCellSize/2,w=this.add.rectangle(M,d,this.skillGridCellSize,this.skillGridCellSize,16777215,0);w.setVisible(!1),this.skillGridContainer.add(w),u.push(w)}const g=()=>{const k=this.time.now-c,y=Math.min(k/h,1),d=r*y;let w=0;for(const{dist:x}of n){const C=u[w++];if(C)if(x>=d){const v=1-x/r*.5;let b=1;d>0&&x<d+1&&(b=x-d);const B=v*Math.max(0,b);B>.01?(C.setFillStyle(16777215,B),C.setVisible(!0)):C.setVisible(!1)}else C.setVisible(!1)}if(y>=1)for(const x of u)x.destroy()};g();const m=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{m.remove();for(const k of u)k.active&&k.destroy()})}flashWhiteCrossAtPositions(t){t.forEach(e=>{this.flashWhiteCrossAt(e.x,e.y)})}flashSkillAreaSector(t,e,s,a,i,o){const l=this.worldToScreen(t,e),r=l.x,h=l.y,c=I.SKILL_GRID_GAP,n=this.skillGridCellSize+c,f=500,u=150,g=150,m=this.time.now,k=[],y=Math.max(0,Math.floor((r-s)/n)),M=Math.min(this.skillGridCols-1,Math.ceil((r+s)/n)),d=Math.max(0,Math.floor((h-s)/n)),w=Math.min(this.skillGridRows-1,Math.ceil((h+s)/n));for(let v=d;v<=w;v++)for(let b=y;b<=M;b++){const B=b*n+this.skillGridCellSize/2,P=v*n+this.skillGridCellSize/2,A=B-r,E=P-h,L=Math.sqrt(A*A+E*E);if(L<=s&&L>0){const H=Math.atan2(E,A);let R=Math.abs(H-a);R>Math.PI&&(R=2*Math.PI-R),R<=i&&k.push({col:b,row:v,dist:L,angleDist:R})}}if(k.length===0)return;const x=[];for(const{col:v,row:b}of k){const B=v*n+this.skillGridCellSize/2,P=b*n+this.skillGridCellSize/2,A=this.add.rectangle(B,P,this.skillGridCellSize,this.skillGridCellSize,o,0);A.setVisible(!1),this.skillGridContainer.add(A),x.push(A)}const C=()=>{const v=this.time.now-m,b=Math.min(v/f,1),B=Math.min(v/u,1),P=s*B;let A=0;v>u+g&&(A=(v-u-g)/(f-u-g));const E=s*A;let L=0;for(const{dist:H,angleDist:R}of k){const _=x[L++];if(_)if(H<=P&&H>=E){const X=H/s,Y=R/i,D=Math.max(X,Y),z=Math.max(0,Math.min(1,(D-.3)/.7)),O=z*z*(3-2*z),V=.15+O*.6;let U=1;if(E>0){const q=s*.15;H<E+q&&(U=(H-E)/q)}const W=V*U;if(W>.01){const q=.5+O*.5,$=o>>16&255,J=o>>8&255,j=o&255;let et=$,Q=J,st=j;if(D>.85&&v<u+g){const it=(D-.85)/.15;et=Math.min(255,$+Math.floor((255-$)*it*.3)),Q=Math.min(255,J+Math.floor((255-J)*it*.3)),st=Math.min(255,j+Math.floor((255-j)*it*.3))}else et=Math.floor($*q),Q=Math.floor(J*q),st=Math.floor(j*q);const rt=et<<16|Q<<8|st;_.setFillStyle(rt,W),_.setVisible(!0)}else _.setVisible(!1)}else _.setVisible(!1)}if(b>=1)for(const H of x)H.destroy()};C();const T=this.time.addEvent({delay:16,callback:C,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{T.remove();for(const v of x)v.active&&v.destroy()})}flashSkillAreaCircle(t,e,s,a){const i=this.worldToScreen(t,e),o=i.x,l=i.y,r=I.SKILL_GRID_GAP,h=this.skillGridCellSize+r,c=500,n=150,f=150,u=this.time.now,g=[],m=Math.max(0,Math.floor((o-s)/h)),k=Math.min(this.skillGridCols-1,Math.ceil((o+s)/h)),y=Math.max(0,Math.floor((l-s)/h)),M=Math.min(this.skillGridRows-1,Math.ceil((l+s)/h));for(let C=y;C<=M;C++)for(let T=m;T<=k;T++){const v=T*h+this.skillGridCellSize/2,b=C*h+this.skillGridCellSize/2,B=v-o,P=b-l,A=Math.sqrt(B*B+P*P);A<=s&&g.push({col:T,row:C,dist:A})}if(g.length===0)return;const d=[];for(const{col:C,row:T}of g){const v=C*h+this.skillGridCellSize/2,b=T*h+this.skillGridCellSize/2,B=this.add.rectangle(v,b,this.skillGridCellSize,this.skillGridCellSize,a,0);B.setVisible(!1),this.skillGridContainer.add(B),d.push(B)}const w=()=>{const C=this.time.now-u,T=Math.min(C/c,1),v=Math.min(C/n,1),b=s*v;let B=0;C>n+f&&(B=(C-n-f)/(c-n-f));const P=s*B;let A=0;for(const{dist:E}of g){const L=d[A++];if(L)if(E<=b&&E>=P){const H=E/s,R=Math.max(0,Math.min(1,(H-.3)/.7)),_=R*R*(3-2*R),X=.15+_*.6;let Y=1;if(P>0){const G=s*.15;E<P+G&&(Y=(E-P)/G)}const K=X*Y;if(K>.01){const G=.5+_*.5,D=a>>16&255,z=a>>8&255,O=a&255;let V=D,U=z,W=O;if(H>.85&&C<n+f){const $=(H-.85)/.15;V=Math.min(255,D+Math.floor((255-D)*$*.3)),U=Math.min(255,z+Math.floor((255-z)*$*.3)),W=Math.min(255,O+Math.floor((255-O)*$*.3))}else V=Math.floor(D*G),U=Math.floor(z*G),W=Math.floor(O*G);const q=V<<16|U<<8|W;L.setFillStyle(q,K),L.setVisible(!0)}else L.setVisible(!1)}else L.setVisible(!1)}if(T>=1)for(const E of d)E.destroy()};w();const x=this.time.addEvent({delay:16,callback:w,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{x.remove();for(const C of d)C.active&&C.destroy()})}flashSkillAreaLine(t,e,s,a,i,o){const l=this.worldToScreen(t,e),r=this.worldToScreen(s,a),h=I.SKILL_GRID_GAP,c=this.skillGridCellSize+h,n=r.x-l.x,f=r.y-l.y,u=Math.sqrt(n*n+f*f);if(u===0)return;const g=n/u,m=f/u,k=-m,y=g,M=i/2,d=800,w=80,x=300,C=d-w-x,T=this.time.now,v=[],b=[{x:l.x+k*M,y:l.y+y*M},{x:l.x-k*M,y:l.y-y*M},{x:r.x+k*M,y:r.y+y*M},{x:r.x-k*M,y:r.y-y*M}],B=Math.min(...b.map(G=>G.x)),P=Math.max(...b.map(G=>G.x)),A=Math.min(...b.map(G=>G.y)),E=Math.max(...b.map(G=>G.y)),L=Math.max(0,Math.floor(B/c)),H=Math.min(this.skillGridCols-1,Math.ceil(P/c)),R=Math.max(0,Math.floor(A/c)),_=Math.min(this.skillGridRows-1,Math.ceil(E/c));for(let G=R;G<=_;G++)for(let D=L;D<=H;D++){const z=D*c+this.skillGridCellSize/2,O=G*c+this.skillGridCellSize/2,V=z-l.x,U=O-l.y,W=V*g+U*m;if(W<0||W>u)continue;const q=l.x+g*W,$=l.y+m*W,J=Math.sqrt((z-q)**2+(O-$)**2);J<=M&&v.push({col:D,row:G,distAlong:W,distToLine:J})}if(v.length===0)return;const X=[];for(const{col:G,row:D}of v){const z=G*c+this.skillGridCellSize/2,O=D*c+this.skillGridCellSize/2,V=this.add.rectangle(z,O,this.skillGridCellSize,this.skillGridCellSize,o,0);V.setVisible(!1),this.skillGridContainer.add(V),X.push(V)}const Y=()=>{const G=this.time.now-T,D=Math.min(G/d,1),z=Math.min(G/w,1),O=u*z;let V=0;G>w+x&&(V=(G-w-x)/C);const U=u*V,W=1-V;let q=0;for(const{distAlong:$,distToLine:J}of v){const j=X[q++];if(!j)continue;const et=M*W;if($<=O&&$>=U&&J<=et){const Q=et>0?J/et:1,st=1-Q*Q;let rt=.2+st*.5;const it=$/u,Tt=Math.min(1,it/.15),Pt=Math.min(1,(1-it)/.15),xt=Math.min(Tt,Pt);rt*=xt*xt;let wt=1;if(U>0){const at=u*.1;$<U+at&&(wt=($-U)/at)}const vt=rt*wt;if(vt>.01){const at=.6+st*.4,ct=o>>16&255,dt=o>>8&255,ft=o&255;let gt,pt,ut;if(Q<.2&&G<w+x){const mt=1-Q/.2;gt=Math.min(255,ct+Math.floor((255-ct)*mt*.3)),pt=Math.min(255,dt+Math.floor((255-dt)*mt*.3)),ut=Math.min(255,ft+Math.floor((255-ft)*mt*.3))}else gt=Math.floor(ct*at),pt=Math.floor(dt*at),ut=Math.floor(ft*at);const It=gt<<16|pt<<8|ut;j.setFillStyle(It,vt),j.setVisible(!0)}else j.setVisible(!1)}else j.setVisible(!1)}if(D>=1)for(const $ of X)$.destroy()};Y();const K=this.time.addEvent({delay:16,callback:Y,callbackScope:this,repeat:Math.ceil(d/16)});this.time.delayedCall(d+50,()=>{K.remove();for(const G of X)G.active&&G.destroy()})}};p(I,"MAP_SCALE",10),p(I,"ACTIVE_SKILLS",4),p(I,"PASSIVE_SKILLS",3),p(I,"CAMERA_DEAD_ZONE",.3),p(I,"HP_DAMAGE_DELAY",1e3),p(I,"HP_DAMAGE_LERP_SPEED",3),p(I,"MIN_FONT_SIZE_LARGE",14),p(I,"MIN_FONT_SIZE_MEDIUM",12),p(I,"MIN_FONT_SIZE_SMALL",10),p(I,"BASE_HP",200),p(I,"HP_PER_LEVEL",50),p(I,"BASE_EXP",100),p(I,"EXP_GROWTH_RATE",1.2),p(I,"DAMAGE_UNIT",10),p(I,"HURT_DURATION",200),p(I,"ATTACK_DURATION",150),p(I,"SKILL_GRID_GAP",1);let kt=I;const Lt=7,Ht={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},Rt={charHeight:Lt,chars:Ht};class Ft{constructor(){p(this,"font");this.font=Rt}textToPixels(S,t,e){const s=[],a=S.letterSpacing??1,i=S.color.replace("#",""),o=parseInt(i.substring(0,2),16),l=parseInt(i.substring(2,4),16),r=parseInt(i.substring(4,6),16),h=o<<16|l<<8|r;let c=0;const n=S.text.toUpperCase().split("");for(let y=0;y<n.length;y++){const M=this.font.chars[n[y]];M&&(c+=M.width,y<n.length-1&&(c+=a))}const f=Math.floor(t*S.position.x),u=Math.floor(e*S.position.y),g=f-Math.floor(c/2),m=u-Math.floor(this.font.charHeight/2);let k=g;for(const y of n){const M=this.font.chars[y];if(M){for(let d=0;d<M.pixels.length;d++){const w=M.pixels[d];for(let x=0;x<w.length;x++)if(w[x]==="#"){const C=k+x,T=m+d;C>=0&&C<t&&T>=0&&T<e&&s.push({gridX:C,gridY:T,color:h})}}k+=M.width+a}}return s}processConfig(S,t,e){const s=new Map;for(const a of S.texts){const i=this.textToPixels(a,t,e);s.set(a.id,i)}return s}}const _t=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],Dt={texts:_t},tt=class tt extends F.Scene{constructor(){super("GridScene");p(this,"cells",[]);p(this,"cols",0);p(this,"rows",0);p(this,"cellWidth",10);p(this,"cellHeight",10);p(this,"gap",1);p(this,"isAnimating",!1);p(this,"isReady",!1);p(this,"textRenderer");p(this,"textPixels",new Map);p(this,"cursorGlowRadius",4);p(this,"glowPhase",0);p(this,"textBreathPhase",0);p(this,"isLoading",!0);p(this,"loadingCells",new Set);p(this,"backgroundImage");p(this,"titleBgm");this.textRenderer=new Ft}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const e=Math.floor(t.x/(this.cellWidth+this.gap)),s=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(e,s)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const s=this.input.activePointer;s&&this.updateCursorGlow(s.x,s.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),s=e<<16|e<<8|e,a=.5+.5*Math.sin(this.textBreathPhase*3),i=t>.6?a*.8:0,o=new Set;this.cells.forEach(l=>{l.isText&&o.add(`${l.x},${l.y}`)}),this.cells.forEach(l=>{if(l.isText)l.graphics.setFillStyle(s),l.graphics.setAlpha(.95);else{const r=`${l.x-1},${l.y-1}`;o.has(r)&&i>0&&(l.graphics.setFillStyle(8939263),l.graphics.setAlpha(i))}})}updateCursorGlow(t,e){const s=Math.floor(t/(this.cellWidth+this.gap)),a=Math.floor(e/(this.cellHeight+this.gap)),i=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(o=>{const l=o.x-s,r=o.y-a,h=Math.sqrt(l*l+r*r);if(h<=this.cursorGlowRadius){const n=(1-h/this.cursorGlowRadius)*i,f=o.originalColor>>16&255,u=o.originalColor>>8&255,g=o.originalColor&255,m=Math.min(255,Math.floor(f+(255-f)*n)),k=Math.min(255,Math.floor(u+(255-u)*n)),y=Math.min(255,Math.floor(g+(255-g)*n)),M=m<<16|k<<8|y;o.graphics.setFillStyle(M)}else o.graphics.setFillStyle(o.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,e/2,"background");const s=t/this.backgroundImage.width,a=e/this.backgroundImage.height,i=Math.max(s,a);this.backgroundImage.setScale(i),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(a=>{this.cells[a]&&(this.cells[a].originalColor=2236962,this.cells[a].isText=!1,this.cells[a].graphics.setFillStyle(2236962),this.cells[a].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(a=>{const i=a.gridY*this.cols+a.gridX;this.cells[i]&&(this.cells[i].originalColor=a.color,this.cells[i].isText=!0,this.cells[i].graphics.setFillStyle(a.color),this.cells[i].graphics.setAlpha(.95),this.loadingCells.add(i))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const e=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,e.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].graphics.setFillStyle(e.color),this.cells[s].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,s=Math.min(1,t/tt.BASE_WIDTH),a=Math.max(tt.MIN_CELL_SIZE,Math.floor(tt.BASE_CELL_SIZE*s));this.gap=1,this.cellWidth=a,this.cellHeight=a,this.cols=Math.ceil((t+this.gap)/(a+this.gap)),this.rows=Math.ceil((e+this.gap)/(a+this.gap));const i=.05,o=t*(1-i*2),l=e*(1-i*2),r=16/9,h=o/l;let c,n;h>r?(n=l,c=l*r):(c=o,n=o/r);const f=(t-c)/2,u=(e-n)/2;this.registry.set("gameBounds",{x:f,y:u,width:c,height:n}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${a}, gameBounds: ${c.toFixed(0)}x${n.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const s=e*(this.cellWidth+this.gap)+this.cellWidth/2,a=t*(this.cellHeight+this.gap)+this.cellHeight/2,i=this.add.rectangle(s,a,this.cellWidth,this.cellHeight,2236962);i.setAlpha(0),this.cells.push({x:e,y:t,graphics:i,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(Dt,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].originalColor=e.color,this.cells[s].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let m=0;m<this.cells.length;m++)t.add(m);const e=20,s=50,a=10,o=Math.floor(200/a),l=3e3;let r=0,h=!1;const c=(m,k)=>k*this.cols+m,n=m=>({x:m%this.cols,y:Math.floor(m/this.cols)}),f=m=>{const k=this.cells[m];k.graphics.setAlpha(1),k.graphics.setFillStyle(16777215),this.tweens.add({targets:k.graphics,fillColor:{from:16777215,to:k.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},u=m=>{const{x:k,y}=n(m),M=o,d=[];for(let C=0;C<=M;C++)d[C]=[];for(let C=-M;C<=M;C++)for(let T=-M;T<=M;T++){const v=k+T,b=y+C;if(v>=0&&v<this.cols&&b>=0&&b<this.rows){const B=Math.sqrt(T*T+C*C),P=Math.floor(B);if(P<=M){const A=c(v,b);d[P].push(A)}}}let w=0;const x=()=>{w>M||(d[w].forEach(C=>{t.has(C)&&(t.delete(C),f(C))}),w++,w<=M&&this.time.delayedCall(a,x))};x()},g=()=>{if(h)return;if(r>=l||t.size===0){this.finishEntry(t),h=!0;return}const m=Array.from(t),k=Math.min(e,m.length);for(let y=0;y<k&&m.length!==0;y++){const M=Math.floor(Math.random()*m.length),d=m[M];m.splice(M,1),t.has(d)&&u(d)}r+=s,t.size>0&&r<l?this.time.delayedCall(s,g):h||(this.finishEntry(t),h=!0)};g()}finishEntry(t){t.forEach(e=>{const s=this.cells[e];s.graphics.setAlpha(.2),s.graphics.setFillStyle(s.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const s=this.cameras.main.width,a=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const i=t*(this.cellWidth+this.gap)+this.cellWidth/2,o=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:i,y:o,radius:0}),this.cells.forEach(n=>{n.graphics.setFillStyle(0),n.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const l=5;let r=0;this.cells.forEach(n=>{const f=n.x-t,u=n.y-e,g=Math.sqrt(f*f+u*u);n.delay=Math.floor(g*l),n.delay>r&&(r=n.delay)});const h=Math.sqrt(Math.max(i,s-i)**2+Math.max(o,a-o)**2)+50,c=r+150;this.tweens.addCounter({from:0,to:h,duration:c,ease:"Linear",onUpdate:n=>{const f=n.getValue()??0;this.registry.events.emit("reveal-update",{x:i,y:o,radius:f})}}),this.cells.forEach(n=>{this.time.delayedCall(n.delay,()=>{n.graphics.setFillStyle(16777215),n.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:f=>{const u=f.getValue()??0;let g,m;u<15?(g=16777215,m=1):u<30?(g=16776960,m=1):u<50?(g=16746496,m=1):u<70?(g=16720384,m=1-(u-50)/50):(g=6684672,m=1-(u-50)/50),n.graphics.setFillStyle(g),n.graphics.setAlpha(Math.max(0,m))},onComplete:()=>{n.graphics.setVisible(!1)}})})}),this.time.delayedCall(r+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};p(tt,"BASE_CELL_SIZE",10),p(tt,"MIN_CELL_SIZE",4),p(tt,"BASE_WIDTH",1920);let yt=tt;const bt=document.getElementById("version-info");bt&&(bt.textContent="v0.3.0a");let N=null;function Xt(){return window.innerWidth>window.innerHeight}function Mt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function Yt(){if(N)return;const Z={type:F.AUTO,width:window.innerWidth,height:Mt(),parent:"app",backgroundColor:"#111111",pixelArt:!0,scale:{mode:F.Scale.RESIZE,autoCenter:F.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[yt,At,kt]};N=new F.Game(Z),N.events.once("ready",()=>{N&&N.sound&&(N.sound.volume=.5)})}function Ct(){(window.innerWidth>900||Xt())&&Yt()}Ct();window.addEventListener("resize",Ct);window.addEventListener("orientationchange",()=>{setTimeout(Ct,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{N&&N.scale.resize(window.innerWidth,Mt())});document.addEventListener("fullscreenchange",()=>{N&&setTimeout(()=>{N.scale.resize(window.innerWidth,Mt())},100)});window.addEventListener("volumechange",Z=>{N&&N.sound&&(N.sound.volume=Z.detail.volume)});
