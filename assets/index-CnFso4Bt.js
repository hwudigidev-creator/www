var Pt=Object.defineProperty;var It=(tt,M,t)=>M in tt?Pt(tt,M,{enumerable:!0,configurable:!0,writable:!0,value:t}):tt[M]=t;var C=(tt,M,t)=>It(tt,typeof M!="symbol"?M+"":M,t);import{P as O}from"./phaser-0RJB29YE.js";(function(){const M=document.createElement("link").relList;if(M&&M.supports&&M.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&e(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class At extends O.Scene{constructor(){super("BootScene")}preload(){this.load.image("effect_circle","effects/circle.png"),this.load.image("effect_line","effects/line.png");const M=[30,40,50,60,70,80,90,100,110,120,130,140,150,160];for(const t of M)this.load.image(`effect_sector_${t}`,`effects/sector_${t}.png`)}create(){this.scene.start("MainScene")}}const ft=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5,levelUpMessages:["60° 扇形、2 傷害","70° 扇形、3 傷害","80° 扇形、4 傷害","90° 扇形、5 傷害","100° 扇形、6 傷害","110° 扇形、7 傷害，已達最大等級！"],maxExtraAbility:{name:"穿透",description:"攻擊後 {value} 機率發射扇形波",baseValue:0,perLevel:.004,unit:"%",isPercentage:!0}},{id:"active_coder",name:"遊戲先知",subtitle:"編碼者",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5,levelUpMessages:["2 單位範圍、1 傷害","2.5 單位範圍、2 傷害","3 單位範圍、3 傷害","3.5 單位範圍、4 傷害","4 單位範圍、5 傷害","4.5 單位範圍、6 傷害，已達最大等級！"],maxExtraAbility:{name:"爆發",description:"擊殺時 {value} 機率再發動（可連鎖）",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}},{id:"active_vfx",name:"超級導演",subtitle:"視效師",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5,levelUpMessages:["1 道光束、1 傷害","2 道光束、2 傷害","3 道光束、3 傷害","4 道光束、4 傷害","5 道光束、5 傷害","6 道光束、6 傷害，已達最大等級！"],maxExtraAbility:{name:"連鎖",description:"擊中時 {value} 機率再發射",baseValue:0,perLevel:.001,unit:"%",isPercentage:!0}},{id:"active_architect",name:"靈魂統領",subtitle:"架構師",description:"產生 30% HP 護盾（霸體）並反傷攻擊者，護盾消失時回復等值 HP",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5,levelUpMessages:["30% HP 護盾、1 反傷","30% HP 護盾、2.5 反傷","30% HP 護盾、4 反傷","30% HP 護盾、5.5 反傷","30% HP 護盾、7 反傷","30% HP 護盾、8.5 反傷，已達最大等級！"],maxExtraAbility:{name:"堅守",description:"護盾覆蓋時 {value} 機率炸開",baseValue:0,perLevel:.01,unit:"%",isPercentage:!0}},{id:"passive_titanium_liver",name:"鈦金屬賽博肝臟",description:"提升 10% HP 總量並每 15 秒回復 1% 最大 HP，每級再 +10% HP、回復間隔 -1 秒",type:"passive",color:11189196,maxLevel:5,levelUpMessages:["+10% HP、每 15 秒回血","+20% HP、每 14 秒回血","+30% HP、每 13 秒回血","+40% HP、每 12 秒回血","+50% HP、每 11 秒回血","+60% HP、每 10 秒回血，已達最大等級！"],maxExtraAbility:{name:"不死",description:"抵銷一次死亡，觸發暗影爆炸",baseValue:1,perLevel:0,unit:"次",isPercentage:!1}},{id:"passive_sync_rate",name:"精神同步率強化",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5,levelUpMessages:["+10% 移速、-8% 冷卻","+20% 移速、-16% 冷卻","+30% 移速、-24% 冷卻","+40% 移速、-32% 冷卻","+50% 移速、-40% 冷卻","+60% 移速、-48% 冷卻，已達最大等級！"],maxExtraAbility:{name:"迅捷",description:"閃避機率 +{value}",baseValue:0,perLevel:.002,unit:"%",isPercentage:!0}},{id:"passive_retina_module",name:"視網膜增強模組",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10035763,maxLevel:5,levelUpMessages:["+30% 經驗","+60% 經驗","+90% 經驗","+120% 經驗","+150% 經驗","+180% 經驗，已達最大等級！"],maxExtraAbility:{name:"洞察",description:"暴擊率 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"提升 25% 攻擊、15% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5,levelUpMessages:["+25% 攻擊、+15% 防禦","+50% 攻擊、+30% 防禦","+75% 攻擊、+45% 防禦","+100% 攻擊、+60% 防禦","+125% 攻擊、+75% 防禦","+150% 攻擊、+90% 防禦，已達最大等級！"],maxExtraAbility:{name:"超載",description:"暴擊傷害 +{value}",baseValue:0,perLevel:.005,unit:"%",isPercentage:!0}}],nt=class nt{constructor(){C(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return ft.filter(M=>M.type==="active")}getPassiveSkillDefinitions(){return ft.filter(M=>M.type==="passive")}getPlayerSkill(M){return this.playerSkills.get(M)}getPlayerActiveSkills(){const M=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&M.push(e)});const t=[];for(let e=0;e<4;e++)t.push(M[e]||null);return t}getPlayerPassiveSkills(){const M=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&M.push(e)});const t=[];for(let e=0;e<nt.MAX_PASSIVE_SLOTS;e++)t.push(M[e]||null);return t}getOwnedPassiveCount(){let M=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&M++}),M}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=nt.MAX_PASSIVE_SLOTS}getSkillLevel(M){const t=this.playerSkills.get(M);return t?t.level:-1}isSkillMaxLevel(M){const t=this.playerSkills.get(M);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(M){const t=ft.find(i=>i.id===M);if(!t)return!1;const e=this.playerSkills.get(M);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(M,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(M=>{const t=this.playerSkills.get(M.id);return!t||t.level<M.maxLevel})}getUpgradeablePassiveSkills(){const M=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return M?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const M=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){const s=this.shuffleArray([...M]);for(let n=0;n<Math.min(3,s.length);n++)e.push(s[n]);return e}const i=this.shuffleArray([...M]);for(let s=0;s<Math.min(2,i.length);s++)e.push(i[s]);const o=this.shuffleArray([...t]);return o.length>0&&e.push(o[0]),e}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(M){for(let t=M.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[M[t],M[e]]=[M[e],M[t]]}return M}static formatLevel(M,t=5){return M<=0?"Lv.0":M>=t?"MAX":`Lv.${M}`}getTitaniumLiverHpBonus(){const M=this.playerSkills.get("passive_titanium_liver");return M?(M.level+1)*.1:0}getTitaniumLiverRegenInterval(){const M=this.playerSkills.get("passive_titanium_liver");return M?(15-M.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const M=this.playerSkills.get("passive_sync_rate");return M?(M.level+1)*.1:0}getSyncRateCooldownReduction(){const M=this.playerSkills.get("passive_sync_rate");return M?(M.level+1)*.08:0}getRetinaModuleExpBonus(){const M=this.playerSkills.get("passive_retina_module");return M?(M.level+1)*.3:0}getAiEnhancementDamageBonus(){const M=this.playerSkills.get("passive_ai_enhancement");return M?(M.level+1)*.25:0}getAiEnhancementDefenseBonus(){const M=this.playerSkills.get("passive_ai_enhancement");return M?(M.level+1)*.15:0}calculateFinalMaxHp(M){const t=this.getTitaniumLiverHpBonus();return Math.floor(M*(1+t))}calculateFinalMoveSpeed(M){const t=this.getSyncRateSpeedBonus();return M*(1+t)}calculateFinalCooldown(M){const t=this.getSyncRateCooldownReduction();return M*(1-t)}calculateFinalExp(M){const t=this.getRetinaModuleExpBonus();return Math.floor(M*(1+t))}calculateFinalDamage(M){const t=this.getAiEnhancementDamageBonus();return Math.floor(M*(1+t))}calculateFinalDamageWithCrit(M,t){const e=this.getAiEnhancementDamageBonus();let i=Math.floor(M*(1+e));const o=this.getRetinaModuleCritChance(t);let s=!1;if(o>0&&Math.random()<o){s=!0;const n=1.5,l=this.getAiEnhancementCritDamage(t),a=n+l;i=Math.floor(i*a)}return{damage:i,isCrit:s}}calculateFinalDamageTaken(M){const t=this.getAiEnhancementDefenseBonus();return Math.floor(M*(1-t))}getMaxExtraAbilityValue(M,t){const e=this.playerSkills.get(M);if(!e||e.level<e.definition.maxLevel)return 0;const i=e.definition.maxExtraAbility;return i?i.baseValue+i.perLevel*t:0}getMaxExtraAbilityText(M,t){const e=this.playerSkills.get(M);if(!e||e.level<e.definition.maxLevel)return null;const i=e.definition.maxExtraAbility;if(!i)return null;const o=this.getMaxExtraAbilityValue(M,t),s=i.isPercentage?(o*100).toFixed(1):o.toFixed(1);return`【${i.name}】${i.description.replace("{value}",s+i.unit)}`}getAllMaxExtraAbilities(M){const t=[];return this.playerSkills.forEach((e,i)=>{const o=this.getMaxExtraAbilityText(i,M);o&&t.push({skillId:i,text:o})}),t}getSoulRenderWaveChance(M){return this.getMaxExtraAbilityValue("active_soul_render",M)}getCoderBurstChance(M){return this.getMaxExtraAbilityValue("active_coder",M)}getVfxChainChance(M){return this.getMaxExtraAbilityValue("active_vfx",M)}getArchitectExplosionChance(M){return this.getMaxExtraAbilityValue("active_architect",M)}hasTitaniumLiverRevive(){const M=this.playerSkills.get("passive_titanium_liver");return M?M.level>=M.definition.maxLevel:!1}getSyncRateDodgeChance(M){return this.getMaxExtraAbilityValue("passive_sync_rate",M)}getRetinaModuleCritChance(M){return this.getMaxExtraAbilityValue("passive_retina_module",M)}getAiEnhancementCritDamage(M){return this.getMaxExtraAbilityValue("passive_ai_enhancement",M)}};C(nt,"MAX_PASSIVE_SLOTS",3);let lt=nt;const dt=[{id:"slime",name:"史萊姆",color:6750054,speed:1,damage:1,size:.05,hp:30,exp:20},{id:"boss_slime",name:"BOSS 史萊姆",color:4856427,speed:.6,damage:3,size:.15,hp:30,exp:200},{id:"bat",name:"蝙蝠",color:8930474,speed:8,damage:.5,size:.025,hp:10,exp:5}],st=class st{constructor(M,t,e,i){C(this,"scene");C(this,"monsters",[]);C(this,"nextMonsterId",0);C(this,"clipMask",null);C(this,"spawnInterval",2e3);C(this,"lastSpawnTime",0);C(this,"isSpawning",!1);C(this,"batSwarmInterval",3e4);C(this,"lastBatSwarmTime",0);C(this,"batSwarmCount",8);C(this,"bossSpawnedAtLevels",new Set);C(this,"gameBounds");C(this,"mapWidth");C(this,"mapHeight");C(this,"playerLevel",0);C(this,"gridCellSize",4);C(this,"gridScaleMultiplier",3);C(this,"monsterGridContainer");C(this,"monsterGridCells",[]);C(this,"screenGridCols",0);C(this,"screenGridRows",0);this.scene=M,this.gameBounds=t,this.mapWidth=e,this.mapHeight=i,this.updateGridCellSize(),this.createMonsterGrid()}setPlayerLevel(M){return this.playerLevel=M,M>=10&&M%10===0&&!this.bossSpawnedAtLevels.has(M)?(this.bossSpawnedAtLevels.add(M),!0):!1}spawnBoss(M,t){const e=this.playerLevel,i=dt.find(g=>g.id==="boss_slime");if(!i)return;const o=["top","left","right"],s=o[Math.floor(Math.random()*o.length)];let n,l;const a=150,h=M,c=M+this.gameBounds.width,r=t;switch(s){case"top":n=h+Math.random()*this.gameBounds.width,l=r-a;break;case"left":n=h-a,l=r+Math.random()*this.gameBounds.height;break;case"right":n=c+a,l=r+Math.random()*this.gameBounds.height;break}const y=this.calculateMonsterHp(i.hp)*e,w={id:this.nextMonsterId++,definition:i,x:n,y:l,hp:y,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:1.5+Math.random()*.5,squashStretch:1,flashStartTime:0,isBoss:!0,bossHpMultiplier:e};this.monsters.push(w),console.log(`BOSS Slime spawned at level ${e}! HP: ${y}`)}setGridScaleMultiplier(M){this.gridScaleMultiplier=M,this.updateGridCellSize(),this.recreateMonsterGrid()}updateGridCellSize(){const M=this.scene.cameras.main.width,t=1920,e=20/this.gridScaleMultiplier,i=6/this.gridScaleMultiplier,o=Math.min(1,M/t);this.gridCellSize=Math.max(i,Math.floor(e*o))}setClipMask(M){this.clipMask=M,this.monsterGridContainer&&this.monsterGridContainer.setMask(M)}createMonsterGrid(){this.monsterGridContainer=this.scene.add.container(this.gameBounds.x,this.gameBounds.y),this.monsterGridContainer.setDepth(5),this.clipMask&&this.monsterGridContainer.setMask(this.clipMask),this.screenGridCols=Math.ceil(this.gameBounds.width/this.gridCellSize)+1,this.screenGridRows=Math.ceil(this.gameBounds.height/this.gridCellSize)+1;for(let M=0;M<this.screenGridRows;M++)for(let t=0;t<this.screenGridCols;t++){const e=t*this.gridCellSize,i=M*this.gridCellSize,o=this.scene.add.rectangle(e,i,this.gridCellSize,this.gridCellSize,0,0);o.setOrigin(0,0),o.setVisible(!1),this.monsterGridContainer.add(o),this.monsterGridCells.push({rect:o,screenCol:t,screenRow:M})}}recreateMonsterGrid(){this.monsterGridCells.forEach(M=>M.rect.destroy()),this.monsterGridCells=[],this.monsterGridContainer&&this.monsterGridContainer.destroy(),this.createMonsterGrid()}calculateMonsterHp(M){return Math.floor(M*Math.pow(st.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(M){const t=Math.max(1,this.playerLevel);return st.DAMAGE_UNIT*t*M.definition.damage}calculateMonsterExp(M){const t=Math.floor(this.playerLevel/5);return M*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now,this.lastBatSwarmTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(M,t,e,i,o){const s=this.scene.time.now;let n=0;const l=[];if(this.isSpawning&&s-this.lastSpawnTime>=this.spawnInterval){const c=1+Math.floor(this.playerLevel/5);for(let r=0;r<c;r++)this.spawnMonster(t,e,i,o);this.lastSpawnTime=s}this.isSpawning&&s-this.lastBatSwarmTime>=this.batSwarmInterval&&(this.spawnBatSwarm(i,o),this.lastBatSwarmTime=s);const a=this.gameBounds.height*.1,h=[];return this.monsters.forEach(c=>{if(c.isBat&&c.directionX!==void 0&&c.directionY!==void 0){const y=c.definition.speed*this.gameBounds.height*.1*M/1e3;c.x+=c.directionX*y,c.y+=c.directionY*y;const w=this.gameBounds.height*.3,g=i-w,k=i+this.gameBounds.width+w,S=o-w,p=o+this.gameBounds.height+w;(c.x<g||c.x>k||c.y<S||c.y>p)&&h.push(c.id);const d=t-c.x,v=e-c.y;Math.sqrt(d*d+v*v)<=a&&s-c.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(c),c.lastDamageTime=s,l.push(c))}else{const f=t-c.x,y=e-c.y,w=Math.sqrt(f*f+y*y);if(w>a){const S=c.definition.speed*this.gameBounds.height*.1*M/1e3/w;c.x+=f*S,c.y+=y*S}else s-c.lastDamageTime>=3e3&&(n+=this.calculateMonsterDamage(c),c.lastDamageTime=s,l.push(c))}c.bouncePhase+=c.bounceSpeed*M/1e3,c.bouncePhase>Math.PI*2&&(c.bouncePhase-=Math.PI*2);const r=.08;c.squashStretch=1+Math.sin(c.bouncePhase)*r}),h.forEach(c=>{this.monsters=this.monsters.filter(r=>r.id!==c)}),this.renderMonstersToGrid(i,o),{damage:n,hitMonsters:l}}spawnMonster(M,t,e,i){const o=["top","left","right"],s=o[Math.floor(Math.random()*o.length)];let n,l;const a=100,h=e,c=e+this.gameBounds.width,r=i;switch(s){case"top":n=h+Math.random()*this.gameBounds.width,l=r-a;break;case"left":n=h-a,l=r+Math.random()*this.gameBounds.height;break;case"right":n=c+a,l=r+Math.random()*this.gameBounds.height;break}n=Phaser.Math.Clamp(n,0,this.mapWidth),l=Phaser.Math.Clamp(l,0,this.mapHeight);const f=dt[0],y=this.calculateMonsterHp(f.hp),w={id:this.nextMonsterId++,definition:f,x:n,y:l,hp:y,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:3+Math.random()*2,squashStretch:1,flashStartTime:0};this.monsters.push(w)}spawnBatSwarm(M,t){const e=["topLeft","topRight","bottomLeft","bottomRight"],i=e[Math.floor(Math.random()*e.length)],o=M,s=M+this.gameBounds.width,n=t,l=t+this.gameBounds.height,a=this.gameBounds.height*.15;let h,c,r,f;switch(i){case"topLeft":h=o-a,c=n-a,r=s+a*2,f=l+a*2;break;case"topRight":h=s+a,c=n-a,r=o-a*2,f=l+a*2;break;case"bottomLeft":h=o-a,c=l+a,r=s+a*2,f=n-a*2;break;case"bottomRight":default:h=s+a,c=l+a,r=o-a*2,f=n-a*2;break}const y=dt.find(k=>k.id==="bat")||dt[0],w=[],g=this.gameBounds.height*.04;for(let k=0;k<this.batSwarmCount;k++){let S,p,d=0;const v=50;do{const T=Math.random()*Math.PI*2,B=Math.random()*a;if(S=h+Math.cos(T)*B,p=c+Math.sin(T)*B,d++,!w.some(G=>{const R=G.x-S,H=G.y-p;return Math.sqrt(R*R+H*H)<g})||d>=v)break}while(!0);w.push({x:S,y:p});const u=r-S,m=f-p,x=Math.sqrt(u*u+m*m),E=u/x,b=m/x,P={id:this.nextMonsterId++,definition:y,x:S,y:p,hp:st.BAT_FIXED_HP,lastDamageTime:0,bouncePhase:Math.random()*Math.PI*2,bounceSpeed:5+Math.random()*3,squashStretch:1,flashStartTime:0,isBat:!0,directionX:E,directionY:b};this.monsters.push(P)}console.log(`Bat swarm spawned from ${i}! Count: ${this.batSwarmCount}`)}renderMonstersToGrid(M,t){const e=this.gridCellSize,i=this.scene.time.now,o=new Map;this.monsters.forEach(s=>{const n=this.gameBounds.height*s.definition.size,l=s.squashStretch,a=1/s.squashStretch,h=s.x-M,c=s.y-t,r=Math.floor(h/e),f=Math.floor(c/e),y=Math.ceil(n/e/2),w=Math.ceil(y*a),g=Math.ceil(y*l),k=s.definition.color;let S=k>>16&255,p=k>>8&255,d=k&255,v=!1;const u=300;if(s.flashStartTime>0){const T=i-s.flashStartTime;if(T<u){v=!0;const B=Math.floor(T/60)%2,I=T<u/2?1:1-(T-u/2)/(u/2);B===0?(S=Math.min(255,Math.floor(S+(255-S)*I)),p=Math.min(255,Math.floor(p+(255-p)*I)),d=Math.min(255,Math.floor(d+(255-d)*I))):(S=Math.min(255,Math.floor(S+(255-S)*I)),p=Math.floor(p*(1-I*.8)),d=Math.floor(d*(1-I*.8)))}else s.flashStartTime=0}if(s.isBat){const B=(Math.sin(s.bouncePhase*3)*.5+.5)*.8-.2,I=Math.max(2,Math.ceil(w*.6)),G=Math.max(2,Math.ceil(g*.8)),R=Math.max(3,Math.ceil(w*3)),H=Math.max(2,Math.ceil(g*1.5)),D=(F,z,$,W)=>{if(F>=0&&F<this.screenGridCols&&z>=0&&z<this.screenGridRows){const N=`${F},${z}`,Z=o.get(N);(!Z||W>Z.alpha)&&o.set(N,{color:$,alpha:W})}},_=S<<16|p<<8|d,L=Math.floor(S*.7)<<16|Math.floor(p*.7)<<8|Math.floor(d*.7),X=Math.floor(S*.5)<<16|Math.floor(p*.5)<<8|Math.floor(d*.5);for(let F=-G;F<=G;F++)for(let z=-I;z<=I;z++){const $=z/I,W=F/G;$*$+W*W<=1&&D(r+z,f+F,_,.95)}const Y=Math.max(1,Math.floor(I*.6)),V=Math.max(1,Math.floor(G*.6));for(let F=0;F<=V;F++){const z=Math.max(1,V-F);for(let $=0;$<z;$++)D(r-Y+$,f-G-F-1,_,.9)}for(let F=0;F<=V;F++){const z=Math.max(1,V-F);for(let $=0;$<z;$++)D(r+Y-$,f-G-F-1,_,.9)}for(let F=1;F<=R;F++){const z=F/R,$=Math.floor(H*z*(1-z*.3)),W=Math.floor(B*z*H),N=-$+W,Z=Math.floor($*.3)+W;for(let q=N;q<=Z;q++){const j=Math.floor(Math.sin(z*Math.PI*2+s.bouncePhase)*.5),J=.85-z*.3,et=q<(N+Z)/2?L:X;D(r-I-F,f+q+j,et,J)}if(F%2===0&&F<R-1){const q=Math.floor((N+Z)/2+W);D(r-I-F,f+q,_,.9)}}for(let F=1;F<=R;F++){const z=F/R,$=Math.floor(H*z*(1-z*.3)),W=Math.floor(B*z*H),N=-$+W,Z=Math.floor($*.3)+W;for(let q=N;q<=Z;q++){const j=Math.floor(Math.sin(z*Math.PI*2+s.bouncePhase)*.5),J=.85-z*.3,et=q<(N+Z)/2?L:X;D(r+I+F,f+q+j,et,J)}if(F%2===0&&F<R-1){const q=Math.floor((N+Z)/2+W);D(r+I+F,f+q,_,.9)}}const K=f-Math.floor(G*.3),U=Math.max(1,Math.floor(I*.4));D(r-U,K,16711680,1),D(r+U,K,16711680,1);return}else{for(let T=-g;T<=0;T++)for(let B=-w;B<=w;B++){const I=B/w,G=T/g,R=I*I+G*G;if(R<=1.1){const D=(.5+(1-Math.pow(Math.min(1,R),.5))*.5)*(R<=1?1:(1.1-R)/.1),_=v?1:1+(1-G)*.4,L=Math.min(255,Math.floor(S*_)),X=Math.min(255,Math.floor(p*_)),Y=Math.min(255,Math.floor(d*_)),V=L<<16|X<<8|Y,K=r+B,U=f+T;if(K>=0&&K<this.screenGridCols&&U>=0&&U<this.screenGridRows){const F=`${K},${U}`,z=o.get(F);(!z||D>z.alpha)&&o.set(F,{color:V,alpha:D})}}}for(let T=-w;T<=w;T++){const B=T/w;if(Math.abs(B)<=1){const I=v?1:.7,G=Math.floor(S*I),R=Math.floor(p*I),H=Math.floor(d*I),D=G<<16|R<<8|H,_=r+T,L=f;if(_>=0&&_<this.screenGridCols&&L>=0&&L<this.screenGridRows){const X=`${_},${L}`;o.set(X,{color:D,alpha:.9})}}}}const m=Math.max(1,Math.floor(w*.35)),x=Math.floor(g*.5),E=r-m,b=r+m,P=f-x;if(E>=0&&E<this.screenGridCols&&P>=0&&P<this.screenGridRows&&o.set(`${E},${P}`,{color:0,alpha:1}),b>=0&&b<this.screenGridCols&&P>=0&&P<this.screenGridRows&&o.set(`${b},${P}`,{color:0,alpha:1}),!v){const T=Math.floor(w*.4),B=Math.floor(g*.7),I=r-T,G=f-B;I>=0&&I<this.screenGridCols&&G>=0&&G<this.screenGridRows&&o.set(`${I},${G}`,{color:16777215,alpha:.8})}});for(const s of this.monsterGridCells){const n=`${s.screenCol},${s.screenRow}`,l=o.get(n);l?(s.rect.setFillStyle(l.color,l.alpha),s.rect.setVisible(!0)):s.rect.setVisible(!1)}}removeMonster(M){const t=this.monsters.findIndex(e=>e.id===M);t!==-1&&this.monsters.splice(t,1)}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters=[]}setSpawnInterval(M){this.spawnInterval=M}damageMonster(M,t){const e=this.monsters.find(i=>i.id===M);if(!e)return{killed:!1,exp:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const i=e.isBat?st.BAT_FIXED_EXP:this.calculateMonsterExp(e.definition.exp);return this.playDeathSmoke(e.x,e.y),this.removeMonster(M),{killed:!0,exp:i}}return{killed:!1,exp:0}}flashMonster(M){M.flashStartTime=this.scene.time.now}playDeathSmoke(M,t){const e=this.scene;e.flashDeathEffect&&e.flashDeathEffect(M,t)}damageMonsters(M,t){let e=0,i=0;const o=[];for(const s of M){const n=this.monsters.find(h=>h.id===s),l=n?{x:n.x,y:n.y}:null,a=this.damageMonster(s,t);a.killed&&l&&(e+=a.exp,i++,o.push(l))}return{totalExp:e,killCount:i,killedPositions:o}}};C(st,"BAT_FIXED_HP",10),C(st,"BAT_FIXED_EXP",5),C(st,"HP_GROWTH_RATE",1.1),C(st,"DAMAGE_UNIT",10);let Ct=st;const A=class A extends O.Scene{constructor(){super("MainScene");C(this,"character");C(this,"characterState","idle");C(this,"facingRight",!0);C(this,"skillIcons",[]);C(this,"skillIconGridGraphics",[]);C(this,"skillIconGridData",[]);C(this,"gameBounds");C(this,"boundsBorder");C(this,"background");C(this,"gameAreaContainer");C(this,"revealMask");C(this,"mapWidth");C(this,"mapHeight");C(this,"characterX");C(this,"characterY");C(this,"characterSize");C(this,"isPointerDown",!1);C(this,"moveDirX",0);C(this,"moveDirY",0);C(this,"baseMoveSpeed",0);C(this,"moveSpeed",0);C(this,"floorGrid");C(this,"worldContainer");C(this,"characterContainer");C(this,"uiContainer");C(this,"cameraOffsetX",0);C(this,"cameraOffsetY",0);C(this,"cursors");C(this,"isKeyboardMoving",!1);C(this,"skillPanelContainer");C(this,"isPaused",!1);C(this,"skillOptions",[]);C(this,"skillCardBgs",[]);C(this,"selectedSkillIndex",0);C(this,"currentSkillChoices",[]);C(this,"skillCutInContainer");C(this,"skillManager",new lt);C(this,"skillIconContainers",[]);C(this,"skillLevelTexts",[]);C(this,"skillInfoPanel");C(this,"skillInfoBg");C(this,"skillInfoText");C(this,"skillInfoHideTimer");C(this,"currentExp",0);C(this,"maxExp",100);C(this,"currentLevel",0);C(this,"expBarContainer");C(this,"expBarFlowOffset",0);C(this,"levelText");C(this,"currentHp",200);C(this,"maxHp",200);C(this,"hpBarContainer");C(this,"hpBarFlowOffset",0);C(this,"hpText");C(this,"currentShield",0);C(this,"maxShield",0);C(this,"shieldBarFlowOffset",0);C(this,"shieldReflectDamage",0);C(this,"shieldText");C(this,"shieldAuraGraphics");C(this,"shieldSparkleTimer",0);C(this,"hpRegenTimer",0);C(this,"reviveUsed",!1);C(this,"displayedHp",200);C(this,"hpDamageDelay",0);C(this,"isMobile",!1);C(this,"keyPlus");C(this,"keyMinus");C(this,"keyShift");C(this,"keyCtrl");C(this,"keyZero");C(this,"keyBackspace");C(this,"keyF5");C(this,"keyF6");C(this,"keyF7");C(this,"keyF8");C(this,"keyF9");C(this,"keyF10");C(this,"keyF11");C(this,"keyF12");C(this,"showGridSkillEffects",!1);C(this,"monsterManager");C(this,"isHurt",!1);C(this,"hurtEndTime",0);C(this,"lowHpBreathTimer",0);C(this,"isLowHp",!1);C(this,"vignetteEdgeCells",new Set);C(this,"skillCooldowns",new Map);C(this,"isAttacking",!1);C(this,"attackEndTime",0);C(this,"gameBgm");C(this,"currentBgmKey","");C(this,"skillGridContainer");C(this,"skillGridCells",[]);C(this,"skillGridCols",0);C(this,"skillGridRows",0);C(this,"skillGridCellSize",10);C(this,"gridScaleMultiplier",3);C(this,"activeSkillGridCells",new Set);C(this,"skillEffectPool",[]);C(this,"activeSkillEffects",[])}create(){this.cameras.main.setBackgroundColor("#111111"),this.isMobile=this.sys.game.device.input.touch&&window.innerWidth<1024,this.gridScaleMultiplier=this.isMobile?2:3;const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const l=t*.9,a=e*(1-.05*2),h=16/9,c=l/a;let r,f;c>h?(f=a,r=a*h):(r=l,f=l/h),this.gameBounds={x:(t-r)/2,y:(e-f)/2,width:r,height:f}}this.mapWidth=this.gameBounds.width*A.MAP_SCALE,this.mapHeight=this.gameBounds.height*A.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const i=this.make.graphics({x:0,y:0});i.fillStyle(16777215),i.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const o=i.createGeometryMask();this.worldContainer.setMask(o),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(100),this.monsterManager=new Ct(this,this.gameBounds,this.mapWidth,this.mapHeight),this.monsterManager.setGridScaleMultiplier(this.gridScaleMultiplier),this.monsterManager.setClipMask(o),this.createSkillGrid(),this.initSkillEffectPool(),window.addEventListener("gridscalechange",n=>{this.gridScaleMultiplier=n.detail.scale,this.recreateSkillGrid(),this.monsterManager.setGridScaleMultiplier(n.detail.scale)}),this.characterContainer.setDepth(60),this.characterContainer.setMask(o),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const s=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(s),this.uiContainer.setMask(s),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(O.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createSkillCutIn(),this.createLowHpVignette()}update(t,e){if(this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.updateShieldAura(e),this.updateHpRegen(e),this.updateLowHpVignetteBreathing(e),this.updateSkillCooldownDisplay(),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const i=this.time.now;this.isHurt&&i>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&i>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isPointerDown||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isPointerDown&&!this.isKeyboardMoving&&this.moveCharacter(e));const o=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);o.damage>0&&this.takeDamage(o.damage,o.hitMonsters),this.tryActivateSkills(i)}tryActivateSkills(t){if(this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const i of e){if(!i)continue;const o=i.definition;let s=o.cooldown||1e3;o.id==="active_architect"&&(s=s-i.level*500);const n=this.skillManager.calculateFinalCooldown(s),l=this.skillCooldowns.get(o.id)||0;t-l>=n&&(this.activateSkill(i,t),this.skillCooldowns.set(o.id,t))}}activateSkill(t,e){const i=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+A.ATTACK_DURATION,this.setCharacterState("attack",!0),i.flashColor&&this.character.setTint(i.flashColor),i.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${i.name}`)}}activateSoulRender(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let i=e[0],o=1/0;for(const k of e){const S=k.x-this.characterX,p=k.y-this.characterY,d=Math.sqrt(S*S+p*p);d<o&&(o=d,i=k)}const s=Math.atan2(i.y-this.characterY,i.x-this.characterX);this.facingRight=Math.cos(s)>=0,this.updateCharacterSprite();const n=this.gameBounds.height*.3,a=(60+t.level*10)/2*(Math.PI/180),h=2+t.level,c=A.DAMAGE_UNIT*h,{damage:r,isCrit:f}=this.skillManager.calculateFinalDamageWithCrit(c,this.currentLevel),y=[];for(const k of e){const S=this.gameBounds.height*k.definition.size*.5,p=k.x-this.characterX,d=k.y-this.characterY,v=Math.sqrt(p*p+d*d);if(v-S>n)continue;let m=Math.atan2(d,p)-s;for(;m>Math.PI;)m-=Math.PI*2;for(;m<-Math.PI;)m+=Math.PI*2;const x=v>0?Math.atan2(S,v):Math.PI;Math.abs(m)<=a+x&&y.push(k.id)}this.drawSectorEdge(s,n,a,t.definition.color);const w=t.definition.flashColor||t.definition.color;if(this.showGridSkillEffects)this.flashSkillAreaSector(this.characterX,this.characterY,n,s,a,w);else{const k=a*(180/Math.PI);this.flashSkillEffectSector(this.characterX,this.characterY,n,s,k,w)}if(y.length>0){const k=e.filter(d=>y.includes(d.id)).map(d=>({x:d.x,y:d.y})),S=this.monsterManager.damageMonsters(y,r);S.totalExp>0&&this.addExp(S.totalExp),f?this.flashCritCrossAtPositions(k):this.flashWhiteCrossAtPositions(k),this.shakeScreen(y.length);const p=f?" [CRIT!]":"";console.log(`Soul Render hit ${y.length} monsters for ${r} damage${p}, killed ${S.killCount}, exp +${S.totalExp}`)}const g=this.skillManager.getSoulRenderWaveChance(this.currentLevel);g>0&&Math.random()<g&&this.triggerSoulRenderWave(s,n,a,r,t)}drawSectorEdge(t,e,i,o){const s=this.add.graphics();this.skillGridContainer.add(s),s.setDepth(55);const n=t-i,l=t+i,a=this.characterX,h=this.characterY,c=500,r=300,f=this.time.now,y=15,w=(S,p,d,v,u)=>{for(let m=0;m<y;m++){const x=m/y,E=(m+1)/y,b=(x+E)/2,P=Math.min(1,b/.15),T=Math.min(1,(1-b)/.15),B=Math.min(P,T),I=d*B*B;if(I>.01){const G=e*x,R=e*E,H=v+Math.cos(S)*G,D=u+Math.sin(S)*G,_=v+Math.cos(S)*R,L=u+Math.sin(S)*R;s.lineStyle(p,16777215,I),s.beginPath(),s.moveTo(H,D),s.lineTo(_,L),s.strokePath()}}},g=()=>{const S=this.time.now-f,p=Math.min(S/c,1);s.clear();const d=this.worldToScreen(a,h),v=d.x,u=d.y;let m=0;S>r&&(m=(S-r)/(c-r));const x=1*(1-m);x>.01&&(w(n,2,x,v,u),w(l,2,x,v,u)),p>=1&&s.destroy()};g();const k=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{s.active&&s.destroy(),k.remove()})}drawCircleEdge(t,e,i,o){const s=this.add.graphics();this.skillGridContainer.add(s),s.setDepth(55);const n=i??this.characterX,l=o??this.characterY,a=500,h=300,c=this.time.now,r=3,f=Math.PI*2/r,y=24,w=()=>{const k=this.time.now-c,S=Math.min(k/a,1);s.clear();const p=this.worldToScreen(n,l),d=p.x,v=p.y;let u=0;k>h&&(u=(k-h)/(a-h));const m=1*(1-u);if(m>.01)for(let x=0;x<r;x++){const E=x*f-Math.PI/2;for(let b=0;b<y;b++){const P=b/y,T=.2+.8*Math.abs(Math.cos(P*Math.PI)),B=m*T,I=E+b/y*f,G=E+(b+1)/y*f,R=d+Math.cos(I)*t,H=v+Math.sin(I)*t,D=d+Math.cos(G)*t,_=v+Math.sin(G)*t;s.lineStyle(2,16777215,B),s.beginPath(),s.moveTo(R,H),s.lineTo(D,_),s.strokePath()}}S>=1&&s.destroy()};w();const g=this.time.addEvent({delay:16,callback:w,callbackScope:this,repeat:Math.ceil(a/16)});this.time.delayedCall(a+50,()=>{s.active&&s.destroy(),g.remove()})}drawBeamEdge(t,e,i,o,s,n){const l=this.add.graphics();this.worldContainer.add(l);const a=s??this.characterX,h=n??this.characterY,c=Math.cos(t),r=Math.sin(t),f=800,y=380,w=this.time.now,g=20,k=()=>{const p=this.time.now-w,d=Math.min(p/f,1);l.clear();let v=0;p>y&&(v=(p-y)/(f-y));const u=.6*(1-v*.5);if(u>.01)for(let m=0;m<g;m++){const x=m/g,E=(m+1)/g,b=(x+E)/2,P=Math.min(1,b/.15),T=Math.min(1,(1-b)/.15),B=Math.min(P,T),I=u*B*B;if(I>.01){const G=a+c*e*x,R=h+r*e*x,H=a+c*e*E,D=h+r*e*E;l.lineStyle(2,16777215,I),l.beginPath(),l.moveTo(G,R),l.lineTo(H,D),l.strokePath()}}d>=1&&l.destroy()};k();const S=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{l.active&&l.destroy(),S.remove()})}activateCoder(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const i=this.gameBounds.height*.1,o=2+t.level*.5,s=i*o,n=1+t.level,l=A.DAMAGE_UNIT*n,{damage:a,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(l,this.currentLevel),c=[];for(const f of e){const y=this.gameBounds.height*f.definition.size*.5,w=f.x-this.characterX,g=f.y-this.characterY;Math.sqrt(w*w+g*g)-y<=s&&c.push(f.id)}this.drawCircleEdge(s,t.definition.color);const r=t.definition.flashColor||t.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,s,r):this.flashSkillEffectCircle(this.characterX,this.characterY,s,r),c.length>0){const f=e.filter(k=>c.includes(k.id)).map(k=>({x:k.x,y:k.y})),y=this.monsterManager.damageMonsters(c,a);y.totalExp>0&&this.addExp(y.totalExp),h?this.flashCritCrossAtPositions(f):this.flashWhiteCrossAtPositions(f),this.shakeScreen(c.length);const w=h?" [CRIT!]":"";console.log(`Coder hit ${c.length} monsters for ${a} damage${w}, killed ${y.killCount}, exp +${y.totalExp}`);const g=this.skillManager.getCoderBurstChance(this.currentLevel);g>0&&y.killedPositions.length>0&&this.triggerCoderBurst(y.killedPositions,s,a,t,g)}}triggerSoulRenderWave(t,e,i,o,s){const n=this.gameBounds.height*.1,l=n*5,a=e*i*2,h=s.definition.flashColor||s.definition.color,c=this.characterX,r=this.characterY,f=new Set;this.showGridSkillEffects?this.flashSkillAreaSectorMoving(c,r,e,t,i,h,l):this.flashSkillEffectSectorMoving(c,r,e,t,i,h,l);const y=500,w=this.time.now,g=n*.5,k=()=>{const S=this.time.now-w,p=Math.min(S/y,1),d=e+l*p,v=a/(2*d),u=this.monsterManager.getMonsters(),m=[];for(const x of u){if(f.has(x.id))continue;const E=this.gameBounds.height*x.definition.size*.5,b=x.x-c,P=x.y-r,T=Math.sqrt(b*b+P*P);if(Math.abs(T-d)>g+E)continue;let I=Math.atan2(P,b)-t;for(;I>Math.PI;)I-=Math.PI*2;for(;I<-Math.PI;)I+=Math.PI*2;const G=T>0?Math.atan2(E,T):Math.PI;Math.abs(I)<=v+G&&(m.push(x.id),f.add(x.id))}if(m.length>0){const x=u.filter(b=>m.includes(b.id)).map(b=>({x:b.x,y:b.y})),E=this.monsterManager.damageMonsters(m,o);E.totalExp>0&&this.addExp(E.totalExp),this.flashWhiteCrossAtPositions(x)}p<1&&this.time.delayedCall(16,k)};k()}flashSkillAreaSectorMoving(t,e,i,o,s,n,l){const a=this.worldToScreen(t,e),h=a.x,c=a.y,r=A.SKILL_GRID_GAP,f=this.skillGridCellSize+r,y=500,w=this.time.now,g=Math.cos(o),k=Math.sin(o),S=i+l+i,p=[],d=Math.max(0,Math.floor((h-S)/f)),v=Math.min(this.skillGridCols-1,Math.ceil((h+S)/f)),u=Math.max(0,Math.floor((c-S)/f)),m=Math.min(this.skillGridRows-1,Math.ceil((c+S)/f));for(let b=u;b<=m;b++)for(let P=d;P<=v;P++){const T=P*f+this.skillGridCellSize/2,B=b*f+this.skillGridCellSize/2;p.push({col:P,row:b,screenX:T,screenY:B})}if(p.length===0)return;const x=[];for(const{col:b,row:P}of p){const T=b*f+this.skillGridCellSize/2,B=P*f+this.skillGridCellSize/2,I=this.add.rectangle(T,B,this.skillGridCellSize,this.skillGridCellSize,n,0);I.setVisible(!1),this.skillGridContainer.add(I),x.push(I)}const E=()=>{const b=this.time.now-w,P=Math.min(b/y,1),T=l*P,B=h+g*T,I=c+k*T,G=.5,R=P>G?(P-G)/(1-G):0;let H=0;for(const{screenX:D,screenY:_}of p){const L=x[H++];if(!L)continue;const X=D-B,Y=_-I,V=Math.sqrt(X*X+Y*Y),K=i*.5;if(V>=K&&V<=i){let F=Math.atan2(Y,X)-o;for(;F>Math.PI;)F-=Math.PI*2;for(;F<-Math.PI;)F+=Math.PI*2;if(Math.abs(F)<=s){const z=(V-K)/(i-K),$=Math.abs(F)/s,W=Math.max(z,$),N=Math.max(0,Math.min(1,(W-.3)/.7)),Z=N*N*(3-2*N),j=(.15+Z*.6)*(1-R);if(j>.01){const J=.5+Z*.5,et=n>>16&255,at=n>>8&255,gt=n&255,rt=Math.floor(et*J),ht=Math.floor(at*J),ct=Math.floor(gt*J),it=rt<<16|ht<<8|ct;L.setFillStyle(it,j),L.setVisible(!0)}else L.setVisible(!1)}else L.setVisible(!1)}else L.setVisible(!1)}if(P>=1)for(const D of x)D.destroy();else this.time.delayedCall(16,E)};E()}triggerCoderBurst(t,e,i,o,s){const n=this.monsterManager.getMonsters();if(n.length===0)return;const l=e*.5;for(const a of t){if(Math.random()>=s)continue;const h=[];for(const r of n){const f=this.gameBounds.height*r.definition.size*.5,y=r.x-a.x,w=r.y-a.y;Math.sqrt(y*y+w*w)-f<=l&&h.push(r.id)}this.drawCircleEdge(l,o.definition.color,a.x,a.y);const c=o.definition.flashColor||o.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaCircle(a.x,a.y,l,c):this.flashSkillEffectCircle(a.x,a.y,l,c),h.length>0){const r=n.filter(y=>h.includes(y.id)).map(y=>({x:y.x,y:y.y})),f=this.monsterManager.damageMonsters(h,i);f.totalExp>0&&this.addExp(f.totalExp),this.flashWhiteCrossAtPositions(r),console.log(`Coder Burst hit ${h.length} monsters for ${i} damage`)}}}activateVfx(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const i=t.level+1,o=this.gameBounds.height*1,s=this.gameBounds.height*.05,n=1+t.level,l=A.DAMAGE_UNIT*n,{damage:a,isCrit:h}=this.skillManager.calculateFinalDamageWithCrit(l,this.currentLevel),c=new Set,r=e.map((w,g)=>g),f=[];for(let w=0;w<i;w++){let g;if(r.length>0){const d=Math.floor(Math.random()*r.length),v=r[d];r.splice(d,1);const u=e[v];g=Math.atan2(u.y-this.characterY,u.x-this.characterX)}else g=Math.random()*Math.PI*2;f.push(g);for(const d of e){const v=this.gameBounds.height*d.definition.size*.5,u=d.x-this.characterX,m=d.y-this.characterY;if(Math.sqrt(u*u+m*m)-v>o)continue;const E=Math.cos(g),b=Math.sin(g);if(u*E+m*b<-v)continue;Math.abs(u*b-m*E)<=s/2+v&&c.add(d.id)}this.drawBeamEdge(g,o,s,t.definition.color);const k=this.characterX+Math.cos(g)*o,S=this.characterY+Math.sin(g)*o,p=t.definition.flashColor||t.definition.color;this.showGridSkillEffects?this.flashSkillAreaLine(this.characterX,this.characterY,k,S,s,p):this.flashSkillEffectLine(this.characterX,this.characterY,k,S,s,p)}f.length>0&&(this.facingRight=Math.cos(f[0])>=0,this.updateCharacterSprite());const y=Array.from(c);if(y.length>0){const g=e.filter(d=>y.includes(d.id)).map(d=>({x:d.x,y:d.y})),k=this.monsterManager.damageMonsters(y,a);k.totalExp>0&&this.addExp(k.totalExp),h?this.flashCritCrossAtPositions(g):this.flashWhiteCrossAtPositions(g),this.shakeScreen(y.length);const S=h?" [CRIT!]":"";console.log(`VFX (${i} beams) hit ${y.length} monsters for ${a} damage${S}, killed ${k.killCount}, exp +${k.totalExp}`);const p=this.skillManager.getVfxChainChance(this.currentLevel);p>0&&g.length>0&&this.triggerVfxChain(g,a,p,t)}}triggerVfxChain(t,e,i,o){const s=this.monsterManager.getMonsters();if(s.length===0)return;const n=this.gameBounds.height*1,l=this.gameBounds.height*.05;for(const a of t){if(Math.random()>=i)continue;const h=s.filter(k=>{const S=k.x-a.x,p=k.y-a.y;return Math.sqrt(S*S+p*p)>10});if(h.length===0)continue;const c=h[Math.floor(Math.random()*h.length)],r=Math.atan2(c.y-a.y,c.x-a.x),f=[];for(const k of s){const S=this.gameBounds.height*k.definition.size*.5,p=k.x-a.x,d=k.y-a.y;if(Math.sqrt(p*p+d*d)-S>n)continue;const u=Math.cos(r),m=Math.sin(r);if(p*u+d*m<-S)continue;Math.abs(p*m-d*u)<=l/2+S&&f.push(k.id)}this.drawBeamEdge(r,n,l,o.definition.color,a.x,a.y);const y=a.x+Math.cos(r)*n,w=a.y+Math.sin(r)*n,g=o.definition.flashColor||o.definition.color;if(this.showGridSkillEffects?this.flashSkillAreaLine(a.x,a.y,y,w,l,g):this.flashSkillEffectLine(a.x,a.y,y,w,l,g),f.length>0){const k=s.filter(p=>f.includes(p.id)).map(p=>({x:p.x,y:p.y})),S=this.monsterManager.damageMonsters(f,e);S.totalExp>0&&this.addExp(S.totalExp),this.flashWhiteCrossAtPositions(k),console.log(`VFX Chain hit ${f.length} monsters for ${e} damage`)}}}_drawBeamEffect(t,e,i,o){const s=this.add.graphics();this.worldContainer.add(s);const n=this.characterX,l=this.characterY,a=n+Math.cos(t)*e,h=l+Math.sin(t)*e,c=i*1.5,r=Math.sin(t)*c/2,f=-Math.cos(t)*c/2,y=Math.sin(t)*c*.4/2,w=-Math.cos(t)*c*.4/2,g=15,k=1e3,S=this.time.now,p=()=>{const v=this.time.now-S,u=Math.min(v/k,1);s.clear();const m=.3,x=u<m?0:(u-m)/(1-m);for(let P=0;P<g;P++){const T=P/g,B=(P+1)/g,I=n+(a-n)*T,G=l+(h-l)*T,R=n+(a-n)*B,H=l+(h-l)*B,_=.85*(1-T*.6)*(1-x);_>.01&&(s.fillStyle(o,_),s.beginPath(),s.moveTo(I-r,G-f),s.lineTo(R-r,H-f),s.lineTo(R+r,H+f),s.lineTo(I+r,G+f),s.closePath(),s.fillPath())}for(let P=0;P<g;P++){const T=P/g,B=(P+1)/g,I=n+(a-n)*T,G=l+(h-l)*T,R=n+(a-n)*B,H=l+(h-l)*B,D=.98*(1-T*.5)*(1-x);D>.01&&(s.fillStyle(16777215,D),s.beginPath(),s.moveTo(I-y,G-w),s.lineTo(R-y,H-w),s.lineTo(R+y,H+w),s.lineTo(I+y,G+w),s.closePath(),s.fillPath())}const E=1*(1-x);E>.01&&(s.lineStyle(6,16777215,E),s.beginPath(),s.moveTo(n,l),s.lineTo(a,h),s.strokePath());const b=1*(1-x);b>.01&&(s.lineStyle(4,o,b),s.beginPath(),s.moveTo(n-r,l-f),s.lineTo(a-r,h-f),s.lineTo(a+r,h+f),s.lineTo(n+r,l+f),s.closePath(),s.strokePath(),s.lineStyle(2,16777215,b*.6),s.beginPath(),s.moveTo(n-r*1.1,l-f*1.1),s.lineTo(a-r*1.1,h-f*1.1),s.lineTo(a+r*1.1,h+f*1.1),s.lineTo(n+r*1.1,l+f*1.1),s.closePath(),s.strokePath()),u>=1&&s.destroy()},d=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(k/16)});this.time.delayedCall(k+50,()=>{s.active&&s.destroy(),d.remove()})}_drawCrossStarBurst(t,e){const o=this.gameBounds.height*.1*1,s=600;for(const n of t){const l=this.add.graphics();this.worldContainer.add(l);const a=this.time.now,h=()=>{const r=this.time.now-a,f=Math.min(r/s,1);l.clear();const y=f<.2?f/.2:1,w=f<.4?0:(f-.4)/.6,g=o*y,k=1-w;if(k>.01&&g>0){const S=g*.2,p=g,d=g*.4;l.fillStyle(16777215,k),l.fillCircle(n.x,n.y,d);for(let m=0;m<4;m++){const x=m*Math.PI/2,E=Math.cos(x),b=Math.sin(x),P=-b,T=E,B=6;for(let I=0;I<B;I++){const G=I/B,R=(I+1)/B,H=S*(1-G*.8),D=S*(1-R*.8),_=n.x+E*p*G,L=n.y+b*p*G,X=n.x+E*p*R,Y=n.y+b*p*R,V=k*(1-G*.7);l.fillStyle(e,V*.8),l.beginPath(),l.moveTo(_+P*H,L+T*H),l.lineTo(X+P*D,Y+T*D),l.lineTo(X-P*D,Y-T*D),l.lineTo(_-P*H,L-T*H),l.closePath(),l.fillPath();const K=H*.5,U=D*.5;l.fillStyle(16777215,V*.9),l.beginPath(),l.moveTo(_+P*K,L+T*K),l.lineTo(X+P*U,Y+T*U),l.lineTo(X-P*U,Y-T*U),l.lineTo(_-P*K,L-T*K),l.closePath(),l.fillPath()}}const v=p*.5,u=S*.6;for(let m=0;m<4;m++){const x=m*Math.PI/2+Math.PI/4,E=Math.cos(x),b=Math.sin(x),P=-b,T=E,B=4;for(let I=0;I<B;I++){const G=I/B,R=(I+1)/B,H=u*(1-G*.9),D=u*(1-R*.9),_=n.x+E*v*G,L=n.y+b*v*G,X=n.x+E*v*R,Y=n.y+b*v*R,V=k*(1-G*.8)*.7;l.fillStyle(e,V),l.beginPath(),l.moveTo(_+P*H,L+T*H),l.lineTo(X+P*D,Y+T*D),l.lineTo(X-P*D,Y-T*D),l.lineTo(_-P*H,L-T*H),l.closePath(),l.fillPath()}}}f>=1&&l.destroy()};h();const c=this.time.addEvent({delay:16,callback:h,callbackScope:this,repeat:Math.ceil(s/16)});this.time.delayedCall(s+50,()=>{l.active&&l.destroy(),c.remove()})}}activateArchitect(t){const e=this.skillManager.getArchitectExplosionChance(this.currentLevel);e>0&&this.currentShield>0&&Math.random()<e&&this.triggerShieldExplosion(t);const i=Math.floor(this.maxHp*.3);this.currentShield=i,this.maxShield=i;const o=1+t.level*1.5;this.shieldReflectDamage=A.DAMAGE_UNIT*o,this.drawShieldBarFill();const s=this.gameBounds.height*.15,n=t.definition.flashColor||t.definition.color;this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,s,n):this.flashSkillEffectCircle(this.characterX,this.characterY,s,n),console.log(`Architect activated: Shield ${i}, Reflect damage ${this.shieldReflectDamage} (${o} units)`)}triggerShieldExplosion(t){const i=this.gameBounds.height*.1*3,o=t.definition.color,s=t.definition.flashColor||o,n=this.shieldReflectDamage;if(this.maxShield>0){const h=this.maxShield;this.currentHp=Math.min(this.currentHp+h,this.maxHp),console.log(`Shield explosion! Healed ${h} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(h)}this.drawCircleEdge(i,o),this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,i,s):this.flashSkillEffectCircle(this.characterX,this.characterY,i,s);const l=this.monsterManager.getMonsters(),a=[];for(const h of l){const c=this.gameBounds.height*h.definition.size*.5,r=h.x-this.characterX,f=h.y-this.characterY;Math.sqrt(r*r+f*f)-c<=i&&a.push(h.id)}if(a.length>0){const h=l.filter(r=>a.includes(r.id)).map(r=>({x:r.x,y:r.y})),c=this.monsterManager.damageMonsters(a,n);c.totalExp>0&&this.addExp(c.totalExp),this.flashWhiteCrossAtPositions(h),this.shakeScreen(a.length),console.log(`Shield Explosion hit ${a.length} monsters for ${n} damage`)}}_drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,i=this.characterY-this.characterSize/2,o=this.characterSize*1.2,s=16763904,n=800,l=this.time.now,a=()=>{const c=this.time.now-l,r=Math.min(c/n,1);t.clear();const f=r<.2?r/.2:1,y=r<.2?0:(r-.2)/.8,w=o*(.3+.7*f),g=1-y;if(g>.01){for(let d=8;d>=1;d--){const v=w*d/8,u=g*(1-(d-1)/8)*.6;u>.01&&(t.fillStyle(s,u),t.fillCircle(e,i,v))}const S=4;for(let d=S;d>=1;d--){const v=w*.4*d/S,u=g*(1-(d-1)/S)*.9;u>.01&&(t.fillStyle(16777215,u),t.fillCircle(e,i,v))}t.lineStyle(5,s,g*.9),t.strokeCircle(e,i,w),t.lineStyle(2,16777215,g*.7),t.strokeCircle(e,i,w*.95);const p=w*.7;t.lineStyle(3,16777215,g*.5),t.beginPath();for(let d=0;d<6;d++){const v=d*Math.PI/3,u=e+Math.cos(v)*p,m=i+Math.sin(v)*p;d===0?t.moveTo(u,m):t.lineTo(u,m)}t.closePath(),t.strokePath()}r>=1&&t.destroy()};a();const h=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{t.active&&t.destroy(),h.remove()})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyBackspace)){this.showGridSkillEffects=!this.showGridSkillEffects,console.log(`Grid skill effects: ${this.showGridSkillEffects?"ON":"OFF"}`);return}if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:i}of t)if(e&&O.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(i);return}}if(this.keyShift.isDown&&O.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=ft.find(l=>l.id===t);if(!e)return;const i=this.skillManager.getSkillLevel(t),o=e.type==="passive";if(i>=e.maxLevel){console.log(`Test: ${e.name} is already MAX`);return}if(o&&i<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${e.name}`);return}const s=i<0?-1:i,n=e.maxLevel-s;this.currentLevel+=n,this.monsterManager.setPlayerLevel(this.currentLevel);for(let l=0;l<n;l++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(A.BASE_EXP*Math.pow(A.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${e.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const i of e)for(let o=0;o<=i.maxLevel;o++)this.skillManager.learnOrUpgradeSkill(i.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(A.BASE_EXP*Math.pow(A.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(A.BASE_EXP*Math.pow(A.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.displayedHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel)&&this.monsterManager.spawnBoss(this.cameraOffsetX,this.cameraOffsetY),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=A.BASE_HP+A.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const i=this.currentHp/e;this.currentHp=Math.floor(this.maxHp*i)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(O.Input.Keyboard.JustDown(this.cursors.A)&&(this.selectedSkillIndex===0?this.confirmSkillSelection():this.setSelectedSkill(0)),O.Input.Keyboard.JustDown(this.cursors.S)&&(this.selectedSkillIndex===1?this.confirmSkillSelection():this.setSelectedSkill(1)),O.Input.Keyboard.JustDown(this.cursors.D)&&(this.selectedSkillIndex===2?this.confirmSkillSelection():this.setSelectedSkill(2)))}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,e){const i=this.skillCardBgs[t],o=this.skillOptions[t];!i||!o||(e?(i.setFillStyle(3355443),i.setStrokeStyle(3,16777215),this.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:100})):(i.setFillStyle(2236962),i.setStrokeStyle(2,6710886),this.tweens.add({targets:o,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let e=0,i=0;if(this.cursors.W.isDown&&(i=-1),this.cursors.S.isDown&&(i=1),this.cursors.A.isDown&&(e=-1),this.cursors.D.isDown&&(e=1),e!==0||i!==0){if(this.isKeyboardMoving=!0,this.isPointerDown=!1,e!==0&&(this.facingRight=e>0),e!==0&&i!==0){const s=1/Math.sqrt(2);e*=s,i*=s}const o=this.moveSpeed*t/1e3;this.characterX+=e*o,this.characterY+=i*o,this.characterX=O.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=O.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isPointerDown||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateMoveDirectionFromPointer(t))}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateMoveDirectionFromPointer(t)}onPointerUp(){this.isPointerDown=!1,this.isKeyboardMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateMoveDirectionFromPointer(t){const e=t.x-this.gameBounds.x,i=t.y-this.gameBounds.y,o=e+this.cameraOffsetX,s=i+this.cameraOffsetY,n=o-this.characterX,l=s-this.characterY,a=Math.sqrt(n*n+l*l);a>0?(this.moveDirX=n/a,this.moveDirY=l/a):(this.moveDirX=0,this.moveDirY=0)}moveCharacter(t){const e=this.moveSpeed*t/1e3,i=this.characterX+this.moveDirX*e,o=this.characterY+this.moveDirY*e;this.characterX=O.Math.Clamp(i,this.characterSize,this.mapWidth-this.characterSize),this.characterY=O.Math.Clamp(o,this.characterSize,this.mapHeight-this.characterSize),this.moveDirX!==0&&this.updateCharacterFacing(this.characterX+this.moveDirX),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,i=this.cameraOffsetY+this.gameBounds.height/2,o=this.characterX-e,s=this.characterY-i,n=this.gameBounds.width*A.CAMERA_DEAD_ZONE,l=this.gameBounds.height*A.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(o)>n/2&&(o>0?this.cameraOffsetX+=o-n/2:this.cameraOffsetX+=o+n/2),Math.abs(s)>l/2&&(s>0?this.cameraOffsetY+=s-l/2:this.cameraOffsetY+=s+l/2)),this.cameraOffsetX=O.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=O.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const i=t.filter(o=>o!==this.currentBgmKey);e=i[Math.floor(Math.random()*i.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const i=t/this.background.width,o=e/this.background.height,s=Math.max(i,o);this.background.setScale(s)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,i=Math.max(A.MIN_FONT_SIZE_MEDIUM,Math.floor(this.gameBounds.height*.03));this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${i}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setResolution(2),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[1,2,3],e=[1,2],i=this.skillGridCols-2,o=this.currentHp/this.maxHp,s=Math.floor(i*o),n=this.displayedHp/this.maxHp,l=Math.floor(i*n);for(const a of t)for(let h=0;h<i;h++){const c=h+1,r=a*this.skillGridCols+c,f=this.skillGridCells[r];f&&(f.setFillStyle(0,.9),f.setVisible(!0),f.setDepth(1e3))}if(l>s)for(const a of t)for(let h=s;h<l;h++){const c=h+1,r=a*this.skillGridCols+c,f=this.skillGridCells[r];if(!f)continue;const y=t.indexOf(a),w=y===0?.85:y===1?.75:.65;f.setFillStyle(16777215,w)}if(s>0)for(const a of t)for(let h=0;h<s;h++){const c=h+1,r=a*this.skillGridCols+c,f=this.skillGridCells[r];if(!f)continue;const y=h/i,w=this.hpBarFlowOffset,g=(y+w)%1,k=(Math.sin(g*Math.PI*2-Math.PI/2)+1)/2,S=Math.floor(136-34*k),p=0,d=Math.floor(34+102*k),v=S<<16|p<<8|d,u=t.indexOf(a),m=u===0?.95:u===1?.85:.75;f.setFillStyle(v,m)}if(this.currentShield>0&&this.maxShield>0){const a=this.currentShield/this.maxShield,h=Math.floor(i*a);for(const c of e)for(let r=0;r<i;r++){const f=r+1,y=c*this.skillGridCols+f,w=this.skillGridCells[y];if(w&&r<h){const g=r/i,k=this.shieldBarFlowOffset,S=(g+k)%1,p=(Math.sin(S*Math.PI*2-Math.PI/2)+1)/2,d=255,v=Math.floor(204+51*p),u=Math.floor(0+204*p),m=d<<16|v<<8|u,x=c===e[0]?.95:.8;w.setFillStyle(m,x)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.updateDamageDisplay(t),this.drawHpBarFill()}updateDamageDisplay(t){if(this.displayedHp>this.currentHp)if(this.hpDamageDelay>0)this.hpDamageDelay-=t;else{const i=(this.displayedHp-this.currentHp)*A.HP_DAMAGE_LERP_SPEED*(t/1e3);this.displayedHp-=Math.max(1,i),this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}else this.displayedHp<this.currentHp&&(this.displayedHp=this.currentHp)}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}+${this.currentShield}/${this.maxHp}`):this.hpText.setText(`${this.currentHp}/${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,i=Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025));this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,e+t/2,"",{fontFamily:"monospace",fontSize:`${i}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.6;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0)return;const e=this.characterX,i=this.characterY,o=this.characterSize*.8,s=this.characterSize*.35,n=i-this.characterSize*.15;for(let a=5;a>=0;a--){const h=1+a*.08,c=.12-a*.018,r=3+a*2;this.shieldAuraGraphics.lineStyle(r,16777215,c),this.shieldAuraGraphics.strokeEllipse(e,n,o*h,s*h)}this.shieldSparkleTimer+=t;const l=80;this.shieldSparkleTimer>=l&&(this.shieldSparkleTimer-=l,this.createShieldSparkle(e,n,o,s))}createShieldSparkle(t,e,i,o){const s=Math.random()*Math.PI*2,n=t+Math.cos(s)*(i/2),l=e+Math.sin(s)*(o/2),a=this.add.graphics();this.characterContainer.add(a);const h=this.gameBounds.height/10,c=h*.08,r=h*.2,f=h*.5,y=600+Math.random()*200,w=this.time.now,g=()=>{const S=this.time.now-w,p=Math.min(S/y,1);a.clear();const d=l-f*p,v=Math.pow(p,.5),u=c+(r-c)*v,m=1-p;m>.01&&(a.fillStyle(16768324,m*.9),a.fillRect(n-u/2,d-u/2,u,u),a.lineStyle(1,16777215,m*.6),a.strokeRect(n-u/2,d-u/2,u,u)),p>=1&&a.destroy()};g();const k=this.time.addEvent({delay:16,callback:g,callbackScope:this,repeat:Math.ceil(y/16)});this.time.delayedCall(y+50,()=>{a.active&&a.destroy(),k.remove()})}updateHpRegen(t){const e=this.skillManager.getTitaniumLiverRegenInterval();if(!(e<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=e){this.hpRegenTimer-=e;const i=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+i,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(i),console.log(`HP Regen: +${i} HP (${this.currentHp}/${this.maxHp})`)}}}showHpHealEffect(t){const e=this.characterX,i=this.characterY-this.characterSize*.3,o=Math.min(8,Math.max(3,Math.floor(t/10)+3));for(let s=0;s<o;s++)this.time.delayedCall(s*40,()=>{this.createHpHealParticle(e,i)})}createHpHealParticle(t,e){const i=Math.random()*Math.PI*2,o=this.characterSize*.4,s=this.characterSize*.25,n=t+Math.cos(i)*o*(.3+Math.random()*.7),l=e+Math.sin(i)*s*(.3+Math.random()*.7),a=this.add.graphics();this.characterContainer.add(a);const h=this.gameBounds.height/10,c=h*(.1+Math.random()*.08),r=h*(.5+Math.random()*.3),f=700+Math.random()*300,y=this.time.now,w=[6702335,8939263,7820782,10057727],g=w[Math.floor(Math.random()*w.length)],k=()=>{const p=this.time.now-y,d=Math.min(p/f,1);a.clear();const v=l-r*d;let u,m;if(d<.2?(u=.6+d*2,m=1-d*5):(u=1-(d-.2)/.8,m=0),u>.01){const x=g>>16&255,E=g>>8&255,b=g&255,P=Math.round(x+(255-x)*m),T=Math.round(E+(255-E)*m),B=Math.round(b+(255-b)*m),I=P<<16|T<<8|B;a.fillStyle(I,u*.9),a.fillRect(n-c/2,v-c/2,c,c),a.lineStyle(1,16777215,u*.7),a.strokeRect(n-c/2,v-c/2,c,c)}d>=1&&a.destroy()};k();const S=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{a.active&&a.destroy(),S.remove()})}takeDamage(t,e=[]){const i=this.skillManager.getSyncRateDodgeChance(this.currentLevel);if(i>0&&Math.random()<i){console.log(`Dodged! (${(i*100).toFixed(1)}% chance)`),this.flashDodgeEffect();return}let s=this.skillManager.calculateFinalDamageTaken(t),n=0;if(this.currentShield>0){const l=this.currentShield>0;if(this.currentShield>=s?(n=s,this.currentShield-=s,s=0):(n=this.currentShield,s-=this.currentShield,this.currentShield=0),l&&this.currentShield===0&&this.maxShield>0){const a=this.maxShield;this.currentHp=Math.min(this.currentHp+a,this.maxHp),console.log(`Shield broken! Healed ${a} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(a)}if(this.drawShieldBarFill(),n>0&&this.showGridSkillEffects&&this.flashShieldHitEffect(),this.shieldReflectDamage>0&&e.length>0){const a=e.map(c=>c.id),h=this.monsterManager.damageMonsters(a,this.shieldReflectDamage);h.totalExp>0&&this.addExp(h.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${e.length} monsters, killed ${h.killCount}`)}}s>0?(this.currentHp-=s,this.currentHp<0&&(this.currentHp=0),this.hpDamageDelay=A.HP_DAMAGE_DELAY,this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+A.HURT_DURATION,this.isPointerDown=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${s} damage (${n} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${n} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&(!this.reviveUsed&&this.skillManager.hasTitaniumLiverRevive()?(this.reviveUsed=!0,this.currentHp=this.maxHp,this.displayedHp=this.maxHp,console.log("【不死】觸發！復活並回滿 HP！"),this.triggerShadowExplosion(),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.flashReviveEffect()):console.log("Player died!"))}_flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,i=this.characterY-this.characterSize/2,o=this.characterSize*1,s=16768324,n=600;let l=this.time.now;const a=()=>{const c=this.time.now-l,r=Math.min(c/n,1);t.clear();const f=.3,w=1-(r<f?0:(r-f)/(1-f));if(w>.01){for(let S=6;S>=1;S--){const p=o*S/6,d=w*(1-(S-1)/6)*.5;d>.01&&(t.fillStyle(s,d),t.fillCircle(e,i,p))}const k=o*.4;t.fillStyle(16777215,w*.8),t.fillCircle(e,i,k),t.lineStyle(5,s,w*.9),t.strokeCircle(e,i,o),t.lineStyle(2,16777215,w*.7),t.strokeCircle(e,i,o*.95)}r>=1&&t.destroy()},h=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{t.active&&t.destroy(),h.remove()})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),e=t.x,i=t.y,o=A.SKILL_GRID_GAP,s=this.skillGridCellSize+o,n=16763904,l=this.gameBounds.height*.2,a=400,h=200,c=this.time.now,r=[],f=Math.max(0,Math.floor((e-l)/s)),y=Math.min(this.skillGridCols-1,Math.ceil((e+l)/s)),w=Math.max(0,Math.floor((i-l)/s)),g=Math.min(this.skillGridRows-1,Math.ceil((i+l)/s));for(let d=w;d<=g;d++)for(let v=f;v<=y;v++){const u=v*s+this.skillGridCellSize/2,m=d*s+this.skillGridCellSize/2,x=u-e,E=m-i,b=Math.sqrt(x*x+E*E);b<=l&&r.push({col:v,row:d,dist:b})}if(r.length===0)return;const k=[];for(const{col:d,row:v}of r){const u=d*s+this.skillGridCellSize/2,m=v*s+this.skillGridCellSize/2,x=this.add.rectangle(u,m,this.skillGridCellSize,this.skillGridCellSize,n,0);x.setVisible(!1),this.skillGridContainer.add(x),k.push(x)}const S=()=>{const d=this.time.now-c,v=Math.min(d/a,1),u=Math.min(d/h,1),m=l*u,x=l*.3,E=Math.max(0,m-x);let b=0;d>h&&(b=(d-h)/(a-h));let P=0;for(const{dist:T}of r){const B=k[P++];if(B)if(T>=E&&T<=m){const I=(E+m)/2,G=Math.abs(T-I),R=x/2,H=G/R,_=.9*(1-H*.5)*(1-b);if(_>.01){if(d<h&&H<.3){const L=n>>16&255,X=n>>8&255,Y=n&255,V=Math.min(255,L+Math.floor((255-L)*.5)),K=Math.min(255,X+Math.floor((255-X)*.5)),U=Math.min(255,Y+Math.floor((255-Y)*.5)),F=V<<16|K<<8|U;B.setFillStyle(F,_)}else B.setFillStyle(n,_);B.setVisible(!0)}else B.setVisible(!1)}else B.setVisible(!1)}if(v>=1)for(const T of k)T.destroy()};S();const p=this.time.addEvent({delay:16,callback:S,callbackScope:this,repeat:Math.ceil(a/16)});this.time.delayedCall(a+50,()=>{p.remove();for(const d of k)d.active&&d.destroy()})}flashCharacter(){this.character.setTint(16777215),this.time.delayedCall(50,()=>{this.character.setTint(16724787)}),this.time.delayedCall(100,()=>{this.character.setTint(16777215)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashDodgeEffect(){this.character.setTint(6737151),this.time.delayedCall(50,()=>{this.character.setTint(16777215)}),this.time.delayedCall(100,()=>{this.character.setTint(6737151)}),this.time.delayedCall(150,()=>{this.character.clearTint()})}flashReviveEffect(){const t=[6684774,2228258,8913032,4456516,11141290];let e=0;const i=()=>{e<t.length?(this.character.setTint(t[e]),e++,this.time.delayedCall(80,i)):this.character.clearTint()};i()}triggerShadowExplosion(){const e=this.gameBounds.height*.1*5,i=this.monsterManager.getMonsters(),o=[];for(const s of i){const n=s.x-this.characterX,l=s.y-this.characterY,a=Math.sqrt(n*n+l*l),h=this.gameBounds.height*s.definition.size*.5;a-h<=e&&o.push(s.id)}if(o.length>0){const s=i.filter(a=>o.includes(a.id)).map(a=>({x:a.x,y:a.y})),l=this.monsterManager.damageMonsters(o,999999);l.totalExp>0&&this.addExp(l.totalExp),this.flashShadowCrossAtPositions(s),console.log(`【暗影爆炸】秒殺 ${o.length} 隻怪物，獲得 ${l.totalExp} 經驗`)}this.drawCircleEdge(e,6684774),this.showGridSkillEffects?this.flashSkillAreaCircle(this.characterX,this.characterY,e,8913032):this.flashSkillEffectCircle(this.characterX,this.characterY,e,8913032),this.cameras.main.shake(200,.01)}_drawShadowExplosionEffect(t){const e=this.add.graphics();this.worldContainer.add(e);const i=this.characterX,o=this.characterY,s=4456516,n=800,l=this.time.now,a=()=>{const c=this.time.now-l,r=Math.min(c/n,1);e.clear();const f=t*r,y=.6*(1-r);y>.01&&(e.fillStyle(s,y),e.fillCircle(i,o,f),e.lineStyle(4,8913032,y*.8),e.strokeCircle(i,o,f)),r>=1&&e.destroy()};a();const h=this.time.addEvent({delay:16,callback:a,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{h.remove(),e.active&&e.destroy()})}flashShadowCrossAtPositions(t){t.forEach(e=>{this.flashShadowCrossAt(e.x,e.y)})}flashShadowCrossAt(t,e){const i=this.worldToScreen(t,e),o=A.SKILL_GRID_GAP,s=this.skillGridCellSize+o,n=Math.floor(i.x/s),l=Math.floor(i.y/s),a=n*s+this.skillGridCellSize/2,h=l*s+this.skillGridCellSize/2,c=5,r=500,f=this.time.now,y=Math.random()<.5?1:-1,w=(Math.PI/4+Math.random()*Math.PI/4)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:u,dr:m}of k)for(let x=1;x<=c;x++)g.push({offsetX:u*x*s,offsetY:m*x*s,dist:x});if(g.length===0)return;const S=8913032,p=[];for(let u=0;u<g.length;u++){const m=this.add.rectangle(a,h,this.skillGridCellSize,this.skillGridCellSize,S,0);m.setVisible(!1),this.skillGridContainer.add(m),p.push(m)}const d=()=>{const u=this.time.now-f,m=Math.min(u/r,1),x=w*m,E=Math.cos(x),b=Math.sin(x),P=c*m;for(let T=0;T<g.length;T++){const{offsetX:B,offsetY:I,dist:G}=g[T],R=p[T];if(!R)continue;const H=a+B*E-I*b,D=h+B*b+I*E;if(R.setPosition(H,D),G>=P){const L=1-G/c*.2;let X=1;P>0&&G<P+1&&(X=G-P);const Y=L*Math.max(0,X);Y>.01?(R.setFillStyle(S,Y),R.setVisible(!0)):R.setVisible(!1)}else R.setVisible(!1)}if(m>=1)for(const T of p)T.destroy()};d();const v=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{v.remove();for(const u of p)u.active&&u.destroy()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){console.log(`Vignette initialized (grid: ${this.skillGridCols}x${this.skillGridRows})`)}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const e=Math.floor(t/this.skillGridCols),i=t%this.skillGridCols;if(e===0||e===this.skillGridRows-1||i===0||i===this.skillGridCols-1||e>=1&&e<=3)continue;const o=this.skillGridCells[t];o&&(o.setFillStyle(16777215,0),o.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const e=1500;this.lowHpBreathTimer>=e&&(this.lowHpBreathTimer-=e);const i=this.lowHpBreathTimer/e,o=Math.sin(i*Math.PI*2)*.5+.5;this.drawGridVignette(o)}drawGridVignette(t){const e=.2+t*.2;let i;this.currentShield>0?i=16768324:i=16720418;const o=this.skillGridCols/2,s=this.skillGridRows/2,n=this.skillGridCols/2*2,l=this.skillGridRows/2*2,a=4,h=this.skillGridRows-3;for(let c=a;c<h;c++)for(let r=1;r<this.skillGridCols-1;r++){const f=c*this.skillGridCols+r,y=this.skillGridCells[f];if(!y)continue;const w=(r-o)/n,g=(c-s)/l,k=Math.sqrt(w*w+g*g);if(k>.5){const S=Math.min(1,(k-.5)/.25),p=e*S;p>.01&&(y.setFillStyle(i,p),y.setVisible(!0),this.vignetteEdgeCells.add(f))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(1002);const t=Math.max(A.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.03)),e=this.skillGridCellSize,i=this.gameBounds.y+this.gameBounds.height-e*2;this.levelText=this.add.text(this.gameBounds.x+10,i-5,`Lv.${this.currentLevel}`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setResolution(2),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText),this.uiContainer.add(this.expBarContainer)}drawExpBarFill(){const t=[this.skillGridRows-3,this.skillGridRows-2],e=this.skillGridCols-2;for(const s of t)for(let n=0;n<e;n++){const l=n+1,a=s*this.skillGridCols+l,h=this.skillGridCells[a];h&&(h.setFillStyle(0,.9),h.setVisible(!0),h.setDepth(1e3))}const i=this.currentExp/this.maxExp,o=Math.floor(e*i);if(!(o<=0))for(const s of t)for(let n=0;n<o;n++){const l=n+1,a=s*this.skillGridCols+l,h=this.skillGridCells[a];if(!h)continue;const c=n/e,r=this.expBarFlowOffset,f=(c+r)%1,y=(Math.sin(f*Math.PI*2-Math.PI/2)+1)/2,w=Math.floor(68+68*y),g=Math.floor(136-68*y),S=w<<16|g<<8|255,p=s===this.skillGridRows-2?.95:.8;h.setFillStyle(S,p)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawBorderFrame(){for(let i=0;i<this.skillGridCols;i++){const o=0*this.skillGridCols+i,s=this.skillGridCells[o];s&&(s.setFillStyle(3355443,.95),s.setVisible(!0),s.setDepth(1001))}for(let i=0;i<this.skillGridCols;i++){const o=(this.skillGridRows-1)*this.skillGridCols+i,s=this.skillGridCells[o];s&&(s.setFillStyle(3355443,.95),s.setVisible(!0),s.setDepth(1001))}for(let i=1;i<this.skillGridRows-1;i++){const o=i*this.skillGridCols+0,s=this.skillGridCells[o];s&&(s.setFillStyle(3355443,.95),s.setVisible(!0),s.setDepth(1001))}for(let i=1;i<this.skillGridRows-1;i++){const o=i*this.skillGridCols+(this.skillGridCols-1),s=this.skillGridCells[o];s&&(s.setFillStyle(3355443,.95),s.setVisible(!0),s.setDepth(1001))}}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,e=Math.ceil(this.mapWidth/t),i=Math.ceil(this.mapHeight/t);for(let l=0;l<i;l++)for(let a=0;a<e;a++){const h=a*t,c=l*t;(l+a)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(h,c,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(h,c,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const o=this.mapWidth/2,s=this.mapHeight/2,n=t;this.floorGrid.strokeRect(o-n/2,s-n/2,n,n);for(let l=0;l<i;l+=5)for(let a=0;a<e;a+=5){const h=a*t+t/2,c=l*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(h,c,4)}}createSkillBar(){const t=this.skillGridCellSize,e=A.SKILL_GRID_GAP,i=8,o=i*(t+e)-e,s=1,n=2,l=A.ACTIVE_SKILLS,a=A.PASSIVE_SKILLS,h=l*i+(l-1)*s,c=a*i+(a-1)*s,f=(h+n+c)*(t+e)-e,y=this.gameBounds.x+(this.gameBounds.width-f)/2,w=2*(t+e),g=t+e,k=this.gameBounds.y+this.gameBounds.height-w-o-g;let S=y;for(let p=0;p<l;p++){const d=S+o/2,v=k+o/2,u=this.add.container(d,v),m=this.add.rectangle(0,0,o,o);m.setStrokeStyle(0,16777215,0),m.setFillStyle(0,0),u.add(m);const x=this.add.rectangle(0,0,o-4,o-4,3355443,0);u.add(x);const E=Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(o*.2)),b=this.add.text(0,o*.3,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${E}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});b.setResolution(2),b.setOrigin(.5,.5),u.add(b),this.skillIcons.push(m),this.skillIconContainers.push(u),this.skillLevelTexts.push(b),u.setDepth(1002),this.uiContainer.add(u),this.drawSkillIconGrid(S,k,i,p),S+=o+s*(t+e)}S+=(n-s)*(t+e);for(let p=0;p<a;p++){const d=S+o/2,v=k+o/2,u=this.add.container(d,v),m=this.add.rectangle(0,0,o,o);m.setStrokeStyle(0,16777215,0),m.setFillStyle(0,0),u.add(m);const x=this.add.rectangle(0,0,o-4,o-4,3355443,0);u.add(x);const E=Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(o*.2)),b=this.add.text(0,o*.3,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${E}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});b.setResolution(2),b.setOrigin(.5,.5),u.add(b),this.skillIcons.push(m),this.skillIconContainers.push(u),this.skillLevelTexts.push(b),u.setDepth(1002),this.uiContainer.add(u),this.drawSkillIconGrid(S,k,i,l+p),S+=o+s*(t+e)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}drawSkillIconGrid(t,e,i,o){const s=this.add.graphics();s.setDepth(1001),this.uiContainer.add(s),this.skillIconGridData[o]={startX:t,startY:e,gridSize:i},this.redrawSkillIconGrid(o,0),this.skillIconGridGraphics[o]=s}redrawSkillIconGrid(t,e){const i=this.skillIconGridGraphics[t],o=this.skillIconGridData[t];if(!i||!o)return;i.clear();const s=this.skillGridCellSize,n=A.SKILL_GRID_GAP,{startX:l,startY:a,gridSize:h}=o,c=A.ACTIVE_SKILLS,r=t<c,f=r?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),y=r?t:t-c;if(!f[y]){i.fillStyle(0,.5);for(let d=0;d<h;d++)for(let v=0;v<h;v++){const u=l+v*(s+n),m=a+d*(s+n);i.fillRect(u,m,s,s)}return}const g=[],k=Math.floor(h/2);for(let d=k;d<h;d++)g.push({row:0,col:d});for(let d=1;d<h;d++)g.push({row:d,col:h-1});for(let d=h-2;d>=0;d--)g.push({row:h-1,col:d});for(let d=h-2;d>=1;d--)g.push({row:d,col:0});g.push({row:0,col:0});for(let d=1;d<k;d++)g.push({row:0,col:d});const S=g.length,p=Math.floor(S*e);for(let d=0;d<S;d++){const{row:v,col:u}=g[d],m=l+u*(s+n),x=a+v*(s+n);if(d<p){const E=this.getSkillColorForIndex(t);i.fillStyle(E,.4)}else i.fillStyle(0,.5);i.fillRect(m,x,s,s)}}getSkillColorForIndex(t){const e=A.ACTIVE_SKILLS,i=t<e,o=i?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),s=i?t:t-e,n=o[s];return n?n.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,e=this.skillManager.getPlayerActiveSkills();for(let s=0;s<e.length;s++){const n=e[s];if(!n){this.redrawSkillIconGrid(s,0);continue}const l=n.definition;let a=l.cooldown||1e3;l.id==="active_architect"&&(a=a-n.level*500);const h=this.skillManager.calculateFinalCooldown(a),c=this.skillCooldowns.get(l.id)||0,r=t-c;if(r>=h)this.redrawSkillIconGrid(s,1);else{const f=r/h;this.redrawSkillIconGrid(s,f)}}const i=this.skillManager.getPlayerPassiveSkills(),o=A.ACTIVE_SKILLS;for(let s=0;s<i.length;s++){const n=i[s];if(!n){this.redrawSkillIconGrid(o+s,0);continue}const l=n.definition;let a=1;switch(l.id){case"passive_titanium_liver":{const h=this.skillManager.getTitaniumLiverRegenInterval();h>0&&this.currentHp<this.maxHp&&(a=this.hpRegenTimer/h);break}}this.redrawSkillIconGrid(o+s,a)}}createSkillInfoPanel(){const t=this.gameBounds,e=200,i=80,o=t.width*.05,s=t.x+o,n=t.y+t.height-i-o-60;this.skillInfoPanel=this.add.container(s,n),this.skillInfoPanel.setDepth(1003),this.skillInfoBg=this.add.rectangle(0,0,e,i,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg);const l=10,a=Math.max(A.MIN_FONT_SIZE_SMALL,12);this.skillInfoText=this.add.text(l,l,"",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${a}px`,color:"#ffffff",wordWrap:{width:e-l*2}}),this.skillInfoText.setResolution(2),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=A.ACTIVE_SKILLS;for(let e=0;e<this.skillIconContainers.length;e++){const i=this.skillIconContainers[e],o=e<t,s=o?e:e-t;i.setSize(i.getBounds().width,i.getBounds().height),i.setInteractive({useHandCursor:!0}),i.on("pointerdown",()=>{this.showSkillInfo(o,s)})}}showSkillInfo(t,e){const o=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[e];if(!o){this.skillInfoPanel.setVisible(!1);return}const s=[];s.push(`【${o.definition.name}】${lt.formatLevel(o.level,o.definition.maxLevel)}`),t?this.appendActiveSkillInfo(s,o):this.appendPassiveSkillInfo(s,o),this.skillInfoText.setText(s.join(`
`));const n=this.skillInfoText.getBounds(),l=10;this.skillInfoBg.setSize(Math.max(180,n.width+l*2),n.height+l*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,e){const i=e.level,o=this.skillManager.getAiEnhancementDamageBonus(),s=this.skillManager.getSyncRateCooldownReduction();switch(e.definition.id){case"active_soul_render":{const n=60+i*10,l=2+i,a=A.DAMAGE_UNIT*l,h=Math.floor(a*(1+o)),r=((e.definition.cooldown||1e3)*(1-s)/1e3).toFixed(1);t.push(`扇形角度: ${n}°`),t.push(`傷害: ${h}`),t.push(`冷卻: ${r}s`);break}case"active_coder":{const n=2+i*.5,l=1+i,a=A.DAMAGE_UNIT*l,h=Math.floor(a*(1+o)),r=((e.definition.cooldown||1500)*(1-s)/1e3).toFixed(1);t.push(`範圍: ${n} 單位`),t.push(`傷害: ${h}`),t.push(`冷卻: ${r}s`);break}case"active_vfx":{const n=i+1,l=1+i,a=A.DAMAGE_UNIT*l,h=Math.floor(a*(1+o)),r=((e.definition.cooldown||2500)*(1-s)/1e3).toFixed(1);t.push(`光束數: ${n} 道`),t.push(`傷害: ${h}`),t.push(`冷卻: ${r}s`);break}case"active_architect":{const l=Math.floor(this.maxHp*.3),a=1+i*1.5,h=A.DAMAGE_UNIT*a,r=((e.definition.cooldown||1e4)*(1-s)/1e3).toFixed(1);t.push(`護盾: ${l} (霸體)`),t.push(`反傷: ${h}`),t.push(`回血: ${l}`),t.push(`冷卻: ${r}s`);break}}this.appendMaxExtraAbility(t,e)}appendMaxExtraAbility(t,e){const i=this.skillManager.getMaxExtraAbilityText(e.definition.id,this.currentLevel);i&&(t.push(""),t.push(i))}appendPassiveSkillInfo(t,e){switch(e.definition.id){case"passive_titanium_liver":{const i=this.skillManager.getTitaniumLiverHpBonus(),o=this.skillManager.getTitaniumLiverRegenInterval()/1e3;if(t.push(`HP 加成: +${Math.round(i*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${o} 秒 +1% HP`),this.skillManager.hasTitaniumLiverRevive()){const s=this.reviveUsed?"(已使用)":"(待命)";t.push(`【不死】抵銷一次死亡 ${s}`)}break}case"passive_sync_rate":{const i=this.skillManager.getSyncRateSpeedBonus(),o=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(i*100)}%`),t.push(`冷卻減少: -${Math.round(o*100)}%`);break}case"passive_retina_module":{const i=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(i*100)}%`);break}case"passive_ai_enhancement":{const i=this.skillManager.getAiEnhancementDamageBonus(),o=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(i*100)}%`),t.push(`防禦加成: +${Math.round(o*100)}%`);break}}this.appendMaxExtraAbility(t,e)}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),i=[...t,...e];for(let o=0;o<this.skillIconContainers.length;o++){const s=this.skillIconContainers[o],n=this.skillLevelTexts[o],l=i[o],a=s.list[1];l?(a.setFillStyle(l.definition.color,.5),n.setText(lt.formatLevel(l.level,l.definition.maxLevel))):(a.setFillStyle(3355443,0),n.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_LARGE,Math.floor(this.gameBounds.height*.07))}px`,color:"#ffffff",fontStyle:"bold"});i.setResolution(2),i.setOrigin(.5,.5),this.skillPanelContainer.add(i);const o=e+this.gameBounds.height*.06,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.025))}px`,color:"#cccccc"});s.setResolution(2),s.setOrigin(.5,.5),this.skillPanelContainer.add(s),this.createSkillOptions();const n=this.gameBounds.y+this.gameBounds.height*.92,l=this.isMobile?"點兩次確認":"重複按同一鍵確認",a=this.add.text(this.gameBounds.x+this.gameBounds.width/2,n,l,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(this.gameBounds.height*.022))}px`,color:"#888888"});a.setResolution(2),a.setOrigin(.5,.5),this.skillPanelContainer.add(a)}createSkillCutIn(){this.skillCutInContainer=this.add.container(0,0),this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setDepth(1e3),this.uiContainer.add(this.skillCutInContainer)}showSkillCutIn(t,e){this.skillCutInContainer.removeAll(!0);const i=this.gameBounds.height*.12,o=this.gameBounds.y+this.gameBounds.height*.25,s=this.gameBounds.width*.15,n=this.gameBounds.width-s*2,l=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,o,n,i,0,.75);this.skillCutInContainer.add(l);const a=this.add.graphics(),h=this.gameBounds.x,c=this.gameBounds.x+s,r=20;for(let E=0;E<r;E++){const b=E/r*.75,P=h+s/r*E,T=s/r+1;a.fillStyle(0,b),a.fillRect(P,o-i/2,T,i)}this.skillCutInContainer.add(a);const f=this.add.graphics(),y=this.gameBounds.x+this.gameBounds.width-s;for(let E=0;E<r;E++){const b=(1-E/r)*.75,P=y+s/r*E,T=s/r+1;f.fillStyle(0,b),f.fillRect(P,o-i/2,T,i)}this.skillCutInContainer.add(f);const w=3,g=this.add.graphics(),k=o-i/2-w/2;for(let E=0;E<r;E++){const b=E/r*.8,P=h+s/r*E,T=s/r+1;g.fillStyle(t.color,b),g.fillRect(P,k,T,w)}g.fillStyle(t.color,.8),g.fillRect(c,k,n,w);for(let E=0;E<r;E++){const b=(1-E/r)*.8,P=y+s/r*E,T=s/r+1;g.fillStyle(t.color,b),g.fillRect(P,k,T,w)}this.skillCutInContainer.add(g);const S=this.add.graphics(),p=o+i/2-w/2;for(let E=0;E<r;E++){const b=E/r*.8,P=h+s/r*E,T=s/r+1;S.fillStyle(t.color,b),S.fillRect(P,p,T,w)}S.fillStyle(t.color,.8),S.fillRect(c,p,n,w);for(let E=0;E<r;E++){const b=(1-E/r)*.8,P=y+s/r*E,T=s/r+1;S.fillStyle(t.color,b),S.fillRect(P,p,T,w)}this.skillCutInContainer.add(S);const d=e>=t.maxLevel?"MAX":`Lv.${e}`,v=`${t.name} 提升到 ${d}`,u=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o-i*.18,v,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_LARGE,Math.floor(i*.35))}px`,color:"#ffffff",fontStyle:"bold"});u.setResolution(2),u.setOrigin(.5,.5),this.skillCutInContainer.add(u);let m=t.description;t.levelUpMessages&&t.levelUpMessages[e]&&(m=t.levelUpMessages[e]);const x=this.add.text(this.gameBounds.x+this.gameBounds.width/2,o+i*.22,m,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_MEDIUM,Math.floor(i*.22))}px`,color:O.Display.Color.IntegerToColor(t.color).rgba});x.setResolution(2),x.setOrigin(.5,.5),this.skillCutInContainer.add(x),this.skillCutInContainer.setX(-this.gameBounds.width),this.skillCutInContainer.setVisible(!0),this.skillCutInContainer.setAlpha(1),this.tweens.add({targets:this.skillCutInContainer,x:0,duration:250,ease:"Power2.easeOut",onComplete:()=>{this.time.delayedCall(1500,()=>{this.tweens.add({targets:this.skillCutInContainer,x:this.gameBounds.width,duration:250,ease:"Power2.easeIn",onComplete:()=>{this.skillCutInContainer.setVisible(!1),this.skillCutInContainer.setX(0)}})})}})}createSkillOptions(){if(this.skillOptions.forEach(h=>h.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,e=this.gameBounds.height*(this.isMobile?.55:.5),i=this.gameBounds.width*.05,o=this.currentSkillChoices.length,s=t*o+i*(o-1),n=this.gameBounds.x+(this.gameBounds.width-s)/2+t/2,l=this.gameBounds.y+this.gameBounds.height*.55,a=["A","S","D"];for(let h=0;h<this.currentSkillChoices.length;h++){const c=this.currentSkillChoices[h],r=this.skillManager.getSkillLevel(c.id),f=r<0,y=f?"-":r,w=f?0:r+1,g=n+h*(t+i),k=this.add.container(g,l),S=this.add.rectangle(0,0,t,e,2236962);S.setStrokeStyle(2,6710886),k.add(S);const p=this.add.text(0,-e*.42,c.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(e*.045))}px`,color:c.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});p.setResolution(2),p.setOrigin(.5,.5),k.add(p);const d=t*.5,v=-e*.18,u=this.add.rectangle(0,v,d,d,c.color,.3);u.setStrokeStyle(2,c.color),k.add(u);const m=e*.06,x=this.add.text(0,m,c.name,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.08))}px`,color:"#ffffff",fontStyle:"bold"});if(x.setResolution(2),x.setOrigin(.5,.5),k.add(x),c.subtitle){const I=this.add.text(0,e*.12,c.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(e*.04))}px`,color:"#999999"});I.setResolution(2),I.setOrigin(.5,.5),k.add(I)}let E;w>=c.maxLevel?E=`Lv.${y} → MAX`:f?E=`NEW → Lv.${w}`:E=`Lv.${y} → Lv.${w}`;const b=this.add.text(0,e*.2,E,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(e*.05))}px`,color:w>=c.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});b.setResolution(2),b.setOrigin(.5,.5),k.add(b);const P=this.isMobile?e*.36:e*.32,T=this.add.text(0,P,c.description,{fontFamily:"Microsoft JhengHei, PingFang TC, -apple-system, BlinkMacSystemFont, sans-serif",fontSize:`${Math.max(A.MIN_FONT_SIZE_SMALL,Math.floor(e*.04))}px`,color:"#dddddd",wordWrap:{width:t*.85},align:"center"});if(T.setResolution(2),T.setOrigin(.5,0),k.add(T),!this.isMobile){const I=this.add.text(0,e*.42,`[ ${a[h]} ]`,{fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace',fontSize:`${Math.max(A.MIN_FONT_SIZE_MEDIUM,Math.floor(e*.06))}px`,color:"#ffff00",fontStyle:"bold"});I.setResolution(2),I.setOrigin(.5,.5),k.add(I)}S.setInteractive({useHandCursor:!0});const B=h;S.on("pointerover",()=>{this.setSelectedSkill(B)}),S.on("pointerdown",()=>{this.isMobile?this.selectedSkillIndex===B?this.confirmSkillSelection():this.setSelectedSkill(B):(this.setSelectedSkill(B),this.confirmSkillSelection())}),this.skillPanelContainer.add(k),this.skillOptions.push(k),this.skillCardBgs.push(S)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out! Continue leveling for HP growth.");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isPointerDown=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,e)=>{e===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,e)=>{t.setScale(e===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:e*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,e){const i=this.currentSkillChoices[t];if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`);return}const s=this.skillManager.getPlayerSkill(e),n=(s==null?void 0:s.level)??0;console.log(`Skill upgraded: ${e} -> Lv.${n}`),this.updateSkillBarDisplay(),(s==null?void 0:s.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const l=this.skillOptions[t];this.tweens.add({targets:l,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel(),this.showSkillCutIn(i,n)}})}createSkillGrid(){const t=this.cameras.main.width,e=1920,i=20/this.gridScaleMultiplier,o=6/this.gridScaleMultiplier,s=Math.min(1,t/e);this.skillGridCellSize=Math.max(o,Math.floor(i*s));const n=A.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+n)/(this.skillGridCellSize+n)),this.skillGridRows=Math.ceil((this.gameBounds.height+n)/(this.skillGridCellSize+n)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(3);for(let l=0;l<this.skillGridRows;l++)for(let a=0;a<this.skillGridCols;a++){const h=a*(this.skillGridCellSize+n)+this.skillGridCellSize/2,c=l*(this.skillGridCellSize+n)+this.skillGridCellSize/2,r=this.add.rectangle(h,c,this.skillGridCellSize,this.skillGridCellSize,16777215,0);r.setVisible(!1),this.skillGridCells.push(r),this.skillGridContainer.add(r)}this.drawBorderFrame()}recreateSkillGrid(){this.skillGridCells.forEach(t=>t.destroy()),this.skillGridCells=[],this.skillGridContainer&&this.skillGridContainer.destroy(),this.createSkillGrid(),this.recreateSkillBar(),this.bringUIToTop()}bringUIToTop(){this.characterContainer&&this.uiContainer.bringToTop(this.characterContainer),this.hpBarContainer&&this.uiContainer.bringToTop(this.hpBarContainer),this.shieldText&&this.uiContainer.bringToTop(this.shieldText),this.expBarContainer&&this.uiContainer.bringToTop(this.expBarContainer),this.skillIconContainers.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillIconGridGraphics.forEach(t=>{this.uiContainer.bringToTop(t)}),this.skillInfoPanel&&this.uiContainer.bringToTop(this.skillInfoPanel),this.skillPanelContainer&&this.uiContainer.bringToTop(this.skillPanelContainer)}recreateSkillBar(){this.skillIcons.forEach(t=>t.destroy()),this.skillIcons=[],this.skillIconContainers.forEach(t=>t.destroy()),this.skillIconContainers=[],this.skillLevelTexts.forEach(t=>t.destroy()),this.skillLevelTexts=[],this.skillIconGridGraphics.forEach(t=>t.destroy()),this.skillIconGridGraphics=[],this.skillIconGridData=[],this.skillInfoPanel&&this.skillInfoPanel.destroy(),this.createSkillBar()}initSkillEffectPool(){for(let t=0;t<A.SKILL_EFFECT_POOL_SIZE;t++){const e=this.add.sprite(0,0,A.TEXTURE_CIRCLE);e.setVisible(!1),e.setActive(!1),e.setDepth(51),this.worldContainer.add(e),this.skillEffectPool.push(e)}}getSkillEffectSprite(){let t=this.skillEffectPool.pop();return t||(t=this.add.sprite(0,0,A.TEXTURE_CIRCLE),t.setDepth(51),this.worldContainer.add(t)),t.setVisible(!0),t.setActive(!0),this.activeSkillEffects.push(t),t}releaseSkillEffectSprite(t){t.setVisible(!1),t.setActive(!1),t.setScale(1),t.setRotation(0),t.setAlpha(1),t.setTint(16777215);const e=this.activeSkillEffects.indexOf(t);e>-1&&this.activeSkillEffects.splice(e,1),this.skillEffectPool.push(t)}getSectorTextureKey(t){const e=[30,40,50,60,70,80,90,100,110,120,130,140,150,160];let i=e[0],o=Math.abs(t-i);for(const s of e){const n=Math.abs(t-s);n<o&&(o=n,i=s)}return A.TEXTURE_SECTOR_PREFIX+i}flashSkillEffectSector(t,e,i,o,s,n){const l=this.getSkillEffectSprite();if(!l)return;const a=this.getSectorTextureKey(s*2);l.setTexture(a),l.setPosition(t,e),l.setRotation(o);const h=i*2/A.EFFECT_TEXTURE_SIZE;l.setScale(h),l.setTint(n),l.setAlpha(0),this.tweens.add({targets:l,alpha:{from:0,to:.75},scale:{from:h*.5,to:h},duration:150,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(150,()=>{this.tweens.add({targets:l,alpha:0,scale:h*1.1,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(l)}})})}})}flashSkillEffectCircle(t,e,i,o){const s=this.getSkillEffectSprite();if(!s)return;s.setTexture(A.TEXTURE_CIRCLE),s.setPosition(t,e);const n=i*2/A.EFFECT_TEXTURE_SIZE;s.setScale(n),s.setTint(o),s.setAlpha(0),this.tweens.add({targets:s,alpha:{from:0,to:.75},scale:{from:n*.3,to:n},duration:150,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(150,()=>{this.tweens.add({targets:s,alpha:0,scale:n*1.2,duration:200,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(s)}})})}})}flashSkillEffectLine(t,e,i,o,s,n){const l=this.getSkillEffectSprite();if(!l)return;l.setTexture(A.TEXTURE_LINE);const a=i-t,h=o-e,c=Math.sqrt(a*a+h*h),r=(t+i)/2,f=(e+o)/2,y=Math.atan2(h,a);l.setPosition(r,f),l.setRotation(y);const w=c/A.EFFECT_TEXTURE_SIZE,g=s/A.EFFECT_LINE_HEIGHT;l.setScale(w,g),l.setTint(n),l.setAlpha(0),this.tweens.add({targets:l,alpha:{from:0,to:.85},scaleY:{from:g*.5,to:g},duration:80,ease:"Quad.easeOut",onComplete:()=>{this.time.delayedCall(300,()=>{this.tweens.add({targets:l,alpha:0,scaleY:g*.2,duration:400,ease:"Quad.easeIn",onComplete:()=>{this.releaseSkillEffectSprite(l)}})})}})}flashSkillEffectSectorMoving(t,e,i,o,s,n,l){const a=this.getSkillEffectSprite();if(!a)return;const h=i*s*2,c=s*(180/Math.PI),r=this.getSectorTextureKey(c*2);a.setTexture(r),a.setPosition(t,e),a.setRotation(o);const f=i*2/A.EFFECT_TEXTURE_SIZE;a.setScale(f),a.setTint(n),a.setAlpha(.4);const y=500,w=this.time.now,g=()=>{const k=this.time.now-w,S=Math.min(k/y,1);if(S>=1){this.releaseSkillEffectSprite(a);return}const p=i+l*S,v=h/(2*p)*(180/Math.PI),u=this.getSectorTextureKey(v*2);a.texture.key!==u&&a.setTexture(u);const m=p*2/A.EFFECT_TEXTURE_SIZE;a.setScale(m);const x=.4*(1-S*.5);a.setAlpha(x),this.time.delayedCall(16,g)};g()}worldToScreen(t,e){return{x:t-this.cameraOffsetX,y:e-this.cameraOffsetY}}showSkillRangeCircle(t,e,i,o,s=.3){const n=this.worldToScreen(t,e),l=n.x,a=n.y,h=A.SKILL_GRID_GAP,c=this.skillGridCellSize+h,r=Math.max(0,Math.floor((l-i)/c)),f=Math.min(this.skillGridCols-1,Math.ceil((l+i)/c)),y=Math.max(0,Math.floor((a-i)/c)),w=Math.min(this.skillGridRows-1,Math.ceil((a+i)/c));for(let g=y;g<=w;g++)for(let k=r;k<=f;k++){const S=k*c+this.skillGridCellSize/2,p=g*c+this.skillGridCellSize/2,d=S-l,v=p-a;if(Math.sqrt(d*d+v*v)<=i){const m=g*this.skillGridCols+k;this.activateSkillGridCell(m,o,s)}}}showSkillRangeSector(t,e,i,o,s,n,l=.3){const a=this.worldToScreen(t,e),h=a.x,c=a.y,r=A.SKILL_GRID_GAP,f=this.skillGridCellSize+r,y=Math.max(0,Math.floor((h-i)/f)),w=Math.min(this.skillGridCols-1,Math.ceil((h+i)/f)),g=Math.max(0,Math.floor((c-i)/f)),k=Math.min(this.skillGridRows-1,Math.ceil((c+i)/f));for(let S=g;S<=k;S++)for(let p=y;p<=w;p++){const d=p*f+this.skillGridCellSize/2,v=S*f+this.skillGridCellSize/2,u=d-h,m=v-c,x=Math.sqrt(u*u+m*m);if(x<=i&&x>0){const E=Math.atan2(m,u);let b=Math.abs(E-o);if(b>Math.PI&&(b=2*Math.PI-b),b<=s){const P=S*this.skillGridCols+p;this.activateSkillGridCell(P,n,l)}}}}showSkillRangeLine(t,e,i,o,s,n,l=.3){const a=this.worldToScreen(t,e),h=this.worldToScreen(i,o),c=A.SKILL_GRID_GAP,r=this.skillGridCellSize+c,f=h.x-a.x,y=h.y-a.y,w=Math.sqrt(f*f+y*y);if(w===0)return;const g=f/w,k=y/w,S=-k,p=g,d=s/2,v=[{x:a.x+S*d,y:a.y+p*d},{x:a.x-S*d,y:a.y-p*d},{x:h.x+S*d,y:h.y+p*d},{x:h.x-S*d,y:h.y-p*d}],u=Math.min(...v.map(I=>I.x)),m=Math.max(...v.map(I=>I.x)),x=Math.min(...v.map(I=>I.y)),E=Math.max(...v.map(I=>I.y)),b=Math.max(0,Math.floor(u/r)),P=Math.min(this.skillGridCols-1,Math.ceil(m/r)),T=Math.max(0,Math.floor(x/r)),B=Math.min(this.skillGridRows-1,Math.ceil(E/r));for(let I=T;I<=B;I++)for(let G=b;G<=P;G++){const R=G*r+this.skillGridCellSize/2,H=I*r+this.skillGridCellSize/2,D=Math.max(0,Math.min(1,((R-a.x)*g+(H-a.y)*k)/w)),_=a.x+D*f,L=a.y+D*y;if(Math.sqrt((R-_)**2+(H-L)**2)<=d){const Y=I*this.skillGridCols+G;this.activateSkillGridCell(Y,n,l)}}}clearSkillGrid(){for(const t of this.activeSkillGridCells){if(this.vignetteEdgeCells.has(t)&&(this.isLowHp||this.currentShield>0))continue;const e=Math.floor(t/this.skillGridCols),i=t%this.skillGridCols;if(e===0||e===this.skillGridRows-1||i===0||i===this.skillGridCols-1||e>=1&&e<=3||e>=this.skillGridRows-3)continue;const o=this.skillGridCells[t];o&&o.setVisible(!1)}this.activeSkillGridCells.clear()}activateSkillGridCell(t,e,i){if(t<0||t>=this.skillGridCells.length)return;const o=this.skillGridCells[t];o&&(o.setFillStyle(e,i),o.setVisible(!0),this.activeSkillGridCells.add(t))}flashGridAt(t,e,i,o=1){const s=this.worldToScreen(t,e),n=A.SKILL_GRID_GAP,l=this.skillGridCellSize+n,a=Math.floor(s.x/l),h=Math.floor(s.y/l),c=600,r=200,f=this.time.now,y=[];for(let k=-o;k<=o;k++)for(let S=-o;S<=o;S++){const p=a+S,d=h+k;if(p<0||p>=this.skillGridCols||d<0||d>=this.skillGridRows)continue;const v=Math.sqrt(k*k+S*S);if(v<=o){const u=d*this.skillGridCols+p,m=this.skillGridCells[u];m&&y.push({cell:m,dist:v})}}if(y.length===0)return;const w=()=>{const k=this.time.now-f,S=Math.min(k/c,1);let p=0;k>r&&(p=(k-r)/(c-r));for(const{cell:d,dist:v}of y){const u=v/Math.max(o,1),x=(1-u*.4)*(1-p);if(x>.01)if(k<r){const b=(1-u)*.5;if(d.setFillStyle(i,x),d.setVisible(!0),v<o*.5){const P=i>>16&255,T=i>>8&255,B=i&255,I=Math.min(255,P+Math.floor((255-P)*b)),G=Math.min(255,T+Math.floor((255-T)*b)),R=Math.min(255,B+Math.floor((255-B)*b)),H=I<<16|G<<8|R;d.setFillStyle(H,x)}}else d.setFillStyle(i,x),d.setVisible(!0);else d.setVisible(!1)}if(S>=1)for(const{cell:d}of y)d.setVisible(!1),d.setAlpha(1)};w();const g=this.time.addEvent({delay:16,callback:w,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{g.remove();for(const{cell:k}of y)k.setVisible(!1),k.setAlpha(1)})}flashGridAtPositions(t,e,i=1){t.forEach(o=>{this.flashGridAt(o.x,o.y,e,i)})}flashWhiteCrossAt(t,e){const i=this.worldToScreen(t,e),o=A.SKILL_GRID_GAP,s=this.skillGridCellSize+o,n=Math.floor(i.x/s),l=Math.floor(i.y/s),a=n*s+this.skillGridCellSize/2,h=l*s+this.skillGridCellSize/2,c=3,r=300,f=this.time.now,y=Math.random()<.5?1:-1,w=(Math.PI/9+Math.random()*Math.PI/6)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:v,dr:u}of k)for(let m=1;m<=c;m++)g.push({offsetX:v*m*s,offsetY:u*m*s,dist:m});if(g.length===0)return;const S=[];for(let v=0;v<g.length;v++){const u=this.add.rectangle(a,h,this.skillGridCellSize,this.skillGridCellSize,16777215,0);u.setVisible(!1),this.skillGridContainer.add(u),S.push(u)}const p=()=>{const v=this.time.now-f,u=Math.min(v/r,1),m=w*u,x=Math.cos(m),E=Math.sin(m),b=c*u;for(let P=0;P<g.length;P++){const{offsetX:T,offsetY:B,dist:I}=g[P],G=S[P];if(!G)continue;const R=a+T*x-B*E,H=h+T*E+B*x;if(G.setPosition(R,H),I>=b){const _=1-I/c*.5;let L=1;b>0&&I<b+1&&(L=I-b);const X=_*Math.max(0,L);X>.01?(G.setFillStyle(16777215,X),G.setVisible(!0)):G.setVisible(!1)}else G.setVisible(!1)}if(u>=1)for(const P of S)P.destroy()};p();const d=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{d.remove();for(const v of S)v.active&&v.destroy()})}flashCritCrossAt(t,e){const i=this.worldToScreen(t,e),o=A.SKILL_GRID_GAP,s=this.skillGridCellSize+o,n=Math.floor(i.x/s),l=Math.floor(i.y/s),a=n*s+this.skillGridCellSize/2,h=l*s+this.skillGridCellSize/2,c=4,r=400,f=this.time.now,y=Math.random()<.5?1:-1,w=(Math.PI/6+Math.random()*Math.PI/6)*y,g=[];g.push({offsetX:0,offsetY:0,dist:0});const k=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:u,dr:m}of k)for(let x=1;x<=c;x++)g.push({offsetX:u*x*s,offsetY:m*x*s,dist:x});if(g.length===0)return;const S=16746496,p=[];for(let u=0;u<g.length;u++){const m=this.add.rectangle(a,h,this.skillGridCellSize,this.skillGridCellSize,S,0);m.setVisible(!1),this.skillGridContainer.add(m),p.push(m)}const d=()=>{const u=this.time.now-f,m=Math.min(u/r,1),x=w*m,E=Math.cos(x),b=Math.sin(x),P=c*m;for(let T=0;T<g.length;T++){const{offsetX:B,offsetY:I,dist:G}=g[T],R=p[T];if(!R)continue;const H=a+B*E-I*b,D=h+B*b+I*E;if(R.setPosition(H,D),G>=P){const L=1-G/c*.3;let X=1;P>0&&G<P+1&&(X=G-P);const Y=L*Math.max(0,X);Y>.01?(R.setFillStyle(S,Y),R.setVisible(!0)):R.setVisible(!1)}else R.setVisible(!1)}if(m>=1)for(const T of p)T.destroy()};d();const v=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{v.remove();for(const u of p)u.active&&u.destroy()})}flashWhiteCrossAtPositions(t){t.forEach(e=>{this.flashWhiteCrossAt(e.x,e.y)})}flashCritCrossAtPositions(t){t.forEach(e=>{this.flashCritCrossAt(e.x,e.y)})}flashDeathEffect(t,e){const i=this.worldToScreen(t,e),o=A.SKILL_GRID_GAP,s=this.skillGridCellSize+o,n=Math.floor(i.x/s),l=Math.floor(i.y/s),a=3,h=400,c=this.time.now,r=[];for(let p=0;p<a;p++){const d=Math.random()*Math.PI*2,v=2+Math.random()*2;r.push({col:n+Math.round(Math.cos(d)*v),row:l+Math.round(Math.sin(d)*v),radius:3+Math.floor(Math.random()*3)})}const f=new Map;for(const p of r){const d=p.radius;for(let v=-d;v<=d;v++)for(let u=-d;u<=d;u++){const m=Math.sqrt(v*v+u*u);if(m<=d){const x=p.col+u,E=p.row+v;if(x>=0&&x<this.skillGridCols&&E>=0&&E<this.skillGridRows){const b=`${x},${E}`,P=f.get(b);(!P||m<P.dist)&&f.set(b,{col:x,row:E,dist:m})}}}}const y=Array.from(f.values());if(y.length===0)return;const w=Math.max(...y.map(p=>p.dist)),g=[];for(const{col:p,row:d,dist:v}of y){const u=p*s+this.skillGridCellSize/2,m=d*s+this.skillGridCellSize/2,x=this.add.rectangle(u,m,this.skillGridCellSize,this.skillGridCellSize,16777215,0);x.setVisible(!1),this.skillGridContainer.add(x),g.push({rect:x,dist:v})}const k=()=>{const p=this.time.now-c,d=Math.min(p/h,1);for(const{rect:v,dist:u}of g){const m=u/(w+1),x=m+.5;let E=0;if(d>=m&&d<=x&&(d<m+.1?E=(d-m)/.1:E=1-(d-m-.1)/(x-m-.1),E=Math.max(0,Math.min(.8,E))),E>.01){const b=200+Math.floor(Math.random()*55),P=b<<16|b<<8|b;v.setFillStyle(P,E),v.setVisible(!0)}else v.setVisible(!1)}if(d>=1)for(const{rect:v}of g)v.destroy()};k();const S=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{S.remove();for(const{rect:p}of g)p.active&&p.destroy()})}flashSkillAreaSector(t,e,i,o,s,n){const l=t,a=e,h=A.SKILL_GRID_GAP,c=this.skillGridCellSize+h,r=500,f=150,y=150,w=this.time.now,g=[],k=l-i,S=l+i,p=a-i,d=a+i;for(let x=p;x<=d;x+=c)for(let E=k;E<=S;E+=c){const b=Math.round(E/c)*c,P=Math.round(x/c)*c,T=b-l,B=P-a,I=Math.sqrt(T*T+B*B);if(I<=i&&I>0){const G=Math.atan2(B,T);let R=Math.abs(G-o);R>Math.PI&&(R=2*Math.PI-R),R<=s&&g.push({worldX:b,worldY:P,dist:I,angleDist:R})}}if(g.length===0)return;const v=[];for(const{worldX:x,worldY:E}of g){const b=this.add.rectangle(x,E,this.skillGridCellSize,this.skillGridCellSize,n,0);b.setVisible(!1),b.setDepth(50),this.worldContainer.add(b),v.push(b)}const u=()=>{const x=this.time.now-w,E=Math.min(x/r,1),b=Math.min(x/f,1),P=i*b;let T=0;x>f+y&&(T=(x-f-y)/(r-f-y));const B=i*T;let I=0;for(const{dist:G,angleDist:R}of g){const H=v[I++];if(H)if(G<=P&&G>=B){const D=G/i,_=R/s,Y=Math.max(D,_),V=Math.max(0,Math.min(1,(Y-.3)/.7)),K=V*V*(3-2*V),U=.15+K*.6;let F=1;if(B>0){const $=i*.15;G<B+$&&(F=(G-B)/$)}const z=U*F;if(z>.01){const $=.5+K*.5,W=n>>16&255,N=n>>8&255,Z=n&255;let q=W,j=N,J=Z;if(Y>.85&&x<f+y){const at=(Y-.85)/.15;q=Math.min(255,W+Math.floor((255-W)*at*.3)),j=Math.min(255,N+Math.floor((255-N)*at*.3)),J=Math.min(255,Z+Math.floor((255-Z)*at*.3))}else q=Math.floor(W*$),j=Math.floor(N*$),J=Math.floor(Z*$);const et=q<<16|j<<8|J;H.setFillStyle(et,z),H.setVisible(!0)}else H.setVisible(!1)}else H.setVisible(!1)}if(E>=1)for(const G of v)G.destroy()};u();const m=this.time.addEvent({delay:16,callback:u,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{m.remove();for(const x of v)x.active&&x.destroy()})}flashSkillAreaCircle(t,e,i,o){const s=t,n=e,l=A.SKILL_GRID_GAP,a=this.skillGridCellSize+l,h=500,c=150,r=150,f=this.time.now,y=[],w=s-i,g=s+i,k=n-i,S=n+i;for(let u=k;u<=S;u+=a)for(let m=w;m<=g;m+=a){const x=Math.round(m/a)*a,E=Math.round(u/a)*a,b=x-s,P=E-n,T=Math.sqrt(b*b+P*P);T<=i&&y.push({worldX:x,worldY:E,dist:T})}if(y.length===0)return;const p=[];for(const{worldX:u,worldY:m}of y){const x=this.add.rectangle(u,m,this.skillGridCellSize,this.skillGridCellSize,o,0);x.setVisible(!1),x.setDepth(50),this.worldContainer.add(x),p.push(x)}const d=()=>{const u=this.time.now-f,m=Math.min(u/h,1),x=Math.min(u/c,1),E=i*x;let b=0;u>c+r&&(b=(u-c-r)/(h-c-r));const P=i*b;let T=0;for(const{dist:B}of y){const I=p[T++];if(I)if(B<=E&&B>=P){const G=B/i,R=Math.max(0,Math.min(1,(G-.3)/.7)),H=R*R*(3-2*R),D=.15+H*.6;let _=1;if(P>0){const X=i*.15;B<P+X&&(_=(B-P)/X)}const L=D*_;if(L>.01){const X=.5+H*.5,Y=o>>16&255,V=o>>8&255,K=o&255;let U=Y,F=V,z=K;if(G>.85&&u<c+r){const W=(G-.85)/.15;U=Math.min(255,Y+Math.floor((255-Y)*W*.3)),F=Math.min(255,V+Math.floor((255-V)*W*.3)),z=Math.min(255,K+Math.floor((255-K)*W*.3))}else U=Math.floor(Y*X),F=Math.floor(V*X),z=Math.floor(K*X);const $=U<<16|F<<8|z;I.setFillStyle($,L),I.setVisible(!0)}else I.setVisible(!1)}else I.setVisible(!1)}if(m>=1)for(const B of p)B.destroy()};d();const v=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{v.remove();for(const u of p)u.active&&u.destroy()})}flashSkillAreaLine(t,e,i,o,s,n){const l=t,a=e,h=i,c=o,r=A.SKILL_GRID_GAP,f=this.skillGridCellSize+r,y=h-l,w=c-a,g=Math.sqrt(y*y+w*w);if(g===0)return;const k=y/g,S=w/g,p=-S,d=k,v=s/2,u=800,m=80,x=300,E=u-m-x,b=this.time.now,P=[],T=[{x:l+p*v,y:a+d*v},{x:l-p*v,y:a-d*v},{x:h+p*v,y:c+d*v},{x:h-p*v,y:c-d*v}],B=Math.min(...T.map(L=>L.x)),I=Math.max(...T.map(L=>L.x)),G=Math.min(...T.map(L=>L.y)),R=Math.max(...T.map(L=>L.y));for(let L=G;L<=R;L+=f)for(let X=B;X<=I;X+=f){const Y=Math.round(X/f)*f,V=Math.round(L/f)*f,K=Y-l,U=V-a,F=K*k+U*S;if(F<0||F>g)continue;const z=l+k*F,$=a+S*F,W=Math.sqrt((Y-z)**2+(V-$)**2);W<=v&&P.push({worldX:Y,worldY:V,distAlong:F,distToLine:W})}if(P.length===0)return;const H=[];for(const{worldX:L,worldY:X}of P){const Y=this.add.rectangle(L,X,this.skillGridCellSize,this.skillGridCellSize,n,0);Y.setVisible(!1),Y.setDepth(50),this.worldContainer.add(Y),H.push(Y)}const D=()=>{const L=this.time.now-b,X=Math.min(L/u,1),Y=Math.min(L/m,1),V=g*Y;let K=0;L>m+x&&(K=(L-m-x)/E);const U=g*K,F=1-K;let z=0;for(const{distAlong:$,distToLine:W}of P){const N=H[z++];if(!N)continue;const Z=v*F;if($<=V&&$>=U&&W<=Z){const q=Z>0?W/Z:1,j=1-q*q;let J=.2+j*.5;const et=$/g,at=Math.min(1,et/.15),gt=Math.min(1,(1-et)/.15),rt=Math.min(at,gt);J*=rt*rt;let ht=1;if(U>0){const it=g*.1;$<U+it&&(ht=($-U)/it)}const ct=J*ht;if(ct>.01){const it=.6+j*.4,pt=n>>16&255,ut=n>>8&255,mt=n&255;let St,Mt,yt;if(q<.2&&L<m+x){const kt=1-q/.2;St=Math.min(255,pt+Math.floor((255-pt)*kt*.3)),Mt=Math.min(255,ut+Math.floor((255-ut)*kt*.3)),yt=Math.min(255,mt+Math.floor((255-mt)*kt*.3))}else St=Math.floor(pt*it),Mt=Math.floor(ut*it),yt=Math.floor(mt*it);const Tt=St<<16|Mt<<8|yt;N.setFillStyle(Tt,ct),N.setVisible(!0)}else N.setVisible(!1)}else N.setVisible(!1)}if(X>=1)for(const $ of H)$.destroy()};D();const _=this.time.addEvent({delay:16,callback:D,callbackScope:this,repeat:Math.ceil(u/16)});this.time.delayedCall(u+50,()=>{_.remove();for(const L of H)L.active&&L.destroy()})}};C(A,"MAP_SCALE",10),C(A,"ACTIVE_SKILLS",4),C(A,"PASSIVE_SKILLS",3),C(A,"CAMERA_DEAD_ZONE",.3),C(A,"HP_DAMAGE_DELAY",1e3),C(A,"HP_DAMAGE_LERP_SPEED",3),C(A,"MIN_FONT_SIZE_LARGE",14),C(A,"MIN_FONT_SIZE_MEDIUM",12),C(A,"MIN_FONT_SIZE_SMALL",10),C(A,"BASE_HP",200),C(A,"HP_PER_LEVEL",50),C(A,"BASE_EXP",100),C(A,"EXP_GROWTH_RATE",1.2),C(A,"DAMAGE_UNIT",10),C(A,"HURT_DURATION",200),C(A,"ATTACK_DURATION",150),C(A,"SKILL_GRID_GAP",1),C(A,"SKILL_EFFECT_POOL_SIZE",50),C(A,"TEXTURE_SECTOR_PREFIX","effect_sector_"),C(A,"TEXTURE_CIRCLE","effect_circle"),C(A,"TEXTURE_LINE","effect_line"),C(A,"EFFECT_TEXTURE_SIZE",256),C(A,"EFFECT_LINE_HEIGHT",64);let xt=A;const Bt=7,Gt={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},Rt={charHeight:Bt,chars:Gt};class Lt{constructor(){C(this,"font");this.font=Rt}textToPixels(M,t,e){const i=[],o=M.letterSpacing??1,s=M.color.replace("#",""),n=parseInt(s.substring(0,2),16),l=parseInt(s.substring(2,4),16),a=parseInt(s.substring(4,6),16),h=n<<16|l<<8|a;let c=0;const r=M.text.toUpperCase().split("");for(let S=0;S<r.length;S++){const p=this.font.chars[r[S]];p&&(c+=p.width,S<r.length-1&&(c+=o))}const f=Math.floor(t*M.position.x),y=Math.floor(e*M.position.y),w=f-Math.floor(c/2),g=y-Math.floor(this.font.charHeight/2);let k=w;for(const S of r){const p=this.font.chars[S];if(p){for(let d=0;d<p.pixels.length;d++){const v=p.pixels[d];for(let u=0;u<v.length;u++)if(v[u]==="#"){const m=k+u,x=g+d;m>=0&&m<t&&x>=0&&x<e&&i.push({gridX:m,gridY:x,color:h})}}k+=p.width+o}}return i}processConfig(M,t,e){const i=new Map;for(const o of M.texts){const s=this.textToPixels(o,t,e);i.set(o.id,s)}return i}}const Ht=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],Ft={texts:Ht},ot=class ot extends O.Scene{constructor(){super("GridScene");C(this,"cells",[]);C(this,"cols",0);C(this,"rows",0);C(this,"cellWidth",10);C(this,"cellHeight",10);C(this,"gap",1);C(this,"isAnimating",!1);C(this,"isReady",!1);C(this,"textRenderer");C(this,"textPixels",new Map);C(this,"cursorGlowRadius",4);C(this,"glowPhase",0);C(this,"textBreathPhase",0);C(this,"isLoading",!0);C(this,"loadingCells",new Set);C(this,"backgroundImage");C(this,"titleBgm");this.textRenderer=new Lt}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.image("effect_circle","effects/circle.png"),this.load.image("effect_line","effects/line.png");const t=[30,40,50,60,70,80,90,100,110,120,130,140,150,160];for(const e of t)this.load.image(`effect_sector_${e}`,`effects/sector_${e}.png`);this.load.on("progress",e=>{this.updateLoadingProgress(Math.floor(e*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const e=Math.floor(t.x/(this.cellWidth+this.gap)),i=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(e,i)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const i=this.input.activePointer;i&&this.updateCursorGlow(i.x,i.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),i=e<<16|e<<8|e,o=.5+.5*Math.sin(this.textBreathPhase*3),s=t>.6?o*.8:0,n=new Set;this.cells.forEach(l=>{l.isText&&n.add(`${l.x},${l.y}`)}),this.cells.forEach(l=>{if(l.isText)l.graphics.setFillStyle(i),l.graphics.setAlpha(.95);else{const a=`${l.x-1},${l.y-1}`;n.has(a)&&s>0&&(l.graphics.setFillStyle(8939263),l.graphics.setAlpha(s))}})}updateCursorGlow(t,e){const i=Math.floor(t/(this.cellWidth+this.gap)),o=Math.floor(e/(this.cellHeight+this.gap)),s=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(n=>{const l=n.x-i,a=n.y-o,h=Math.sqrt(l*l+a*a);if(h<=this.cursorGlowRadius){const r=(1-h/this.cursorGlowRadius)*s,f=n.originalColor>>16&255,y=n.originalColor>>8&255,w=n.originalColor&255,g=Math.min(255,Math.floor(f+(255-f)*r)),k=Math.min(255,Math.floor(y+(255-y)*r)),S=Math.min(255,Math.floor(w+(255-w)*r)),p=g<<16|k<<8|S;n.graphics.setFillStyle(p)}else n.graphics.setFillStyle(n.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,e/2,"background");const i=t/this.backgroundImage.width,o=e/this.backgroundImage.height,s=Math.max(i,o);this.backgroundImage.setScale(s),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(o=>{this.cells[o]&&(this.cells[o].originalColor=2236962,this.cells[o].isText=!1,this.cells[o].graphics.setFillStyle(2236962),this.cells[o].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(o=>{const s=o.gridY*this.cols+o.gridX;this.cells[s]&&(this.cells[s].originalColor=o.color,this.cells[s].isText=!0,this.cells[s].graphics.setFillStyle(o.color),this.cells[s].graphics.setAlpha(.95),this.loadingCells.add(s))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const e=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,e.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const i=e.gridY*this.cols+e.gridX;this.cells[i]&&(this.cells[i].graphics.setFillStyle(e.color),this.cells[i].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,i=Math.min(1,t/ot.BASE_WIDTH),o=Math.max(ot.MIN_CELL_SIZE,Math.floor(ot.BASE_CELL_SIZE*i));this.gap=1,this.cellWidth=o,this.cellHeight=o,this.cols=Math.ceil((t+this.gap)/(o+this.gap)),this.rows=Math.ceil((e+this.gap)/(o+this.gap));const s=.05,n=t*(1-s*2),l=e*(1-s*2),a=16/9,h=n/l;let c,r;h>a?(r=l,c=l*a):(c=n,r=n/a);const f=(t-c)/2,y=(e-r)/2;this.registry.set("gameBounds",{x:f,y,width:c,height:r}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${o}, gameBounds: ${c.toFixed(0)}x${r.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const i=e*(this.cellWidth+this.gap)+this.cellWidth/2,o=t*(this.cellHeight+this.gap)+this.cellHeight/2,s=this.add.rectangle(i,o,this.cellWidth,this.cellHeight,2236962);s.setAlpha(0),this.cells.push({x:e,y:t,graphics:s,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(Ft,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const i=e.gridY*this.cols+e.gridX;this.cells[i]&&(this.cells[i].originalColor=e.color,this.cells[i].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let g=0;g<this.cells.length;g++)t.add(g);const e=20,i=50,o=10,n=Math.floor(200/o),l=3e3;let a=0,h=!1;const c=(g,k)=>k*this.cols+g,r=g=>({x:g%this.cols,y:Math.floor(g/this.cols)}),f=g=>{const k=this.cells[g];k.graphics.setAlpha(1),k.graphics.setFillStyle(16777215),this.tweens.add({targets:k.graphics,fillColor:{from:16777215,to:k.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},y=g=>{const{x:k,y:S}=r(g),p=n,d=[];for(let m=0;m<=p;m++)d[m]=[];for(let m=-p;m<=p;m++)for(let x=-p;x<=p;x++){const E=k+x,b=S+m;if(E>=0&&E<this.cols&&b>=0&&b<this.rows){const P=Math.sqrt(x*x+m*m),T=Math.floor(P);if(T<=p){const B=c(E,b);d[T].push(B)}}}let v=0;const u=()=>{v>p||(d[v].forEach(m=>{t.has(m)&&(t.delete(m),f(m))}),v++,v<=p&&this.time.delayedCall(o,u))};u()},w=()=>{if(h)return;if(a>=l||t.size===0){this.finishEntry(t),h=!0;return}const g=Array.from(t),k=Math.min(e,g.length);for(let S=0;S<k&&g.length!==0;S++){const p=Math.floor(Math.random()*g.length),d=g[p];g.splice(p,1),t.has(d)&&y(d)}a+=i,t.size>0&&a<l?this.time.delayedCall(i,w):h||(this.finishEntry(t),h=!0)};w()}finishEntry(t){t.forEach(e=>{const i=this.cells[e];i.graphics.setAlpha(.2),i.graphics.setFillStyle(i.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const i=this.cameras.main.width,o=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const s=t*(this.cellWidth+this.gap)+this.cellWidth/2,n=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:s,y:n,radius:0}),this.cells.forEach(r=>{r.graphics.setFillStyle(0),r.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const l=5;let a=0;this.cells.forEach(r=>{const f=r.x-t,y=r.y-e,w=Math.sqrt(f*f+y*y);r.delay=Math.floor(w*l),r.delay>a&&(a=r.delay)});const h=Math.sqrt(Math.max(s,i-s)**2+Math.max(n,o-n)**2)+50,c=a+150;this.tweens.addCounter({from:0,to:h,duration:c,ease:"Linear",onUpdate:r=>{const f=r.getValue()??0;this.registry.events.emit("reveal-update",{x:s,y:n,radius:f})}}),this.cells.forEach(r=>{this.time.delayedCall(r.delay,()=>{r.graphics.setFillStyle(16777215),r.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:f=>{const y=f.getValue()??0;let w,g;y<15?(w=16777215,g=1):y<30?(w=16776960,g=1):y<50?(w=16746496,g=1):y<70?(w=16720384,g=1-(y-50)/50):(w=6684672,g=1-(y-50)/50),r.graphics.setFillStyle(w),r.graphics.setAlpha(Math.max(0,g))},onComplete:()=>{r.graphics.setVisible(!1)}})})}),this.time.delayedCall(a+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};C(ot,"BASE_CELL_SIZE",10),C(ot,"MIN_CELL_SIZE",4),C(ot,"BASE_WIDTH",1920);let wt=ot;const Et=document.getElementById("version-info");Et&&(Et.textContent="v0.5.0a");let Q=null;function Dt(){return window.innerWidth>window.innerHeight}function vt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function _t(){if(Q)return;const tt={type:O.AUTO,width:window.innerWidth,height:vt(),parent:"app",backgroundColor:"#111111",pixelArt:!0,scale:{mode:O.Scale.RESIZE,autoCenter:O.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[wt,At,xt]};Q=new O.Game(tt),Q.events.once("ready",()=>{Q&&Q.sound&&(Q.sound.volume=.5)})}function bt(){(window.innerWidth>900||Dt())&&_t()}bt();window.addEventListener("resize",bt);window.addEventListener("orientationchange",()=>{setTimeout(bt,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{Q&&Q.scale.resize(window.innerWidth,vt())});document.addEventListener("fullscreenchange",()=>{Q&&setTimeout(()=>{Q.scale.resize(window.innerWidth,vt())},100)});window.addEventListener("volumechange",tt=>{Q&&Q.sound&&(Q.sound.volume=tt.detail.volume)});
