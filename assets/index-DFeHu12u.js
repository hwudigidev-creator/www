var At=Object.defineProperty;var Et=(q,u,t)=>u in q?At(q,u,{enumerable:!0,configurable:!0,writable:!0,value:t}):q[u]=t;var m=(q,u,t)=>Et(q,typeof u!="symbol"?u+"":u,t);import{P as F}from"./phaser-0RJB29YE.js";(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function e(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class Gt extends F.Scene{constructor(){super("BootScene")}preload(){}create(){const u=this.cameras.main.width,t=this.cameras.main.height;this.add.text(u/2,t/2,"Loading...",{font:"20px monospace",color:"#ffffff"}).setOrigin(.5,.5),this.scene.start("MainScene")}}const ht=[{id:"active_soul_render",name:"靈魂渲染",subtitle:"動畫大師",description:"朝最近敵人發射 3 單位扇形攻擊，每級擴大 10°",type:"active",color:6724095,flashColor:6737151,cooldown:1e3,maxLevel:5},{id:"active_coder",name:"編碼者",subtitle:"遊戲先知",description:"對周圍 2 單位敵人造成傷害，每級增加 0.5 單位範圍",type:"active",color:11167487,flashColor:13404415,cooldown:1500,maxLevel:5},{id:"active_vfx",name:"視效師",subtitle:"超級導演",description:"朝隨機敵人發射 10 單位貫穿光束，每級增加 1 道",type:"active",color:6750054,flashColor:8978312,cooldown:2500,maxLevel:5},{id:"active_architect",name:"架構師",subtitle:"靈魂統領",description:"產生 30% HP 護盾並反傷攻擊者，護盾消失時回復等值 HP",type:"active",color:16763904,flashColor:16768324,cooldown:1e4,maxLevel:5},{id:"passive_titanium_liver",name:"鈦金肝",description:"提升 10% HP 總量並每 15 秒回復 1% 最大 HP，每級再 +10% HP、回復間隔 -1 秒",type:"passive",color:11189196,maxLevel:5},{id:"passive_sync_rate",name:"精神同步率強化",description:"提升 10% 移速、減少 8% 冷卻，每級再疊加",type:"passive",color:14518340,maxLevel:5},{id:"passive_retina_module",name:"視網膜增強模組",description:"提升 30% 經驗取得，每級再 +30%",type:"passive",color:10035763,maxLevel:5},{id:"passive_ai_enhancement",name:"AI賦能強化",description:"提升 25% 攻擊、5% 防禦，每級再疊加",type:"passive",color:6719658,maxLevel:5}],nt=class nt{constructor(){m(this,"playerSkills",new Map)}getActiveSkillDefinitions(){return ht.filter(u=>u.type==="active")}getPassiveSkillDefinitions(){return ht.filter(u=>u.type==="passive")}getPlayerSkill(u){return this.playerSkills.get(u)}getPlayerActiveSkills(){const u=[];this.playerSkills.forEach(e=>{e.definition.type==="active"&&u.push(e)});const t=[];for(let e=0;e<4;e++)t.push(u[e]||null);return t}getPlayerPassiveSkills(){const u=[];this.playerSkills.forEach(e=>{e.definition.type==="passive"&&u.push(e)});const t=[];for(let e=0;e<nt.MAX_PASSIVE_SLOTS;e++)t.push(u[e]||null);return t}getOwnedPassiveCount(){let u=0;return this.playerSkills.forEach(t=>{t.definition.type==="passive"&&u++}),u}isPassiveSlotsFull(){return this.getOwnedPassiveCount()>=nt.MAX_PASSIVE_SLOTS}getSkillLevel(u){const t=this.playerSkills.get(u);return t?t.level:-1}isSkillMaxLevel(u){const t=this.playerSkills.get(u);return t?t.level>=t.definition.maxLevel:!1}learnOrUpgradeSkill(u){const t=ht.find(s=>s.id===u);if(!t)return!1;const e=this.playerSkills.get(u);if(e){if(e.level>=t.maxLevel)return!1;e.level++}else this.playerSkills.set(u,{definition:t,level:0});return!0}getUpgradeableActiveSkills(){return this.getActiveSkillDefinitions().filter(u=>{const t=this.playerSkills.get(u.id);return!t||t.level<u.maxLevel})}getUpgradeablePassiveSkills(){const u=this.isPassiveSlotsFull();return this.getPassiveSkillDefinitions().filter(t=>{const e=this.playerSkills.get(t.id);return u?e&&e.level<t.maxLevel:!e||e.level<t.maxLevel})}hasAnyActiveSkill(){return this.getActiveSkillDefinitions().some(t=>this.playerSkills.has(t.id))}getRandomSkillOptions(){const u=this.getUpgradeableActiveSkills(),t=this.getUpgradeablePassiveSkills(),e=[];if(!this.hasAnyActiveSkill()){const i=this.shuffleArray([...u]);for(let l=0;l<Math.min(3,i.length);l++)e.push(i[l]);return e}const s=this.shuffleArray([...u]);for(let i=0;i<Math.min(2,s.length);i++)e.push(s[i]);const a=this.shuffleArray([...t]);return a.length>0&&e.push(a[0]),e}hasUpgradeableSkills(){return this.getUpgradeableActiveSkills().length>0||this.getUpgradeablePassiveSkills().length>0}shuffleArray(u){for(let t=u.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[u[t],u[e]]=[u[e],u[t]]}return u}static formatLevel(u,t=5){return u<=0?"Lv.0":u>=t?"MAX":`Lv.${u}`}getTitaniumLiverHpBonus(){const u=this.playerSkills.get("passive_titanium_liver");return u?(u.level+1)*.1:0}getTitaniumLiverRegenInterval(){const u=this.playerSkills.get("passive_titanium_liver");return u?(15-u.level)*1e3:0}hasTitaniumLiver(){return this.playerSkills.has("passive_titanium_liver")}getSyncRateSpeedBonus(){const u=this.playerSkills.get("passive_sync_rate");return u?(u.level+1)*.1:0}getSyncRateCooldownReduction(){const u=this.playerSkills.get("passive_sync_rate");return u?(u.level+1)*.08:0}getRetinaModuleExpBonus(){const u=this.playerSkills.get("passive_retina_module");return u?(u.level+1)*.3:0}getAiEnhancementDamageBonus(){const u=this.playerSkills.get("passive_ai_enhancement");return u?(u.level+1)*.25:0}getAiEnhancementDefenseBonus(){const u=this.playerSkills.get("passive_ai_enhancement");return u?(u.level+1)*.05:0}calculateFinalMaxHp(u){const t=this.getTitaniumLiverHpBonus();return Math.floor(u*(1+t))}calculateFinalMoveSpeed(u){const t=this.getSyncRateSpeedBonus();return u*(1+t)}calculateFinalCooldown(u){const t=this.getSyncRateCooldownReduction();return u*(1-t)}calculateFinalExp(u){const t=this.getRetinaModuleExpBonus();return Math.floor(u*(1+t))}calculateFinalDamage(u){const t=this.getAiEnhancementDamageBonus();return Math.floor(u*(1+t))}calculateFinalDamageTaken(u){const t=this.getAiEnhancementDefenseBonus();return Math.floor(u*(1-t))}};m(nt,"MAX_PASSIVE_SLOTS",3);let lt=nt;const It=[{id:"slime",name:"史萊姆",color:6750054,speed:1.5,damage:1,size:.08,hp:30,exp:20}],ot=class ot{constructor(u,t,e,s,a){m(this,"scene");m(this,"monsters",[]);m(this,"nextMonsterId",0);m(this,"container");m(this,"spawnInterval",2e3);m(this,"lastSpawnTime",0);m(this,"isSpawning",!1);m(this,"gameBounds");m(this,"mapWidth");m(this,"mapHeight");m(this,"playerLevel",0);this.scene=u,this.container=t,this.gameBounds=e,this.mapWidth=s,this.mapHeight=a}setPlayerLevel(u){this.playerLevel=u}calculateMonsterHp(u){return Math.floor(u*Math.pow(ot.HP_GROWTH_RATE,this.playerLevel))}calculateMonsterDamage(){const u=Math.max(1,this.playerLevel);return ot.DAMAGE_UNIT*u}calculateMonsterExp(u){const t=Math.floor(this.playerLevel/5);return u*Math.pow(2,t)}startSpawning(){this.isSpawning=!0,this.lastSpawnTime=this.scene.time.now}stopSpawning(){this.isSpawning=!1}update(u,t,e,s,a){const i=this.scene.time.now;let l=0;const o=[];if(this.isSpawning&&i-this.lastSpawnTime>=this.spawnInterval){const h=1+Math.floor(this.playerLevel/5);for(let r=0;r<h;r++)this.spawnMonster(t,e,s,a);this.lastSpawnTime=i}const n=this.gameBounds.height*.1,c=this.gameBounds.height*.1;return this.monsters.forEach(h=>{const r=t-h.x,f=e-h.y,p=Math.sqrt(r*r+f*f);if(p>c){const S=h.definition.speed*this.gameBounds.height*.1*u/1e3/p;h.x+=r*S,h.y+=f*S}else i-h.lastDamageTime>=3e3&&(l+=this.calculateMonsterDamage(),h.lastDamageTime=i,o.push(h));this.drawMonster(h,n,s,a)}),{damage:l,hitMonsters:o}}spawnMonster(u,t,e,s){const a=["top","left","right"],i=a[Math.floor(Math.random()*a.length)];let l,o;const n=100,c=e,h=e+this.gameBounds.width,r=s;switch(i){case"top":l=c+Math.random()*this.gameBounds.width,o=r-n;break;case"left":l=c-n,o=r+Math.random()*this.gameBounds.height;break;case"right":l=h+n,o=r+Math.random()*this.gameBounds.height;break}l=Phaser.Math.Clamp(l,0,this.mapWidth),o=Phaser.Math.Clamp(o,0,this.mapHeight);const f=It[0],p=this.scene.add.graphics(),d=this.calculateMonsterHp(f.hp),y={id:this.nextMonsterId++,definition:f,x:l,y:o,hp:d,graphics:p,lastDamageTime:0};this.monsters.push(y),this.container.add(p)}drawMonster(u,t,e,s){const a=u.graphics;a.clear();const i=u.x,l=u.y;a.fillStyle(u.definition.color,.8),a.fillCircle(i,l-t/2,t/2),a.fillStyle(0,1),a.fillCircle(i-t*.15,l-t*.6,t*.08),a.fillCircle(i+t*.15,l-t*.6,t*.08)}removeMonster(u){const t=this.monsters.findIndex(e=>e.id===u);t!==-1&&(this.monsters[t].graphics.destroy(),this.monsters.splice(t,1))}getMonsters(){return this.monsters}clearAllMonsters(){this.monsters.forEach(u=>{u.graphics.destroy()}),this.monsters=[]}setSpawnInterval(u){this.spawnInterval=u}damageMonster(u,t){const e=this.monsters.find(s=>s.id===u);if(!e)return{killed:!1,exp:0};if(e.hp-=t,this.flashMonster(e),e.hp<=0){const s=this.calculateMonsterExp(e.definition.exp);return this.removeMonster(u),{killed:!0,exp:s}}return{killed:!1,exp:0}}flashMonster(u){const t=u.definition.color,e=u.graphics,s=this.gameBounds.height*.1;e.clear(),e.fillStyle(16777215,1),e.fillCircle(u.x,u.y-s/2,s/2),this.scene.time.delayedCall(50,()=>{u.hp>0&&(e.clear(),e.fillStyle(t,.8),e.fillCircle(u.x,u.y-s/2,s/2),e.fillStyle(0,1),e.fillCircle(u.x-s*.15,u.y-s*.6,s*.08),e.fillCircle(u.x+s*.15,u.y-s*.6,s*.08))})}damageMonsters(u,t){let e=0,s=0;for(const a of u){const i=this.damageMonster(a,t);i.killed&&(e+=i.exp,s++)}return{totalExp:e,killCount:s}}};m(ot,"HP_GROWTH_RATE",1.1),m(ot,"DAMAGE_UNIT",10);let St=ot;const G=class G extends F.Scene{constructor(){super("MainScene");m(this,"character");m(this,"characterState","idle");m(this,"facingRight",!0);m(this,"skillIcons",[]);m(this,"skillIconGridGraphics",[]);m(this,"skillIconGridData",[]);m(this,"gameBounds");m(this,"boundsBorder");m(this,"background");m(this,"gameAreaContainer");m(this,"revealMask");m(this,"mapWidth");m(this,"mapHeight");m(this,"characterX");m(this,"characterY");m(this,"characterSize");m(this,"isMoving",!1);m(this,"isPointerDown",!1);m(this,"targetX");m(this,"targetY");m(this,"baseMoveSpeed",0);m(this,"moveSpeed",0);m(this,"floorGrid");m(this,"worldContainer");m(this,"characterContainer");m(this,"uiContainer");m(this,"cameraOffsetX",0);m(this,"cameraOffsetY",0);m(this,"cursors");m(this,"isKeyboardMoving",!1);m(this,"skillPanelContainer");m(this,"isPaused",!1);m(this,"skillOptions",[]);m(this,"skillCardBgs",[]);m(this,"selectedSkillIndex",0);m(this,"currentSkillChoices",[]);m(this,"skillManager",new lt);m(this,"skillIconContainers",[]);m(this,"skillLevelTexts",[]);m(this,"skillInfoPanel");m(this,"skillInfoBg");m(this,"skillInfoText");m(this,"skillInfoHideTimer");m(this,"currentExp",0);m(this,"maxExp",100);m(this,"currentLevel",0);m(this,"expBarContainer");m(this,"expBarFlowOffset",0);m(this,"levelText");m(this,"currentHp",200);m(this,"maxHp",200);m(this,"hpBarContainer");m(this,"hpBarFlowOffset",0);m(this,"hpText");m(this,"currentShield",0);m(this,"maxShield",0);m(this,"shieldBarFlowOffset",0);m(this,"shieldReflectDamage",0);m(this,"shieldText");m(this,"shieldAuraGraphics");m(this,"shieldSparkleTimer",0);m(this,"hpRegenTimer",0);m(this,"keyPlus");m(this,"keyMinus");m(this,"keyShift");m(this,"keyCtrl");m(this,"keyZero");m(this,"keyBackspace");m(this,"keyF5");m(this,"keyF6");m(this,"keyF7");m(this,"keyF8");m(this,"keyF9");m(this,"keyF10");m(this,"keyF11");m(this,"keyF12");m(this,"showLegacySkillEffects",!1);m(this,"monsterManager");m(this,"isHurt",!1);m(this,"hurtEndTime",0);m(this,"lowHpBreathTimer",0);m(this,"isLowHp",!1);m(this,"vignetteEdgeCells",new Set);m(this,"skillCooldowns",new Map);m(this,"isAttacking",!1);m(this,"attackEndTime",0);m(this,"gameBgm");m(this,"currentBgmKey","");m(this,"skillGridContainer");m(this,"skillGridCells",[]);m(this,"skillGridCols",0);m(this,"skillGridRows",0);m(this,"skillGridCellSize",10)}create(){this.cameras.main.setBackgroundColor("#111111");const t=this.cameras.main.width,e=this.cameras.main.height;if(this.gameBounds=this.registry.get("gameBounds"),!this.gameBounds){const o=t*.9,n=e*(1-.05*2),c=16/9,h=o/n;let r,f;h>c?(f=n,r=n*c):(r=o,f=o/c),this.gameBounds={x:(t-r)/2,y:(e-f)/2,width:r,height:f}}this.mapWidth=this.gameBounds.width*G.MAP_SCALE,this.mapHeight=this.gameBounds.height*G.MAP_SCALE,this.characterSize=this.gameBounds.height*.15,this.baseMoveSpeed=this.gameBounds.height*.3,this.moveSpeed=this.baseMoveSpeed,this.characterX=this.mapWidth/2,this.characterY=this.mapHeight/2,this.createFullscreenBackground(t,e),this.gameAreaContainer=this.add.container(0,0),this.gameAreaContainer.setDepth(0),this.drawGameBorder(),this.worldContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.floorGrid=this.add.graphics(),this.drawFloorGrid(),this.worldContainer.add(this.floorGrid),this.createCharacterAnimations(),this.characterContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.shieldAuraGraphics=this.add.graphics(),this.characterContainer.add(this.shieldAuraGraphics),this.character=this.add.sprite(this.characterX,this.characterY,"char_idle_1"),this.character.setScale(this.characterSize/this.character.height),this.character.setOrigin(.5,1),this.character.play("char_idle"),this.characterContainer.add(this.character),this.monsterManager=new St(this,this.worldContainer,this.gameBounds,this.mapWidth,this.mapHeight),this.gameAreaContainer.add([this.boundsBorder,this.worldContainer]);const s=this.make.graphics({x:0,y:0});s.fillStyle(16777215),s.fillRect(this.gameBounds.x,this.gameBounds.y,this.gameBounds.width,this.gameBounds.height);const a=s.createGeometryMask();this.worldContainer.setMask(a),this.uiContainer=this.add.container(0,0),this.uiContainer.setDepth(10),this.createSkillGrid(),this.characterContainer.setDepth(60),this.characterContainer.setMask(a),this.uiContainer.add(this.characterContainer),this.createSkillBar(),this.revealMask=this.make.graphics({x:0,y:0});const i=this.revealMask.createGeometryMask();this.gameAreaContainer.setMask(i),this.uiContainer.setMask(i),this.registry.events.on("reveal-update",this.updateRevealMask,this),this.registry.events.on("reveal-complete",this.onRevealComplete,this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.keyboard&&(this.cursors={W:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.D)},this.keyPlus=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.PLUS),this.keyMinus=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.MINUS),this.keyShift=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.SHIFT),this.keyCtrl=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.CTRL),this.keyZero=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.ZERO),this.keyBackspace=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.BACKSPACE),this.keyF5=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F5),this.keyF6=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F6),this.keyF7=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F7),this.keyF8=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F8),this.keyF9=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F9),this.keyF10=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F10),this.keyF11=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F11),this.keyF12=this.input.keyboard.addKey(F.Input.Keyboard.KeyCodes.F12)),this.updateCamera(!0),this.createHpBar(),this.createShieldBar(),this.createExpBar(),this.createSkillPanel(),this.createLowHpVignette()}update(t,e){if(this.updateHpBarFlow(e),this.updateShieldBarFlow(e),this.updateExpBarFlow(e),this.updateShieldAura(e),this.updateHpRegen(e),this.updateLowHpVignetteBreathing(e),this.updateSkillCooldownDisplay(),this.isPaused){this.handleSkillPanelInput();return}this.handleExpTestInput();const s=this.time.now;this.isHurt&&s>=this.hurtEndTime&&(this.isHurt=!1,this.setCharacterState("idle"),this.updateCharacterSprite()),this.isAttacking&&s>=this.attackEndTime&&(this.isAttacking=!1,this.character.clearTint(),this.isMoving||this.isKeyboardMoving?this.setCharacterState("run",!0):this.setCharacterState("idle",!0)),this.isHurt||(this.handleKeyboardInput(e),this.isMoving&&!this.isKeyboardMoving&&this.moveCharacter(e));const a=this.monsterManager.update(e,this.characterX,this.characterY,this.cameraOffsetX,this.cameraOffsetY);a.damage>0&&this.takeDamage(a.damage,a.hitMonsters),this.updateSkillRangePreview(s),this.tryActivateSkills(s)}updateSkillRangePreview(t){if(this.clearSkillGrid(),this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const l=this.skillManager.calculateFinalCooldown(i),o=this.skillCooldowns.get(a.id)||0;t-o>=l&&this.showSkillPreview(s)}}showSkillPreview(t){const e=t.definition,s=e.color,a=.2;switch(e.id){case"active_soul_render":{const i=this.monsterManager.getMonsters();if(i.length===0)return;let l=0,o=1/0;for(const r of i){const f=r.x-this.characterX,p=r.y-this.characterY,d=Math.sqrt(f*f+p*p);d<o&&(o=d,l=Math.atan2(p,f))}const n=this.gameBounds.height*.3,h=(60+t.level*10)/2*(Math.PI/180);this.showSkillRangeSector(this.characterX,this.characterY,n,l,h,s,a);break}case"active_coder":{const i=this.gameBounds.height*.1,l=2+t.level*.5,o=i*l;this.showSkillRangeCircle(this.characterX,this.characterY,o,s,a);break}case"active_vfx":{const i=this.monsterManager.getMonsters();if(i.length===0)return;const l=Math.min(t.level+1,i.length),o=this.gameBounds.height*1,n=this.gameBounds.height*.05,c=[...i].sort((h,r)=>{const f=Math.sqrt((h.x-this.characterX)**2+(h.y-this.characterY)**2),p=Math.sqrt((r.x-this.characterX)**2+(r.y-this.characterY)**2);return f-p});for(let h=0;h<l;h++){const r=c[h],f=r.x-this.characterX,p=r.y-this.characterY,d=Math.sqrt(f*f+p*p);if(d>0){const y=this.characterX+f/d*o,S=this.characterY+p/d*o;this.showSkillRangeLine(this.characterX,this.characterY,y,S,n,s,a)}}break}case"active_architect":{const i=this.gameBounds.height*.15;this.showSkillRangeCircle(this.characterX,this.characterY,i,s,a);break}}}tryActivateSkills(t){if(this.isHurt)return;const e=this.skillManager.getPlayerActiveSkills();for(const s of e){if(!s)continue;const a=s.definition;let i=a.cooldown||1e3;a.id==="active_architect"&&(i=i-s.level*500);const l=this.skillManager.calculateFinalCooldown(i),o=this.skillCooldowns.get(a.id)||0;t-o>=l&&(this.activateSkill(s,t),this.skillCooldowns.set(a.id,t))}}activateSkill(t,e){const s=t.definition;switch(this.isAttacking=!0,this.attackEndTime=e+G.ATTACK_DURATION,this.setCharacterState("attack",!0),s.flashColor&&this.character.setTint(s.flashColor),s.id){case"active_soul_render":this.activateSoulRender(t);break;case"active_coder":this.activateCoder(t);break;case"active_vfx":this.activateVfx(t);break;case"active_architect":this.activateArchitect(t);break;default:console.log(`Skill activated: ${s.name}`)}}activateSoulRender(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;let s=e[0],a=1/0;for(const p of e){const d=p.x-this.characterX,y=p.y-this.characterY,S=Math.sqrt(d*d+y*y);S<a&&(a=S,s=p)}const i=Math.atan2(s.y-this.characterY,s.x-this.characterX);this.facingRight=Math.cos(i)>=0,this.updateCharacterSprite();const l=this.gameBounds.height*.3,n=(60+t.level*10)/2*(Math.PI/180),c=2+t.level,h=G.DAMAGE_UNIT*c,r=this.skillManager.calculateFinalDamage(h),f=[];for(const p of e){const d=p.x-this.characterX,y=p.y-this.characterY;if(Math.sqrt(d*d+y*y)>l)continue;let x=Math.atan2(y,d)-i;for(;x>Math.PI;)x-=Math.PI*2;for(;x<-Math.PI;)x+=Math.PI*2;Math.abs(x)<=n&&f.push(p.id)}if(this.showLegacySkillEffects&&this.drawSectorEffect(i,l,n,t.definition.color),this.drawSectorEdge(i,l,n,t.definition.color),this.flashSkillAreaSector(this.characterX,this.characterY,l,i,n,t.definition.flashColor||t.definition.color),f.length>0){const p=e.filter(y=>f.includes(y.id)).map(y=>({x:y.x,y:y.y})),d=this.monsterManager.damageMonsters(f,r);d.totalExp>0&&this.addExp(d.totalExp),this.flashWhiteCrossAtPositions(p),this.showLegacySkillEffects&&this.drawCrossStarBurst(p,t.definition.flashColor||t.definition.color),this.shakeScreen(f.length),console.log(`Soul Render hit ${f.length} monsters for ${r} damage, killed ${d.killCount}, exp +${d.totalExp}`)}}drawSectorEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=t-s,o=t+s,n=this.characterX,c=this.characterY,h=15,r=1e3,f=this.time.now,p=()=>{const y=this.time.now-f,S=Math.min(y/r,1);i.clear();const k=.3,x=S<k?0:(S-k)/(1-k);for(let C=h;C>=1;C--){const M=e*C/h,b=.8*(1-(C-1)/h)*(1-x);b>.01&&(i.fillStyle(a,b),i.beginPath(),i.moveTo(n,c),i.arc(n,c,M,l,o,!1),i.closePath(),i.fillPath())}const g=8;for(let C=g;C>=1;C--){const M=e*.6*C/g,v=.95*(1-(C-1)/g)*(1-x);v>.01&&(i.fillStyle(16777215,v),i.beginPath(),i.moveTo(n,c),i.arc(n,c,M,l,o,!1),i.closePath(),i.fillPath())}const w=1*(1-x);w>.01&&(i.lineStyle(6,a,w),i.beginPath(),i.moveTo(n,c),i.arc(n,c,e,l,o,!1),i.closePath(),i.strokePath(),i.lineStyle(3,16777215,w*.8),i.beginPath(),i.moveTo(n,c),i.arc(n,c,e*.97,l,o,!1),i.closePath(),i.strokePath(),i.lineStyle(4,16777215,w*.9),i.beginPath(),i.moveTo(n,c),i.lineTo(n+Math.cos(t)*e,c+Math.sin(t)*e),i.strokePath()),S>=1&&i.destroy()},d=this.time.addEvent({delay:16,callback:p,callbackScope:this,repeat:Math.ceil(r/16)});this.time.delayedCall(r+50,()=>{i.active&&i.destroy(),d.remove()})}drawSectorEdge(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=t-s,o=t+s,n=this.characterX,c=this.characterY,h=500,r=300,f=this.time.now,p=15,d=(k,x,g,w,C=1)=>{for(let M=0;M<p;M++){const v=M/p,b=(M+1)/p,P=(v+b)/2,B=Math.min(1,P/.15),T=Math.min(1,(1-P)/.15),E=Math.min(B,T),A=w*E*E;if(A>.01){const R=e*v*C,L=e*b*C,H=n+Math.cos(k)*R,D=c+Math.sin(k)*R,X=n+Math.cos(k)*L,Y=c+Math.sin(k)*L;i.lineStyle(g,x,A),i.beginPath(),i.moveTo(H,D),i.lineTo(X,Y),i.strokePath()}}},y=()=>{const k=this.time.now-f,x=Math.min(k/h,1);i.clear();let g=0;k>r&&(g=(k-r)/(h-r));const w=.6*(1-g);w>.01&&(d(l,a,3,w),d(o,a,3,w),d(l,16777215,1.5,w*.5,.98),d(o,16777215,1.5,w*.5,.98)),x>=1&&i.destroy()};y();const S=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{i.active&&i.destroy(),S.remove()})}drawCircleEdge(t,e){const s=this.add.graphics();this.worldContainer.add(s);const a=this.characterX,i=this.characterY,l=500,o=300,n=this.time.now,c=()=>{const r=this.time.now-n,f=Math.min(r/l,1);s.clear();let p=0;r>o&&(p=(r-o)/(l-o));const d=.6*(1-p);d>.01&&(s.lineStyle(3,e,d),s.strokeCircle(a,i,t),s.lineStyle(1.5,16777215,d*.5),s.strokeCircle(a,i,t*.98)),f>=1&&s.destroy()};c();const h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{s.active&&s.destroy(),h.remove()})}drawBeamEdge(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=this.characterX,o=this.characterY,n=Math.cos(t),c=Math.sin(t),h=800,r=380,f=this.time.now,p=20,d=()=>{const S=this.time.now-f,k=Math.min(S/h,1);i.clear();let x=0;S>r&&(x=(S-r)/(h-r));const g=.6*(1-x*.5);if(g>.01)for(let w=0;w<p;w++){const C=w/p,M=(w+1)/p,v=(C+M)/2,b=Math.min(1,v/.15),P=Math.min(1,(1-v)/.15),B=Math.min(b,P),T=g*B*B;if(T>.01){const E=l+n*e*C,A=o+c*e*C,R=l+n*e*M,L=o+c*e*M;i.lineStyle(2,16777215,T),i.beginPath(),i.moveTo(E,A),i.lineTo(R,L),i.strokePath()}}k>=1&&i.destroy()};d();const y=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{i.active&&i.destroy(),y.remove()})}activateCoder(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=this.gameBounds.height*.1,a=2+t.level*.5,i=s*a,l=1+t.level,o=G.DAMAGE_UNIT*l,n=this.skillManager.calculateFinalDamage(o),c=[];for(const h of e){const r=h.x-this.characterX,f=h.y-this.characterY;Math.sqrt(r*r+f*f)<=i&&c.push(h.id)}if(this.showLegacySkillEffects&&this.drawCircleEffect(i,t.definition.color),this.drawCircleEdge(i,t.definition.color),this.flashSkillAreaCircle(this.characterX,this.characterY,i,t.definition.flashColor||t.definition.color),c.length>0){const h=e.filter(f=>c.includes(f.id)).map(f=>({x:f.x,y:f.y})),r=this.monsterManager.damageMonsters(c,n);r.totalExp>0&&this.addExp(r.totalExp),this.flashWhiteCrossAtPositions(h),this.showLegacySkillEffects&&this.drawCrossStarBurst(h,t.definition.flashColor||t.definition.color),this.shakeScreen(c.length),console.log(`Coder hit ${c.length} monsters for ${n} damage, killed ${r.killCount}, exp +${r.totalExp}`)}}drawCircleEffect(t,e){const s=this.add.graphics();this.worldContainer.add(s);const a=this.characterX,i=this.characterY,l=15,o=1e3,n=this.time.now,c=()=>{const r=this.time.now-n,f=Math.min(r/o,1);s.clear();const p=.3,d=f<p?0:(f-p)/(1-p);for(let k=l;k>=1;k--){const x=t*k/l,g=t*(k-1)/l,C=.7*(1-(k-1)/l)*(1-d);C>.01&&(s.fillStyle(e,C),s.beginPath(),s.arc(a,i,x,0,Math.PI*2,!1),g>0&&s.arc(a,i,g,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const y=8;for(let k=y;k>=1;k--){const x=t*.5*k/y,g=t*.5*(k-1)/y,w=.95*(1-(k-1)/y)*(1-d);w>.01&&(s.fillStyle(16777215,w),s.beginPath(),s.arc(a,i,x,0,Math.PI*2,!1),g>0&&s.arc(a,i,g,0,Math.PI*2,!0),s.closePath(),s.fillPath())}const S=1*(1-d);S>.01&&(s.lineStyle(6,e,S),s.strokeCircle(a,i,t),s.lineStyle(3,16777215,S*.8),s.strokeCircle(a,i,t*.96),s.lineStyle(2,16777215,S*.5),s.strokeCircle(a,i,t*.7),s.strokeCircle(a,i,t*.4)),f>=1&&s.destroy()},h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(o/16)});this.time.delayedCall(o+50,()=>{s.active&&s.destroy(),h.remove()})}activateVfx(t){const e=this.monsterManager.getMonsters();if(e.length===0)return;const s=t.level+1,a=this.gameBounds.height*1,i=this.gameBounds.height*.05,l=1+t.level,o=G.DAMAGE_UNIT*l,n=this.skillManager.calculateFinalDamage(o),c=new Set,h=e.map((p,d)=>d),r=[];for(let p=0;p<s;p++){let d;if(h.length>0){const k=Math.floor(Math.random()*h.length),x=h[k];h.splice(k,1);const g=e[x];d=Math.atan2(g.y-this.characterY,g.x-this.characterX)}else d=Math.random()*Math.PI*2;r.push(d);for(const k of e){const x=k.x-this.characterX,g=k.y-this.characterY;if(Math.sqrt(x*x+g*g)>a)continue;const C=Math.cos(d),M=Math.sin(d);if(x*C+g*M<0)continue;Math.abs(x*M-g*C)<=i/2&&c.add(k.id)}this.showLegacySkillEffects&&this.drawBeamEffect(d,a,i,t.definition.color),this.drawBeamEdge(d,a,i,t.definition.color);const y=this.characterX+Math.cos(d)*a,S=this.characterY+Math.sin(d)*a;this.flashSkillAreaLine(this.characterX,this.characterY,y,S,i,t.definition.flashColor||t.definition.color)}r.length>0&&(this.facingRight=Math.cos(r[0])>=0,this.updateCharacterSprite());const f=Array.from(c);if(f.length>0){const p=e.filter(y=>f.includes(y.id)).map(y=>({x:y.x,y:y.y})),d=this.monsterManager.damageMonsters(f,n);d.totalExp>0&&this.addExp(d.totalExp),this.flashWhiteCrossAtPositions(p),this.showLegacySkillEffects&&this.drawCrossStarBurst(p,t.definition.flashColor||t.definition.color),this.shakeScreen(f.length),console.log(`VFX (${s} beams) hit ${f.length} monsters for ${n} damage, killed ${d.killCount}, exp +${d.totalExp}`)}}drawBeamEffect(t,e,s,a){const i=this.add.graphics();this.worldContainer.add(i);const l=this.characterX,o=this.characterY,n=l+Math.cos(t)*e,c=o+Math.sin(t)*e,h=s*1.5,r=Math.sin(t)*h/2,f=-Math.cos(t)*h/2,p=Math.sin(t)*h*.4/2,d=-Math.cos(t)*h*.4/2,y=15,S=1e3,k=this.time.now,x=()=>{const w=this.time.now-k,C=Math.min(w/S,1);i.clear();const M=.3,v=C<M?0:(C-M)/(1-M);for(let B=0;B<y;B++){const T=B/y,E=(B+1)/y,A=l+(n-l)*T,R=o+(c-o)*T,L=l+(n-l)*E,H=o+(c-o)*E,X=.85*(1-T*.6)*(1-v);X>.01&&(i.fillStyle(a,X),i.beginPath(),i.moveTo(A-r,R-f),i.lineTo(L-r,H-f),i.lineTo(L+r,H+f),i.lineTo(A+r,R+f),i.closePath(),i.fillPath())}for(let B=0;B<y;B++){const T=B/y,E=(B+1)/y,A=l+(n-l)*T,R=o+(c-o)*T,L=l+(n-l)*E,H=o+(c-o)*E,D=.98*(1-T*.5)*(1-v);D>.01&&(i.fillStyle(16777215,D),i.beginPath(),i.moveTo(A-p,R-d),i.lineTo(L-p,H-d),i.lineTo(L+p,H+d),i.lineTo(A+p,R+d),i.closePath(),i.fillPath())}const b=1*(1-v);b>.01&&(i.lineStyle(6,16777215,b),i.beginPath(),i.moveTo(l,o),i.lineTo(n,c),i.strokePath());const P=1*(1-v);P>.01&&(i.lineStyle(4,a,P),i.beginPath(),i.moveTo(l-r,o-f),i.lineTo(n-r,c-f),i.lineTo(n+r,c+f),i.lineTo(l+r,o+f),i.closePath(),i.strokePath(),i.lineStyle(2,16777215,P*.6),i.beginPath(),i.moveTo(l-r*1.1,o-f*1.1),i.lineTo(n-r*1.1,c-f*1.1),i.lineTo(n+r*1.1,c+f*1.1),i.lineTo(l+r*1.1,o+f*1.1),i.closePath(),i.strokePath()),C>=1&&i.destroy()},g=this.time.addEvent({delay:16,callback:x,callbackScope:this,repeat:Math.ceil(S/16)});this.time.delayedCall(S+50,()=>{i.active&&i.destroy(),g.remove()})}drawCrossStarBurst(t,e){const a=this.gameBounds.height*.1*1,i=600;for(const l of t){const o=this.add.graphics();this.worldContainer.add(o);const n=this.time.now,c=()=>{const r=this.time.now-n,f=Math.min(r/i,1);o.clear();const p=f<.2?f/.2:1,d=f<.4?0:(f-.4)/.6,y=a*p,S=1-d;if(S>.01&&y>0){const k=y*.2,x=y,g=y*.4;o.fillStyle(16777215,S),o.fillCircle(l.x,l.y,g);for(let M=0;M<4;M++){const v=M*Math.PI/2,b=Math.cos(v),P=Math.sin(v),B=-P,T=b,E=6;for(let A=0;A<E;A++){const R=A/E,L=(A+1)/E,H=k*(1-R*.8),D=k*(1-L*.8),X=l.x+b*x*R,Y=l.y+P*x*R,K=l.x+b*x*L,I=l.y+P*x*L,_=S*(1-R*.7);o.fillStyle(e,_*.8),o.beginPath(),o.moveTo(X+B*H,Y+T*H),o.lineTo(K+B*D,I+T*D),o.lineTo(K-B*D,I-T*D),o.lineTo(X-B*H,Y-T*H),o.closePath(),o.fillPath();const z=H*.5,$=D*.5;o.fillStyle(16777215,_*.9),o.beginPath(),o.moveTo(X+B*z,Y+T*z),o.lineTo(K+B*$,I+T*$),o.lineTo(K-B*$,I-T*$),o.lineTo(X-B*z,Y-T*z),o.closePath(),o.fillPath()}}const w=x*.5,C=k*.6;for(let M=0;M<4;M++){const v=M*Math.PI/2+Math.PI/4,b=Math.cos(v),P=Math.sin(v),B=-P,T=b,E=4;for(let A=0;A<E;A++){const R=A/E,L=(A+1)/E,H=C*(1-R*.9),D=C*(1-L*.9),X=l.x+b*w*R,Y=l.y+P*w*R,K=l.x+b*w*L,I=l.y+P*w*L,_=S*(1-R*.8)*.7;o.fillStyle(e,_),o.beginPath(),o.moveTo(X+B*H,Y+T*H),o.lineTo(K+B*D,I+T*D),o.lineTo(K-B*D,I-T*D),o.lineTo(X-B*H,Y-T*H),o.closePath(),o.fillPath()}}}f>=1&&o.destroy()};c();const h=this.time.addEvent({delay:16,callback:c,callbackScope:this,repeat:Math.ceil(i/16)});this.time.delayedCall(i+50,()=>{o.active&&o.destroy(),h.remove()})}}activateArchitect(t){const e=Math.floor(this.maxHp*.3);this.currentShield=e,this.maxShield=e;const s=1+t.level*1.5;this.shieldReflectDamage=G.DAMAGE_UNIT*s,this.drawShieldBarFill(),this.showLegacySkillEffects&&this.drawShieldActivateEffect();const a=this.gameBounds.height*.15;this.flashSkillAreaCircle(this.characterX,this.characterY,a,t.definition.flashColor||t.definition.color),console.log(`Architect activated: Shield ${e}, Reflect damage ${this.shieldReflectDamage} (${s} units)`)}drawShieldActivateEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1.2,i=16763904,l=800,o=this.time.now,n=()=>{const h=this.time.now-o,r=Math.min(h/l,1);t.clear();const f=r<.2?r/.2:1,p=r<.2?0:(r-.2)/.8,d=a*(.3+.7*f),y=1-p;if(y>.01){for(let g=8;g>=1;g--){const w=d*g/8,C=y*(1-(g-1)/8)*.6;C>.01&&(t.fillStyle(i,C),t.fillCircle(e,s,w))}const k=4;for(let g=k;g>=1;g--){const w=d*.4*g/k,C=y*(1-(g-1)/k)*.9;C>.01&&(t.fillStyle(16777215,C),t.fillCircle(e,s,w))}t.lineStyle(5,i,y*.9),t.strokeCircle(e,s,d),t.lineStyle(2,16777215,y*.7),t.strokeCircle(e,s,d*.95);const x=d*.7;t.lineStyle(3,16777215,y*.5),t.beginPath();for(let g=0;g<6;g++){const w=g*Math.PI/3,C=e+Math.cos(w)*x,M=s+Math.sin(w)*x;g===0?t.moveTo(C,M):t.lineTo(C,M)}t.closePath(),t.strokePath()}r>=1&&t.destroy()};n();const c=this.time.addEvent({delay:16,callback:n,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),c.remove()})}handleExpTestInput(){if(!(!this.keyPlus||!this.keyMinus||!this.keyShift)){if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyBackspace)){this.showLegacySkillEffects=!this.showLegacySkillEffects,console.log(`Legacy skill effects: ${this.showLegacySkillEffects?"ON":"OFF"}`);return}if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyZero)){this.maxOutAllSkills();return}if(this.keyCtrl.isDown&&this.keyShift.isDown){const t=[{key:this.keyF5,skillId:"active_soul_render"},{key:this.keyF6,skillId:"active_coder"},{key:this.keyF7,skillId:"active_vfx"},{key:this.keyF8,skillId:"active_architect"},{key:this.keyF9,skillId:"passive_titanium_liver"},{key:this.keyF10,skillId:"passive_sync_rate"},{key:this.keyF11,skillId:"passive_retina_module"},{key:this.keyF12,skillId:"passive_ai_enhancement"}];for(const{key:e,skillId:s}of t)if(e&&F.Input.Keyboard.JustDown(e)){this.maxOutSingleSkill(s);return}}if(this.keyShift.isDown&&F.Input.Keyboard.JustDown(this.keyPlus)){this.levelUp();return}this.keyPlus.isDown&&!this.keyShift.isDown&&this.addExp(10),this.keyMinus.isDown&&this.addExp(-10)}}maxOutSingleSkill(t){const e=ht.find(o=>o.id===t);if(!e)return;const s=this.skillManager.getSkillLevel(t),a=e.type==="passive";if(s>=e.maxLevel){console.log(`Test: ${e.name} is already MAX`);return}if(a&&s<0&&this.skillManager.isPassiveSlotsFull()){console.log(`Test: Passive slots full, cannot add ${e.name}`);return}const i=s<0?-1:s,l=e.maxLevel-i;this.currentLevel+=l,this.monsterManager.setPlayerLevel(this.currentLevel);for(let o=0;o<l;o++)this.skillManager.learnOrUpgradeSkill(t);this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log(`Test: ${e.name} maxed! Player level: ${this.currentLevel}`)}maxOutAllSkills(){this.currentLevel=24;const e=this.skillManager.getActiveSkillDefinitions();for(const s of e)for(let a=0;a<=s.maxLevel;a++)this.skillManager.learnOrUpgradeSkill(s.id);this.monsterManager.setPlayerLevel(this.currentLevel),this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.currentHp=this.maxHp,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.drawHpBarFill(),this.updateHpText(),this.drawExpBarFill(),this.levelText.setText(`Lv.${this.currentLevel}`),this.updateSkillBarDisplay(),console.log("Test: Jumped to level 24 with all active skills maxed!")}addExp(t){t>0&&(t=this.skillManager.calculateFinalExp(t)),this.currentExp+=t,this.currentExp<0&&(this.currentExp=0),this.currentExp>=this.maxExp&&this.levelUp(),this.drawExpBarFill()}levelUp(){this.currentLevel++,this.currentExp=0,this.maxExp=Math.floor(G.BASE_EXP*Math.pow(G.EXP_GROWTH_RATE,this.currentLevel)),this.recalculateMaxHp(),this.currentHp=this.maxHp,this.monsterManager.setPlayerLevel(this.currentLevel),this.levelText.setText(`Lv.${this.currentLevel}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showSkillPanel(),this.drawExpBarFill(),console.log(`Level up! Lv.${this.currentLevel}, MaxHP: ${this.maxHp}, NextExp: ${this.maxExp}`)}recalculateMaxHp(){const t=G.BASE_HP+G.HP_PER_LEVEL*this.currentLevel,e=this.maxHp;if(this.maxHp=this.skillManager.calculateFinalMaxHp(t),this.maxHp>e&&e>0){const s=this.currentHp/e;this.currentHp=Math.floor(this.maxHp*s)}this.currentHp=Math.min(this.currentHp,this.maxHp)}recalculateMoveSpeed(){this.moveSpeed=this.skillManager.calculateFinalMoveSpeed(this.baseMoveSpeed)}handleSkillPanelInput(){this.cursors&&(F.Input.Keyboard.JustDown(this.cursors.A)&&this.setSelectedSkill(0),F.Input.Keyboard.JustDown(this.cursors.S)&&this.setSelectedSkill(1),F.Input.Keyboard.JustDown(this.cursors.D)&&this.setSelectedSkill(2),F.Input.Keyboard.JustDown(this.cursors.W)&&this.confirmSkillSelection())}setSelectedSkill(t){this.updateSkillCardStyle(this.selectedSkillIndex,!1),this.selectedSkillIndex=t,this.updateSkillCardStyle(this.selectedSkillIndex,!0)}updateSkillCardStyle(t,e){const s=this.skillCardBgs[t],a=this.skillOptions[t];!s||!a||(e?(s.setFillStyle(3355443),s.setStrokeStyle(3,16777215),this.tweens.add({targets:a,scaleX:1.05,scaleY:1.05,duration:100})):(s.setFillStyle(2236962),s.setStrokeStyle(2,6710886),this.tweens.add({targets:a,scaleX:1,scaleY:1,duration:100})))}confirmSkillSelection(){if(this.currentSkillChoices.length===0||this.selectedSkillIndex>=this.currentSkillChoices.length)return;const t=this.currentSkillChoices[this.selectedSkillIndex];this.selectSkill(this.selectedSkillIndex,t.id)}handleKeyboardInput(t){if(!this.cursors)return;let e=0,s=0;if(this.cursors.W.isDown&&(s=-1),this.cursors.S.isDown&&(s=1),this.cursors.A.isDown&&(e=-1),this.cursors.D.isDown&&(e=1),e!==0||s!==0){if(this.isKeyboardMoving=!0,this.isMoving=!1,e!==0&&(this.facingRight=e>0),e!==0&&s!==0){const i=1/Math.sqrt(2);e*=i,s*=i}const a=this.moveSpeed*t/1e3;this.characterX+=e*a,this.characterY+=s*a,this.characterX=F.Math.Clamp(this.characterX,this.characterSize,this.mapWidth-this.characterSize),this.characterY=F.Math.Clamp(this.characterY,this.characterSize,this.mapHeight-this.characterSize),this.setCharacterState("run"),this.updateCharacterSprite(),this.updateCamera()}else this.isKeyboardMoving=!1,this.isMoving||(this.setCharacterState("idle"),this.updateCharacterSprite())}onPointerDown(t){this.isPaused||this.isPointerInGameArea(t)&&(this.isPointerDown=!0,this.updateTargetFromPointer(t),this.isMoving=!0)}onPointerMove(t){!this.isPointerDown||this.isPaused||this.isPointerInGameArea(t)&&this.updateTargetFromPointer(t)}onPointerUp(){this.isPointerDown=!1}isPointerInGameArea(t){return t.x>=this.gameBounds.x&&t.x<=this.gameBounds.x+this.gameBounds.width&&t.y>=this.gameBounds.y&&t.y<=this.gameBounds.y+this.gameBounds.height}updateTargetFromPointer(t){const e=t.x-this.gameBounds.x,s=t.y-this.gameBounds.y,a=e+this.cameraOffsetX,i=s+this.cameraOffsetY;this.targetX=F.Math.Clamp(a,this.characterSize,this.mapWidth-this.characterSize),this.targetY=F.Math.Clamp(i,this.characterSize,this.mapHeight-this.characterSize)}moveCharacter(t){const e=this.targetX-this.characterX,s=this.targetY-this.characterY,a=Math.sqrt(e*e+s*s);if(this.updateCharacterFacing(this.targetX),a<5)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const i=this.moveSpeed*t/1e3;if(i>=a)this.characterX=this.targetX,this.characterY=this.targetY,this.isMoving=!1,this.setCharacterState("idle");else{const l=i/a;this.characterX+=e*l,this.characterY+=s*l,this.setCharacterState("run")}}this.updateCharacterSprite(),this.updateCamera()}updateCamera(t=!1){const e=this.cameraOffsetX+this.gameBounds.width/2,s=this.cameraOffsetY+this.gameBounds.height/2,a=this.characterX-e,i=this.characterY-s,l=this.gameBounds.width*G.CAMERA_DEAD_ZONE,o=this.gameBounds.height*G.CAMERA_DEAD_ZONE;t?(this.cameraOffsetX=this.characterX-this.gameBounds.width/2,this.cameraOffsetY=this.characterY-this.gameBounds.height/2):(Math.abs(a)>l/2&&(a>0?this.cameraOffsetX+=a-l/2:this.cameraOffsetX+=a+l/2),Math.abs(i)>o/2&&(i>0?this.cameraOffsetY+=i-o/2:this.cameraOffsetY+=i+o/2)),this.cameraOffsetX=F.Math.Clamp(this.cameraOffsetX,0,this.mapWidth-this.gameBounds.width),this.cameraOffsetY=F.Math.Clamp(this.cameraOffsetY,0,this.mapHeight-this.gameBounds.height),this.worldContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY),this.characterContainer.setPosition(this.gameBounds.x-this.cameraOffsetX,this.gameBounds.y-this.cameraOffsetY)}updateRevealMask(t){this.revealMask&&(this.revealMask.clear(),this.revealMask.fillStyle(16777215),this.revealMask.fillCircle(t.x,t.y,t.radius))}onRevealComplete(){this.gameAreaContainer.clearMask(!0),this.uiContainer.clearMask(!0),this.revealMask.destroy(),this.registry.events.off("reveal-update",this.updateRevealMask,this),this.registry.events.off("reveal-complete",this.onRevealComplete,this);const t=document.getElementById("controls");t&&t.classList.add("visible"),this.showSkillPanel(),this.monsterManager.startSpawning(),this.playRandomGameBgm()}playRandomGameBgm(){const t=["bgm_game_01","bgm_game_02"];let e;if(this.currentBgmKey&&t.length>1){const s=t.filter(a=>a!==this.currentBgmKey);e=s[Math.floor(Math.random()*s.length)]}else e=t[Math.floor(Math.random()*t.length)];this.currentBgmKey=e,this.gameBgm&&(this.gameBgm.stop(),this.gameBgm.destroy()),this.cache.audio.exists(e)&&(this.gameBgm=this.sound.add(e,{volume:.5,loop:!1}),this.gameBgm.on("complete",()=>{this.playRandomGameBgm()}),this.gameBgm.play())}createFullscreenBackground(t,e){this.background=this.add.image(t/2,e/2,"background");const s=t/this.background.width,a=e/this.background.height,i=Math.max(s,a);this.background.setScale(i)}drawGameBorder(){this.boundsBorder=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0),this.boundsBorder.setStrokeStyle(2,4473924)}createHpBar(){this.hpBarContainer=this.add.container(0,0),this.hpBarContainer.setDepth(1001);const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.floor(this.gameBounds.height*.03);this.hpText=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e+t/2,`${this.currentHp} / ${this.maxHp}`,{fontFamily:"monospace",fontSize:`${s}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:4}),this.hpText.setOrigin(.5,.5),this.hpText.setDepth(1002),this.hpBarContainer.add(this.hpText),this.drawHpBarFill(),this.uiContainer.add(this.hpBarContainer)}drawHpBarFill(){const t=[0,1];for(const i of t)for(let l=0;l<this.skillGridCols;l++){const o=i*this.skillGridCols+l,n=this.skillGridCells[o];n&&(n.setFillStyle(0,.9),n.setVisible(!0),n.setDepth(1e3))}const e=this.currentHp/this.maxHp,s=this.skillGridCols,a=Math.floor(s*e);if(!(a<=0)){for(const i of t)for(let l=0;l<a;l++){const o=i*this.skillGridCols+l,n=this.skillGridCells[o];if(!n)continue;const c=l/s,h=this.hpBarFlowOffset,r=(c+h)%1,f=(Math.sin(r*Math.PI*2-Math.PI/2)+1)/2,p=Math.floor(136-34*f),d=0,y=Math.floor(34+102*f),S=p<<16|d<<8|y,k=i===0?.95:.8;n.setFillStyle(S,k)}if(this.currentShield>0&&this.maxShield>0){const i=this.currentShield/this.maxShield,l=Math.floor(s*i);for(let o=0;o<l;o++){const n=0*this.skillGridCols+o,c=this.skillGridCells[n];if(!c)continue;const h=o/s,r=this.shieldBarFlowOffset,f=(h+r)%1,p=(Math.sin(f*Math.PI*2-Math.PI/2)+1)/2,d=255,y=Math.floor(204+51*p),S=Math.floor(0+204*p),k=d<<16|y<<8|S;c.setFillStyle(k,.95)}}}}updateHpBarFlow(t){this.hpBarFlowOffset+=.2*t/1e3,this.hpBarFlowOffset>=1&&(this.hpBarFlowOffset-=1),this.drawHpBarFill()}updateHpText(){this.hpText&&(this.currentShield>0?this.hpText.setText(`${this.currentHp}(+${this.currentShield}) / ${this.maxHp}`):this.hpText.setText(`${this.currentHp} / ${this.maxHp}`))}createShieldBar(){const t=this.skillGridCellSize,e=this.gameBounds.y+t*2,s=Math.floor(this.gameBounds.height*.025);this.shieldText=this.add.text(this.gameBounds.x+this.gameBounds.width-10,e+t/2,"",{fontFamily:"monospace",fontSize:`${s}px`,color:"#ffdd44",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.shieldText.setOrigin(1,.5),this.shieldText.setDepth(1002),this.shieldText.setVisible(!1),this.uiContainer.add(this.shieldText)}drawShieldBarFill(){this.shieldText.setVisible(!1),this.updateHpText()}updateShieldBarFlow(t){if(this.currentShield<=0)return;const e=.6;this.shieldBarFlowOffset+=e*t/1e3,this.shieldBarFlowOffset>=1&&(this.shieldBarFlowOffset-=1),this.drawShieldBarFill()}updateShieldAura(t){if(this.shieldAuraGraphics.clear(),this.currentShield<=0)return;const e=this.characterX,s=this.characterY,a=this.characterSize*.8,i=this.characterSize*.35,l=s-this.characterSize*.15;for(let n=5;n>=0;n--){const c=1+n*.08,h=.12-n*.018,r=3+n*2;this.shieldAuraGraphics.lineStyle(r,16777215,h),this.shieldAuraGraphics.strokeEllipse(e,l,a*c,i*c)}this.shieldSparkleTimer+=t;const o=80;this.shieldSparkleTimer>=o&&(this.shieldSparkleTimer-=o,this.createShieldSparkle(e,l,a,i))}createShieldSparkle(t,e,s,a){const i=Math.random()*Math.PI*2,l=t+Math.cos(i)*(s/2),o=e+Math.sin(i)*(a/2),n=this.add.graphics();this.characterContainer.add(n);const c=this.gameBounds.height/10,h=c*.08,r=c*.2,f=c*.5,p=600+Math.random()*200,d=this.time.now,y=()=>{const k=this.time.now-d,x=Math.min(k/p,1);n.clear();const g=o-f*x,w=Math.pow(x,.5),C=h+(r-h)*w,M=1-x;M>.01&&(n.fillStyle(16768324,M*.9),n.fillRect(l-C/2,g-C/2,C,C),n.lineStyle(1,16777215,M*.6),n.strokeRect(l-C/2,g-C/2,C,C)),x>=1&&n.destroy()};y();const S=this.time.addEvent({delay:16,callback:y,callbackScope:this,repeat:Math.ceil(p/16)});this.time.delayedCall(p+50,()=>{n.active&&n.destroy(),S.remove()})}updateHpRegen(t){const e=this.skillManager.getTitaniumLiverRegenInterval();if(!(e<=0)){if(this.currentHp>=this.maxHp){this.hpRegenTimer=0;return}if(this.hpRegenTimer+=t,this.hpRegenTimer>=e){this.hpRegenTimer-=e;const s=Math.max(1,Math.floor(this.maxHp*.01));this.currentHp=Math.min(this.currentHp+s,this.maxHp),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(s),console.log(`HP Regen: +${s} HP (${this.currentHp}/${this.maxHp})`)}}}showHpHealEffect(t){const e=this.characterX,s=this.characterY-this.characterSize*.3,a=Math.min(8,Math.max(3,Math.floor(t/10)+3));for(let i=0;i<a;i++)this.time.delayedCall(i*40,()=>{this.createHpHealParticle(e,s)})}createHpHealParticle(t,e){const s=Math.random()*Math.PI*2,a=this.characterSize*.4,i=this.characterSize*.25,l=t+Math.cos(s)*a*(.3+Math.random()*.7),o=e+Math.sin(s)*i*(.3+Math.random()*.7),n=this.add.graphics();this.characterContainer.add(n);const c=this.gameBounds.height/10,h=c*(.1+Math.random()*.08),r=c*(.5+Math.random()*.3),f=700+Math.random()*300,p=this.time.now,d=[6702335,8939263,7820782,10057727],y=d[Math.floor(Math.random()*d.length)],S=()=>{const x=this.time.now-p,g=Math.min(x/f,1);n.clear();const w=o-r*g;let C,M;if(g<.2?(C=.6+g*2,M=1-g*5):(C=1-(g-.2)/.8,M=0),C>.01){const v=y>>16&255,b=y>>8&255,P=y&255,B=Math.round(v+(255-v)*M),T=Math.round(b+(255-b)*M),E=Math.round(P+(255-P)*M),A=B<<16|T<<8|E;n.fillStyle(A,C*.9),n.fillRect(l-h/2,w-h/2,h,h),n.lineStyle(1,16777215,C*.7),n.strokeRect(l-h/2,w-h/2,h,h)}g>=1&&n.destroy()};S();const k=this.time.addEvent({delay:16,callback:S,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{n.active&&n.destroy(),k.remove()})}takeDamage(t,e=[]){let a=this.skillManager.calculateFinalDamageTaken(t),i=0;if(this.currentShield>0){const l=this.currentShield>0;if(this.currentShield>=a?(i=a,this.currentShield-=a,a=0):(i=this.currentShield,a-=this.currentShield,this.currentShield=0),l&&this.currentShield===0&&this.maxShield>0){const o=this.maxShield;this.currentHp=Math.min(this.currentHp+o,this.maxHp),console.log(`Shield broken! Healed ${o} HP, current HP: ${this.currentHp}/${this.maxHp}`),this.drawHpBarFill(),this.updateHpText(),this.updateLowHpVignette(),this.showHpHealEffect(o)}if(this.drawShieldBarFill(),i>0&&(this.showLegacySkillEffects&&this.flashShieldEffect(),this.flashShieldHitEffect()),this.shieldReflectDamage>0&&e.length>0){const o=e.map(c=>c.id),n=this.monsterManager.damageMonsters(o,this.shieldReflectDamage);n.totalExp>0&&this.addExp(n.totalExp),console.log(`Shield reflected ${this.shieldReflectDamage} damage to ${e.length} monsters, killed ${n.killCount}`)}}a>0?(this.currentHp-=a,this.currentHp<0&&(this.currentHp=0),this.drawHpBarFill(),this.updateHpText(),this.isHurt=!0,this.hurtEndTime=this.time.now+G.HURT_DURATION,this.isMoving=!1,this.isKeyboardMoving=!1,this.setCharacterState("hurt"),this.updateCharacterSprite(),this.flashCharacter(),this.updateLowHpVignette(),console.log(`Player took ${a} damage (${i} absorbed by shield), HP: ${this.currentHp}/${this.maxHp}`)):console.log(`Shield absorbed all ${i} damage, Shield: ${this.currentShield}`),this.currentHp<=0&&console.log("Player died!")}flashShieldEffect(){const t=this.add.graphics();this.worldContainer.add(t);const e=this.characterX,s=this.characterY-this.characterSize/2,a=this.characterSize*1,i=16768324,l=600;let o=this.time.now;const n=()=>{const h=this.time.now-o,r=Math.min(h/l,1);t.clear();const f=.3,d=1-(r<f?0:(r-f)/(1-f));if(d>.01){for(let k=6;k>=1;k--){const x=a*k/6,g=d*(1-(k-1)/6)*.5;g>.01&&(t.fillStyle(i,g),t.fillCircle(e,s,x))}const S=a*.4;t.fillStyle(16777215,d*.8),t.fillCircle(e,s,S),t.lineStyle(5,i,d*.9),t.strokeCircle(e,s,a),t.lineStyle(2,16777215,d*.7),t.strokeCircle(e,s,a*.95)}r>=1&&t.destroy()},c=this.time.addEvent({delay:16,callback:n,callbackScope:this,repeat:Math.ceil(l/16)});this.time.delayedCall(l+50,()=>{t.active&&t.destroy(),c.remove()})}flashShieldHitEffect(){const t=this.worldToScreen(this.characterX,this.characterY),e=t.x,s=t.y,a=G.SKILL_GRID_GAP,i=this.skillGridCellSize+a,l=16763904,o=this.gameBounds.height*.2,n=400,c=200,h=this.time.now,r=[],f=Math.max(0,Math.floor((e-o)/i)),p=Math.min(this.skillGridCols-1,Math.ceil((e+o)/i)),d=Math.max(0,Math.floor((s-o)/i)),y=Math.min(this.skillGridRows-1,Math.ceil((s+o)/i));for(let g=d;g<=y;g++)for(let w=f;w<=p;w++){const C=w*i+this.skillGridCellSize/2,M=g*i+this.skillGridCellSize/2,v=C-e,b=M-s,P=Math.sqrt(v*v+b*b);P<=o&&r.push({col:w,row:g,dist:P})}if(r.length===0)return;const S=[];for(const{col:g,row:w}of r){const C=g*i+this.skillGridCellSize/2,M=w*i+this.skillGridCellSize/2,v=this.add.rectangle(C,M,this.skillGridCellSize,this.skillGridCellSize,l,0);v.setVisible(!1),this.skillGridContainer.add(v),S.push(v)}const k=()=>{const g=this.time.now-h,w=Math.min(g/n,1),C=Math.min(g/c,1),M=o*C,v=o*.3,b=Math.max(0,M-v);let P=0;g>c&&(P=(g-c)/(n-c));let B=0;for(const{dist:T}of r){const E=S[B++];if(E)if(T>=b&&T<=M){const A=(b+M)/2,R=Math.abs(T-A),L=v/2,H=R/L,X=.9*(1-H*.5)*(1-P);if(X>.01){if(g<c&&H<.3){const Y=l>>16&255,K=l>>8&255,I=l&255,_=Math.min(255,Y+Math.floor((255-Y)*.5)),z=Math.min(255,K+Math.floor((255-K)*.5)),$=Math.min(255,I+Math.floor((255-I)*.5)),V=_<<16|z<<8|$;E.setFillStyle(V,X)}else E.setFillStyle(l,X);E.setVisible(!0)}else E.setVisible(!1)}else E.setVisible(!1)}if(w>=1)for(const T of S)T.destroy()};k();const x=this.time.addEvent({delay:16,callback:k,callbackScope:this,repeat:Math.ceil(n/16)});this.time.delayedCall(n+50,()=>{x.remove();for(const g of S)g.active&&g.destroy()})}flashCharacter(){this.character.setTint(16764108),this.time.delayedCall(50,()=>{this.character.setTint(16737894)}),this.time.delayedCall(100,()=>{this.character.clearTint()})}shakeScreen(t){t<10||this.cameras.main.shake(100,.005)}createLowHpVignette(){console.log(`Vignette initialized (grid: ${this.skillGridCols}x${this.skillGridRows})`)}updateLowHpVignette(){const t=this.currentHp/this.maxHp;this.isLowHp=t<=.3,!this.isLowHp&&this.currentShield<=0&&this.clearVignetteCells()}clearVignetteCells(){for(const t of this.vignetteEdgeCells){const e=this.skillGridCells[t];e&&(e.setFillStyle(16777215,0),e.setVisible(!1))}this.vignetteEdgeCells.clear()}updateLowHpVignetteBreathing(t){if(!this.isLowHp&&this.currentShield<=0)return;this.lowHpBreathTimer+=t;const e=1500;this.lowHpBreathTimer>=e&&(this.lowHpBreathTimer-=e);const s=this.lowHpBreathTimer/e,a=Math.sin(s*Math.PI*2)*.5+.5;this.drawGridVignette(a)}drawGridVignette(t){const e=.2+t*.2;let s;this.currentShield>0?s=16768324:s=16720418;const a=this.skillGridCols/2,i=this.skillGridRows/2,l=this.skillGridCols/2*2,o=this.skillGridRows/2*2,n=2,c=this.skillGridRows-2;for(let h=n;h<c;h++)for(let r=0;r<this.skillGridCols;r++){const f=h*this.skillGridCols+r,p=this.skillGridCells[f];if(!p)continue;const d=(r-a)/l,y=(h-i)/o,S=Math.sqrt(d*d+y*y);if(S>.5){const k=Math.min(1,(S-.5)/.25),x=e*k;x>.01&&(p.setFillStyle(s,x),p.setVisible(!0),this.vignetteEdgeCells.add(f))}}}createExpBar(){this.expBarContainer=this.add.container(0,0),this.expBarContainer.setDepth(100);const t=Math.floor(this.gameBounds.height*.03),e=this.skillGridCellSize,s=this.gameBounds.y+this.gameBounds.height-e*2;this.levelText=this.add.text(this.gameBounds.x+10,s-5,`Lv.${this.currentLevel}`,{fontFamily:"monospace",fontSize:`${t}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}),this.levelText.setOrigin(0,1),this.expBarContainer.add(this.levelText)}drawExpBarFill(){const t=[this.skillGridRows-2,this.skillGridRows-1];for(const i of t)for(let l=0;l<this.skillGridCols;l++){const o=i*this.skillGridCols+l,n=this.skillGridCells[o];n&&(n.setFillStyle(0,.9),n.setVisible(!0),n.setDepth(1e3))}const e=this.currentExp/this.maxExp,s=this.skillGridCols,a=Math.floor(s*e);if(!(a<=0))for(const i of t)for(let l=0;l<a;l++){const o=i*this.skillGridCols+l,n=this.skillGridCells[o];if(!n)continue;const c=l/s,h=this.expBarFlowOffset,r=(c+h)%1,f=(Math.sin(r*Math.PI*2-Math.PI/2)+1)/2,p=Math.floor(68+68*f),d=Math.floor(136-68*f),S=p<<16|d<<8|255,k=i===this.skillGridRows-2?.95:.8;n.setFillStyle(S,k)}}updateExpBarFlow(t){this.expBarFlowOffset+=.2*t/1e3,this.expBarFlowOffset>=1&&(this.expBarFlowOffset-=1),this.drawExpBarFill()}drawFloorGrid(){this.floorGrid.clear();const t=this.gameBounds.height/10,e=Math.ceil(this.mapWidth/t),s=Math.ceil(this.mapHeight/t);for(let o=0;o<s;o++)for(let n=0;n<e;n++){const c=n*t,h=o*t;(o+n)%2===0?this.floorGrid.fillStyle(3355443,1):this.floorGrid.fillStyle(4473924,1),this.floorGrid.fillRect(c,h,t,t),this.floorGrid.lineStyle(1,5592405,.5),this.floorGrid.strokeRect(c,h,t,t)}this.floorGrid.lineStyle(4,16729156,1),this.floorGrid.strokeRect(0,0,this.mapWidth,this.mapHeight),this.floorGrid.lineStyle(2,16776960,1);const a=this.mapWidth/2,i=this.mapHeight/2,l=t;this.floorGrid.strokeRect(a-l/2,i-l/2,l,l);for(let o=0;o<s;o+=5)for(let n=0;n<e;n+=5){const c=n*t+t/2,h=o*t+t/2;this.floorGrid.fillStyle(6710886,1),this.floorGrid.fillCircle(c,h,4)}}createSkillBar(){const t=this.skillGridCellSize,e=G.SKILL_GRID_GAP,s=8,a=s*(t+e)-e,i=1,l=2,o=G.ACTIVE_SKILLS,n=G.PASSIVE_SKILLS,c=o*s+(o-1)*i,h=n*s+(n-1)*i,f=(c+l+h)*(t+e)-e,p=this.gameBounds.x+(this.gameBounds.width-f)/2,d=2*(t+e),y=t+e,S=this.gameBounds.y+this.gameBounds.height-d-a-y;let k=p;for(let x=0;x<o;x++){const g=k+a/2,w=S+a/2,C=this.add.container(g,w),M=this.add.rectangle(0,0,a,a);M.setStrokeStyle(0,16777215,0),M.setFillStyle(0,0),C.add(M);const v=this.add.rectangle(0,0,a-4,a-4,3355443,0);C.add(v);const b=Math.floor(a*.2),P=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${b}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});P.setOrigin(.5,.5),C.add(P),this.skillIcons.push(M),this.skillIconContainers.push(C),this.skillLevelTexts.push(P),this.uiContainer.add(C),this.drawSkillIconGrid(k,S,s,x),k+=a+i*(t+e)}k+=(l-i)*(t+e);for(let x=0;x<n;x++){const g=k+a/2,w=S+a/2,C=this.add.container(g,w),M=this.add.rectangle(0,0,a,a);M.setStrokeStyle(0,16777215,0),M.setFillStyle(0,0),C.add(M);const v=this.add.rectangle(0,0,a-4,a-4,3355443,0);C.add(v);const b=Math.floor(a*.2),P=this.add.text(0,a*.3,"",{fontFamily:"monospace",fontSize:`${b}px`,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3});P.setOrigin(.5,.5),C.add(P),this.skillIcons.push(M),this.skillIconContainers.push(C),this.skillLevelTexts.push(P),this.uiContainer.add(C),this.drawSkillIconGrid(k,S,s,o+x),k+=a+i*(t+e)}this.createSkillInfoPanel(),this.setupSkillIconInteractions()}drawSkillIconGrid(t,e,s,a){const i=this.add.graphics();i.setDepth(1001),this.uiContainer.add(i),this.skillIconGridData[a]={startX:t,startY:e,gridSize:s},this.redrawSkillIconGrid(a,0),this.skillIconGridGraphics[a]=i}redrawSkillIconGrid(t,e){const s=this.skillIconGridGraphics[t],a=this.skillIconGridData[t];if(!s||!a)return;s.clear();const i=this.skillGridCellSize,l=G.SKILL_GRID_GAP,{startX:o,startY:n,gridSize:c}=a,h=[],r=Math.floor(c/2);for(let d=r;d<c;d++)h.push({row:0,col:d});for(let d=1;d<c;d++)h.push({row:d,col:c-1});for(let d=c-2;d>=0;d--)h.push({row:c-1,col:d});for(let d=c-2;d>=1;d--)h.push({row:d,col:0});h.push({row:0,col:0});for(let d=1;d<r;d++)h.push({row:0,col:d});const f=h.length,p=Math.floor(f*e);for(let d=0;d<f;d++){const{row:y,col:S}=h[d],k=o+S*(i+l),x=n+y*(i+l);if(d<p){const g=this.getSkillColorForIndex(t);s.fillStyle(g,.4)}else s.fillStyle(0,.5);s.fillRect(k,x,i,i)}}getSkillColorForIndex(t){const e=G.ACTIVE_SKILLS,s=t<e,a=s?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills(),i=s?t:t-e,l=a[i];return l?l.definition.color:6710886}updateSkillCooldownDisplay(){const t=this.time.now,e=this.skillManager.getPlayerActiveSkills();for(let i=0;i<e.length;i++){const l=e[i];if(!l){this.redrawSkillIconGrid(i,0);continue}const o=l.definition;let n=o.cooldown||1e3;o.id==="active_architect"&&(n=n-l.level*500);const c=this.skillManager.calculateFinalCooldown(n),h=this.skillCooldowns.get(o.id)||0,r=t-h;if(r>=c)this.redrawSkillIconGrid(i,1);else{const f=r/c;this.redrawSkillIconGrid(i,f)}}const s=this.skillManager.getPlayerPassiveSkills(),a=G.ACTIVE_SKILLS;for(let i=0;i<s.length;i++){const l=s[i];if(!l){this.redrawSkillIconGrid(a+i,0);continue}const o=l.definition;let n=1;switch(o.id){case"passive_titanium_liver":{const c=this.skillManager.getTitaniumLiverRegenInterval();c>0&&this.currentHp<this.maxHp&&(n=this.hpRegenTimer/c);break}}this.redrawSkillIconGrid(a+i,n)}}createSkillInfoPanel(){const t=this.gameBounds,e=200,s=80,a=10,i=t.x+a,l=t.y+t.height-s-a-60;this.skillInfoPanel=this.add.container(i,l),this.skillInfoPanel.setDepth(200),this.skillInfoBg=this.add.rectangle(0,0,e,s,0,.7),this.skillInfoBg.setOrigin(0,0),this.skillInfoBg.setStrokeStyle(1,6710886),this.skillInfoPanel.add(this.skillInfoBg),this.skillInfoText=this.add.text(a,a,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff",wordWrap:{width:e-a*2}}),this.skillInfoPanel.add(this.skillInfoText),this.skillInfoPanel.setVisible(!1),this.uiContainer.add(this.skillInfoPanel)}setupSkillIconInteractions(){const t=G.ACTIVE_SKILLS;for(let e=0;e<this.skillIconContainers.length;e++){const s=this.skillIconContainers[e],a=e<t,i=a?e:e-t;s.setSize(s.getBounds().width,s.getBounds().height),s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this.showSkillInfo(a,i)})}}showSkillInfo(t,e){const a=(t?this.skillManager.getPlayerActiveSkills():this.skillManager.getPlayerPassiveSkills())[e];if(!a){this.skillInfoPanel.setVisible(!1);return}const i=[];i.push(`【${a.definition.name}】${lt.formatLevel(a.level,a.definition.maxLevel)}`),t?this.appendActiveSkillInfo(i,a):this.appendPassiveSkillInfo(i,a),this.skillInfoText.setText(i.join(`
`));const l=this.skillInfoText.getBounds(),o=10;this.skillInfoBg.setSize(Math.max(180,l.width+o*2),l.height+o*2),this.skillInfoPanel.setVisible(!0),this.skillInfoHideTimer&&this.skillInfoHideTimer.destroy(),this.skillInfoHideTimer=this.time.delayedCall(3e3,()=>{this.skillInfoPanel.setVisible(!1)})}appendActiveSkillInfo(t,e){const s=e.level,a=this.skillManager.getAiEnhancementDamageBonus(),i=this.skillManager.getSyncRateCooldownReduction();switch(e.definition.id){case"active_soul_render":{const l=60+s*10,o=2+s,n=G.DAMAGE_UNIT*o,c=Math.floor(n*(1+a)),r=((e.definition.cooldown||1e3)*(1-i)/1e3).toFixed(1);t.push(`扇形角度: ${l}°`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_coder":{const l=2+s*.5,o=1+s,n=G.DAMAGE_UNIT*o,c=Math.floor(n*(1+a)),r=((e.definition.cooldown||1500)*(1-i)/1e3).toFixed(1);t.push(`範圍: ${l} 單位`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_vfx":{const l=s+1,o=1+s,n=G.DAMAGE_UNIT*o,c=Math.floor(n*(1+a)),r=((e.definition.cooldown||2500)*(1-i)/1e3).toFixed(1);t.push(`光束數: ${l} 道`),t.push(`傷害: ${c}`),t.push(`冷卻: ${r}s`);break}case"active_architect":{const l=Math.floor(this.maxHp*.3),o=1+s*1.5,n=G.DAMAGE_UNIT*o,h=((e.definition.cooldown||1e4)*(1-i)/1e3).toFixed(1);t.push(`護盾: ${l}`),t.push(`反傷: ${n}`),t.push(`冷卻: ${h}s`);break}}}appendPassiveSkillInfo(t,e){switch(e.definition.id){case"passive_titanium_liver":{const s=this.skillManager.getTitaniumLiverHpBonus(),a=this.skillManager.getTitaniumLiverRegenInterval()/1e3;t.push(`HP 加成: +${Math.round(s*100)}%`),t.push(`最大 HP: ${this.maxHp}`),t.push(`回復: 每 ${a} 秒 +1% HP`);break}case"passive_sync_rate":{const s=this.skillManager.getSyncRateSpeedBonus(),a=this.skillManager.getSyncRateCooldownReduction();t.push(`移速加成: +${Math.round(s*100)}%`),t.push(`冷卻減少: -${Math.round(a*100)}%`);break}case"passive_retina_module":{const s=this.skillManager.getRetinaModuleExpBonus();t.push(`經驗加成: +${Math.round(s*100)}%`);break}case"passive_ai_enhancement":{const s=this.skillManager.getAiEnhancementDamageBonus(),a=this.skillManager.getAiEnhancementDefenseBonus();t.push(`攻擊加成: +${Math.round(s*100)}%`),t.push(`防禦加成: +${Math.round(a*100)}%`);break}}}updateSkillBarDisplay(){const t=this.skillManager.getPlayerActiveSkills(),e=this.skillManager.getPlayerPassiveSkills(),s=[...t,...e];for(let a=0;a<this.skillIconContainers.length;a++){const i=this.skillIconContainers[a],l=this.skillLevelTexts[a],o=s[a],n=i.list[1];o?(n.setFillStyle(o.definition.color,.5),l.setText(lt.formatLevel(o.level,o.definition.maxLevel))):(n.setFillStyle(3355443,0),l.setText(""))}}createCharacterAnimations(){this.anims.create({key:"char_idle",frames:[{key:"char_idle_1"},{key:"char_idle_2"}],frameRate:2,repeat:-1}),this.anims.create({key:"char_run",frames:[{key:"char_run_1"},{key:"char_run_2"}],frameRate:8,repeat:-1}),this.anims.create({key:"char_attack",frames:[{key:"char_attack_1"},{key:"char_attack_2"}],frameRate:8,repeat:0}),this.anims.create({key:"char_hurt",frames:[{key:"char_hurt"}],frameRate:2,repeat:0})}updateCharacterSprite(){this.character.setPosition(this.characterX,this.characterY),this.character.setScale((this.facingRight?1:-1)*(this.characterSize/this.character.height),this.characterSize/this.character.height)}setCharacterState(t,e=!1){this.characterState!==t&&(this.isHurt&&!e&&t!=="hurt"||this.isAttacking&&!e&&t!=="hurt"||(this.characterState=t,this.character.play(`char_${t}`)))}updateCharacterFacing(t){t>this.characterX?this.facingRight=!0:t<this.characterX&&(this.facingRight=!1)}createSkillPanel(){this.skillPanelContainer=this.add.container(0,0),this.skillPanelContainer.setVisible(!1),this.uiContainer.add(this.skillPanelContainer);const t=this.add.rectangle(this.gameBounds.x+this.gameBounds.width/2,this.gameBounds.y+this.gameBounds.height/2,this.gameBounds.width,this.gameBounds.height,0,.8);t.setInteractive(),this.skillPanelContainer.add(t);const e=this.gameBounds.y+this.gameBounds.height*.12,s=this.add.text(this.gameBounds.x+this.gameBounds.width/2,e,"選擇技能",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.07)}px`,color:"#ffffff",fontStyle:"bold"});s.setOrigin(.5,.5),this.skillPanelContainer.add(s);const a=e+this.gameBounds.height*.06,i=this.add.text(this.gameBounds.x+this.gameBounds.width/2,a,"提升你的數位能力",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.025)}px`,color:"#aaaaaa"});i.setOrigin(.5,.5),this.skillPanelContainer.add(i),this.createSkillOptions();const l=this.gameBounds.y+this.gameBounds.height*.92,o=this.add.text(this.gameBounds.x+this.gameBounds.width/2,l,"點選或按 W 確定",{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(this.gameBounds.height*.022)}px`,color:"#666666"});o.setOrigin(.5,.5),this.skillPanelContainer.add(o)}createSkillOptions(){if(this.skillOptions.forEach(c=>c.destroy()),this.skillOptions=[],this.skillCardBgs=[],this.currentSkillChoices=this.skillManager.getRandomSkillOptions(),this.currentSkillChoices.length===0)return;const t=this.gameBounds.width*.25,e=this.gameBounds.height*.5,s=this.gameBounds.width*.05,a=this.currentSkillChoices.length,i=t*a+s*(a-1),l=this.gameBounds.x+(this.gameBounds.width-i)/2+t/2,o=this.gameBounds.y+this.gameBounds.height*.55,n=["A","S","D"];for(let c=0;c<this.currentSkillChoices.length;c++){const h=this.currentSkillChoices[c],r=this.skillManager.getSkillLevel(h.id),f=r<0,p=f?"-":r,d=f?0:r+1,y=l+c*(t+s),S=this.add.container(y,o),k=this.add.rectangle(0,0,t,e,2236962);k.setStrokeStyle(2,6710886),S.add(k);const x=this.add.text(0,-e*.42,h.type==="active"?"ACTIVE":"PASSIVE",{fontFamily:"monospace",fontSize:`${Math.floor(e*.045)}px`,color:h.type==="active"?"#ff6666":"#66ffff",fontStyle:"bold"});x.setOrigin(.5,.5),S.add(x);const g=t*.5,w=-e*.18,C=this.add.rectangle(0,w,g,g,h.color,.3);C.setStrokeStyle(2,h.color),S.add(C);const M=e*.06,v=this.add.text(0,M,h.name,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.08)}px`,color:"#ffffff",fontStyle:"bold"});if(v.setOrigin(.5,.5),S.add(v),h.subtitle){const A=this.add.text(0,e*.12,h.subtitle,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#999999"});A.setOrigin(.5,.5),S.add(A)}let b;d>=h.maxLevel?b=`Lv.${p} → MAX`:f?b=`NEW → Lv.${d}`:b=`Lv.${p} → Lv.${d}`;const P=this.add.text(0,e*.2,b,{fontFamily:"monospace",fontSize:`${Math.floor(e*.05)}px`,color:d>=h.maxLevel?"#ffff00":"#88ff88",fontStyle:"bold"});P.setOrigin(.5,.5),S.add(P);const B=this.add.text(0,e*.32,h.description,{fontFamily:"Microsoft JhengHei, PingFang TC, sans-serif",fontSize:`${Math.floor(e*.04)}px`,color:"#aaaaaa",wordWrap:{width:t*.85},align:"center"});B.setOrigin(.5,.5),S.add(B);const T=this.add.text(0,e*.42,`[ ${n[c]} ]`,{fontFamily:"monospace",fontSize:`${Math.floor(e*.06)}px`,color:"#ffff00",fontStyle:"bold"});T.setOrigin(.5,.5),S.add(T),k.setInteractive({useHandCursor:!0});const E=c;k.on("pointerover",()=>{this.setSelectedSkill(E)}),k.on("pointerdown",()=>{this.setSelectedSkill(E),this.confirmSkillSelection()}),this.skillPanelContainer.add(S),this.skillOptions.push(S),this.skillCardBgs.push(k)}this.selectedSkillIndex=0}showSkillPanel(){if(!this.skillManager.hasUpgradeableSkills()){console.log("All skills are maxed out! Continue leveling for HP growth.");return}this.createSkillOptions(),this.currentSkillChoices.length!==0&&(this.isPaused=!0,this.isMoving=!1,this.skillPanelContainer.setVisible(!0),this.selectedSkillIndex=0,this.skillCardBgs.forEach((t,e)=>{e===0?(t.setFillStyle(3355443),t.setStrokeStyle(3,16777215)):(t.setFillStyle(2236962),t.setStrokeStyle(2,6710886))}),this.skillPanelContainer.setAlpha(0),this.tweens.add({targets:this.skillPanelContainer,alpha:1,duration:200}),this.skillOptions.forEach((t,e)=>{t.setScale(e===0?1.05:1),t.setY(this.gameBounds.y+this.gameBounds.height*.55+50),t.setAlpha(0),this.tweens.add({targets:t,y:this.gameBounds.y+this.gameBounds.height*.55,alpha:1,duration:300,delay:e*100,ease:"Back.easeOut"})}))}hideSkillPanel(){this.tweens.add({targets:this.skillPanelContainer,alpha:0,duration:200,onComplete:()=>{this.skillPanelContainer.setVisible(!1),this.isPaused=!1}})}selectSkill(t,e){if(!this.skillManager.learnOrUpgradeSkill(e)){console.warn(`Failed to learn/upgrade skill: ${e}`);return}const a=this.skillManager.getPlayerSkill(e);console.log(`Skill upgraded: ${e} -> Lv.${a==null?void 0:a.level}`),this.updateSkillBarDisplay(),(a==null?void 0:a.definition.type)==="passive"&&(this.recalculateMaxHp(),this.recalculateMoveSpeed(),this.drawHpBarFill(),this.updateHpText(),console.log(`Passive skill effect applied. MaxHP: ${this.maxHp}, MoveSpeed: ${this.moveSpeed}`));const i=this.skillOptions[t];this.tweens.add({targets:i,scaleX:1.1,scaleY:1.1,duration:100,yoyo:!0,onComplete:()=>{this.hideSkillPanel()}})}createSkillGrid(){const t=this.cameras.main.width,e=1920,s=10,a=4,i=Math.min(1,t/e);this.skillGridCellSize=Math.max(a,Math.floor(s*i));const l=G.SKILL_GRID_GAP;this.skillGridCols=Math.ceil((this.gameBounds.width+l)/(this.skillGridCellSize+l)),this.skillGridRows=Math.ceil((this.gameBounds.height+l)/(this.skillGridCellSize+l)),this.skillGridContainer=this.add.container(this.gameBounds.x,this.gameBounds.y),this.skillGridContainer.setDepth(50);for(let o=0;o<this.skillGridRows;o++)for(let n=0;n<this.skillGridCols;n++){const c=n*(this.skillGridCellSize+l)+this.skillGridCellSize/2,h=o*(this.skillGridCellSize+l)+this.skillGridCellSize/2,r=this.add.rectangle(c,h,this.skillGridCellSize,this.skillGridCellSize,16777215,0);r.setVisible(!1),this.skillGridCells.push(r),this.skillGridContainer.add(r)}this.uiContainer.add(this.skillGridContainer)}worldToScreen(t,e){return{x:t-this.cameraOffsetX,y:e-this.cameraOffsetY}}showSkillRangeCircle(t,e,s,a,i=.3){const l=this.worldToScreen(t,e),o=l.x,n=l.y,c=G.SKILL_GRID_GAP,h=this.skillGridCellSize+c,r=Math.max(0,Math.floor((o-s)/h)),f=Math.min(this.skillGridCols-1,Math.ceil((o+s)/h)),p=Math.max(0,Math.floor((n-s)/h)),d=Math.min(this.skillGridRows-1,Math.ceil((n+s)/h));for(let y=p;y<=d;y++)for(let S=r;S<=f;S++){const k=S*h+this.skillGridCellSize/2,x=y*h+this.skillGridCellSize/2,g=k-o,w=x-n;if(Math.sqrt(g*g+w*w)<=s){const M=y*this.skillGridCols+S,v=this.skillGridCells[M];v&&(v.setFillStyle(a,i),v.setVisible(!0))}}}showSkillRangeSector(t,e,s,a,i,l,o=.3){const n=this.worldToScreen(t,e),c=n.x,h=n.y,r=G.SKILL_GRID_GAP,f=this.skillGridCellSize+r,p=Math.max(0,Math.floor((c-s)/f)),d=Math.min(this.skillGridCols-1,Math.ceil((c+s)/f)),y=Math.max(0,Math.floor((h-s)/f)),S=Math.min(this.skillGridRows-1,Math.ceil((h+s)/f));for(let k=y;k<=S;k++)for(let x=p;x<=d;x++){const g=x*f+this.skillGridCellSize/2,w=k*f+this.skillGridCellSize/2,C=g-c,M=w-h,v=Math.sqrt(C*C+M*M);if(v<=s&&v>0){const b=Math.atan2(M,C);let P=Math.abs(b-a);if(P>Math.PI&&(P=2*Math.PI-P),P<=i){const B=k*this.skillGridCols+x,T=this.skillGridCells[B];T&&(T.setFillStyle(l,o),T.setVisible(!0))}}}}showSkillRangeLine(t,e,s,a,i,l,o=.3){const n=this.worldToScreen(t,e),c=this.worldToScreen(s,a),h=G.SKILL_GRID_GAP,r=this.skillGridCellSize+h,f=c.x-n.x,p=c.y-n.y,d=Math.sqrt(f*f+p*p);if(d===0)return;const y=f/d,S=p/d,k=-S,x=y,g=i/2,w=[{x:n.x+k*g,y:n.y+x*g},{x:n.x-k*g,y:n.y-x*g},{x:c.x+k*g,y:c.y+x*g},{x:c.x-k*g,y:c.y-x*g}],C=Math.min(...w.map(A=>A.x)),M=Math.max(...w.map(A=>A.x)),v=Math.min(...w.map(A=>A.y)),b=Math.max(...w.map(A=>A.y)),P=Math.max(0,Math.floor(C/r)),B=Math.min(this.skillGridCols-1,Math.ceil(M/r)),T=Math.max(0,Math.floor(v/r)),E=Math.min(this.skillGridRows-1,Math.ceil(b/r));for(let A=T;A<=E;A++)for(let R=P;R<=B;R++){const L=R*r+this.skillGridCellSize/2,H=A*r+this.skillGridCellSize/2,D=Math.max(0,Math.min(1,((L-n.x)*y+(H-n.y)*S)/d)),X=n.x+D*f,Y=n.y+D*p;if(Math.sqrt((L-X)**2+(H-Y)**2)<=g){const I=A*this.skillGridCols+R,_=this.skillGridCells[I];_&&(_.setFillStyle(l,o),_.setVisible(!0))}}}clearSkillGrid(){this.skillGridCells.forEach((t,e)=>{if(this.vignetteEdgeCells.has(e)&&(this.isLowHp||this.currentShield>0))return;const s=Math.floor(e/this.skillGridCols);s<2||s>=this.skillGridRows-2||t.setVisible(!1)})}flashGridAt(t,e,s,a=1){const i=this.worldToScreen(t,e),l=G.SKILL_GRID_GAP,o=this.skillGridCellSize+l,n=Math.floor(i.x/o),c=Math.floor(i.y/o),h=600,r=200,f=this.time.now,p=[];for(let S=-a;S<=a;S++)for(let k=-a;k<=a;k++){const x=n+k,g=c+S;if(x<0||x>=this.skillGridCols||g<0||g>=this.skillGridRows)continue;const w=Math.sqrt(S*S+k*k);if(w<=a){const C=g*this.skillGridCols+x,M=this.skillGridCells[C];M&&p.push({cell:M,dist:w})}}if(p.length===0)return;const d=()=>{const S=this.time.now-f,k=Math.min(S/h,1);let x=0;S>r&&(x=(S-r)/(h-r));for(const{cell:g,dist:w}of p){const C=w/Math.max(a,1),v=(1-C*.4)*(1-x);if(v>.01)if(S<r){const P=(1-C)*.5;if(g.setFillStyle(s,v),g.setVisible(!0),w<a*.5){const B=s>>16&255,T=s>>8&255,E=s&255,A=Math.min(255,B+Math.floor((255-B)*P)),R=Math.min(255,T+Math.floor((255-T)*P)),L=Math.min(255,E+Math.floor((255-E)*P)),H=A<<16|R<<8|L;g.setFillStyle(H,v)}}else g.setFillStyle(s,v),g.setVisible(!0);else g.setVisible(!1)}if(k>=1)for(const{cell:g}of p)g.setVisible(!1),g.setAlpha(1)};d();const y=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{y.remove();for(const{cell:S}of p)S.setVisible(!1),S.setAlpha(1)})}flashGridAtPositions(t,e,s=1){t.forEach(a=>{this.flashGridAt(a.x,a.y,e,s)})}flashWhiteCrossAt(t,e){const s=this.worldToScreen(t,e),a=G.SKILL_GRID_GAP,i=this.skillGridCellSize+a,l=Math.floor(s.x/i),o=Math.floor(s.y/i),n=3,c=300,h=this.time.now,r=[];l>=0&&l<this.skillGridCols&&o>=0&&o<this.skillGridRows&&r.push({col:l,row:o,dist:0});const f=[{dc:1,dr:0},{dc:-1,dr:0},{dc:0,dr:1},{dc:0,dr:-1}];for(const{dc:S,dr:k}of f)for(let x=1;x<=n;x++){const g=l+S*x,w=o+k*x;g>=0&&g<this.skillGridCols&&w>=0&&w<this.skillGridRows&&r.push({col:g,row:w,dist:x})}if(r.length===0)return;const p=[];for(const{col:S,row:k}of r){const x=S*i+this.skillGridCellSize/2,g=k*i+this.skillGridCellSize/2,w=this.add.rectangle(x,g,this.skillGridCellSize,this.skillGridCellSize,16777215,0);w.setVisible(!1),this.skillGridContainer.add(w),p.push(w)}const d=()=>{const S=this.time.now-h,k=Math.min(S/c,1),g=n*k;let w=0;for(const{dist:C}of r){const M=p[w++];if(M)if(C>=g){const b=1-C/n*.5;let P=1;g>0&&C<g+1&&(P=C-g);const B=b*Math.max(0,P);B>.01?(M.setFillStyle(16777215,B),M.setVisible(!0)):M.setVisible(!1)}else M.setVisible(!1)}if(k>=1)for(const C of p)C.destroy()};d();const y=this.time.addEvent({delay:16,callback:d,callbackScope:this,repeat:Math.ceil(c/16)});this.time.delayedCall(c+50,()=>{y.remove();for(const S of p)S.active&&S.destroy()})}flashWhiteCrossAtPositions(t){t.forEach(e=>{this.flashWhiteCrossAt(e.x,e.y)})}flashSkillAreaSector(t,e,s,a,i,l){const o=this.worldToScreen(t,e),n=o.x,c=o.y,h=G.SKILL_GRID_GAP,r=this.skillGridCellSize+h,f=500,p=150,d=150,y=this.time.now,S=[],k=Math.max(0,Math.floor((n-s)/r)),x=Math.min(this.skillGridCols-1,Math.ceil((n+s)/r)),g=Math.max(0,Math.floor((c-s)/r)),w=Math.min(this.skillGridRows-1,Math.ceil((c+s)/r));for(let b=g;b<=w;b++)for(let P=k;P<=x;P++){const B=P*r+this.skillGridCellSize/2,T=b*r+this.skillGridCellSize/2,E=B-n,A=T-c,R=Math.sqrt(E*E+A*A);if(R<=s&&R>0){const L=Math.atan2(A,E);let H=Math.abs(L-a);H>Math.PI&&(H=2*Math.PI-H),H<=i&&S.push({col:P,row:b,dist:R,angleDist:H})}}if(S.length===0)return;const C=[];for(const{col:b,row:P}of S){const B=b*r+this.skillGridCellSize/2,T=P*r+this.skillGridCellSize/2,E=this.add.rectangle(B,T,this.skillGridCellSize,this.skillGridCellSize,l,0);E.setVisible(!1),this.skillGridContainer.add(E),C.push(E)}const M=()=>{const b=this.time.now-y,P=Math.min(b/f,1),B=Math.min(b/p,1),T=s*B;let E=0;b>p+d&&(E=(b-p-d)/(f-p-d));const A=s*E;let R=0;for(const{dist:L,angleDist:H}of S){const D=C[R++];if(D)if(L<=T&&L>=A){const X=L/s,Y=H/i,_=Math.max(X,Y),z=Math.max(0,Math.min(1,(_-.3)/.7)),$=z*z*(3-2*z),V=.15+$*.6;let U=1;if(A>0){const J=s*.15;L<A+J&&(U=(L-A)/J)}const W=V*U;if(W>.01){const J=.5+$*.5,O=l>>16&255,Z=l>>8&255,j=l&255;let et=O,Q=Z,st=j;if(_>.85&&b<p+d){const it=(_-.85)/.15;et=Math.min(255,O+Math.floor((255-O)*it*.3)),Q=Math.min(255,Z+Math.floor((255-Z)*it*.3)),st=Math.min(255,j+Math.floor((255-j)*it*.3))}else et=Math.floor(O*J),Q=Math.floor(Z*J),st=Math.floor(j*J);const rt=et<<16|Q<<8|st;D.setFillStyle(rt,W),D.setVisible(!0)}else D.setVisible(!1)}else D.setVisible(!1)}if(P>=1)for(const L of C)L.destroy()};M();const v=this.time.addEvent({delay:16,callback:M,callbackScope:this,repeat:Math.ceil(f/16)});this.time.delayedCall(f+50,()=>{v.remove();for(const b of C)b.active&&b.destroy()})}flashSkillAreaCircle(t,e,s,a){const i=this.worldToScreen(t,e),l=i.x,o=i.y,n=G.SKILL_GRID_GAP,c=this.skillGridCellSize+n,h=500,r=150,f=150,p=this.time.now,d=[],y=Math.max(0,Math.floor((l-s)/c)),S=Math.min(this.skillGridCols-1,Math.ceil((l+s)/c)),k=Math.max(0,Math.floor((o-s)/c)),x=Math.min(this.skillGridRows-1,Math.ceil((o+s)/c));for(let M=k;M<=x;M++)for(let v=y;v<=S;v++){const b=v*c+this.skillGridCellSize/2,P=M*c+this.skillGridCellSize/2,B=b-l,T=P-o,E=Math.sqrt(B*B+T*T);E<=s&&d.push({col:v,row:M,dist:E})}if(d.length===0)return;const g=[];for(const{col:M,row:v}of d){const b=M*c+this.skillGridCellSize/2,P=v*c+this.skillGridCellSize/2,B=this.add.rectangle(b,P,this.skillGridCellSize,this.skillGridCellSize,a,0);B.setVisible(!1),this.skillGridContainer.add(B),g.push(B)}const w=()=>{const M=this.time.now-p,v=Math.min(M/h,1),b=Math.min(M/r,1),P=s*b;let B=0;M>r+f&&(B=(M-r-f)/(h-r-f));const T=s*B;let E=0;for(const{dist:A}of d){const R=g[E++];if(R)if(A<=P&&A>=T){const L=A/s,H=Math.max(0,Math.min(1,(L-.3)/.7)),D=H*H*(3-2*H),X=.15+D*.6;let Y=1;if(T>0){const I=s*.15;A<T+I&&(Y=(A-T)/I)}const K=X*Y;if(K>.01){const I=.5+D*.5,_=a>>16&255,z=a>>8&255,$=a&255;let V=_,U=z,W=$;if(L>.85&&M<r+f){const O=(L-.85)/.15;V=Math.min(255,_+Math.floor((255-_)*O*.3)),U=Math.min(255,z+Math.floor((255-z)*O*.3)),W=Math.min(255,$+Math.floor((255-$)*O*.3))}else V=Math.floor(_*I),U=Math.floor(z*I),W=Math.floor($*I);const J=V<<16|U<<8|W;R.setFillStyle(J,K),R.setVisible(!0)}else R.setVisible(!1)}else R.setVisible(!1)}if(v>=1)for(const A of g)A.destroy()};w();const C=this.time.addEvent({delay:16,callback:w,callbackScope:this,repeat:Math.ceil(h/16)});this.time.delayedCall(h+50,()=>{C.remove();for(const M of g)M.active&&M.destroy()})}flashSkillAreaLine(t,e,s,a,i,l){const o=this.worldToScreen(t,e),n=this.worldToScreen(s,a),c=G.SKILL_GRID_GAP,h=this.skillGridCellSize+c,r=n.x-o.x,f=n.y-o.y,p=Math.sqrt(r*r+f*f);if(p===0)return;const d=r/p,y=f/p,S=-y,k=d,x=i/2,g=800,w=80,C=300,M=g-w-C,v=this.time.now,b=[],P=[{x:o.x+S*x,y:o.y+k*x},{x:o.x-S*x,y:o.y-k*x},{x:n.x+S*x,y:n.y+k*x},{x:n.x-S*x,y:n.y-k*x}],B=Math.min(...P.map(I=>I.x)),T=Math.max(...P.map(I=>I.x)),E=Math.min(...P.map(I=>I.y)),A=Math.max(...P.map(I=>I.y)),R=Math.max(0,Math.floor(B/h)),L=Math.min(this.skillGridCols-1,Math.ceil(T/h)),H=Math.max(0,Math.floor(E/h)),D=Math.min(this.skillGridRows-1,Math.ceil(A/h));for(let I=H;I<=D;I++)for(let _=R;_<=L;_++){const z=_*h+this.skillGridCellSize/2,$=I*h+this.skillGridCellSize/2,V=z-o.x,U=$-o.y,W=V*d+U*y;if(W<0||W>p)continue;const J=o.x+d*W,O=o.y+y*W,Z=Math.sqrt((z-J)**2+($-O)**2);Z<=x&&b.push({col:_,row:I,distAlong:W,distToLine:Z})}if(b.length===0)return;const X=[];for(const{col:I,row:_}of b){const z=I*h+this.skillGridCellSize/2,$=_*h+this.skillGridCellSize/2,V=this.add.rectangle(z,$,this.skillGridCellSize,this.skillGridCellSize,l,0);V.setVisible(!1),this.skillGridContainer.add(V),X.push(V)}const Y=()=>{const I=this.time.now-v,_=Math.min(I/g,1),z=Math.min(I/w,1),$=p*z;let V=0;I>w+C&&(V=(I-w-C)/M);const U=p*V,W=1-V;let J=0;for(const{distAlong:O,distToLine:Z}of b){const j=X[J++];if(!j)continue;const et=x*W;if(O<=$&&O>=U&&Z<=et){const Q=et>0?Z/et:1,st=1-Q*Q;let rt=.2+st*.5;const it=O/p,Pt=Math.min(1,it/.15),Bt=Math.min(1,(1-it)/.15),Ct=Math.min(Pt,Bt);rt*=Ct*Ct;let wt=1;if(U>0){const at=p*.1;O<U+at&&(wt=(O-U)/at)}const vt=rt*wt;if(vt>.01){const at=.6+st*.4,ct=l>>16&255,dt=l>>8&255,ft=l&255;let gt,pt,mt;if(Q<.2&&I<w+C){const ut=1-Q/.2;gt=Math.min(255,ct+Math.floor((255-ct)*ut*.3)),pt=Math.min(255,dt+Math.floor((255-dt)*ut*.3)),mt=Math.min(255,ft+Math.floor((255-ft)*ut*.3))}else gt=Math.floor(ct*at),pt=Math.floor(dt*at),mt=Math.floor(ft*at);const Tt=gt<<16|pt<<8|mt;j.setFillStyle(Tt,vt),j.setVisible(!0)}else j.setVisible(!1)}else j.setVisible(!1)}if(_>=1)for(const O of X)O.destroy()};Y();const K=this.time.addEvent({delay:16,callback:Y,callbackScope:this,repeat:Math.ceil(g/16)});this.time.delayedCall(g+50,()=>{K.remove();for(const I of X)I.active&&I.destroy()})}};m(G,"MAP_SCALE",10),m(G,"ACTIVE_SKILLS",4),m(G,"PASSIVE_SKILLS",3),m(G,"CAMERA_DEAD_ZONE",.3),m(G,"BASE_HP",200),m(G,"HP_PER_LEVEL",50),m(G,"BASE_EXP",100),m(G,"EXP_GROWTH_RATE",1.2),m(G,"DAMAGE_UNIT",10),m(G,"HURT_DURATION",200),m(G,"ATTACK_DURATION",150),m(G,"SKILL_GRID_GAP",1);let kt=G;const Rt=7,Lt={0:{width:5,pixels:[" ### ","#   #","#  ##","# # #","##  #","#   #"," ### "]},1:{width:3,pixels:[" # ","## "," # "," # "," # "," # ","###"]},2:{width:5,pixels:[" ### ","#   #","    #","  ## "," #   ","#    ","#####"]},3:{width:5,pixels:[" ### ","#   #","    #","  ## ","    #","#   #"," ### "]},4:{width:5,pixels:["#   #","#   #","#   #","#####","    #","    #","    #"]},5:{width:5,pixels:["#####","#    ","#    ","#### ","    #","#   #"," ### "]},6:{width:5,pixels:[" ### ","#    ","#    ","#### ","#   #","#   #"," ### "]},7:{width:5,pixels:["#####","    #","   # ","  #  ","  #  ","  #  ","  #  "]},8:{width:5,pixels:[" ### ","#   #","#   #"," ### ","#   #","#   #"," ### "]},9:{width:5,pixels:[" ### ","#   #","#   #"," ####","    #","    #"," ### "]},A:{width:5,pixels:[" ### ","#   #","#   #","#####","#   #","#   #","#   #"]},D:{width:5,pixels:["#### ","#   #","#   #","#   #","#   #","#   #","#### "]},E:{width:4,pixels:["####","#   ","#   ","### ","#   ","#   ","####"]},G:{width:5,pixels:[" ### ","#    ","#    ","# ###","#   #","#   #"," ### "]},I:{width:3,pixels:["###"," # "," # "," # "," # "," # ","###"]},L:{width:4,pixels:["#   ","#   ","#   ","#   ","#   ","#   ","####"]},N:{width:5,pixels:["#   #","##  #","# # #","#  ##","#   #","#   #","#   #"]},O:{width:5,pixels:[" ### ","#   #","#   #","#   #","#   #","#   #"," ### "]},P:{width:4,pixels:["### ","#  #","#  #","### ","#   ","#   ","#   "]},R:{width:4,pixels:["### ","#  #","#  #","### ","# # ","#  #","#  #"]},S:{width:4,pixels:[" ###","#   ","#   "," ## ","   #","   #","### "]},T:{width:5,pixels:["#####","  #  ","  #  ","  #  ","  #  ","  #  ","  #  "]},"%":{width:5,pixels:["##  #","## # ","  #  "," #   "," # ##","#  ##","   ##"]}," ":{width:3,pixels:["   ","   ","   ","   ","   ","   ","   "]}},Ht={charHeight:Rt,chars:Lt};class Ft{constructor(){m(this,"font");this.font=Ht}textToPixels(u,t,e){const s=[],a=u.letterSpacing??1,i=u.color.replace("#",""),l=parseInt(i.substring(0,2),16),o=parseInt(i.substring(2,4),16),n=parseInt(i.substring(4,6),16),c=l<<16|o<<8|n;let h=0;const r=u.text.toUpperCase().split("");for(let k=0;k<r.length;k++){const x=this.font.chars[r[k]];x&&(h+=x.width,k<r.length-1&&(h+=a))}const f=Math.floor(t*u.position.x),p=Math.floor(e*u.position.y),d=f-Math.floor(h/2),y=p-Math.floor(this.font.charHeight/2);let S=d;for(const k of r){const x=this.font.chars[k];if(x){for(let g=0;g<x.pixels.length;g++){const w=x.pixels[g];for(let C=0;C<w.length;C++)if(w[C]==="#"){const M=S+C,v=y+g;M>=0&&M<t&&v>=0&&v<e&&s.push({gridX:M,gridY:v,color:c})}}S+=x.width+a}}return s}processConfig(u,t,e){const s=new Map;for(const a of u.texts){const i=this.textToPixels(a,t,e);s.set(a.id,i)}return s}}const Dt=[{id:"title",text:"PRESS TO START",letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"}],_t={texts:Dt},tt=class tt extends F.Scene{constructor(){super("GridScene");m(this,"cells",[]);m(this,"cols",0);m(this,"rows",0);m(this,"cellWidth",10);m(this,"cellHeight",10);m(this,"gap",1);m(this,"isAnimating",!1);m(this,"isReady",!1);m(this,"textRenderer");m(this,"textPixels",new Map);m(this,"cursorGlowRadius",4);m(this,"glowPhase",0);m(this,"textBreathPhase",0);m(this,"isLoading",!0);m(this,"loadingCells",new Set);m(this,"backgroundImage");m(this,"titleBgm");this.textRenderer=new Ft}preload(){this.load.image("background","background.png"),this.load.image("char_idle_1","sprites/character/IDEL01.png"),this.load.image("char_idle_2","sprites/character/IDEL02.png"),this.load.image("char_run_1","sprites/character/RUN01.png"),this.load.image("char_run_2","sprites/character/RUN02.png"),this.load.image("char_attack_1","sprites/character/ATTACK01.png"),this.load.image("char_attack_2","sprites/character/ATTACK02.png"),this.load.image("char_hurt","sprites/character/HURT01.png"),this.load.audio("bgm_title","audio/BGM00.mp3"),this.load.audio("bgm_game_01","audio/BGM01.mp3"),this.load.audio("bgm_game_02","audio/BGM02.mp3"),this.load.on("progress",t=>{this.updateLoadingProgress(Math.floor(t*100))})}create(){this.cameras.main.setBackgroundColor("rgba(0,0,0,0)"),this.createBackground(),this.calculateGridSize(),this.createGrid(),this.showLoadingText(0),this.startEntryAnimation(),this.preloadGameAssets(),this.input.on("pointerdown",t=>{if(!this.isReady||this.isAnimating)return;const e=Math.floor(t.x/(this.cellWidth+this.gap)),s=Math.floor(t.y/(this.cellHeight+this.gap));this.startExitAnimation(e,s)}),this.input.on("pointermove",t=>{!this.isReady||this.isAnimating||this.updateCursorGlow(t.x,t.y)})}update(t,e){if(!this.isReady||this.isAnimating)return;this.glowPhase+=e*.002,this.textBreathPhase+=e*.004;const s=this.input.activePointer;s&&this.updateCursorGlow(s.x,s.y),this.updateTextBreath()}updateTextBreath(){const t=.5+.5*Math.sin(this.textBreathPhase),e=Math.floor(204+51*t),s=e<<16|e<<8|e,a=.5+.5*Math.sin(this.textBreathPhase*3),i=t>.6?a*.8:0,l=new Set;this.cells.forEach(o=>{o.isText&&l.add(`${o.x},${o.y}`)}),this.cells.forEach(o=>{if(o.isText)o.graphics.setFillStyle(s),o.graphics.setAlpha(.95);else{const n=`${o.x-1},${o.y-1}`;l.has(n)&&i>0&&(o.graphics.setFillStyle(8939263),o.graphics.setAlpha(i))}})}updateCursorGlow(t,e){const s=Math.floor(t/(this.cellWidth+this.gap)),a=Math.floor(e/(this.cellHeight+this.gap)),i=.3+.7*(.5+.5*Math.sin(this.glowPhase));this.cells.forEach(l=>{const o=l.x-s,n=l.y-a,c=Math.sqrt(o*o+n*n);if(c<=this.cursorGlowRadius){const r=(1-c/this.cursorGlowRadius)*i,f=l.originalColor>>16&255,p=l.originalColor>>8&255,d=l.originalColor&255,y=Math.min(255,Math.floor(f+(255-f)*r)),S=Math.min(255,Math.floor(p+(255-p)*r)),k=Math.min(255,Math.floor(d+(255-d)*r)),x=y<<16|S<<8|k;l.graphics.setFillStyle(x)}else l.graphics.setFillStyle(l.originalColor)})}createBackground(){const t=this.cameras.main.width,e=this.cameras.main.height;this.backgroundImage=this.add.image(t/2,e/2,"background");const s=t/this.backgroundImage.width,a=e/this.backgroundImage.height,i=Math.max(s,a);this.backgroundImage.setScale(i),this.backgroundImage.setDepth(-1)}showLoadingText(t){this.loadingCells.forEach(a=>{this.cells[a]&&(this.cells[a].originalColor=2236962,this.cells[a].isText=!1,this.cells[a].graphics.setFillStyle(2236962),this.cells[a].graphics.setAlpha(.2))}),this.loadingCells.clear();const e=`LOADING ${t}%`;this.textRenderer.textToPixels({id:"loading",text:e,letterSpacing:2,position:{x:.5,y:.5},color:"#ffffff"},this.cols,this.rows).forEach(a=>{const i=a.gridY*this.cols+a.gridX;this.cells[i]&&(this.cells[i].originalColor=a.color,this.cells[i].isText=!0,this.cells[i].graphics.setFillStyle(a.color),this.cells[i].graphics.setAlpha(.95),this.loadingCells.add(i))})}updateLoadingProgress(t){this.isLoading&&this.showLoadingText(t)}preloadGameAssets(){let t=0;const e=this.time.addEvent({delay:50,callback:()=>{t+=Math.random()*15,t>=100&&(t=100,e.destroy(),this.onLoadingComplete()),this.showLoadingText(Math.floor(t))},loop:!0})}onLoadingComplete(){this.isLoading=!1,this.time.delayedCall(500,()=>{this.cells.forEach(t=>{t.originalColor=2236962,t.isText=!1,t.graphics.setFillStyle(2236962),t.graphics.setAlpha(.2)}),this.loadingCells.clear(),this.time.delayedCall(300,()=>{this.processTextConfig(),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].graphics.setFillStyle(e.color),this.cells[s].graphics.setAlpha(.95))})}),this.isAnimating||(this.isReady=!0),this.cache.audio.exists("bgm_title")&&(this.titleBgm=this.sound.add("bgm_title",{volume:.5,loop:!0}),this.titleBgm.play())})})}calculateGridSize(){const t=this.cameras.main.width,e=this.cameras.main.height,s=Math.min(1,t/tt.BASE_WIDTH),a=Math.max(tt.MIN_CELL_SIZE,Math.floor(tt.BASE_CELL_SIZE*s));this.gap=1,this.cellWidth=a,this.cellHeight=a,this.cols=Math.ceil((t+this.gap)/(a+this.gap)),this.rows=Math.ceil((e+this.gap)/(a+this.gap));const i=.05,l=t*(1-i*2),o=e*(1-i*2),n=16/9,c=l/o;let h,r;c>n?(r=o,h=o*n):(h=l,r=l/n);const f=(t-h)/2,p=(e-r)/2;this.registry.set("gameBounds",{x:f,y:p,width:h,height:r}),console.log(`Grid: ${this.cols}x${this.rows}, cellSize: ${a}, gameBounds: ${h.toFixed(0)}x${r.toFixed(0)}`)}createGrid(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++){const s=e*(this.cellWidth+this.gap)+this.cellWidth/2,a=t*(this.cellHeight+this.gap)+this.cellHeight/2,i=this.add.rectangle(s,a,this.cellWidth,this.cellHeight,2236962);i.setAlpha(0),this.cells.push({x:e,y:t,graphics:i,delay:0,originalColor:2236962,isText:!1})}}processTextConfig(){this.textPixels=this.textRenderer.processConfig(_t,this.cols,this.rows),this.textPixels.forEach(t=>{t.forEach(e=>{const s=e.gridY*this.cols+e.gridX;this.cells[s]&&(this.cells[s].originalColor=e.color,this.cells[s].isText=!0)})})}startEntryAnimation(){this.isAnimating=!0;const t=new Set;for(let y=0;y<this.cells.length;y++)t.add(y);const e=20,s=50,a=10,l=Math.floor(200/a),o=3e3;let n=0,c=!1;const h=(y,S)=>S*this.cols+y,r=y=>({x:y%this.cols,y:Math.floor(y/this.cols)}),f=y=>{const S=this.cells[y];S.graphics.setAlpha(1),S.graphics.setFillStyle(16777215),this.tweens.add({targets:S.graphics,fillColor:{from:16777215,to:S.originalColor},alpha:{from:1,to:.2},duration:80,ease:"Linear"})},p=y=>{const{x:S,y:k}=r(y),x=l,g=[];for(let M=0;M<=x;M++)g[M]=[];for(let M=-x;M<=x;M++)for(let v=-x;v<=x;v++){const b=S+v,P=k+M;if(b>=0&&b<this.cols&&P>=0&&P<this.rows){const B=Math.sqrt(v*v+M*M),T=Math.floor(B);if(T<=x){const E=h(b,P);g[T].push(E)}}}let w=0;const C=()=>{w>x||(g[w].forEach(M=>{t.has(M)&&(t.delete(M),f(M))}),w++,w<=x&&this.time.delayedCall(a,C))};C()},d=()=>{if(c)return;if(n>=o||t.size===0){this.finishEntry(t),c=!0;return}const y=Array.from(t),S=Math.min(e,y.length);for(let k=0;k<S&&y.length!==0;k++){const x=Math.floor(Math.random()*y.length),g=y[x];y.splice(x,1),t.has(g)&&p(g)}n+=s,t.size>0&&n<o?this.time.delayedCall(s,d):c||(this.finishEntry(t),c=!0)};d()}finishEntry(t){t.forEach(e=>{const s=this.cells[e];s.graphics.setAlpha(.2),s.graphics.setFillStyle(s.originalColor)}),this.time.delayedCall(100,()=>{this.isAnimating=!1,this.isLoading||(this.isReady=!0)})}startExitAnimation(t,e){this.isAnimating=!0,this.titleBgm&&this.titleBgm.isPlaying&&this.titleBgm.stop();const s=this.cameras.main.width,a=this.cameras.main.height;this.scene.launch("MainScene"),this.scene.bringToTop("GridScene");const i=t*(this.cellWidth+this.gap)+this.cellWidth/2,l=e*(this.cellHeight+this.gap)+this.cellHeight/2;this.registry.events.emit("reveal-update",{x:i,y:l,radius:0}),this.cells.forEach(r=>{r.graphics.setFillStyle(0),r.graphics.setAlpha(1)}),this.backgroundImage.setVisible(!1);const o=5;let n=0;this.cells.forEach(r=>{const f=r.x-t,p=r.y-e,d=Math.sqrt(f*f+p*p);r.delay=Math.floor(d*o),r.delay>n&&(n=r.delay)});const c=Math.sqrt(Math.max(i,s-i)**2+Math.max(l,a-l)**2)+50,h=n+150;this.tweens.addCounter({from:0,to:c,duration:h,ease:"Linear",onUpdate:r=>{const f=r.getValue()??0;this.registry.events.emit("reveal-update",{x:i,y:l,radius:f})}}),this.cells.forEach(r=>{this.time.delayedCall(r.delay,()=>{r.graphics.setFillStyle(16777215),r.graphics.setAlpha(1),this.tweens.addCounter({from:0,to:100,duration:200,ease:"Linear",onUpdate:f=>{const p=f.getValue()??0;let d,y;p<15?(d=16777215,y=1):p<30?(d=16776960,y=1):p<50?(d=16746496,y=1):p<70?(d=16720384,y=1-(p-50)/50):(d=6684672,y=1-(p-50)/50),r.graphics.setFillStyle(d),r.graphics.setAlpha(Math.max(0,y))},onComplete:()=>{r.graphics.setVisible(!1)}})})}),this.time.delayedCall(n+200,()=>{this.registry.events.emit("reveal-complete"),this.scene.stop("GridScene")})}};m(tt,"BASE_CELL_SIZE",10),m(tt,"MIN_CELL_SIZE",4),m(tt,"BASE_WIDTH",1920);let yt=tt;const bt=document.getElementById("version-info");bt&&(bt.textContent="v0.1.0a");let N=null;function Xt(){return window.innerWidth>window.innerHeight}function xt(){return window.visualViewport?window.visualViewport.height:window.innerHeight}function Yt(){if(N)return;const q={type:F.AUTO,width:window.innerWidth,height:xt(),parent:"app",backgroundColor:"#111111",scale:{mode:F.Scale.RESIZE,autoCenter:F.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[yt,Gt,kt]};N=new F.Game(q),N.events.once("ready",()=>{N&&N.sound&&(N.sound.volume=.5)})}function Mt(){(window.innerWidth>900||Xt())&&Yt()}Mt();window.addEventListener("resize",Mt);window.addEventListener("orientationchange",()=>{setTimeout(Mt,100)});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{N&&N.scale.resize(window.innerWidth,xt())});document.addEventListener("fullscreenchange",()=>{N&&setTimeout(()=>{N.scale.resize(window.innerWidth,xt())},100)});window.addEventListener("volumechange",q=>{N&&N.sound&&(N.sound.volume=q.detail.volume)});
